<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Notes|笔记站</title>
  
  
  <link href="https://zhongye1.github.io/Arknight-notes/rss.xml" rel="self"/>
  
  <link href="https://zhongye1.github.io/Arknight-notes/"/>
  <updated>2025-12-25T04:59:03.902Z</updated>
  <id>https://zhongye1.github.io/Arknight-notes/</id>
  
  <author>
    <name>柊野</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2025-12-25-前端学习-关于JavaScript 实现哈希表</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/39960.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/39960.html</id>
    <published>2025-12-25T03:31:39.000Z</published>
    <updated>2025-12-25T04:59:03.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JavaScript-实现哈希表"><a href="#JavaScript-实现哈希表" class="headerlink" title="JavaScript 实现哈希表"></a>JavaScript 实现哈希表</h1><p><strong>哈希表</strong>（Hash Table，散列表）是一种通过键（Key）直接访问值（Value）的数据结构，通过哈希函数将键映射到表中的位置</p><h3 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// 简单的哈希函数示例</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hashString</span>(<span class="hljs-params">key, tableSize</span>) {<br>  let <span class="hljs-built_in">hash</span> = <span class="hljs-number">17</span>;<br>  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; key.<span class="hljs-built_in">length</span>; i++) {<br>    <span class="hljs-built_in">hash</span> = (<span class="hljs-number">13</span> * <span class="hljs-built_in">hash</span> * key.charCodeAt(i)) % tableSize;<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>;<br>}<br></code></pre></td></tr></table></figure><h2 id="用-JavaScript-实现哈希表"><a href="#用-JavaScript-实现哈希表" class="headerlink" title="用 JavaScript 实现哈希表"></a>用 JavaScript 实现哈希表</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HashTable</span> {<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">size = <span class="hljs-number">53</span></span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(size);<br>  }<br><br>  <span class="hljs-comment">// 哈希函数</span><br>  <span class="hljs-title function_">_hash</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRIME</span> = <span class="hljs-number">31</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_LENGTH</span> = <span class="hljs-number">100</span>;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(key.<span class="hljs-property">length</span>, <span class="hljs-variable constant_">MAX_LENGTH</span>); i++) {<br>      <span class="hljs-keyword">const</span> char = key[i];<br>      <span class="hljs-keyword">const</span> value = char.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) - <span class="hljs-number">96</span>; <span class="hljs-comment">// a=1, b=2...</span><br>      total = (total * <span class="hljs-variable constant_">PRIME</span> + value) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>.<span class="hljs-property">length</span>;<br>    }<br>    <span class="hljs-keyword">return</span> total;<br>  }<br><br>  <span class="hljs-comment">// 插入键值对</span><br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index]) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index] = [];<br>    }<br>    <br>    <span class="hljs-comment">// 检查键是否已存在，存在则更新</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-property">length</span>; i++) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index][i][<span class="hljs-number">0</span>] === key) {<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index][i][<span class="hljs-number">1</span>] = value;<br>        <span class="hljs-keyword">return</span>;<br>      }<br>    }<br>    <br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-title function_">push</span>([key, value]);<br>  }<br><br>  <span class="hljs-comment">// 获取值</span><br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index]) {<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-property">length</span>; i++) {<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index][i][<span class="hljs-number">0</span>] === key) {<br>          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index][i][<span class="hljs-number">1</span>];<br>        }<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;<br>  }<br><br>  <span class="hljs-comment">// 删除键值对</span><br>  <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-property">length</span>; i++) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index][i][<span class="hljs-number">0</span>] === key) {<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index].<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {<br>          <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[index];<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br><br>  <span class="hljs-comment">// 获取所有键</span><br>  <span class="hljs-title function_">keys</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">const</span> keysArr = [];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>.<span class="hljs-property">length</span>; i++) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i]) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i].<span class="hljs-property">length</span>; j++) {<br>          <span class="hljs-keyword">if</span> (!keysArr.<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i][j][<span class="hljs-number">0</span>])) {<br>            keysArr.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i][j][<span class="hljs-number">0</span>]);<br>          }<br>        }<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> keysArr;<br>  }<br><br>  <span class="hljs-comment">// 获取所有值</span><br>  <span class="hljs-title function_">values</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">const</span> valuesArr = [];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>.<span class="hljs-property">length</span>; i++) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i]) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i].<span class="hljs-property">length</span>; j++) {<br>          <span class="hljs-keyword">if</span> (!valuesArr.<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i][j][<span class="hljs-number">1</span>])) {<br>            valuesArr.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyMap</span>[i][j][<span class="hljs-number">1</span>]);<br>          }<br>        }<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> valuesArr;<br>  }<br>}<br></code></pre></td></tr></table></figure><h3 id="自动扩容"><a href="#自动扩容" class="headerlink" title="自动扩容"></a>自动扩容</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedHashTable</span> {<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">initialCapacity = <span class="hljs-number">8</span>, loadFactor = <span class="hljs-number">0.75</span></span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = initialCapacity;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadFactor</span> = loadFactor;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>);<br>  }<br><br>  <span class="hljs-title function_">_hash</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">let</span> hashCode = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRIME</span> = <span class="hljs-number">31</span>;<br>    <br>    <span class="hljs-comment">// 处理不同类型的键</span><br>    <span class="hljs-keyword">const</span> keyStr = <span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'string'</span> ? key : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(key);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keyStr.<span class="hljs-property">length</span>; i++) {<br>      hashCode = (<span class="hljs-variable constant_">PRIME</span> * hashCode + keyStr.<span class="hljs-title function_">charCodeAt</span>(i)) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;<br>    }<br>    <span class="hljs-keyword">return</span> hashCode;<br>  }<br><br>  <span class="hljs-title function_">_resize</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">const</span> oldBuckets = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> *= <span class="hljs-number">2</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> bucket <span class="hljs-keyword">of</span> oldBuckets) {<br>      <span class="hljs-keyword">if</span> (bucket) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> bucket) {<br>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(key, value);<br>        }<br>      }<br>    }<br>  }<br><br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {<br>    <span class="hljs-comment">// 检查是否需要扩容</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadFactor</span>) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_resize</span>();<br>    }<br><br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index]) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index] = [];<br>    }<br><br>    <span class="hljs-comment">// 更新或添加</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index].<span class="hljs-property">length</span>; i++) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index][i][<span class="hljs-number">0</span>] === key) {<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index][i][<span class="hljs-number">1</span>] = value;<br>        <span class="hljs-keyword">return</span>;<br>      }<br>    }<br><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index].<span class="hljs-title function_">push</span>([key, value]);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++;<br>  }<br><br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <span class="hljs-keyword">const</span> bucket = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>[index];<br>    <br>    <span class="hljs-keyword">if</span> (bucket) {<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [k, v] <span class="hljs-keyword">of</span> bucket) {<br>        <span class="hljs-keyword">if</span> (k === key) <span class="hljs-keyword">return</span> v;<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;<br>  }<br><br>  <span class="hljs-title function_">has</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key) !== <span class="hljs-literal">undefined</span>;<br>  }<br><br>  <span class="hljs-title function_">clear</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">0</span>;<br>  }<br><br>  <span class="hljs-comment">// 获取负载因子</span><br>  <span class="hljs-title function_">getLoadFactor</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;<br>  }<br>}<br></code></pre></td></tr></table></figure><h3 id="支持任何类型键的通用哈希表"><a href="#支持任何类型键的通用哈希表" class="headerlink" title="支持任何类型键的通用哈希表"></a>支持任何类型键的通用哈希表</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalHashTable</span> {<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">size = <span class="hljs-number">53</span></span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(size);<br>  }<br><br>  <span class="hljs-comment">// 通用哈希函数，支持多种类型</span><br>  <span class="hljs-title function_">_hash</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'number'</span>) {<br>      <span class="hljs-keyword">return</span> key % <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">length</span>;<br>    }<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'string'</span>) {<br>      <span class="hljs-keyword">let</span> hash = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; key.<span class="hljs-property">length</span>; i++) {<br>        hash = (hash &lt;&lt; <span class="hljs-number">5</span>) - hash + key.<span class="hljs-title function_">charCodeAt</span>(i);<br>        hash = hash &amp; hash; <span class="hljs-comment">// 转为32位整数</span><br>      }<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(hash) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">length</span>;<br>    }<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span> &amp;&amp; key !== <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// 对象使用JSON字符串化</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(key));<br>    }<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  }<br><br>  <span class="hljs-comment">// 双重哈希解决冲突</span><br>  <span class="hljs-title function_">_hash2</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">7</span> - (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key) % <span class="hljs-number">7</span>);<br>  }<br><br>  <span class="hljs-comment">// 使用线性探测开放寻址</span><br>  <span class="hljs-title function_">_findSlot</span>(<span class="hljs-params">key, forInsert = <span class="hljs-literal">false</span></span>) {<br>    <span class="hljs-keyword">let</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash</span>(key);<br>    <span class="hljs-keyword">let</span> step = <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] !== <span class="hljs-literal">undefined</span>) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index].<span class="hljs-property">key</span> === key) {<br>        <span class="hljs-keyword">return</span> index; <span class="hljs-comment">// 找到键</span><br>      }<br>      <br>      <span class="hljs-keyword">if</span> (forInsert &amp;&amp; (<span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] === <span class="hljs-literal">null</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] === <span class="hljs-literal">undefined</span>)) {<br>        <span class="hljs-keyword">return</span> index; <span class="hljs-comment">// 找到可插入的空槽</span><br>      }<br>      <br>      <span class="hljs-comment">// 线性探测</span><br>      index = (index + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">length</span>;<br>      step++;<br>      <br>      <span class="hljs-keyword">if</span> (step &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">length</span>) {<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Hash table is full'</span>);<br>      }<br>    }<br>    <br>    <span class="hljs-keyword">return</span> forInsert ? index : -<span class="hljs-number">1</span>;<br>  }<br><br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findSlot</span>(key, <span class="hljs-literal">true</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] = { key, value };<br>  }<br><br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findSlot</span>(key, <span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">return</span> index !== -<span class="hljs-number">1</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index].<span class="hljs-property">value</span> : <span class="hljs-literal">undefined</span>;<br>  }<br><br>  <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findSlot</span>(key, <span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>[index] = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 标记为删除</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br>}<br></code></pre></td></tr></table></figure><h2 id="使用-JavaScript-内置结构"><a href="#使用-JavaScript-内置结构" class="headerlink" title="使用 JavaScript 内置结构"></a>使用 JavaScript 内置结构</h2><p>使用 Object</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 最简单的哈希表实现</span><br><span class="hljs-keyword">const</span> hashTable = {};<br>hashTable[<span class="hljs-string">'key1'</span>] = <span class="hljs-string">'value1'</span>;<br>hashTable[<span class="hljs-string">'key2'</span>] = <span class="hljs-string">'value2'</span>;<br><br><span class="hljs-comment">// 获取</span><br><span class="hljs-keyword">const</span> value = hashTable[<span class="hljs-string">'key1'</span>];<br><br><span class="hljs-comment">// 删除</span><br><span class="hljs-keyword">delete</span> hashTable[<span class="hljs-string">'key1'</span>];<br></code></pre></td></tr></table></figure><p>使用 Map</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// ES6 Map 是更好的哈希表实现</span><br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><br><span class="hljs-comment">// 设置键值对</span><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'Alice'</span>);<br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">42</span>, <span class="hljs-string">'The Answer'</span>);<br>map.<span class="hljs-title function_">set</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> }, <span class="hljs-string">'Object Key'</span>);<br><br><span class="hljs-comment">// 获取</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>)); <span class="hljs-comment">// Alice</span><br><br><span class="hljs-comment">// 检查是否存在</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">has</span>(<span class="hljs-number">42</span>)); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// 删除</span><br>map.<span class="hljs-title function_">delete</span>(<span class="hljs-number">42</span>);<br><br><span class="hljs-comment">// 大小</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>);<br><br><span class="hljs-comment">// 遍历</span><br>map.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> {<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);<br>});<br><br><span class="hljs-comment">// 清空</span><br>map.<span class="hljs-title function_">clear</span>();<br></code></pre></td></tr></table></figure><p>使用 Set（类似哈希集合）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 用于存储唯一值</span><br><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br><br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>);<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 重复，不会被添加</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-title function_">has</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-property">size</span>);   <span class="hljs-comment">// 2</span><br><br>set.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>选择合适的哈希函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 更好的字符串哈希函数（djb2算法）</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hashDJB2</span>(<span class="hljs-params">str, tableSize</span>) {<br>  <span class="hljs-keyword">let</span> hash = <span class="hljs-number">5381</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {<br>    hash = (hash * <span class="hljs-number">33</span>) ^ str.<span class="hljs-title function_">charCodeAt</span>(i);<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(hash) % tableSize;<br>}<br></code></pre></td></tr></table></figure><p>优化冲突处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedHashTable</span> {<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">size = <span class="hljs-number">53</span></span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(size);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleted</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'deleted'</span>); <span class="hljs-comment">// 特殊标记删除</span><br>  }<br><br>  <span class="hljs-comment">// 二次探测</span><br>  <span class="hljs-title function_">_probe</span>(<span class="hljs-params">index, i, tableSize</span>) {<br>    <span class="hljs-keyword">return</span> (index + i * i) % tableSize;<br>  }<br><br>  <span class="hljs-comment">// 双重哈希</span><br>  <span class="hljs-title function_">_doubleHash</span>(<span class="hljs-params">index, i, tableSize, key</span>) {<br>    <span class="hljs-keyword">const</span> hash2 = <span class="hljs-number">1</span> + (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_hash2</span>(key) % (tableSize - <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">return</span> (index + i * hash2) % tableSize;<br>  }<br>}<br></code></pre></td></tr></table></figure><h2 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h2><p>频率计数器</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">frequencyCounter</span>(<span class="hljs-params">arr</span>) {<br>  <span class="hljs-keyword">const</span> frequency = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {<br>    frequency.<span class="hljs-title function_">set</span>(item, (frequency.<span class="hljs-title function_">get</span>(item) || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>);<br>  }<br>  <br>  <span class="hljs-keyword">return</span> frequency;<br>}<br><br><span class="hljs-comment">// 使用</span><br><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'banana'</span>];<br><span class="hljs-keyword">const</span> freq = <span class="hljs-title function_">frequencyCounter</span>(arr);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(freq.<span class="hljs-title function_">get</span>(<span class="hljs-string">'banana'</span>)); <span class="hljs-comment">// 3</span><br></code></pre></td></tr></table></figure><p>缓存实现（LRU Cache）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> {<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">capacity</span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = capacity;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 哈希表 + 维护顺序</span><br>  }<br><br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-keyword">const</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(key);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, value); <span class="hljs-comment">// 更新为最近使用</span><br>    <br>    <span class="hljs-keyword">return</span> value;<br>  }<br><br>  <span class="hljs-title function_">put</span>(<span class="hljs-params">key, value</span>) {<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(key)) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) {<br>      <span class="hljs-comment">// 删除最久未使用的</span><br>      <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(oldestKey);<br>    }<br>    <br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, value);<br>  }<br>}<br></code></pre></td></tr></table></figure><p>分组算法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">groupBy</span>(<span class="hljs-params">array, keyFn</span>) {<br>  <span class="hljs-keyword">const</span> groups = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> array) {<br>    <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">typeof</span> keyFn === <span class="hljs-string">'function'</span> <br>      ? <span class="hljs-title function_">keyFn</span>(item) <br>      : item[keyFn];<br>    <br>    <span class="hljs-keyword">if</span> (!groups.<span class="hljs-title function_">has</span>(key)) {<br>      groups.<span class="hljs-title function_">set</span>(key, []);<br>    }<br>    <br>    groups.<span class="hljs-title function_">get</span>(key).<span class="hljs-title function_">push</span>(item);<br>  }<br>  <br>  <span class="hljs-keyword">return</span> groups;<br>}<br><br><span class="hljs-comment">// 使用</span><br><span class="hljs-keyword">const</span> people = [<br>  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },<br>  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },<br>  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }<br>];<br><br><span class="hljs-keyword">const</span> groupedByAge = <span class="hljs-title function_">groupBy</span>(people, <span class="hljs-string">'age'</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(groupedByAge.<span class="hljs-title function_">get</span>(<span class="hljs-number">25</span>));<br><span class="hljs-comment">// [{ name: 'Alice', age: 25 }, { name: 'Charlie', age: 25 }]</span><br></code></pre></td></tr></table></figure><h2 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h2><div class="table-container"><table><thead><tr><th>操作</th><th>Object</th><th>Map</th><th>自定义哈希表</th></tr></thead><tbody><tr><td>插入</td><td>O(1)</td><td>O(1)</td><td>O(1)-O(n)</td></tr><tr><td>查找</td><td>O(1)</td><td>O(1)</td><td>O(1)-O(n)</td></tr><tr><td>删除</td><td>O(1)</td><td>O(1)</td><td>O(1)-O(n)</td></tr><tr><td>遍历键</td><td>O(n)</td><td>O(n)</td><td>O(n)</td></tr></tbody></table></div><p>最坏情况（所有键冲突）会退化为 O(n)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;JavaScript-实现哈希表&quot;&gt;&lt;a href=&quot;#JavaScript-实现哈希表&quot; class=&quot;headerlink&quot; title=&quot;JavaScript 实现哈希表&quot;&gt;&lt;/a&gt;JavaScript 实现哈希表&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;哈希表&lt;/s</summary>
      
    
    
    
    <category term="数据结构" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>2025-12-25-JavaScript / TypeScript 语法速记</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/23505.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/23505.html</id>
    <published>2025-12-25T03:19:07.000Z</published>
    <updated>2025-12-25T03:23:33.851Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JavaScript-TypeScript-语法速记表"><a href="#JavaScript-TypeScript-语法速记表" class="headerlink" title="JavaScript / TypeScript 语法速记表"></a>JavaScript / TypeScript 语法速记表</h1><h2 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// ES5</span><br><span class="hljs-keyword">var</span> x = <span class="hljs-number">10</span>;           <span class="hljs-comment">// 函数作用域</span><br><br><span class="hljs-comment">// ES6+</span><br><span class="hljs-keyword">let</span> y = <span class="hljs-number">20</span>;           <span class="hljs-comment">// 块级作用域，可重新赋值</span><br><span class="hljs-keyword">const</span> z = <span class="hljs-number">30</span>;         <span class="hljs-comment">// 块级作用域，不可重新赋值</span><br></code></pre></td></tr></table></figure><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 基本类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Hello"</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">42</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-attr">bool</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-attr">undef</span>: <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-attr">nul</span>: <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-attr">sym</span>: <span class="hljs-built_in">symbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"id"</span>);<br><br><span class="hljs-comment">// 引用类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-built_in">object</span> = { <span class="hljs-attr">key</span>: <span class="hljs-string">"value"</span> };<br><span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br><span class="hljs-keyword">let</span> <span class="hljs-attr">func</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-function">() =&gt;</span> {};<br><br><span class="hljs-comment">// TS特有类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">anyType</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"anything"</span>;      <span class="hljs-comment">// 任意类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">tuple</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">"a"</span>, <span class="hljs-number">1</span>];  <span class="hljs-comment">// 元组</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Color</span> { <span class="hljs-title class_">Red</span>, <span class="hljs-title class_">Green</span>, <span class="hljs-title class_">Blue</span> };    <span class="hljs-comment">// 枚举</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">unknownType</span>: <span class="hljs-built_in">unknown</span>;           <span class="hljs-comment">// 未知类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">neverType</span>: <span class="hljs-built_in">never</span>;               <span class="hljs-comment">// 永不存在的值</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">voidType</span>: <span class="hljs-built_in">void</span>;                 <span class="hljs-comment">// 无返回值</span><br></code></pre></td></tr></table></figure><h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 算术运算符</span><br>+ - * / % ** ++ --<br><br><span class="hljs-comment">// 比较运算符</span><br>==  ===  !=  !==  &gt;  &lt;  &gt;=  &lt;=<br><br><span class="hljs-comment">// 逻辑运算符</span><br>&amp;&amp;  ||  !<br><br><span class="hljs-comment">// 赋值运算符</span><br>=  +=  -=  *=  /=  %=<br><br><span class="hljs-comment">// ES6新增</span><br>??    <span class="hljs-comment">// 空值合并</span><br>?.    <span class="hljs-comment">// 可选链</span><br>...   <span class="hljs-comment">// 展开/剩余运算符</span><br></code></pre></td></tr></table></figure><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 函数声明</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {<br>  <span class="hljs-keyword">return</span> a + b;<br>}<br><br><span class="hljs-comment">// 函数表达式</span><br><span class="hljs-keyword">const</span> multiply = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a * b; };<br><br><span class="hljs-comment">// 箭头函数</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">divide</span> = (<span class="hljs-params">a, b</span>) =&gt; a / b;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">sayHi</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hi"</span>);<br><br><span class="hljs-comment">// 参数默认值</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name = <span class="hljs-string">"Guest"</span></span>) { }<br><br><span class="hljs-comment">// 剩余参数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">...numbers</span>) { }<br><br><span class="hljs-comment">// TS函数类型</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFunc</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;<br></code></pre></td></tr></table></figure><h2 id="类与面向对象"><a href="#类与面向对象" class="headerlink" title="类与面向对象"></a>类与面向对象</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 类定义</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {<br>  <span class="hljs-comment">// 属性</span><br>  <span class="hljs-attr">name</span>: string;<br>  private <span class="hljs-attr">age</span>: number;<br>  protected <span class="hljs-attr">species</span>: string;<br>  <span class="hljs-keyword">static</span> <span class="hljs-attr">count</span>: number = <span class="hljs-number">0</span>;<br>  <br>  <span class="hljs-comment">// 构造函数</span><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: string</span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  }<br>  <br>  <span class="hljs-comment">// 方法</span><br>  <span class="hljs-title function_">speak</span>(): <span class="hljs-keyword">void</span> {<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Sound"</span>);<br>  }<br>  <br>  <span class="hljs-comment">// Getter/Setter</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">getAge</span>(): number { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>; }<br>  <span class="hljs-keyword">set</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params">value: number</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = value; }<br>}<br><br><span class="hljs-comment">// 继承</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {<br>  <span class="hljs-title function_">bark</span>(): <span class="hljs-keyword">void</span> {<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Woof!"</span>);<br>  }<br>  <br>  <span class="hljs-comment">// 方法重写</span><br>  override <span class="hljs-title function_">speak</span>(): <span class="hljs-keyword">void</span> {<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Woof!"</span>);<br>  }<br>}<br><br><span class="hljs-comment">// 抽象类 (TS)</span><br>abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {<br>  abstract <span class="hljs-title function_">area</span>(): number;<br>}<br><br><span class="hljs-comment">// 接口 (TS)</span><br>interface <span class="hljs-title class_">Person</span> {<br>  <span class="hljs-attr">name</span>: string;<br>  <span class="hljs-attr">age</span>: number;<br>  <span class="hljs-title function_">greet</span>(): <span class="hljs-keyword">void</span>;<br>}<br><br><span class="hljs-comment">// 实现接口</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> implements <span class="hljs-title class_">Person</span> {<br>  <span class="hljs-attr">name</span>: string;<br>  <span class="hljs-attr">age</span>: number;<br>  <span class="hljs-title function_">greet</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>); }<br>}<br></code></pre></td></tr></table></figure><h2 id="数组操作"><a href="#数组操作" class="headerlink" title="数组操作"></a>数组操作</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 数组方法</span><br>arr.<span class="hljs-title function_">push</span>(), arr.<span class="hljs-title function_">pop</span>(), arr.<span class="hljs-title function_">shift</span>(), arr.<span class="hljs-title function_">unshift</span>()<br>arr.<span class="hljs-title function_">map</span>(), arr.<span class="hljs-title function_">filter</span>(), arr.<span class="hljs-title function_">reduce</span>(), arr.<span class="hljs-title function_">forEach</span>()<br>arr.<span class="hljs-title function_">find</span>(), arr.<span class="hljs-title function_">findIndex</span>(), arr.<span class="hljs-title function_">some</span>(), arr.<span class="hljs-title function_">every</span>()<br>arr.<span class="hljs-title function_">slice</span>(), arr.<span class="hljs-title function_">splice</span>(), arr.<span class="hljs-title function_">concat</span>(), arr.<span class="hljs-title function_">join</span>()<br>arr.<span class="hljs-title function_">sort</span>(), arr.<span class="hljs-title function_">reverse</span>()<br><br><span class="hljs-comment">// 解构赋值</span><br><span class="hljs-keyword">const</span> [first, ...rest] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br><span class="hljs-keyword">const</span> { name, age } = person;<br><br><span class="hljs-comment">// 扩展运算符</span><br><span class="hljs-keyword">const</span> newArr = [...oldArr, <span class="hljs-number">4</span>];<br><span class="hljs-keyword">const</span> newObj = { ...oldObj, <span class="hljs-attr">key</span>: <span class="hljs-string">"value"</span> };<br></code></pre></td></tr></table></figure><h2 id="对象操作"><a href="#对象操作" class="headerlink" title="对象操作"></a>对象操作</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 对象字面量增强</span><br><span class="hljs-keyword">const</span> name = <span class="hljs-string">"John"</span>;<br><span class="hljs-keyword">const</span> person = { name, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> };  <span class="hljs-comment">// 属性简写</span><br><span class="hljs-keyword">const</span> obj = { [<span class="hljs-string">"key"</span> + <span class="hljs-number">1</span>]: <span class="hljs-string">"value"</span> };  <span class="hljs-comment">// 计算属性名</span><br><br><span class="hljs-comment">// 方法简写</span><br><span class="hljs-keyword">const</span> obj = {<br>  <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; }<br>};<br><br><span class="hljs-comment">// 对象方法</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj), <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj), <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)<br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(target, source)<br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(obj)<br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(obj)<br></code></pre></td></tr></table></figure><h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// Promise</span><br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"Done"</span>), <span class="hljs-number">1000</span>);<br>});<br><br>promise<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error))<br>  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Complete"</span>));<br><br><span class="hljs-comment">// Async/Await</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"></span>) {<br>  <span class="hljs-keyword">try</span> {<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">json</span>();<br>    <span class="hljs-keyword">return</span> result;<br>  } <span class="hljs-keyword">catch</span> (error) {<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);<br>  }<br>}<br><br><span class="hljs-comment">// Promise方法</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([p1, p2])<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([p1, p2])<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([p1, p2])<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([p1, p2])<br></code></pre></td></tr></table></figure><h2 id="模块系统"><a href="#模块系统" class="headerlink" title="模块系统"></a>模块系统</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 导出</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"></span>) { }<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> { }<br><span class="hljs-keyword">export</span> { var1, var2 <span class="hljs-keyword">as</span> alias };<br><br><span class="hljs-comment">// 导入</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">MyClass</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span>;<br><span class="hljs-keyword">import</span> { var1, var2 <span class="hljs-keyword">as</span> alias } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Module</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span>;<br><span class="hljs-keyword">import</span>(<span class="hljs-string">'./module'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> { });  <span class="hljs-comment">// 动态导入</span><br></code></pre></td></tr></table></figure><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 模板字符串</span><br><span class="hljs-keyword">const</span> greeting = <span class="hljs-string">`Hello <span class="hljs-subst">${name}</span>, you are <span class="hljs-subst">${age}</span> years old`</span>;<br><br><span class="hljs-comment">// 字符串方法</span><br>str.<span class="hljs-title function_">includes</span>(), str.<span class="hljs-title function_">startsWith</span>(), str.<span class="hljs-title function_">endsWith</span>()<br>str.<span class="hljs-title function_">repeat</span>(), str.<span class="hljs-title function_">padStart</span>(), str.<span class="hljs-title function_">padEnd</span>()<br>str.<span class="hljs-title function_">trim</span>(), str.<span class="hljs-title function_">trimStart</span>(), str.<span class="hljs-title function_">trimEnd</span>()<br>str.<span class="hljs-title function_">replace</span>(), str.<span class="hljs-title function_">replaceAll</span>()<br>str.<span class="hljs-title function_">slice</span>(), str.<span class="hljs-title function_">substring</span>(), str.<span class="hljs-title function_">substr</span>()<br></code></pre></td></tr></table></figure><h2 id="类型操作-TypeScript"><a href="#类型操作-TypeScript" class="headerlink" title="类型操作 (TypeScript)"></a>类型操作 (TypeScript)</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 类型注解</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">// 类型别名</span><br><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> };<br><br><span class="hljs-comment">// 联合类型</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;<br><br><span class="hljs-comment">// 交叉类型</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Combined</span> = <span class="hljs-title class_">TypeA</span> &amp; <span class="hljs-title class_">TypeB</span>;<br><br><span class="hljs-comment">// 类型断言</span><br><span class="hljs-keyword">let</span> str = (value <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">let</span> len = (&lt;<span class="hljs-built_in">string</span>&gt;value).<span class="hljs-property">length</span>;<br><br><span class="hljs-comment">// 泛型</span><br><span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">arg</span>: T): T { <span class="hljs-keyword">return</span> arg; }<br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Generic</span>&lt;T&gt; { <span class="hljs-attr">value</span>: T; }<br><br><span class="hljs-comment">// 条件类型</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">IsString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// 映射类型</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Readonly</span>&lt;T&gt; = { <span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: T[K] };<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Partial</span>&lt;T&gt; = { [K <span class="hljs-keyword">in</span> keyof T]?: T[K] };<br></code></pre></td></tr></table></figure><h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// Try-Catch</span><br><span class="hljs-keyword">try</span> {<br>  <span class="hljs-comment">// 可能出错的代码</span><br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Something went wrong"</span>);<br>} <span class="hljs-keyword">catch</span> (error) {<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);<br>} <span class="hljs-keyword">finally</span> {<br>  <span class="hljs-comment">// 始终执行</span><br>}<br></code></pre></td></tr></table></figure><h2 id="ES6-新特性"><a href="#ES6-新特性" class="headerlink" title="ES6+ 新特性"></a>ES6+ 新特性</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 解构赋值</span><br><span class="hljs-keyword">const</span> { a, b } = obj;<br><span class="hljs-keyword">const</span> [x, y] = arr;<br><br><span class="hljs-comment">// 默认参数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x = <span class="hljs-number">1</span>, y = <span class="hljs-number">2</span></span>) { }<br><br><span class="hljs-comment">// 剩余参数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">...args</span>) { }<br><br><span class="hljs-comment">// 可选链</span><br><span class="hljs-keyword">const</span> value = obj?.<span class="hljs-property">prop</span>?.<span class="hljs-property">nested</span>;<br><br><span class="hljs-comment">// 空值合并</span><br><span class="hljs-keyword">const</span> result = input ?? <span class="hljs-string">"default"</span>;<br><br><span class="hljs-comment">// BigInt</span><br><span class="hljs-keyword">const</span> big = <span class="hljs-number">9007199254740991n</span>;<br><br><span class="hljs-comment">// 动态导入</span><br><span class="hljs-keyword">import</span>(<span class="hljs-string">'./module.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> { });<br></code></pre></td></tr></table></figure><h2 id="常用数组-对象方法链"><a href="#常用数组-对象方法链" class="headerlink" title="常用数组/对象方法链"></a>常用数组/对象方法链</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 常见处理模式</span><br>array<br>  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)<br>  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">processed</span>: <span class="hljs-literal">true</span> }))<br>  .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>)<br>  .<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, curr</span>) =&gt;</span> acc + curr.<span class="hljs-property">value</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h2 id="实用代码片段"><a href="#实用代码片段" class="headerlink" title="实用代码片段"></a>实用代码片段</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 深拷贝</span><br><span class="hljs-keyword">const</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br><span class="hljs-comment">// 或</span><br><span class="hljs-keyword">const</span> deepCopy = <span class="hljs-title function_">structuredClone</span>(obj);<br><br><span class="hljs-comment">// 去重</span><br><span class="hljs-keyword">const</span> unique = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(array)];<br><br><span class="hljs-comment">// 对象合并</span><br><span class="hljs-keyword">const</span> merged = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, obj1, obj2);<br><span class="hljs-comment">// 或</span><br><span class="hljs-keyword">const</span> merged = { ...obj1, ...obj2 };<br><br><span class="hljs-comment">// 检查空对象</span><br><span class="hljs-keyword">const</span> isEmpty = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 延迟执行</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">delay</span> = ms =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms));<br><br><span class="hljs-comment">// 节流防抖</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">debounce</span> = (<span class="hljs-params">func, wait</span>) =&gt; {<br>  <span class="hljs-keyword">let</span> timeout;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {<br>    <span class="hljs-built_in">clearTimeout</span>(timeout);<br>    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">func</span>(...args), wait);<br>  };<br>};<br></code></pre></td></tr></table></figure><hr><h2 id="DST"><a href="#DST" class="headerlink" title="DST:"></a>DST:</h2><ol><li><strong>const &gt; let &gt; var</strong>​ - 优先使用 const</li><li>**=== 代替 ==  - 严格相等判断</li><li><strong>箭头函数保持 this 绑定</strong></li><li><strong>模板字符串代替拼接</strong></li><li><strong>解构简化代码</strong></li><li><strong>Promise 处理异步，async/await 更可读</strong></li><li><strong>可选链和空值合并处理 null/undefined</strong></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;JavaScript-TypeScript-语法速记表&quot;&gt;&lt;a href=&quot;#JavaScript-TypeScript-语法速记表&quot; class=&quot;headerlink&quot; title=&quot;JavaScript / TypeScript 语法速记表&quot;&gt;&lt;/a&gt;Jav</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-12-15-杂谈-系统问题</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/48096.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/48096.html</id>
    <published>2025-12-15T03:51:13.000Z</published>
    <updated>2025-12-25T03:23:33.852Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="请联系站长。WXID:Zhong_ye1" data-whm="OOPS, these decrypted content may changed, but you can still have a look.">      <script id="hbeData" type="hbeData" data-hmacdigest="ccd73d91ff6acf1da6e9b350ebf6af408870b54e6aeecf9ed40e90b8b3ee8bde" data-keysalt="bb0896cc3a56ddedf88e7ff32dc73aaa20952fb32a7e5d6784e3324ac57ab96d" data-ivsalt="46fcf312b2f4200b98b21011c55b9027a9c97488452122d040c8065d7d11dc09">        ed00f382df084a80af42822c46b31c1ab68dc9f1d5011c41999b5349a849239a92b1389f34448c8f8d878247f9062faf3ac7fc80964515a92032a80d981a044b1d6c37243b44df3784d2a349f6e8a6f09059c34faaefb7412593001324bdaeb80e8fe1c36c7f93d779d53e83815ddae101fe716fe1b3a76cb690b21d3676656d78f3beafd4d6247d3db591bb713085df641054005f240c1c74edbae32faf37bc3a91794119a3cbbf939279c890bcbf9ded22e58c33b653e8db087f9b7dcdd4be26caddce119cc86eb5bb30b3047a7842d6dd9d865b8a36b8b04f900b39039a83645c696d6d304b2cea4fe549906094074449cd2281de0741356d9dc96bb1ad41b119a0dab412ecc51118341ab6c474ec8629d56d11d4af28c321d9a30d770502e63492445fe45ce8926429c6ad6c78118d0d2991c6f840cf10fc7c6dbbdee21723182398109d041535afbc2f86b750873af3685cf7697510dc262243339f5baca0fa80fc3c19c30038d92d465b0ffd8d41ef174a5bc3db065c1b1f458880de75f2c7450e3352fbc90196370860cf232250fa7498c94e6ad4533851caacd5513bcaf9866595ec4275b828416e7f27af46a97fb7821999a4b4929f97ddbea59902108ffa3729257be3da7cff09418ccc35e10298f4684a3116825d093303bfb74107bcf190fa53a46a32cfefce7632883eb8ea5c493ea8ea37aca91d4779ff993a5310adb1c13057580ca7984ccf65e0effa0d26300227c87410f79b092e734a9d6b0d82e25539a659244a94151e8810e9f9f1cf57eb20a06b67027d3659b0406ab22180270b8b6b4fbb6b9eb9609c405128457a2560f9c10ee2de401f50765565645538dfbe164caddd8e8d5e7a2d23d23269fadbc665dc7c52436e1938aa7b8b7e4fda5540adcdc46db633e628bc64c7f20bed6746459441aa9313cbf58ccf29a357afc50311a4096d0bcfdd2ef4c526bb0f149a78758832ad1a371b234a54c528f1b7db201cb92fe1fbf2e6b5af5a24b7b018d9724cbf543659f161a098c73f15eaa4d38a5c014e2d6ad9fc8df65a0e2970de33c23bcc7f05b3a358f633fb42fea22041835cac052e0fab59b1f64f47a010f0993fa0cd9e06eaeacb88a179dbf0697e323552440abfb9a90c96bdb2ed05ef59c230d30c832ab0fb292de8230355051415004703f9aa26a0c69f809bee6d5e666c1d75196e2227ed77b69b7963da22d349c161fbaa3101dc8cfe91b049a4c2456a55bcf38d8d4ea87be5ae9ee42e99ad679ecd026988ca6dcf4467b8845f7f83cec2d8da0720ae5706dce1ae12ce1a0087cdaef1c0f46816b932a30abd6a1652539b60c6893776f288425ece04337dc3234dbc4ef7d686ac0ca96cde50c850c89fc490640058f0833ce00b8ce72ec9df56e2c14828d4f7e2c5e01e697ce3a3e3589a46e06d48b62f698733a18a8f6eefedd7ff2bef94b03fed5afde71a97bd67903a9b630759593eb4b3a35fdcab70a1b2bf5bde4166e3adcbd3b7d2985f8ae59a656951325d03034a58cfbe0aa9c38458c5fe427ec092461cf67973be2fe3830a4d6825d93a83be4bc41211ff8b1a16ab8f1eaeffb34bb36041116d5210dfc258c2a43f0d839fdfe8bc77aa49122057b97924c44373e139dca8432150952d7587ef829517a8755bbd29844a2b4b3044d9fcf5a18d3ae7890c2762999002f488cdc1c11204af0982123e80cf0069458c4880d731cd50bf6ab86e5882eb6e9aaf19afb831c924071128947b7cf433c881b1b8cf536f4ad47bf928cc585cbc77df2d2baae9646e4a87e3ad882c3657bf4a678881d93671adb26207b29c8036e501d9adda34ddf4bad91aca06e0b18a3ad16b1f826b1ab82c7c97ac11e8067fbd8ff622ca6dff3d303cd4326dbc59fae3c207d1b2ba9ca0a7622cd4dcbbaf9688d98b3b076a5a93f37d319a08a18987185b0f65dd5c6e9342432900e2ca82748ff38f4a189b5b27275c2d89de37b7a507cf4c3ec869dd94973557f516bbcdb0f162e4a3876ecc7b3044f6a92371c1d9eb5e8350d0bc1bb1dd18da8abf28d896d78eb24064cfd8a57d69b4a2f5ddfabab766ac1d4e6d25093188ec7ffee331dcbe6ef31aef93e7b7f3ea1ca453d312a3c1bc8a6c0b3d2595621d40c48d1100504b2e2a2e16149e1af980a3e0efd3929cad1eeddbae156a07d6729222c5c01adb36da4be8bc0ae1edb98ba030b7d42409218866eab433c7d41389ae5890e3c2b9edab70dafd97a6022cc8c9e46fc5539929e5428501f4a4c0e829f850472c231d1fccfcede240ae05962cb0c16de6382ee0981c6c501036e376396f73be5d7929a0989e6a1dc62f31a92eff4ab8b0ce1afdfae60a442f2a983b9aca4cfab4a07618b5adc592f61c98b9f05d644c88efbc286c4d06ce1e87346ba6d78b3a722d44340ce82f10cab4f80e3b9ed3d56398812c9cc5240a242e54883ef36319c91ac2140fb214f0f2b9f0b8186164701d63684c086c59e5a400f499c07c2a5015e5e4d0df6654e19c7a4124c29f78a932279ebeda3341f65987eed85240dc96f82fc663dd36b061a9910deb564d06f5ca0b7e594200947a3071fdb451db7a7ee6036cd283d91f6296825c7883ed3fa0afb06fbfc27a90165ed2a59b7de7a2f2c424bee3db844ad3897097b590fbb88a65fab1baa82b6af609ae94211d7d747dca86bd6c32b7700c607eb9a0433173982639c942ee36bb058371f64153dacc269dd8127fa3c2712750418b0e2f798089564cb2f0489d0a5535b1c11bd1d4210efb09fd2b22b3f232145ae994f65feb61a8b8e264072c93c9b2a4406c003ee6fa61004776418d36358f74c510c2db3e41e2740e8065fca42b4c899042c42d214fa7281fc32489c0f598427437c1c76ffdce86f0f24c126d09537448ec4a54393f7179f43582e0271baa8f49bc7ecf8f4f2e7fbd3307d58bf36f12a50582959e543501acffaa8317e13f2b0d7a3cfade1e4079223e09252813d9ffce6af3ad727f44a80d910ee3865a4c6addbfea9a7c2cce8ab723303f41edf21238a3cd5e89992124958923c04b219f656910b042df37f68030fc953ac5492b3f32e4b4a3348ebc4ba5ebdead27de866c5dbcbe2e54e0333e955ed65895f2add34293f93ba69e0b5cd4b8288bbc507698fb01b37d44985a92cdd5b13509369cdee66300dedbd1fd509d96d32cf5c1e3fb2cb42eff76cca8eb63c3d83b8aac41224fb8453f833d8c4d7d6be7932f0ce5712c0ae83c92a490a04481f55c21425aa53a786c8b52a34e068f72b2d8abbb0a2660cd6a1444d90f06eac8f94d4695a122f50ba0c524c174db9bb70aac3374a84b8c65238d353087260bb992666692b10f2eacc3018148215d38630b867c929e83e2eba0fc423a8810ef3596ee02375eacf660bc901446e6baec00a8481c59595ee4482d959c500e774bdbc5ce1913e03f6b8a6b701f8e55e003dbbf82d13cd6e766d6cb9cf00033daa8864c68b6a1380a3d2be0bf8a9615cc6b58527e04e6c45bb002579efdb1204d024b917e06a4074c87d7c0ed527eb022ccae5264b16053f71af35f3feaf4f915ae6886c129788f5f8d08eef96e90fa766a158a9ce33445172436013e64d2e073f467031e49bc3cd201c4c93e95a0bec746d3e003402cbeb9a3d50611e951f35e1465397c46a4604a1b51685c60eecafc4f01e95e714592a8ba9a8f5c0056baf55e05e98bc8335aecc132fa789187171cc6bac79bf3ae4cc8a24abdf80bdca16eef7736e47b91ea3731ad7f45dd7e3c1e4d8f4ddbf69c68809b59b30be034b08b5505a019e2c83b10b39742c2edcf1d5588ab0ae830f9a88efc5c2187379f1facafc64b26565c3aeaea47250f3b120659cf64658c45acad855cca23d01d148546570a6528b125281212c98680a97e6f7ab7e8e84342d9a5d830e5ab9e8934322ff09c1ee5de2fce6fd197ff484c5b67a675f2372db6b1e748006b67e95b06c05664d4a6b8234bfbc7d3fed4e06dd81031a84c35b09656053e7caffb6912327b339604ed867620943fb3286507556928f7df330f57507d1753f7d232f0c708ea43c728fbb46ef84d95148570ed445d20a43bebfdd1e5250b0b55cd097e5e2ffc9aca8bb3812a11feecb09cdbca585935335f0823722d369e29652ef34565d2a35510ebcc79ae9a954f8752a352d8a1e7ad29a906d28bda2d150be747057eb66ef8656262bc4e49f705a4f3fe67c5d9fd24110cdb82f662d56e6c464f4aa08351f24016723380938cfd9749ed55bebef360e33b99496509c36c070f9a3c88a3edb22d6ff40d75a9ffddd58ba352c5ad7dbbfca3b1ac8e36fae9c29f368796643b3dc20f436d1bc6768cb3daf61fa3ae6a5947982ab162331181b6a68e2415bfd055ce3bf6845239030d7fb61b460587fb267b025c6b3ec2dcd7a14b40be22f661395ef4cfe00802db69e94699006cd0d12d931e23549a818cc3a1338e62cd10edb708cd620ba75a15106f8545402533ef55fcd71c426294c49635b84bb94a336f7388562004d27c5a326b0d89af19b82cdb2eba714b3d8a7a9404db28930b24e27302c4ec81a18b649a192d7fb30001f8116424aea06aaadac1ab6b129b44e990d927feed7ddb5a2b1ab2603270290b69bf4d423a59c0dbaafcc5b168e8b9b8b8da6d1e2fecfcdc407389e1f0bed9a9c307909eca2fc00bf3aba1860adb19b7b4993d56c40446fe53f94aa5e3b5b6d44189bd66e4ad6e6ce0939f7f76a2a05a031e35a56ed31692b8480d6568786fca0ec7fea697818bff9ffa358e534a7b96a36b5b602c3a77aad9cb96d2cb83ff024802f5bbe76637f292863e186817a048627ece600f1c8cb7577135e9a9b412d95dad4bd8cbba29fb9e4f5c69015b53c22a21e8f57324a49f0749b1920bfc30883081f5434b0122b9400e380f45bdc0eacea33e8cb0ee8626ae5d8b788e35c1780861cee034bd96c79ae249cb6bac6baa2187ae33664aec94c62a8f715d5e077c4625eb5b6b7bfbc9b97be344c563201a90cb705421d34da94b3c9643c8ab3c1b0c0c5a552915f226ca642d165415dccbc6270944703e80fadbe6ebd2fd47056db70208558a434b9efe1bd61bdd38ff9ad58df2200d011eea576943ecb501d4f47583dd00c2006bb573180e4654f5848f9363e34c726ec62f086ae7dd1718b122994d997075f5226649cf18a4454464512c4c13b8a2bfc300aaf7f070bf3936b608ce04088d1f4335ec09105309137b219e6bbadf210e91881ac3edb3db5837892982d8eda985b2611a9e08bced3508944f9c96a0bd66ffa542348b94893a283ea02272a0372757e5c439017a6672e92384bbc66a76f344894a1ea65172cbc483d8819ba3d1fbb65e3756fb11a8d82be3b3bb79e3ede23768e025253237a667e822aea8a3c9e75855691c07878a050ee11910905a892818484cf5f4802a946eb6893ac231115de9e6a5b2caad5a71893e6cea826c7e6ecc4cd1ca42a9195dd97e242e977d86d22ef4d2dff54f8ada16566b59eea32f7094ad31cc9ceb2e68001cf629087bfcb9223552b5954a070faaa2d01c0a26d665f1426aa4966c5bfdcbfdf65bc378fa52f3e4a71cc787159038b65b0293802d18119427ea9357bc8457fbfabf58eb7beccd1481207be9b3e028923be3c955428ac9184e1d77e114b8954c1dba88008dc013dd47b73c36ea6ddaa20a0099a3c03cdee3a18ab7d9d6ca58360610712b43a594c58d71d33d8dfae2c7cf05c9956589636e6fc965f5c67f3040f0bdce215e3fe1db4e6ec25267525e4f9cbfafcde2cb0c468569023403301b9a34bff52f2e5632c3998043c1a68279a228360b133da5ec7cf2cc3b9d5680334eaec12d9c6867aaefecc2c670eeb1cafbb732ab88c7e84ac1bbc319f9f78db040ed674bc1d624ca0d32b385cbf4f6d1abc558064b2ad4221d83432795cdc3b5c6f8205de41a2e9978a452638336876b007cf3a1617293eb6c53fceda88621291ea6463f2202052ec64ef808f8a2ed0f137d726496b9644ff75de11174f53fd80922dfa8e9fdcd034b8cf74aecdad43fade27f9cfcdc7484cd3440930749c007e933e665086426026b595dd275c98bfff60eb50fe5504aa2126e12620ca798bc7d58afe2c841fe0c58237cbe73a8e92da4add773d122d0e941bcdc03ed616a9e16a86c55e6e4cb8a0cb16bd69a5abb6beeb11a3ea62bba0ea2834cfefedd5ef03772248263852b44190728b9dddb292a38b451987fe843302cb7ac557bea42e7f6f3d7ce25adf6a35caf60f78129cc25e86561958000ce9b42c6122d0364d379fa7bc8fdce9f489fb21ec2885fa6694dcefeca0bd402174617264767873d8d15da03b98ad9553d0df366baa81a8849fcb1658925026bac1982f7bf0ef1c0b193debf781a1e47a9f5234a8f083ee18759dee1a0c88df6fcb8685df50524e260df635d2bc8538c1f846c6f052cc27e896ccc4d9ba05b5027a3383be78ab8cb7f5e63e7d0634cd502d76a4fbe7009b44ae93b2147dbf67244970f979166fde23f4936603c68c6c7931412dccd311564a644e3c40054957172b702bc6a31ac52cd8f9fed71621a068b3eda5dbb7c76896a7178a1c758e782c943e548505fa9bc5844a5f1deb338abde8950512d80d3ef8b9e438c4ba3efc198cc9a030b05279fd94c05800dec8b4470ebb14b0f2b61916a1659d048b31f536fec3516d572aa65b2213a35b84916d829cd49a6d001d68341cf29203fc229eec19e85686f1f1715eb66d58cf213ade3822343dc94420fc9f37e03599b3a7db9326a524d4591d837de2c003078f65aa781cda32dfcad7831796b5d1a6a5c8269a257bdae4bf1168ae1683885f78a1d7ea545eaf102880435ad8eff51bbe999900ec5e9f99da5c55e2162a4ddbdf3e6b7b0fb003f4646957498fa3242fd9a69b03610b3215f97ff50bb34355ba1c0e9f99efa28153319ad7fef88c21002bb7c513b31a5f806351961f5305b6532b1f92bc40af155b95520facc7bdedb38cf6ca0d21257ccbd5100ae61566ebbaebc727b92af3eb4b897f5ea79f1b2417be3f2b5bfc6d5067e2891913e8e159ff538c31ce781b9681bffce60c060a7354e520c050b9480896c11436f16d28e8a187973885e578c974516bd9b0611f4e5ee3460fedc49a0bd782a1b023e192d83ef98a57186c7c28aa43412b3e78e5d5832689c08b7100adf3e1c951fed1bd11aa2a5e6bc101f935f304a5aa00a7e945e5189034ab67381dcbda5885a7885d4d6bb1a67aa12623af31c11e761c5237c4f9490267c17bde4d9ac6465c0c8a4fb8927a558790b645d5bf010851f74d4762bf769d92fac2c6ef57a83a557efda2e9d36aa2e53a26d2977bddbeb513ea4125c5ad2df0d788553f9ce86a0ea9c29b6f52ee382679ecba01f155f5dd25ab06b94576ebec43275a097b46c285ef21446e1a5688ed482f35c513cd351d9559fcafada4ca8a03e000ad233695ccac8db8acfdd1f917b7fd07d709bed57a0a8abc289be45e23a5d8417ebb1164b2b71fa9a5c67d376889cc63887d8c826f8b4e5ad998201f0f59b10fcc1de34a2c6589643261b37b52dbdb23948c330488cc3c809224ca249695a20e6c44cae417b57da95316fbf8e72fb560a2c4ce1988d22398a8a478604426a8b0191312901559ef6f286ba13d2e1de89cd0d95b9009cd2ff78f82a0eee2d2c9a7fa47a2c56c123de4dff8dce2f439134f76a0eb6f9065a09381543bf430cfc1a5c33e766aa766ecb02ddc024fd0576341799b174938ed50697636ad9353fe5de712f54fb7288583721b3da9980b51691a3febd4852b9a431ec4d030be038e4891e9fc5817323f6a3b797149dc060b52828faf06dc564783cbb97b7bf82c38df3d8b935c5ecdfcb41214ffadbeed482755f6f6063fdf6c9b8bb415a99b50b5f7ecffd0a6453751ac3fad73607910dc11fa24e182b53662453a5faa923da14ad6eb5563eaa0e3d04f21f601c92b24156e150d983c5fd4e715f2d9fcf893d7f66dd7abbc1eb41be93504aa58a2e806a8fce25f381b3a7ce80b89ed806f13cc8ec0f16fe22ad9920c555368df74afd774291d01ba6a2bd9b48d6900b78987f9652d0bc84a9981b150c127dc7232b9a6f60c6f4305351287bb58bd8c06693feedde7890fa4881f7eac36ac739dda5d48fe8648920b88950e32becced2bf89d0660ba1091b7f0b7a438e172992ce0ec17bf4bfc5ed2ae990a03e94434d460934db1993f3654c5e3fa1a62421b9db609a3fbf8fc1218456b612a875b1dc240c73f7de0cdab1605e87af15edc9481b1579ca7f0a41a7a92a5bd12d51c0e2d7d337b6de49dcd3ae632084c8c11dbff95967a52c231e88e01d905d27d83ddbcd12326bbbfbcb7e3cd8ee20a386c0d57d20572ce91a5afd072c3032258652bd8b383a3e54b9b5e28438ea513907527415e3d4b61f076a16b7defc68147d26e785328752da41291ef01166e4848afdcd7616173371b463a57b7e3ed010a73b5f3f1d4baf54de8227d9eedc8d6809966f02f2d02e704181671497c055401674eeb93a9ea205f24ba4f94ff2cde613b14b7c281c16fd608abb3a422f27a7ec00d3d31ce501393dd44bafb37fbe30b6c09460b5bb94366a91dea0ee4fb1e8081aae15ff8926bfbb034e1af43cde524b247d19558aaf9c8f4b595b0494488489ae78c46f8ea78d249a815915f3675916d23c8346b835fdf655aa41f1b991718d6df3a774192ba20d5172b282115ce7f319910268b867387d8088087fe40831e3ed3f76b8ba3a7b3f480f81ce92772d23330cd1c74ad875e090448ea21096a18c78afef9a4174dfd3b6ce85ca5098f9effc5c29da7a3478f0a44e316b6d38f06336825f298a387c1e9c6f7587058bc0d210b600f9a4b1c4641d142fde05d05057b7b8c7b02a5e9e614115eb22625351e1f321d40e1bf4f4bfb1a9d2e59c5a32ae902d948d75e49608c8d5c6d90ce2539b0f446f2dbf7ddbb751cd6126a2a8d82e51d4bf6a5e7ce616d11f8d7c384b6263dd1d0023a72bfea73008d280d10dd2116eef8e060846a3c2e7252cca85dffa5a424797d419d53ce776ad052b3196b906c749d40cf224b693b715c7bb716ec4c8b7d02c47ca4bcceb257aba4c03a03e6d58eed68276a486ae640a65d10aad785382152a6ab654849479c8f38388822514a3fc83f876e438157986d555f5b12b18114f22ba3c9ae45c8e33acd758b9f27cd2efdaee81351cbf0042baca762be5456edd231ee4ed15bc4611fb2327f6c43d88a063229b5d33b532d18b8bb9fde56e75aaa2d6ebd3b0cca9d396c24c62f91e6b1663d81613bcc7afd575436bb54d8a426e4b810ea5cb15cf4d1a3dc19af1ba49ff3c425d73e5a19682047cf116eb4c1533379cab66b0e82e6d53f90a23c13f5f25da23520274f6d57e8093b15fb76e9d64412ca5308a28b493418540135addae153d5e4cad69421e7d720f6e8c2bad378db796ffbb16deaa14832390f198cac6b1fb31eedad9869c931e6c5b046ef9ed044e3ff8cf6fcf7bb784da575435b3009ad869507c8ff6a9bd338a9662eee97f80835b1918e887ca76733bc829ffdf62e5d19f6b3fbcfa915d5e245c2eebb2fb82ad55d1b32278e27e6b8092b6e80269ff499785d078e9250ac5f797256b09c629369364c939fc709dee593a04d4e157d9440f8562537e8d1bfc2cb0f3c8d176cb71b17bc4e97ba917285a107e1d1b1e381d6bc7f962fe97de9c64a71edf9bb9342c723b7f4277562a925edd59ef4f294cfb289e24b5eedddf42f035ce674a428e47f2b2ae181bafa58b702c66f259118f7c299a8deda27ba5504649c9d07fa057c1220fada03ebe603a55c7784392b2bcf14bee9670a748234ef5e7e71f42733fe856571eff8c6047da4bfa79345c6c9df9b11cd160ebb8d337faeb3b4c4425ce61c541099077761ac517978e18fcff1cf153da0e49dec76a636db7330c9084834de03090e8c47c60098060519a55eb27faaecc478fe9a9889cf400b896f1ede8ff217d7e6a7320e0fa94b593c93479181452592f828ef2c59d44e68996ddd0253723268993ff1cd298789d8a885714666bdffdc514db446a94fe28bc010efd7003d55c2acc1ee749c69a2b89535612f098e14557c84ca9a10f1f88c4428a88edd3e1ea4fe04f461eb103525e96b1b418846820259a18cbf908a04c4506127155046bd32c2a0ba112a1ec4e0be6eac0c4623ac085ecb96c68e281213778645ca67c256c9d9e1442518f2cbddca7dc9717efc0301f4005fca145338ff670a5a672a3da038c9c6471009403c10639381a45a531b1abee7b148df03031100689ea6f0bba75fef54df14b4c73911ebb5db3e14cffb6e4e3e6f8e2f0a01814677498de47df97b6aa2e20b41e93a135f7faa9bd4031dd75cfc0cb1757d4a930020f91c30bb92026deac86af9d1fc79736782ecbcb22aa90876386d318e30d4b6ddc25bae41de99255d9645e06ad012674e1ed5002957f4de0e1b766757800d49f42994bb76179edba04d5e7f25d63788189382dd1ecd088904f045128245599c5962ca80948ebae2368df3a4835a1ccae5c2d3c72042734c501dd23887866807052307ccbf43d44c0b242638fe203b0595e712b30641f0da5bf8bc1e5e53b7143a8c67126549b0e5c23edd5e3829748dd852abe41a40340d49f50a554d7a05bf985805910d35c3f76b8b46cc27e05a8c7264006bf37fdeb307b02bdfd8fef56cc5dfa2f3ceac5c0c35838c2c646c32a827eb30c4cf6bd676207a2c82d50721e98e768f903a5462a6d892d2a2dc09b5e9b695ba67497ba1cc2611e949f4f8f6ec5b3a21ea2014d9473f88f9defe31aa2010906ce6ffca51851a123ffc46d5b159d63ca7ac762788ea2bccc7a3b249816f45c4d1fab2cbd0356ee1b90d910e91830d549a330e3ebfb3e4ebf6fa18b20b4f9d8b51ce995790142e36b24abbd20e5c6fb2cca94eeaaeb3ab19c203bb0193a66eb7cafa28d321c0d5a52852e48ac5118fbd929286d9c7f2d8b49b78b55cb0bcc1cda86a3d6ca9aa8802eb6204000e7e27c8b20a451b11ef74282ab6599da8e7b90cfd30595173780d203ec84e6d61b47b52222f33303c0ab88d5bc0bf1b0e333f2cf2e31f291cc90a76c74dfc3e3fee4c5febfcb1959e23d57f80796cac4e6dfbdb0e3c31fc5727afa0d7e4638552d69fe71d0322e1979b450d6d2a322724d11ae75a436dc4ceb32db48d2d92de50eafffab9bb85fa5202a8e882c2aa22e078becdc02d71a9ee76d5b04d329a610e17f9ea71c03aa39613fff430a71c45f57f0dcd922bcaaa082bcb249c444df2d5e40b6ccee5c33710f942a75300cf14c3c1dffdd7662a1c66e3d9d49b7d6cdaea00688d1e2526d0408b011d6323649aebfd98faee91d9a8434065a7cc970d84e97df11b0402066c623f5c26ebda6dbadbbb6cacf242fb4b04c8bb4d9f6c6c476f8774bd67aed2376c81f6f41de35bcd5243db15cb5c4ae6e352aa148128c82142c707947cf7d0011df24d78bd3d432296ab4dd9ea6932eefe25085b690c0d6bc148ed0315ed11a12055f3fdd4e94c5d606c34041ae6ed383f1e70bcb4b87a74b19ccb7a37790c7fd52ea1b84bc9b7a09d291936a8c80081755c9b946c8bf838439c13e979e63c607332d24dfcd14ab67efb2ce5e4a5c1e40c115662be627e5a4fcf314f5d9e78346292fa3a2583b386943d9bbaa6aad93457bdefe162b2747fc53baef2f4aea215362ad69b5d9af9013011b0512e51befb1b61249cda94e6cce038e47994fa2983eb27253239f19644f0dcc57bccfce53a22546bc7ddee2c8dc02f860720ee0b4af5a22eaa24d6152c6d47bd6676430541927047cc292bb1f7df92efd86229c5250c691cf659775c9e337cb20e77c5c985914d48734007bec1a7e248d35fce46c4e666ae816a6adcb1fb2ebb15481498eba915cabd51567b662e6db5f9fab99bc1402b76434f86ed2a3bcdb6646bc4646f7f08e5137224c57284d0fb35aff357cb20f5fbe9ab71f08cc919762c5c8c4dcd10be850ff7c490bdb564cad0c12731042db451816dd0ed60ca80375d31c0e6aebe9ac64d8bee433596ec81bbcb939a5bcd40d6bfbc83dbda086b4af250c3c2a3eb40fab9cf8608e195bef6eb3e1b257c4783a970f5b4e68ff849064f813c16e6d53117ec281f49d7957b80ad723dce2b8df1caa75a9c8f534a1c6eceee74934f77619f78b3e6f234d2f706e8521caba95472246e3508c337fda57002ba3a6b745adb6499e4d437350d940e2abaf697a498b41c9058f9bd60a46dc74e04af85ab0974bc088082682037d202c9cd884668d17cf3fde116a6b03c8c158a67c604c5737315ec71e8ed5ab2e5bbd949ec4f67a757238ec1e752019122f6e9e6a95c2b12d25acf268bd3ee700660bbca49f3226e6a23e589616c1d0e2396dbaaeaa2f2cf7414c3329ecd7fe80be574a9268dcb1eefb90d47fe970b07781d4a39f24f37945c0ca3966b12d4f7b969cf50b5800bc2e84455c00c7b502795b4a84714e67399c5ae77c8c21bd2f4927d8574a93076ab73b22a0d1e21f05264b2eaf4591a048a062e600f2d77206beff871b5ddb71ca771664be65b6fab9c21bcf2d27015112d5d2cb42f44ea13447ca11adf3eaecc09a77521d12ca84054532f8953fb4405c599471c3a8950b1c68dad89641ba1c324b2f2d53204f184662bf07f47f1611b6eb7ff374d350b1f6b0115a27444861b33b4632dc3168273cc8b2c181ba4c40c2089685030bee410c4846115e58ae8f4687e1b9538925f5cf8a8263ad5d4b0c0888167c6d38426d4c5a30c8ef4f4deefff24827544b83371a87bd40f5d76784894a00e76e33b35f7023ea66c8f0a66348da740da71e2ecafff03a9d40ab411de46084c6dbf5a4196fe238a2bc9a3e5ff581c222c65e786385c0e8dbc1fd75e28fa308a8bc0d6cc668e5a7f48ef5ea74b27705ab5275b5a9c8dab0678516d6477aa63e25902434a2eda4f9e02989cc6ed017766403a3dd3109874883b070d0f3b4f7e028990d694f81f7c92fa2e66784f79897c4f22170b6ac128bb1c21cf828b0a4296e81bb86489c449366ba721e7ae01f1658f81fe6fd575ecca28a1bbee7e415781b79e1ab2033e25ba57689c887b06023bbef6b73190122fa6b82186ca9f36b626c0dd6a6b9443b39c675ad6b3b6e217f711535e6a5538e0e46eaa79241ba07d3e2b8f7ec9345b8902f49fc15ec6de57377cc1853baf6b167ce50bb43ed0d88cc6b8b3d4f9d5ef04ec0fbcc3e9e9943c61d48755b3346dbb09dea4998f2675d5bdc1c7e70b66e8b5cc671dedc381e0856adf6faa9632a44df49f1b310645a4691c5649b5f9d27d23437579088d7b38f0e92ff848bde123a9af0b6d110f0fdd577a69211f9cf40871353fc3f3580fdf76e3e8e0770d72a7c199ce0d419548829f55c4ea7873223c44dd6eeedec446210f3679cf9bfb2a1de4995430577fefb5547442637a5467f5e168062b9dd55445b066324412fb346c64fbb26542ed88a483a1617679bb9bb5f767ee91cffd5160e5ef36be2101ae10a43c3562141b3a637e1a82bcbde1f469d28d0041b06f18413438451b2bb75e4dc82f66a04c5883f13b6baace489d609a8a12d82b816a5db555ed27c36e034a8c5a26446f40ed53b9da6c34429c6c9acbfd14484fc345eec65aa7210bb8555c1f3cceebddb0374f0d55d992e4cb80de4c2d54c9cfed28115ae43fd4f0728c97aba4d266790dd508f527896bc7d1c11d64731b388b9379f2a7b88bc33b2665ce7f7040f01a8e0ce5ae7e31093ef99e3f12b1d43f743d0600a76b5f648158151c7a8c2a55b84a9ff4b8786193391d9e013b3cf17279f025f86451e961dac6206d19a4f4b9d078fbe9120e9136033c0e8f957c82fb3e8a85c51830d64f829444f3e03cda64f007b8fe10b0558ae06272b8a7e6b50e33910c95ab5b77203e0905361837f075a14390ae7475211fdeac5b0b7eff3bdc22c04eb8d00f132f4a1aad70e37b362420e429baa00df877037b770bb2912c2c427fb45b900bfe6f07a9a59f86789ef717832615c7eb3888b869f0832f0632f92a2a42a39348efe0a5660f7445531edb855a7df4dd9574128777dd68529d4806076dba8ed79c5cb2e19c697aa40a5286a00fba0ccd34fe5f7f70abe2237b3aa0e1a8e297481d10ce092ede535d12e3197b0ead98e0fa9995c8fba106980c811a3c76b5418db243ee6b8acdc4d585e72167da6a3d2aa20b614125bdec395c0329478c164d7e862fe09e3e3ac457ddd08e980d3fdd60ee1157c720d0c098dca7974099ee85045f2c8465ed6c85b60df4ef25480a9577e4a4cc7d19166ea9644283c1654e4a54911526abe1d984e87c5b44900e992200c9169809a09296bbdf60f5ce938551560fce0cf6ee9795912a462bcf118c71ed7f798e840b9005e9cc546ad0c39a3a3f42959f8ce2a1e2a556f4af521d245e8fe0434b132af465529f7eba472f7f64401c36a4e5d5de8f9dc2d748498304384e309fe5714b3330a3341303ec3e2a21d5849492856d92dee145d8b37e9cfe56c03afecf5718212944ca7cede53d5579c10a478bca973ee51c163fd38a9a702292237ac23a672c160ac8b870de17070982df11ef3df3ae52a94aa08fa6880e7e6a6d3019a3d1fbbdc2660e82d62098a05eed9169c1b9ce6232ebd43e8a978c8620fce70abe0115261d1cfd2daba665e0d4d92cf3bf3760eebdb4c22e0466dd477e0d395ae9458ec1cc353f0936b0467d7af22bc5876a76fd541b8ae1e7c23f1d6785251b6b5e91b8741838ae894490ded73bcc31385bed76fee0b23decaa96d181ff2e7f8c1b2bed02f2435bd887cfa149daae50003e34523f6a6bebb619999ec76ad5a6a306fe3110bbb4be7da976314e35060a268bb351df7ebe9f832fca94ab6d0544b4510e159a714b58c7ddac7c8888ba078296a5d726074e8c8f440da94c7664b2cbdf563c1a57f4262ca9bf920986c32bfca83e3325e28d1a5edb34aa408e19bb6b00a9f35e5cdf32bcbad93f2fc454f2016353b4f3c0b38090ad8d30d81353e4163903883441ddaaa8ba0bbe6ff95cf3482ea130077d890eb28a77ffef8ee97bd9404acbf66099e5c7f20a682d12e8c8047e0d3a45a74908dc5197db8114cbb1e9375c8c676269cb83898f68d6710312448efab671db45033ac450e37e5f053702495b74917073cd215e2006b109950dc31f8e821634004510fd80c8bdd722bbae565ae43c658213b9a1993a4403f3d202ced0898e65b88204eca9035a486317d36e04893d3b6b3895c2be09b10671024193cca9fbe2cc62885358933ee8fbb5aef1e082c6dab22653d5eb444a5e627ca93f5f5d52b0f8f5953f8a69bea1c9bb4e9169c58a15ead83c5c4d8399e8e043a084de9e74ed7af90d68abe462d0047ea26d3abaaa9318cc08bef854b959594c12e607d6ad8d0194d8b5e1819a91c6ff857cc76581edd6e89029476bd0bdab50c2c8c08b3b1cca06db333aac6fa2c8239bef4d8012e8ed403a25a468e5b73718435c005a82362ee2b9f9319de782280637c8d8b80c0b5fbb80296f439c5a2933f40534f062d65407e6e7ede27ec51d36670856b163ee2d047a4b4e20787d1d49b1922b022cfe3680a3977efad7bf04d4e5b64a2c5cd35c49e74ae8dd78c505cf5f790786c1a17279e750010885ac661cadd13f00a5494801abd410e5b700c82882d200637642bac79a2ff6dfac48a68cff3961c44ee36c8bffca499a4cbf161f9fe1f11aa8155c2b45cb0447ab9384adf7644e85ea6034cb8ca5245b51def2d1c8acc80884dc299d3da75ffcb8f2e372484b833241fb1e588a701963ad4cb5229566bad6d3640f74841f20cb153104033a3e0c3fbbff849285591fc948418ad1095ebe5cd68d3f81219eb124062a07e2a7dd692ce2270e23af52e63e85619a89dd0246095d9858e1cfe39b73687885452ef96c1d7d74b4eadc68c5d054bc4ff8ff75fb4000917fb5d157c7070df0973b7ef461162f7b85677ed5efa6d35bcc1541c876b36e5faa1d9e59dfa286f86892f763e5693cb2862347bcd5d7325495e5721b9882624211b7e56aedc7449a0c57294d8f0a0c90ecf56e00b63174617a6038efcdef3664a659e9cefb7025667e6e58971af2abfe6edf06fd81ec57905a04dc443cdba2cb88854dff0fe8eb938333e9de7c1f8ad9dfb5ebf7cf1bb17ad60975ae7a1323f7d6cc989c63cb45c662f76ca2889129e45efe3855eb1065aae30095dbf56f0ae4f26e4f4c2f21df0959a9ebfafbbd80e9cf7b87fb7a8820c2024b0bebaaca2e97c083b565601a34e035f40a599cf97cc1781c948ab1a84a9b455aa0b3611ae4579e288c3e0428f4256d34b11674e71716842f7977c1e635538c85440a16950cf6631d0a0e165ed6d781b905183cfc106fc609ef43e6abeccd4ba82ff7fffabdca94b38f6b586fe76c6958f8af7c5587facc67e6ec150aaf904981ca78d456df633bc6a9096cbe1cd34c115fd41b29813a5b38e54c4f2c7dc0f011a899e7d1ca8b827b15b67029a9a526f4de868e0d9e19be0cadd1964aca2b39439ee649dea1097483609d630a6d6489dc2517ec450fcde6d2406090ab6f482ff85ab6e81d3962dcc5b70e24ea38feea9285c0ab2029a6fff088057cf9ebdce706134466c3183750f5fc798da32846ad1c747442ed29f5f7d4cc532269e2836cf4669bd2e358fb03296396d9eb74f2b9f96a34e743b1b4905f9370d59b5f86fa044f8bed0b8ffce31003c2d80cecd2306fccd5d6753558cc5e91e534f7f8b030be5d4e9c6887b5998d480f6720f9ddda7de7de40ee6da44112ee7d85bbccf01811184d0727774e363c853d08a75b56ae3ea7294428c7e00f3cdd8372833ee24f60f448cd267b0ff8283a3a07289c05629d63ab0c86a8a9e53ed8d0832ec13b06f2d4477dddbf07678e97c2df976f615c1de471fdec27916abddabff4510ff71a29bdfba86100d36fa7020748efee0ae1d57eac30c3f26abc409880d3ba9080c7362d230b059fd6d5aa094a253bc7eed953885b14458c9d512b62585684c6ae4e68e0d1ae767db87e0977bf63cd02c831e46a7d24043e0f303767f6b45d730dd3945564651efc102edb448dfe8fe7dcd547b3cfbc925ba4ff6a908f98d9ba7919e89acdefde6badadb710ec27e84c7b5fa299bfdabfeaeb74f5e54361c3ac6127089c87b198515184751288c56b6a648b4c1d7325376377333186f36e0c355c3b58fce6b6fb7dc6dda790ee335d4178d566c50f80520d0dc0327873705ec8c425357804f16dfc16c8bc820eadb5513b7394f1edd3fb010b75377d1b7b6322e2167d0b0ece9a8563f5f51102f1cbe508610db31c38a98cbf61aabdee5d88416549d4d5c8c77d8e6200183856deda1ced75bbdc83f8d4fb25713a59eee04f795cc8dff1d9fe706feb563e4db144430aec5d2bec7c9cd757174d953482a569c2a4e5bfb993ea7396ddf7e9698f8d7be71a2c61edb6e7a3612772913599ee0d35ee6f8d95e7d56bd222049f9586ec0645bff3eadb99ffbfc331f308c850aaed232d0ce94057eb19d04f46da81df30c2bf76c8f281203a005955a4301be6301328349873b38fd7b8ce185d235989c717cd05d9b43b75a62f134a28018b55474dfa8ab82bf234e16070f621c519fda8297e56cc3d391c1a33bc7f42f21d195862ff83babb4ede3d217d5f22a441e9a16946ecb25829a7225576c8ad860a2db19f7b15e94227631c7b8c94b47d9334bcb25f7a4e8acd1f81ea0f9136488b39679c4f5cc412723e540a56d8dd597cb8d42d2e343cbebf3ca70362ecf8ca89f5514ec650efb944909784a93e1e6712fef4e5261d6b74c9ccdfbee5e7f4285ddac14b3817977b0b55e0e8aeda853fe0527364172baf04368a35c08d1b9c8fedefb4959ed4fc222745968eb69747a4eaad15035162b8aa0b96deba181705d2dff23682ed63d2a1a17f35d7c1685a16f514e2c9ec11cab0a981a92e563a3b8b2685e2f53d0ffb222229f3b809469bb7fe54dc586a20b9f918bd503374872b895d3810c83633ced79446883e13d3ecf4a9e2fbdb4573225cbbc05df5eb0788cc722c88710243745d4642657d43faff3cf2184f13a945d231e631215867e1c346fabe0bddcd194f5fd77c381bc5cfabdae78b604b0186ae6971beba8a3b2323db343d48536a155311d93cc9dc73d8d8f2e061ad57f16e6b6680c6bb53dd0cd991136315f54a8ab182dab1602fe4b58da7bdc7b9422732bbf9a2536874d227617e1daca5f5035467b91ea93cdc87f778c95b3212a55a7c5ec09b6bfed98c617464c4c00db7853121d0000cd4d1f0d48ea232c39d2c74ef7bcc7f1a9af1cd7355acca96fff9cd2d083421b4a1c1f4fe2e6b22ed7c8246152133da8a48b67971ff683dee22090fc0867da51f891130424b48f4676fa39b3a010f2319df1e224be9ca76f3107fd85a8eac14ea831a89817a3ec540dab66ec4f36a624863ba2c75b9b3bac665d15c62c25bacb80193816b1774c9ed926d3aab2a658b4998a8764c92eaeabc5cf7d155a8821521173c97e0a1e9c01cff567d4d3cd88a6f9daa6e2f38abfbabc91e7bda46cae4b599132ff6ac86b71aa4b5f9ac066c8b38f175a35d01ef3d5631c1e6a1ff2566bc12d2bf736ebf41a07c5edbfbc4453a4902268d40205b6b18feabf416a8c231614a2b1a2d4373b7b86c41267a2472e8d46207962d8a0aea8ceef9be78ce086af0aec4c8c6cd0bb9cd1b8ed884eec88073f4fbceb0a8ddf0589d7bbe28469a99e2156f5f3257c897620ba58b1c787fee514667cfe344507e2153ab85ef33e30d45428555d91faaf9184f62dbfbfd273d291428b9e838541152b5399f45bb56fcc30dc140d9ef113d1457f6c41926857773badd7aa2501ee6c76fef15e5320a91653dbfb0ef1c2c3980a688a62d6a15644e18543cb16bb5e5df355ea8fb160a9812741fc58bb916834cd7880a1e5eb0bd0a59f3103663c055a71346b21d29118b698af0d0b60fbd437ca70a0ad649c592ee51177acf551ad65700070a35ec0b1ca7e0ac69f2451280c3c6cb114409dbc9b733a2cec684640448d3b40acbc5631981e334a0ce376e5d52cbacee00289196204217bdc195d756b8ff6fbec6e21cef56efc38199542e41f11138bb117af689408bc59a9102f229733d243a95241cbe8b9eb4872aad52f93e216faa491e2e987cec0d781857c2359baeda030e37b546a6e09e74a8681882dcac5cf4ae2ee50aa467d12a7bf80e7a0f87e20309f241834c3c06a9f05806bea1f0ad32a2da0ddf53814dcbe858ffa5220acdb65a4e346bbbe59a6fe07651e968ace420c81cbc553bdf9dc4644f39c7ae4cf56eec825c603f7b5f88c30bcbea80e86a3ba6ab0a04605bc4442abcb12870a192b482b0e3dd4336552d13a5cd16fe47b276cf241862a40e26fb27e666f84d9794c99d4ed9a5799bb051790a7527b7fe76cf0f279ab0a1cb08d06114732f0fd8d8bd9b213f5bef165dcdb1e2e83b794e4fde76a1f59ba31c891f2ee1dca98ad98442e88a1ee7376398a78c1c084768d39ea479df1a4cdb591e2bd2043fe4b34831ff48970f83669a3743fb211e6272dcb9dfa719ea0d9d2a726e60ff5493e495f245d3adb7f9e4cc68b3bf3d529ee8af84c9c88bdb22cc31211d54c0e2bdf6c4498038653e349d6c74fc622081a45f8d75532e5e0998496c910188b35b781bf5a6bb1b1d55b33231608ca30afd07483c001c9608a949e7ad293298d17c60a01010c932768972c69080db54e2d1fff8f28617eb5293f5f536ed4a11171df92621fccfdde2718e23b1409db2e39f8a6516f1c6ec9ed40d1c497561b522cc130e16254aee10cb515c7fdf3453169702c0ee73f5d807a479deeebd45af365812a0d42b956ea6f2f594dc09f8bbfed6a2485b3c2e9a04e536c73343605cfcc15f80cbec08ebf76bb8699bc9ef2dc950a9f415874c8db04dfc1f5baa9f7a5daed843a95da7933458b1456674939c5f1fa6008563a74bd8778131d28ddc12868c145a521cceaae13f405bb673c0786505e74bcef882899e0f13824608ee2ccb8be165707e48fca47963b90137c9d3cc260a764c07e511753f121d15c3c1707d538661b429569283a6e99e1009587b095b45947ff28cd04398c4675e11f93109fc932c6203dc7a5ef45540a364383a2bd83fb2dc065130a355fe63d8366f4acf6acd9e236d664f4711635f71b24fa52b3b4adbd8fbae13aacd298dd2929416cd99a8e0adac06c7dee83998f8825daeb613746b2ff829d259e8bb267b31952b3c3b2c95daee9b6a78f2e425ea58755825c94a4e787eea9896a85fd3794c2147fb83194a1508c6b08edb1225b08f2f64c08d24a6a0a8045ac777f06d57db9eccc3b83ca5068af915551945022ee91b993efac8dad60778ff5d181baa93ccb3d1218e175788425a2a6b80df01a3972c829e2d4c542d5a43628a9832d7ee433121ff02930c2188023d5b9f63d9218f63b36918218752fcb61a0c7cc5cce7030a677b8d71d82b5a907e5b637b3837fc6c86fb769d1276ecca155a0d8c17216c2d92c206cb055daa51a9427828c6ad0883b7c9edeb48908481abe6b116edfd5f94ad2f72ad6f4221a4ebe56e43a88b41bccc896aeffe49bdd17355389d5ad270f5432ed9c26a6d13759c15af7115b1cf0017ee83ba1c25a31f0725954ce9a39fecdc454b976dc184efc78cfabeac8e50f0d18d0eb8ffd111734ff93f20b1e1fba39765073d6972664872ade694d8765d13ad165e857702aa7eed87273ec2626deb9efdbcf204d      </script>      <div class="hbe hbe-content">        <div class="hbe hbe-input hbe-input-default">          <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">          <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">            <span class="hbe hbe-input-label-content hbe-input-label-content-default" data-content="联系站长以查看密码">联系站长以查看密码</span>          </label>        </div>        <button class="hbe hbe-confirm"></button>      </div>    </div>    ]]></content>
    
    
    <summary type="html">联系站长以查看密码</summary>
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-12-07-杂谈-复杂异构系统监控与可视化项目设计</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/51477.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/51477.html</id>
    <published>2025-12-07T13:09:33.000Z</published>
    <updated>2025-12-15T03:40:34.795Z</updated>
    
    <content type="html"><![CDATA[<h2 id="复杂异构系统监控与可视化项目设计"><a href="#复杂异构系统监控与可视化项目设计" class="headerlink" title="复杂异构系统监控与可视化项目设计"></a><strong>复杂异构系统监控与可视化</strong>项目设计</h2><h3 id="问题背景："><a href="#问题背景：" class="headerlink" title="问题背景："></a>问题背景：</h3><p>现在需要设计一个系统，使用py的fastapi作为后端</p><p>目前有一个使用 Docker Compose 编排的复杂容器化环境，基于 SeedEmu（SEED Internet Emulator）框架构建。该框架专用于模拟大规模互联网基础设施，常用于网络安全研究、教育和实验，特别是区块链网络的安全性测试。<br>此 docker-compose.yml 定义了一个模拟的互联网环境，其中部署了一个完整的 Ethereum Proof-of-Stake (PoS) 区块链网络，分布在多个自治系统（Autonomous Systems, AS）中，并通过互联网交换点（Internet Exchange Points, IXP）和路由器实现互联。该环境的主要目的是：</p><p>模拟真实互联网拓扑下的区块链网络行为。<br>支持研究区块链在复杂网络环境下的安全性、性能、攻击与防御（如 Eclipse 攻击、分区攻击、路由攻击等）。<br>提供可视化监控、数据采集和分析工具。</p><p>主要组件与功能有：</p><p>数据库与辅助服务：<br>postgresql: 用于存储区块链监控数据（数据库名为 ethereum_monitor）。<br>redis: 作为缓存或消息队列，可能用于节点间协调或数据临时存储。<br>neo4j: 图数据库，用于存储和分析网络拓扑、区块链节点关系等复杂关系数据。</p><p>Ethereum 区块链网络：<br>在 AS 101–112（共12个自治系统）中部署了大量 Ethereum PoS 节点。<br>每个 AS 内部包含 3 个本地网络（inet0、inet1、inet2），每个网络内有 3 个 Ethereum 节点（共9个节点/AS）。<br>总计约 108 个 Ethereum validator/miner 节点（节点ID从2到108），加上一个 BootNode 和 BeaconSetup 节点。<br>所有节点运行在自定义的链上（chain_id: 1337, chain_name: posCurrentEnhancedNet）。<br>部分节点（如 AS101 的 host0）暴露了 JSON-RPC (8545)、WebSocket (8546) 和 Web 界面 (8000) 端口，便于外部交互。</p><p>网络路由基础设施（基于 SeedEmu）：<br>AS 2：作为一个骨干/中转 AS，包含四个边界路由器（r51–r54），通过点对点链路（net_2_net_51_52 等）连接。<br>IXP（互联网交换点）：ix51–ix54 四个全球 IXP，每个有 Route Server（路由服务器），用于多边对等互联。<br>AS 21–24：作为 IXP 的参与者（peering AS），每个连接一个 IXP。<br>AS 101–112：每个 AS 有一个边界路由器连接到对应的 IXP（例如 AS101 连接 ix51），实现与外部互联网的连通。<br>所有路由器运行真实路由协议（如 BGP），支持模拟路由攻击、劫持等。</p><p>可视化与监控工具：<br>seedemu-internet-client：运行 SeedEmu 的互联网拓扑可视化界面，映射端口 8080，提供整个网络拓扑的图形化视图。<br>seedemu-ether-client：运行 Ethereum 网络专用可视化界面，映射端口 5000，用于查看区块链节点状态、同步情况、交易等。<br>eth_node_cleaner：自定义服务，暴露端口 8888，可能用于中央数据收集、节点状态清理或监控指标聚合，连接 PostgreSQL、Redis 和 Neo4j。</p><p>其他特性：<br>大量自定义网络（local 和 global 类型），精确分配 IP 地址段。<br>节点标签丰富（org.seedsecuritylabs.seedemu.meta.*），便于 SeedEmu 工具识别和渲染。<br>部分服务使用 privileged 模式和 cap_add: ALL，以支持模拟路由所需的网络权限。</p><p>现在需要实现一系列功能，提供基于FastAPI框架的RESTful API路由模块（topology_router），专用于提供区块链仿真环境（特别是结合SeedEmu和Ethereum PoS网络）的完整拓扑数据访问接口如下：</p><p>GET /overview<br>获取整个仿真环境的拓扑概览信息（如节点总数、层级结构等）。<br>GET /statistics<br>获取拓扑统计数据（如节点、链路数量等汇总指标）。<br>GET /health<br>检查拓扑服务的健康状态，返回组件运行状况。</p><p>GET /ethereum<br>获取完整的以太坊网络拓扑数据（节点与P2P连接）。<br>GET /ethereum/nodes<br>获取所有以太坊节点列表，支持按层级过滤（execution或consensus）。<br>GET /ethereum/nodes/{node_id}<br>获取指定以太坊节点（执行层或共识层）的详细信息。<br>GET /ethereum/validators/{validator_id}<br>根据验证者公钥获取单个验证者节点的详细状态和信息。</p><p>GET /physical<br>获取纯物理拓扑结构（不包含容器运行时监控数据）。<br>GET /physical/devices<br>获取物理设备列表（路由器、主机等），支持按设备类型过滤。<br>GET /physical/links<br>获取物理链路（网络连接）列表，支持按连接类型过滤。<br>GET /physical/networks<br>获取所有物理网络的配置信息（网络ID、名称、子网、网关等）。</p><p>GET /contract<br>获取智能合约相关的拓扑视图（合约部署、调用关系等）。<br>GET /contract/statistics<br>获取合约层面的统计信息（如合约数量、调用频率等）。</p><p>GET /transaction<br>获取交易拓扑数据，支持通过时间范围（start_time和end_time）过滤。<br>GET /transaction/statistics<br>获取交易层面的统计信息。<br>GET /transaction/address/{address}/analysis<br>分析特定以太坊地址的资金/交易流向（流入流出关系图）。</p><p>GET /layer/{layer}<br>根据指定拓扑层（枚举值，如ethereum、physical等）获取对应层级的完整拓扑数据。<br>POST /combined<br>支持组合多个拓扑层（如以太坊层+物理层）生成统一的拓扑视图，可指定渲染格式。</p><p>POST /render<br>接收任意拓扑数据和渲染请求（格式如cytoscape、graphviz等），返回经过布局算法处理的可直接用于前端可视化的数据。</p><p>GET /nodes/{node_id}<br>获取任意节点（跨层级）的详细信息，支持指定层级。<br>GET /analysis/{layer}<br>对指定层级进行网络分析（如连通性、中心性、社区检测等指标）。</p><p>POST /cache/clear<br>清空服务内部所有缓存（用于强制刷新数据）。<br>GET /debug/info<br>获取详细的调试信息，包括服务组件状态、各处理器缓存大小、支持的层级与渲染格式等，便于开发与运维排查。</p><hr><h2 id="针对该环境和需求的系统设计方案"><a href="#针对该环境和需求的系统设计方案" class="headerlink" title="针对该环境和需求的系统设计方案"></a>针对该环境和需求的<strong>系统设计方案</strong></h2><p>需要设计一个 FastAPI 后端，它充当一个“中间层（Middleware）”或“聚合层（Aggregator）”，将底层分散的基础设施（Docker）、网络拓扑（SeedEmu/Neo4j）和应用状态（Ethereum/PostgreSQL）整合成统一的 API 暴露给前端</p><h3 id="1-系统架构概览"><a href="#1-系统架构概览" class="headerlink" title="1. 系统架构概览"></a>1. 系统架构概览</h3><p>由于涉及 140+ 容器和多种数据源，系统的核心挑战在于<strong>数据聚合</strong>和<strong>性能优化</strong>。建议采用分层架构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    User[前端/可视化大屏] &lt;--&gt; API[FastAPI 网关]<br>    <br>    subgraph "FastAPI 后端应用"<br>        API --&gt; Cache[Redis 缓存层]<br>        API --&gt; Service[业务逻辑层 TopologyService]<br>        <br>        Service --&gt; Adapter1[Docker Adapter]<br>        Service --&gt; Adapter2[Neo4j Adapter]<br>        Service --&gt; Adapter3[Ethereum Adapter Web3.py]<br>        Service --&gt; Adapter4[DB Adapter SQLAlchemy]<br>    end<br>    <br>    subgraph "基础设施 Docker Compose"<br>        Adapter1 --&gt; DockerDaemon[Docker Socket]<br>        Adapter2 --&gt; Neo4j[Neo4j 图数据库]<br>        Adapter3 --&gt; EthNodes[JSON-RPC AS101 Host0]<br>        Adapter4 --&gt; PG[PostgreSQL ethereum_monitor]<br>    end<br></code></pre></td></tr></table></figure><hr><h3 id="2-核心模块设计"><a href="#2-核心模块设计" class="headerlink" title="2. 核心模块设计"></a>2. 核心模块设计</h3><p>我们需要将代码组织为清晰的模块，以应对你列出的 9 大类接口。</p><h4 id="2-1-数据模型层-Models-Schemas"><a href="#2-1-数据模型层-Models-Schemas" class="headerlink" title="2.1 数据模型层 (Models/Schemas)"></a>2.1 数据模型层 (Models/Schemas)</h4><p>使用 Pydantic 定义统一的拓扑数据结构，这是所有接口返回的基础。</p><p>网络拓扑系统采用了分层架构设计，主要包括以下几个层级：</p><ol><li><strong>API层</strong> - topology_api.py 提供RESTful接口</li><li><strong>服务层</strong> - topology_service.py 协调各种拓扑功能</li><li><strong>数据层</strong> - real_topology_service.py 处理真实数据获取</li><li><strong>专门处理器层</strong> - 处理合约、交易等特定类型的拓扑</li><li><p><strong>管理与渲染层</strong> - 负责生命周期管理和数据渲染</p></li><li><p>用户通过API请求拓扑数据（如 /topology/ethereum）</p></li><li>API调用 TopologyService 的 get_ethereum_topology() 方法</li><li>TopologyService 委托给 _real_data_service（即 RealTopologyService）</li><li>RealTopologyService 从Neo4j数据库获取真实的以太坊P2P网络拓扑数据</li><li>数据经过处理和格式化后返回给用户</li></ol><p>对于以太坊拓扑：</p><ol><li>从Neo4j数据库查询执行层和共识层节点及其连接关系</li><li>查询验证者节点并与共识节点关联</li><li>将原始数据转换为前端友好的拓扑格式</li><li>通过Docker客户端获取容器信息，建立IP地址与容器名称的映射</li></ol><p>对于物理拓扑：</p><ol><li>通过Docker客户端获取所有容器的详细信息</li><li>根据容器名称识别设备类型（路由器、主机等）</li><li>根据容器连接的网络建立设备间连接关系</li><li>使用共享网络原则确定设备连接</li></ol><p>在 topology_interfaces.py 中定义了核心抽象类：</p><ol><li><p><strong>TopologyNode</strong> - 拓扑节点基类</p><ul><li>id: 节点唯一标识</li><li>name: 节点名称</li><li>node_type: 节点类型（执行层、共识层、验证者等）</li><li>ip_address: IP地址</li><li>layer: 所属层级</li><li>status: 状态</li><li>metadata: 元数据</li></ul></li><li><p><strong>TopologyLink</strong> - 拓扑连接基类</p><ul><li>source: 源节点ID</li><li>target: 目标节点ID</li><li>link_type: 连接类型</li><li>layer: 所属层级</li><li>direction: 连接方向</li><li>metadata: 元数据</li></ul></li></ol><p>不同类型的拓扑节点</p><ol><li><p><strong>以太坊节点</strong>：</p><ul><li>执行层节点（execution）</li><li>共识层节点（consensus）</li><li>验证者节点（validator）</li></ul></li><li><p><strong>物理节点</strong>：</p><ul><li>路由器（border_router）</li><li>主机（ethernet_host）</li><li>交换机（ixp_core）</li></ul></li></ol><p>拓扑数据最终以以下格式组织：</p><ul><li><strong>nodes</strong>: 节点列表，每个节点包含id、name、type、ip_address、status等属性</li><li><strong>links</strong>: 连接列表，每个连接包含source、target、type等属性</li><li><strong>元数据</strong>: 时间戳、数据源、统计信息等</li></ul><p>这是与底层交互的关键。</p><ol><li><p><strong>InfrastructureAdapter (Docker &amp; SeedEmu):</strong></p><ul><li><p><strong>作用:</strong> 获取物理拓扑。</p></li><li><p><strong>实现:</strong> 使用 docker Python 库读取容器列表。解析 com.docker.compose.service 和 org.seedsecuritylabs.seedemu.meta.* 标签来识别节点角色（AS、路由器、主机）。</p></li><li><p><strong>对应接口:</strong> /physical/*</p></li></ul></li><li><p><strong>GraphDBAdapter (Neo4j):</strong></p><ul><li><p><strong>作用:</strong> 获取网络静态拓扑和关联关系。</p></li><li><p><strong>实现:</strong> 使用 neo4j Python 驱动。SeedEmu 通常会将生成的拓扑导入 Neo4j。查询 Cypher 语句来获取节点间的连接。</p></li><li><p><strong>对应接口:</strong> /overview, /analysis/{layer}</p></li></ul></li><li><p><strong>BlockchainAdapter (Web3.py &amp; Postgres):</strong></p><ul><li><p><strong>作用:</strong> 获取链上实时状态。</p></li><li><p><strong>实现:</strong></p><ul><li><p>实时数据: 使用 web3.py (AsyncHTTPProvider) 连接开放 RPC 端口的节点（如 AS101 的 8545）。获取 Block Height, Peer Count。</p></li><li><p>历史/统计: 连接 PostgreSQL (ethereum_monitor)，查询交易历史、合约调用统计。</p></li></ul></li><li><p><strong>对应接口:</strong> /ethereum/<em>, /contract/</em>, /transaction/*</p></li></ul></li></ol><h4 id="2-3-业务服务层-Services"><a href="#2-3-业务服务层-Services" class="headerlink" title="2.3 业务服务层 (Services)"></a>2.3 业务服务层 (Services)</h4><p>这是实现 RealTopologyService 的地方，负责组装数据。</p><ul><li><p><strong>TopologyService:</strong></p><ul><li><p><strong>Layer Filtering:</strong> 能够根据请求的 layer (physical, ethereum) 调用不同的 Adapter。</p></li><li><p><strong>Merging:</strong> 实现 /combined 接口，将 Docker 的运行状态（Up/Down）注入到 Neo4j 查出的静态拓扑中，并将 Ethereum 节点的逻辑 ID（Validator ID）映射到物理容器 IP。</p></li><li><p><strong>Caching:</strong> <strong>非常重要</strong>。遍历 140 个容器和查询区块链是耗时的。</p><ul><li><p>使用 Redis 缓存完整的拓扑 JSON。</p></li><li><p>设置后台定时任务（FastAPI lifespan 或 APScheduler）每 5-10 秒刷新一次缓存。</p></li></ul></li></ul></li><li><p><strong>AnalysisService:</strong></p><ul><li><p><strong>NetworkX 集成:</strong> 将拓扑数据加载到 Python 的 networkx 库中。</p></li><li><p><strong>算法:</strong> 计算中心性（Centrality）、最短路径（用于分析攻击传播）、社区发现。</p></li><li><p><strong>对应接口:</strong> /analysis/*</p></li></ul></li></ul><hr><h3 id="3-具体接口实现策略"><a href="#3-具体接口实现策略" class="headerlink" title="3. 具体接口实现策略"></a>3. 具体接口实现策略</h3><p>针对你提供的文档，以下是具体实现建议：</p><h4 id="A-物理层-Physical-Layer"><a href="#A-物理层-Physical-Layer" class="headerlink" title="A. 物理层 (Physical Layer)"></a>A. 物理层 (Physical Layer)</h4><ul><li><p><strong>挑战:</strong> 如何知道哪个容器连接哪个？</p></li><li><p><strong>方案:</strong> SeedEmu 通常会在生成容器时将连接信息写入 Neo4j 或生成的 metadata 文件。优先从 <strong>Neo4j</strong> 读取链路关系，从 <strong>Docker API</strong> 读取节点存活状态（Status: Running/Exited）。</p></li></ul><h4 id="B-以太坊层-Ethereum-Layer"><a href="#B-以太坊层-Ethereum-Layer" class="headerlink" title="B. 以太坊层 (Ethereum Layer)"></a>B. 以太坊层 (Ethereum Layer)</h4><ul><li><p><strong>挑战:</strong> 108 个节点，如何获取所有节点状态？</p></li><li><p><strong>方案:</strong></p><ol><li><p><strong>信标链数据 (Consensus):</strong> 连接 Beacon Node API (如果环境中有) 获取验证者状态 (Active/Slashed)。</p></li><li><p><strong>P2P 拓扑:</strong> 使用 admin_peers RPC 方法（需要节点开启该 API）查询节点的连接对象。由于无法轮询所有 108 个节点，可以只轮询几个关键 Bootnode 和 AS 网关节点，构建局部图。</p></li><li><p><strong>Postgres 补充:</strong> 从数据库中读取已知的节点列表和 Validator ID 映射。</p></li></ol></li></ul><h4 id="C-交易与合约-Transaction-amp-Contract"><a href="#C-交易与合约-Transaction-amp-Contract" class="headerlink" title="C. 交易与合约 (Transaction & Contract)"></a>C. 交易与合约 (Transaction &amp; Contract)</h4><ul><li><p><strong>挑战:</strong> 实时分析交易流向。</p></li><li><p><strong>方案:</strong></p><ul><li><p>不要直接扫描链。</p></li><li><p>利用环境中的 postgresql (ethereum_monitor)。SeedEmu 的监控器应该已经将区块和交易写入库中。</p></li><li><p>接口 /transaction/address/{address}/analysis 直接执行 SQL 聚合查询（Group by to/from），返回资金流向图。</p></li></ul></li></ul><h4 id="D-可视化渲染-Rendering"><a href="#D-可视化渲染-Rendering" class="headerlink" title="D. 可视化渲染 (Rendering)"></a>D. 可视化渲染 (Rendering)</h4><ul><li><p><strong>接口:</strong> POST /render</p></li><li><p><strong>逻辑:</strong> 前端可能只需传递原始数据，后端使用 networkx 计算布局（如 ForceAtlas2 或层级布局），计算出每个节点的 (x, y) 坐标，返回给前端直接绘制。这能减轻前端浏览器处理 140+ 节点布局的压力。</p></li></ul><hr><h3 id="4-代码结构示例"><a href="#4-代码结构示例" class="headerlink" title="4. 代码结构示例"></a>4. 代码结构示例</h3><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/routers/topology.py</span><br><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Depends, HTTPException<br><span class="hljs-keyword">from</span> app.services.topology_service <span class="hljs-keyword">import</span> TopologyService<br><span class="hljs-keyword">from</span> app.schemas.topology <span class="hljs-keyword">import</span> TopologyGraph<br><br>router = APIRouter(prefix=<span class="hljs-string">"/topology"</span>, tags=[<span class="hljs-string">"Topology"</span>])<br><br><span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/overview"</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_overview</span>(<span class="hljs-params">service: TopologyService = Depends(<span class="hljs-params">get_topology_service</span>)</span>):<br>    <span class="hljs-comment"># 从缓存获取，如果无则计算</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> service.get_system_overview()<br><br><span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/ethereum/nodes/{node_id}"</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_eth_node_detail</span>(<span class="hljs-params">node_id: <span class="hljs-built_in">str</span>, service: TopologyService = Depends(<span class="hljs-params"></span>)</span>):<br>    <span class="hljs-comment"># 1. 查 Neo4j 获取节点基础信息</span><br>    <span class="hljs-comment"># 2. 查 Docker 确认容器是否在线</span><br>    <span class="hljs-comment"># 3. 查 Web3/DB 获取链上余额和状态</span><br>    data = <span class="hljs-keyword">await</span> service.get_node_composite_info(node_id, layer=<span class="hljs-string">"ethereum"</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Node not found"</span>)<br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/combined"</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_combined_view</span>(<span class="hljs-params">layers: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], service: TopologyService = Depends(<span class="hljs-params"></span>)</span>):<br>    <span class="hljs-comment"># 融合物理层和区块链层</span><br>    <span class="hljs-comment"># 例如：展示 区块链P2P连线 覆盖在 物理AS拓扑 上</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> service.generate_combined_topology(layers)<br></code></pre></td></tr></table></figure><h3 id="5-关键技术难点与解决方案"><a href="#5-关键技术难点与解决方案" class="headerlink" title="5. 关键技术难点与解决方案"></a>5. 关键技术难点与解决方案</h3><ol><li><p><strong>Docker 网络访问:</strong></p><ul><li><p>FastAPI 容器需要挂载 /var/run/docker.sock 才能查询兄弟容器的状态。</p></li><li><p>docker-compose.yml 配置:</p><p>  codeYaml</p>  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-attr">volumes:</span><br>  - <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/docker.sock:/</span><span class="hljs-keyword">var</span><span class="hljs-regexp">/run/</span>docker.sock<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>跨容器数据库连接:</strong></p><ul><li>连接 Neo4j 和 Postgres 时，Host 应使用 Docker Compose 服务名（如 neo4j, postgresql），而不是 localhost。</li></ul></li><li><p><strong>性能瓶颈:</strong></p><ul><li><p><strong>问题:</strong> /ethereum 接口如果实时调用 100+ 次 RPC 会超时。</p></li><li><p><strong>解决:</strong> 使用 <strong>“后台采集 + 前端读取”</strong> 模式。编写一个后台 Task (使用 asyncio 或 Celery) 每 10 秒扫描一次网络状态存入 Redis。API 接口只读 Redis。</p></li></ul></li><li><p><strong>IP地址管理:</strong></p><ul><li><p>SeedEmu 的自定义网络（inet0, net_2_net_51_52）非常复杂。</p></li><li><p>在返回 /physical 拓扑时，务必解析 Docker inspect 结果中的 NetworkSettings，将特定网段 IP 映射给前端，否则前端无法理解路由关系。</p></li></ul></li></ol><h3 id="6-总结建议"><a href="#6-总结建议" class="headerlink" title="6. 总结建议"></a>6. 总结建议</h3><p>设计这个系统时，请遵循以下步骤：</p><ol><li><p><strong>优先打通 Neo4j:</strong> 它是拓扑的真理来源（Source of Truth）。确保能查询出 AS、Router 和 Host 的关系。</p></li><li><p><strong>实现缓存机制:</strong> 复杂的 Docker 集群状态获取很慢，不要让 API 直接穿透到 Docker Daemon。</p></li><li><p><strong>定义清晰的 ID 映射:</strong> 最大的坑在于关联 “Docker Container Name” (e.g., as101_host0) 和 “Ethereum Node ID” (e.g., Validator-3)。需要在服务启动时建立这个映射表。</p></li><li><p><strong>按层开发:</strong> 先做 Physical（最简单，只读 Docker），再做 Ethereum（读 DB），最后做高级的 Contract/Transaction 分析。</p></li></ol><hr><p>实现“实时更新”并“高亮变化”的核心在于结合 <strong>FastAPI 的 WebSocket</strong> 推送机制与 <strong>D3.js 的 General Update Pattern（通用更新模式）</strong>。</p><p>这里有三个关键点：</p><ol><li><p><strong>后端推送</strong>：只推送最新的全量/增量状态。</p></li><li><p><strong>前端数据绑定</strong>：D3 必须通过 Key Function 识别哪些是新节点、哪些是旧节点，而不是每次清空画布重绘。</p></li><li><p><strong>视觉反馈</strong>：利用 CSS 动画或 D3 Transition 让变化的节点产生“闪烁”或“颜色渐变”。</p></li></ol><hr><h3 id="1-整体架构设计"><a href="#1-整体架构设计" class="headerlink" title="1. 整体架构设计"></a>1. 整体架构设计</h3><ul><li><p><strong>后端 (FastAPI)</strong>: 运行一个后台任务（Background Task），每隔几秒扫描一次 Docker/Ethereum 状态，通过 WebSocket 广播给前端。</p></li><li><p><strong>前端 (D3.js)</strong>: 维护一个长连接，收到数据后，执行 updateGraph(newData)。</p></li></ul><hr><h3 id="2-后端：FastAPI-WebSocket-实现"><a href="#2-后端：FastAPI-WebSocket-实现" class="headerlink" title="2. 后端：FastAPI WebSocket 实现"></a>2. 后端：FastAPI WebSocket 实现</h3><p>我们需要一个 ConnectionManager 来管理前端连接，并推送拓扑数据。</p><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/routers/ws_topology.py</span><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, WebSocket, WebSocketDisconnect<br><span class="hljs-keyword">from</span> app.services.topology_service <span class="hljs-keyword">import</span> TopologyService<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> json<br><br>router = APIRouter()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionManager</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.active_connections: <span class="hljs-built_in">list</span>[WebSocket] = []<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">self, websocket: WebSocket</span>):<br>        <span class="hljs-keyword">await</span> websocket.accept()<br>        <span class="hljs-variable language_">self</span>.active_connections.append(websocket)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params">self, websocket: WebSocket</span>):<br>        <span class="hljs-variable language_">self</span>.active_connections.remove(websocket)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">broadcast</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">dict</span></span>):<br>        <span class="hljs-keyword">for</span> connection <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.active_connections:<br>            <span class="hljs-keyword">await</span> connection.send_json(message)<br><br>manager = ConnectionManager()<br><br><span class="hljs-comment"># 模拟后台数据推送任务</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">topology_broadcaster</span>(<span class="hljs-params">service: TopologyService</span>):<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    这个函数需要在 main.py 的 @app.on_event("startup") 中启动</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># 获取最新拓扑（包含 Docker 状态 + Geth 连接）</span><br>        topology_data = <span class="hljs-keyword">await</span> service.get_full_topology_snapshot()<br>        <br>        <span class="hljs-comment"># 广播数据</span><br>        <span class="hljs-keyword">if</span> manager.active_connections:<br>            <span class="hljs-keyword">await</span> manager.broadcast(topology_data)<br>        <br>        <span class="hljs-comment"># 每 5 秒推送一次，避免前端渲染压力过大</span><br>        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)<br><br><span class="hljs-meta">@router.websocket(<span class="hljs-params"><span class="hljs-string">"/ws/topology"</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">websocket_endpoint</span>(<span class="hljs-params">websocket: WebSocket</span>):<br>    <span class="hljs-keyword">await</span> manager.connect(websocket)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># 保持连接活跃，也可以接收前端的控制指令（比如点击了某个节点）</span><br>            data = <span class="hljs-keyword">await</span> websocket.receive_text() <br>    <span class="hljs-keyword">except</span> WebSocketDisconnect:<br>        manager.disconnect(websocket)<br></code></pre></td></tr></table></figure><hr><h3 id="3-前端：D3-js-实时更新与高亮逻辑"><a href="#3-前端：D3-js-实时更新与高亮逻辑" class="headerlink" title="3. 前端：D3.js 实时更新与高亮逻辑"></a>3. 前端：D3.js 实时更新与高亮逻辑</h3><p>这是最关键的部分。不要清空 SVG！使用 D3 的 <strong>Enter (新增), Update (更新), Exit (删除)</strong> 模式。</p><h4 id="核心策略："><a href="#核心策略：" class="headerlink" title="核心策略："></a>核心策略：</h4><ol><li><p><strong>ID 绑定</strong>：告诉 D3 如何通过 ID（如 enode_id 或 container_name）区分节点，而不是数组索引。</p></li><li><p><strong>平滑模拟</strong>：数据更新时，不要将 alpha 重置为 1（会导致整个图剧烈爆炸），而是重置为 0.3 左右（轻微调整）。</p></li><li><p><strong>样式Diff</strong>：比对新旧数据，如果状态变化（如 IP 变了，Peer 数变了），添加 CSS 类名触发动画。</p></li></ol><h4 id="代码实现-HTML-JS"><a href="#代码实现-HTML-JS" class="headerlink" title="代码实现 (HTML/JS)"></a>代码实现 (HTML/JS)</h4><p>codeJavaScript</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 初始化 SVG 和 Simulation</span><br><span class="hljs-keyword">const</span> svg = d3.<span class="hljs-title function_">select</span>(<span class="hljs-string">"#topology-svg"</span>);<br><span class="hljs-keyword">const</span> width = +svg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">"width"</span>);<br><span class="hljs-keyword">const</span> height = +svg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">"height"</span>);<br><br><span class="hljs-keyword">let</span> simulation = d3.<span class="hljs-title function_">forceSimulation</span>()<br>    .<span class="hljs-title function_">force</span>(<span class="hljs-string">"link"</span>, d3.<span class="hljs-title function_">forceLink</span>().<span class="hljs-title function_">id</span>(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">id</span>).<span class="hljs-title function_">distance</span>(<span class="hljs-number">100</span>))<br>    .<span class="hljs-title function_">force</span>(<span class="hljs-string">"charge"</span>, d3.<span class="hljs-title function_">forceManyBody</span>().<span class="hljs-title function_">strength</span>(-<span class="hljs-number">300</span>))<br>    .<span class="hljs-title function_">force</span>(<span class="hljs-string">"center"</span>, d3.<span class="hljs-title function_">forceCenter</span>(width / <span class="hljs-number">2</span>, height / <span class="hljs-number">2</span>));<br><br><span class="hljs-comment">// 定义箭头和样式</span><br><span class="hljs-comment">// ... (省略定义 marker 的代码) ...</span><br><br><span class="hljs-comment">// 建立 WebSocket 连接</span><br><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">"ws://localhost:8000/ws/topology"</span>);<br><br><span class="hljs-comment">// 本地存储当前数据，用于 diff</span><br><span class="hljs-keyword">let</span> currentNodes = [];<br><span class="hljs-keyword">let</span> currentEdges = [];<br><br>ws.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);<br>    <span class="hljs-title function_">updateGraph</span>(data);<br>};<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateGraph</span>(<span class="hljs-params">data</span>) {<br>    <span class="hljs-comment">// 1. 保留旧节点的位置信息！</span><br>    <span class="hljs-comment">// 如果不这样做，每次更新所有节点都会瞬间跳回原点或随机位置</span><br>    <span class="hljs-keyword">const</span> nodeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(currentNodes.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> [n.<span class="hljs-property">id</span>, n]));<br>    data.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">newNode</span> =&gt;</span> {<br>        <span class="hljs-keyword">const</span> oldNode = nodeMap.<span class="hljs-title function_">get</span>(newNode.<span class="hljs-property">id</span>);<br>        <span class="hljs-keyword">if</span> (oldNode) {<br>            newNode.<span class="hljs-property">x</span> = oldNode.<span class="hljs-property">x</span>;<br>            newNode.<span class="hljs-property">y</span> = oldNode.<span class="hljs-property">y</span>;<br>            newNode.<span class="hljs-property">vx</span> = oldNode.<span class="hljs-property">vx</span>;<br>            newNode.<span class="hljs-property">vy</span> = oldNode.<span class="hljs-property">vy</span>;<br>        }<br>    });<br>    <br>    currentNodes = data.<span class="hljs-property">nodes</span>;<br>    currentEdges = data.<span class="hljs-property">edges</span>;<br><br>    <span class="hljs-comment">// ================= 处理连线 (Links) =================</span><br>    <span class="hljs-comment">// key function: d =&gt; d.source.id + "-" + d.target.id</span><br>    <span class="hljs-comment">// 确保连线唯一性</span><br>    <span class="hljs-keyword">const</span> links = svg.<span class="hljs-title function_">selectAll</span>(<span class="hljs-string">".link"</span>)<br>        .<span class="hljs-title function_">data</span>(data.<span class="hljs-property">edges</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${d.source}</span>-<span class="hljs-subst">${d.target}</span>`</span>);<br><br>    links.<span class="hljs-title function_">exit</span>()<br>        .<span class="hljs-title function_">transition</span>().<span class="hljs-title function_">duration</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">style</span>(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 消失动画</span><br>        .<span class="hljs-title function_">remove</span>();<br><br>    <span class="hljs-keyword">const</span> linksEnter = links.<span class="hljs-title function_">enter</span>().<span class="hljs-title function_">append</span>(<span class="hljs-string">"line"</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"class"</span>, <span class="hljs-string">"link"</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"stroke"</span>, <span class="hljs-string">"#999"</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"stroke-width"</span>, <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">// MERGE: 合并新老连线</span><br>    <span class="hljs-keyword">const</span> linksMerge = linksEnter.<span class="hljs-title function_">merge</span>(links);<br><br>    <span class="hljs-comment">// ================= 处理节点 (Nodes) =================</span><br>    <span class="hljs-keyword">const</span> nodes = svg.<span class="hljs-title function_">selectAll</span>(<span class="hljs-string">".node"</span>)<br>        .<span class="hljs-title function_">data</span>(data.<span class="hljs-property">nodes</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">id</span>); <span class="hljs-comment">// 关键：使用 id 作为 key</span><br><br>    <span class="hljs-comment">// EXIT: 节点消失</span><br>    nodes.<span class="hljs-title function_">exit</span>()<br>        .<span class="hljs-title function_">transition</span>().<span class="hljs-title function_">duration</span>(<span class="hljs-number">1000</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"r"</span>, <span class="hljs-number">0</span>)<br>        .<span class="hljs-title function_">style</span>(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>)<br>        .<span class="hljs-title function_">remove</span>();<br><br>    <span class="hljs-comment">// UPDATE: 节点状态更新（比如颜色变化）</span><br>    <span class="hljs-comment">// 可以在这里判断状态，比如 d.status === 'mining'</span><br>    nodes.<span class="hljs-title function_">classed</span>(<span class="hljs-string">"node-updated"</span>, <span class="hljs-literal">true</span>) <span class="hljs-comment">// 添加一个类触发 CSS 闪烁</span><br>        .<span class="hljs-title function_">transition</span>().<span class="hljs-title function_">duration</span>(<span class="hljs-number">500</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"fill"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">layer</span> === <span class="hljs-string">'ethereum'</span> ? <span class="hljs-string">"#69b3a2"</span> : <span class="hljs-string">"#ffcc00"</span>);<br><br>    <span class="hljs-comment">// ENTER: 新节点出现</span><br>    <span class="hljs-keyword">const</span> nodesEnter = nodes.<span class="hljs-title function_">enter</span>().<span class="hljs-title function_">append</span>(<span class="hljs-string">"g"</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"class"</span>, <span class="hljs-string">"node"</span>)<br>        .<span class="hljs-title function_">call</span>(d3.<span class="hljs-title function_">drag</span>()<br>            .<span class="hljs-title function_">on</span>(<span class="hljs-string">"start"</span>, dragstarted)<br>            .<span class="hljs-title function_">on</span>(<span class="hljs-string">"drag"</span>, dragged)<br>            .<span class="hljs-title function_">on</span>(<span class="hljs-string">"end"</span>, dragended));<br><br>    nodesEnter.<span class="hljs-title function_">append</span>(<span class="hljs-string">"circle"</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"r"</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 初始大小为0，产生弹出的效果</span><br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"fill"</span>, <span class="hljs-string">"red"</span>) <span class="hljs-comment">//以此高亮新节点</span><br>        .<span class="hljs-title function_">transition</span>().<span class="hljs-title function_">duration</span>(<span class="hljs-number">750</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"r"</span>, <span class="hljs-number">10</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"fill"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">layer</span> === <span class="hljs-string">'ethereum'</span> ? <span class="hljs-string">"#69b3a2"</span> : <span class="hljs-string">"#ffcc00"</span>);<br><br>    nodesEnter.<span class="hljs-title function_">append</span>(<span class="hljs-string">"text"</span>)<br>        .<span class="hljs-title function_">text</span>(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">id</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"x"</span>, <span class="hljs-number">12</span>)<br>        .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"y"</span>, <span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// MERGE: 合并</span><br>    <span class="hljs-keyword">const</span> nodesMerge = nodesEnter.<span class="hljs-title function_">merge</span>(nodes);<br><br>    <span class="hljs-comment">// ================= 重启模拟 =================</span><br>    simulation.<span class="hljs-title function_">nodes</span>(data.<span class="hljs-property">nodes</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">"tick"</span>, ticked);<br>    simulation.<span class="hljs-title function_">force</span>(<span class="hljs-string">"link"</span>).<span class="hljs-title function_">links</span>(data.<span class="hljs-property">edges</span>);<br>    <br>    <span class="hljs-comment">// 关键：温和地重启模拟，而不是完全重置</span><br>    <span class="hljs-comment">// alpha(0.3) 意味着只进行微调，不会导致布局剧烈震荡</span><br>    simulation.<span class="hljs-title function_">alpha</span>(<span class="hljs-number">0.3</span>).<span class="hljs-title function_">restart</span>();<br><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">ticked</span>(<span class="hljs-params"></span>) {<br>        linksMerge<br>            .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"x1"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">source</span>.<span class="hljs-property">x</span>)<br>            .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"y1"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">source</span>.<span class="hljs-property">y</span>)<br>            .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"x2"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">target</span>.<span class="hljs-property">x</span>)<br>            .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"y2"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.<span class="hljs-property">target</span>.<span class="hljs-property">y</span>);<br><br>        nodesMerge<br>            .<span class="hljs-title function_">attr</span>(<span class="hljs-string">"transform"</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> <span class="hljs-string">`translate(<span class="hljs-subst">${d.x}</span>,<span class="hljs-subst">${d.y}</span>)`</span>);<br>    }<br>}<br><br><span class="hljs-comment">// 拖拽函数（标准 D3 代码，略）</span><br></code></pre></td></tr></table></figure><h3 id="4-视觉高亮变化的技巧"><a href="#4-视觉高亮变化的技巧" class="headerlink" title="4. 视觉高亮变化的技巧"></a>4. 视觉高亮变化的技巧</h3><p>为了让用户明显看到“发生了什么变化”，建议配合 CSS 动画：</p><p><strong>技巧 A：新节点闪烁</strong><br>当节点 enter() 时，给它设置一个临时的高亮颜色（如亮绿色），然后 transition 回正常颜色。</p><p><strong>技巧 B：状态变更光环</strong><br>如果节点还在列表里，但状态变了（例如从 syncing 变成 mining），在 nodes (Update set) 中检测：</p><p>codeJavaScript</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs q">nodes.<span class="hljs-built_in">each</span>(function(d) {<br>    <span class="hljs-comment">// d 是新数据，this 是 DOM 元素</span><br>    const oldStatus = d3.<span class="hljs-keyword">select</span>(this).<span class="hljs-built_in">attr</span>(<span class="hljs-string">"data-status"</span>);<br>    if (oldStatus &amp;&amp; oldStatus !== d.status) {<br>        <span class="hljs-comment">// 状态变了！添加一个临时 SVG 圆环扩散动画</span><br>        d3.<span class="hljs-keyword">select</span>(this).append(<span class="hljs-string">"circle"</span>)<br>            .<span class="hljs-built_in">attr</span>(<span class="hljs-string">"r"</span>, <span class="hljs-number">10</span>)<br>            .<span class="hljs-built_in">attr</span>(<span class="hljs-string">"class"</span>, <span class="hljs-string">"ripple"</span>)<br>            .transition().duration(<span class="hljs-number">1000</span>)<br>            .<span class="hljs-built_in">attr</span>(<span class="hljs-string">"r"</span>, <span class="hljs-number">30</span>)<br>            .style(<span class="hljs-string">"opacity"</span>, <span class="hljs-number">0</span>)<br>            .remove();<br>    }<br>    <span class="hljs-comment">// 更新 DOM 上的状态标记</span><br>    d3.<span class="hljs-keyword">select</span>(this).<span class="hljs-built_in">attr</span>(<span class="hljs-string">"data-status"</span>, d.status);<br>});<br></code></pre></td></tr></table></figure><p><strong>技巧 C：固定骨干网（针对 SeedEmu）</strong><br>你的环境中有 AS 路由器（骨干网）和 Host（叶子节点）。</p><ul><li><p><strong>建议</strong>：在 D3 中，将骨干路由器（r51-r54, AS路由器）的坐标<strong>根据逻辑预设好并固定</strong>（设置 fx, fy）。</p></li><li><p><strong>效果</strong>：这样即使以太坊节点上线下线，整个网络的“骨架”不会乱跑，只有边缘节点在动，视觉上更清晰，更容易看清变化。</p></li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li><p><strong>FastAPI</strong>：使用 WebSocket + Background Task 推送全量快照。</p></li><li><p><strong>D3.js</strong>：使用 data(dataset, d =&gt; d.id) 绑定 ID。</p></li><li><p><strong>Diff 逻辑</strong>：</p><ul><li><p><strong>Enter</strong>: 初始半径为 0 -&gt; 放大，颜色高亮。</p></li><li><p><strong>Exit</strong>: 透明度变 0 -&gt; 移除。</p></li><li><p><strong>Update</strong>: 继承旧节点的 x, y 坐标，避免位置重置；利用 transition 表现状态变更。</p></li><li><p><strong>Simulation</strong>: 使用 alpha(0.3).restart() 进行温和重绘。</p></li></ul></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;复杂异构系统监控与可视化项目设计&quot;&gt;&lt;a href=&quot;#复杂异构系统监控与可视化项目设计&quot; class=&quot;headerlink&quot; title=&quot;复杂异构系统监控与可视化项目设计&quot;&gt;&lt;/a&gt;&lt;strong&gt;复杂异构系统监控与可视化&lt;/strong&gt;项目设计&lt;/h2&gt;</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-12-06-杂记-前端图拓扑渲染优化</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/7900.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/7900.html</id>
    <published>2025-12-06T03:25:47.000Z</published>
    <updated>2025-12-14T17:56:13.795Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p><strong>性能优化 (Web Workers)</strong>: 目前的数据获取、解析和Diff算法都在<strong>主线程</strong>运行。当拓扑变大时，计算Diff会导致页面卡顿。建议将这部分移至 <strong>Web Worker</strong>。</p></li><li><p><strong>D3 渲染优化</strong>: 目前的设计倾向于每次更新都全量替换 filteredNodes，这会导致 D3 力导向图重新初始化或位置抖动。应该利用 Diff 结果进行<strong>增量渲染 (Enter/Update/Exit)</strong>。</p></li><li><p><strong>状态管理解耦</strong>: useTopologyData 承担了太多职责（数据存储、UI状态、标签逻辑）。应该拆分为“数据层”和“视觉层”。</p></li><li><p><strong>数据结构优化</strong>: 数组查找（.find）效率低，应更多使用 Map/Set 索引。</p></li></ol><h3 id="优化后文件结构"><a href="#优化后文件结构" class="headerlink" title="优化后文件结构"></a>优化后文件结构</h3><p>采用了 <strong>Core (数据核心) + Visual (视觉逻辑) + Worker (后台计算)</strong> 的分层结构。</p><p>codeText</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-attribute">src</span>/<br>  ├── types/<br>  │   └── topology<span class="hljs-selector-class">.ts</span>           <span class="hljs-comment">// (保持不变) 类型定义</span><br>  ├── workers/<br>  │   └── topology<span class="hljs-selector-class">.worker</span><span class="hljs-selector-class">.ts</span>    <span class="hljs-comment">// [新] 负责Fetch、解析数据、计算Diff</span><br>  ├── composables/<br>  │   ├── useTopologyCore<span class="hljs-selector-class">.ts</span>    <span class="hljs-comment">// [优化] 负责与Worker通信，持有原始数据</span><br>  │   ├── useTopologyVisual<span class="hljs-selector-class">.ts</span>  <span class="hljs-comment">// [拆分] 负责过滤、标签、高亮等UI逻辑</span><br>  │   └── useD3Renderer<span class="hljs-selector-class">.ts</span>      <span class="hljs-comment">// [新] 封装D3的具体操作，接受Diff指令</span><br>  └── components/<br>      └── EthereumTopology<span class="hljs-selector-class">.vue</span>  <span class="hljs-comment">// [优化] 变得很薄，只负责组装</span><br></code></pre></td></tr></table></figure><p>现在的以太坊拓扑渲染架构采用了 <strong>“分层响应式架构” (Layered Reactive Architecture)</strong>，结合了 <strong>Web Worker 多线程计算</strong> 和 <strong>D3 增量渲染</strong> 技术。</p><p>这是一种高性能、低耦合的现代前端架构，专门为了处理大量节点（数千级）的实时动态拓扑而设计。</p><p>以下是该架构的详细层级解析：</p><h3 id="1-架构总览图"><a href="#1-架构总览图" class="headerlink" title="1. 架构总览图"></a>1. 架构总览图</h3><p>数据流向是单向的，状态管理是响应式的：</p><p>codeMermaid</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs coq">graph TD<br>    BackEnd[FastAPI 后端] --&gt;|<span class="hljs-type">JSON</span> Stream| <span class="hljs-type">Worker</span>[Web Worker (后台线程)]<br>    <br>    subgraph <span class="hljs-string">"Main Thread (主线程)"</span><br>        Worker --&gt;|<span class="hljs-type">Diff</span> Update (增量/全量)| <span class="hljs-type">Store</span>[useTopologyCore (数据层)]<br>        Store --&gt;|<span class="hljs-type">Raw</span> Data| <span class="hljs-type">Visual</span>[useTopologyVisual (视觉层)]<br>        <br>        subgraph <span class="hljs-string">"UI Components (视图层)"</span><br>            Visual --&gt;|<span class="hljs-type">Filtered</span> Data| <span class="hljs-type">Renderer</span>[useD3Renderer (渲染层)]<br>            Visual --&gt;|<span class="hljs-type">Filters</span>/<span class="hljs-keyword">Mode</span>| <span class="hljs-type">Controls</span>[TopologyVisualization (控制面板)]<br>            Renderer --&gt;|<span class="hljs-type">Click</span> Event| <span class="hljs-type">Details</span>[PhysicalTopology (详情抽屉)]<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <br>    Renderer --&gt;|<span class="hljs-type">Draw</span>| <span class="hljs-type">DOM</span>[SVG/Canvas]<br></code></pre></td></tr></table></figure><hr><h3 id="2-核心层级详细解析"><a href="#2-核心层级详细解析" class="headerlink" title="2. 核心层级详细解析"></a>2. 核心层级详细解析</h3><h4 id="第一层：数据处理层-Worker-Thread"><a href="#第一层：数据处理层-Worker-Thread" class="headerlink" title="第一层：数据处理层 (Worker Thread)"></a>第一层：数据处理层 (Worker Thread)</h4><p><strong>文件</strong>: workers/topology.worker.ts<br>这是架构的“发动机”，完全脱离主线程运行。</p><ul><li><p><strong>职责</strong>：</p><ol><li><p><strong>数据拉取</strong>：直接发起 Fetch 请求，不占用主线程网络资源。</p></li><li><p><strong>数据清洗</strong>：解析复杂的 JSON 结构，标准化为 TopologyNode 和 TopologyLink。</p></li><li><p><strong>智能 Diff (差异计算)</strong>：</p><ul><li><p>这是性能优化的关键。它对比新旧数据，计算出新增、删除和更新的节点。</p></li><li><p><strong>坐标继承</strong>：在 Worker 中将旧节点的 x, y 坐标赋值给新节点，防止 D3 在数据更新时重新计算布局导致视图“爆炸”或闪烁。</p></li></ul></li></ol></li></ul><h4 id="第二层：状态管理层-Composables"><a href="#第二层：状态管理层-Composables" class="headerlink" title="第二层：状态管理层 (Composables)"></a>第二层：状态管理层 (Composables)</h4><p>这一层利用 Vue 3 的 Composition API 将业务逻辑拆分为独立的模块。</p><ul><li><p><strong>数据持有 (useTopologyCore.ts)</strong>：</p><ul><li><p>与 Worker 通信的桥梁。</p></li><li><p>使用 shallowRef 存储庞大的拓扑数据。<strong>优化点</strong>：shallowRef 不会深度监听节点内部属性的变化（如 x, y 坐标），这极大减轻了 Vue 响应式系统的负担，因为 D3 会直接操作这些原生对象。</p></li></ul></li><li><p><strong>视觉逻辑 (useTopologyVisual.ts)</strong>：</p><ul><li><p><strong>纯粹的计算层</strong>。它不关心数据怎么来的，只关心怎么显示。</p></li><li><p><strong>动态过滤</strong>：利用 computed 属性，根据 filters（如隐藏共识节点）实时生成 filteredNodes。</p></li><li><p><strong>样式映射</strong>：集中管理颜色 (getNodeColor) 和标签 (getNodeLabel) 逻辑，实现逻辑与渲染分离。</p></li></ul></li></ul><h4 id="第三层：渲染驱动层-Render-Engine"><a href="#第三层：渲染驱动层-Render-Engine" class="headerlink" title="第三层：渲染驱动层 (Render Engine)"></a>第三层：渲染驱动层 (Render Engine)</h4><p><strong>文件</strong>: useD3Renderer.ts<br>这是 D3.js 与 Vue 的结合点。</p><ul><li><p><strong>生命周期接管</strong>：它在 onMounted 时初始化 D3 仿真器。</p></li><li><p><strong>增量渲染 (Incremental Rendering)</strong>：</p><ul><li><p>使用 Vue 的 watch 监听过滤后的数据。</p></li><li><p>利用 D3 的 enter(), update(), exit() 模式。</p></li><li><p><strong>Enter</strong>: 新节点淡入。</p></li><li><p><strong>Exit</strong>: 被过滤或删除的节点淡出移除。</p></li><li><p><strong>Update</strong>: 现有节点平滑移动到新位置。</p></li></ul></li><li><p><strong>事件桥接</strong>：将 D3 的 click、drag 事件转换为 Vue 的回调函数，传递给上层组件。</p></li></ul><h4 id="第四层：视图组装层-View-Integration"><a href="#第四层：视图组装层-View-Integration" class="headerlink" title="第四层：视图组装层 (View Integration)"></a>第四层：视图组装层 (View Integration)</h4><p><strong>文件</strong>: EthereumTopology.vue (父组件)<br>这是架构的“容器”和“胶水”。</p><ul><li><p><strong>依赖注入 (Dependency Injection)</strong>：</p><ul><li><p>父组件通过 provide(‘topology-state’, …) 将 mode、filters 等状态下发。</p></li><li><p>子组件 TopologyVisualization 通过 inject 直接获取并修改这些状态。避免了深层 Prop 传递（Prop Drilling）。</p></li></ul></li><li><p><strong>组件编排</strong>：</p><ul><li><p>负责布局：左上角悬浮控制面板、中间 D3 画布、右侧详情抽屉。</p></li><li><p>负责联动：当 D3 点击节点时，控制 showPhysicalDetails 变量来弹出侧边栏。</p></li></ul></li></ul><hr><h3 id="3-关键性能优化点总结"><a href="#3-关键性能优化点总结" class="headerlink" title="3. 关键性能优化点总结"></a>3. 关键性能优化点总结</h3><ol><li><p><strong>非阻塞主线程 (Off-Main-Thread)</strong>:</p><ul><li><p><strong>旧架构</strong>：在组件内 fetch 数据 -&gt; 解析 -&gt; 赋值。数据量大时 UI 会卡顿。</p></li><li><p><strong>新架构</strong>：所有数据处理都在 Worker 中完成，主线程只负责接收“准备好渲染”的数据。</p></li></ul></li><li><p><strong>浅层响应式 (Shallow Reactivity)</strong>:</p><ul><li>使用 shallowRef 代替 ref 存储节点数组。D3 内部高频修改 node.x 和 node.y 时，不会触发 Vue 的依赖更新系统，显著提升动画帧率。</li></ul></li><li><p><strong>状态保持 (State Preservation)</strong>:</p><ul><li>Worker 在处理新数据时，会查找旧数据的 ID，并将 x, y, vx, vy (速度向量) 复制给新数据。这保证了在轮询更新时，节点不会重置位置，实现了“流式”的平滑更新效果。</li></ul></li><li><p><strong>按需计算 (Computed Filtering)</strong>:</p><ul><li>连接 (links) 的过滤依赖于节点 (nodes) 的过滤结果。新架构使用了 Set 来建立索引，将连接过滤的时间复杂度从 O(N*M) 降低到 O(M)（其中 N 是节点数，M 是连接数）。</li></ul></li></ol><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h3><p>现在的架构是一个 <strong>“重后台、轻前台、数据驱动视图”</strong> 的专业可视化架构。</p><ul><li><p><strong>Worker</strong> 负责“脏活累活”（数据处理）。</p></li><li><p><strong>D3</strong> 负责“精细活”（物理仿真和绘图）。</p></li><li><p><strong>Vue</strong> 负责“指挥”（状态管理和组件通信）。</p></li></ul><p>这种架构非常适合需要长时间运行、实时监控网络状态的生产级系统。</p><hr><p>根据提供的代码（EthereumTopologyHandler 和 RealTopologyService），以太坊网络拓扑的处理流程是一个<strong>分层获取、数据融合、格式化输出</strong>的过程。核心逻辑依赖于 <strong>Neo4j 图数据库</strong>（存储P2P关系）和 <strong>Docker 守护进程</strong>（提供容器运行时信息）。</p><p>以下是详细的处理步骤解析：</p><h3 id="1-数据源获取-Data-Acquisition"><a href="#1-数据源获取-Data-Acquisition" class="headerlink" title="1. 数据源获取 (Data Acquisition)"></a>1. 数据源获取 (Data Acquisition)</h3><p>系统主要通过两个渠道获取数据：</p><ul><li><p><strong>Neo4j 数据库 (核心数据源)</strong>：存储了爬虫或客户端上报的节点发现数据，包含节点ID、IP、以及节点间的 P2P 连接关系。</p></li><li><p><strong>Docker Client (辅助数据源)</strong>：用于获取运行中容器的实时状态、名称映射和网络设置。</p></li></ul><h3 id="2-核心处理流程"><a href="#2-核心处理流程" class="headerlink" title="2. 核心处理流程"></a>2. 核心处理流程</h3><p>整个拓扑生成的逻辑主要集中在 _get_real_topology_from_neo4j 和 _convert_topology_format 方法中。</p><h4 id="步骤-A：从-Neo4j-提取原始拓扑结构"><a href="#步骤-A：从-Neo4j-提取原始拓扑结构" class="headerlink" title="步骤 A：从 Neo4j 提取原始拓扑结构"></a>步骤 A：从 Neo4j 提取原始拓扑结构</h4><p>代码通过 Cypher 查询语句分三步提取数据：</p><ol><li><p><strong>查询执行层 (Execution Layer)</strong>：</p><ul><li><p>查找所有 ExecNode 标签的节点。</p></li><li><p>查找 EXEC_PEERS_WITH 关系，获取该节点的对等节点（Peers）。</p></li></ul></li><li><p><strong>查询共识层 (Consensus Layer)</strong>：</p><ul><li><p>查找所有 ConsNode 标签的节点。</p></li><li><p>查找 CONS_PEERS_WITH 关系。</p></li></ul></li><li><p><strong>查询验证者 (Validators)</strong>：</p><ul><li><p>查找与共识节点通过 MANAGES_VALIDATOR 关系连接的 Validator 节点。</p></li><li><p>这反映了哪个信标节点（Beacon Node）管理着哪些验证者客户端。</p></li></ul></li></ol><h4 id="步骤-B：容器身份映射-Container-Mapping"><a href="#步骤-B：容器身份映射-Container-Mapping" class="headerlink" title="步骤 B：容器身份映射 (Container Mapping)"></a>步骤 B：容器身份映射 (Container Mapping)</h4><ul><li><p><strong>目的</strong>：数据库中只有 IP 地址，但在前端展示时，最好能显示具体的 Docker 容器名称（如 geth-node-1）。</p></li><li><p><strong>实现</strong>：_create_ip_to_container_mapping 方法遍历所有 Docker 容器，提取其网络设置中的 IP 地址，建立 IP -&gt; ContainerName 的映射表。</p></li></ul><h4 id="步骤-C：构建拓扑对象-Topology-Construction"><a href="#步骤-C：构建拓扑对象-Topology-Construction" class="headerlink" title="步骤 C：构建拓扑对象 (Topology Construction)"></a>步骤 C：构建拓扑对象 (Topology Construction)</h4><p>系统将原始数据转换为前端可视化的 JSON 格式，包含 nodes 和 links。</p><p><strong>1. 节点生成 (Nodes):</strong><br>代码根据逻辑自动计算节点的坐标 (x, y) 以便可视化布局：</p><ul><li><p><strong>执行层节点</strong>：</p><ul><li><p>type: execution</p></li><li><p>位置：固定在 Y=150 的水平线上。</p></li></ul></li><li><p><strong>共识层节点</strong>：</p><ul><li><p>type: consensus</p></li><li><p>位置：固定在 Y=350 的水平线上（位于执行层下方）。</p></li></ul></li><li><p><strong>验证者节点</strong>：</p><ul><li><p>type: validator</p></li><li><p>位置：簇拥在所属共识节点的下方 (y + 60)，通过计算偏移量排成小方阵。</p></li></ul></li></ul><p><strong>2. 连接生成 (Links):</strong><br>系统构建了四种类型的连接：</p><ul><li><p><strong>执行层 P2P (exec_peer)</strong>：基于 Neo4j 中的 EXEC_PEERS_WITH 关系，表示 Geth/Nethermind 节点间的 Gossip 协议连接。</p></li><li><p><strong>共识层 P2P (cons_peer)</strong>：基于 CONS_PEERS_WITH 关系，表示 Lighthouse/Prysm 节点间的连接。</p></li><li><p><strong>管理关系 (manages_validator)</strong>：连接共识节点和它管理的验证者节点。</p></li><li><p><strong>跨层连接 (cross_layer)</strong>：<strong>关键逻辑</strong>。代码会自动匹配 IP 地址相同的执行层节点和共识层节点，并创建一个垂直连接。这代表了以太坊客户端组合（Engine API 通信，例如 Geth &lt;-&gt; Lighthouse 在同一台机器/Pod内）。</p></li></ul><h3 id="3-容错与缓存机制"><a href="#3-容错与缓存机制" class="headerlink" title="3. 容错与缓存机制"></a>3. 容错与缓存机制</h3><p>为了保证性能和稳定性，代码中包含了以下机制：</p><ul><li><p><strong>缓存 (Caching)</strong>：</p><ul><li><p>使用 self.cache 存储计算好的拓扑。</p></li><li><p>设置 cache_ttl (20-30秒)，防止频繁查询 Neo4j 导致数据库过载。</p></li></ul></li><li><p><strong>降级模式 (Fallback - 仅在 Service 中)</strong>：</p><ul><li><p>如果 Neo4j 连接失败或返回空数据，RealTopologyService 会调用 _get_container_based_topology。</p></li><li><p><strong>Fallback 逻辑</strong>：直接扫描 Docker 容器，如果发现名为 ethereum 的容器，就根据容器数量“伪造”一个链式的拓扑结构（非网状），以确保界面上至少能看到节点存在，而不是一片空白。</p></li></ul></li></ul><h3 id="4-统计与验证-Statistics-amp-Validation"><a href="#4-统计与验证-Statistics-amp-Validation" class="headerlink" title="4. 统计与验证 (Statistics & Validation)"></a>4. 统计与验证 (Statistics &amp; Validation)</h3><p>EthereumTopologyHandler 还提供了额外的高级功能：</p><ul><li><p><strong>独立查询</strong>：get_nodes 和 get_links 可以不依赖完整拓扑逻辑，直接查询特定层的数据，提高效率。</p></li><li><p><strong>拓扑验证</strong>：validate_topology 检查数据一致性：</p><ul><li><p>节点 ID 是否唯一。</p></li><li><p>连接的源/目标节点是否存在。</p></li><li><p>是否存在孤立节点。</p></li><li><p>IP 地址分布是否异常（例如一个 IP 运行了超过2个主要节点）。</p></li></ul></li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>该系统处理以太坊拓扑的核心思想是：<strong>“数据库定义逻辑关系，Docker 定义物理属性，代码负责视觉组装”</strong>。</p><ol><li><p><strong>逻辑层</strong>：谁连谁？由 Neo4j 决定。</p></li><li><p><strong>物理层</strong>：你是谁？由 Docker IP 映射决定。</p></li><li><p><strong>视觉层</strong>：你在哪？由代码中的分层坐标计算逻辑决定（执行层在上，共识层在中，验证者在下）。</p></li></ol><hr><p>目前的实现逻辑虽然功能完整，但在性能上存在几个显著的<strong>瓶颈</strong>，特别是在节点数量增多或 Docker 容器较多时，响应速度会明显下降。</p><p>以下是针对代码的具体性能优化方案，按<strong>提升幅度从大到小</strong>排序：</p><h3 id="1-痛点分析：目前的性能瓶颈在哪里？"><a href="#1-痛点分析：目前的性能瓶颈在哪里？" class="headerlink" title="1. 痛点分析：目前的性能瓶颈在哪里？"></a>1. 痛点分析：目前的性能瓶颈在哪里？</h3><ol><li><p><strong>Docker API 调用过于频繁 (主要瓶颈)</strong>：</p><ul><li><p>_create_ip_to_container_mapping 每次生成拓扑都会被调用。它会遍历<strong>所有</strong>容器并检查网络设置。Docker API 的响应通常是毫秒级到秒级的，如果不缓存，这会严重阻塞主线程。</p></li><li><p>在物理拓扑中，_get_link_bandwidth 会对每个连接进入容器执行 tc 命令。如果有 50 个连接，就要串行执行 50 次 docker exec，这是极慢的 IO 操作。</p></li></ul></li><li><p><strong>串行数据库查询</strong>：</p><ul><li>在 _get_real_topology_from_neo4j 中，执行层查询及处理完之后，才开始共识层的查询。这两者没有依赖关系，完全可以并行。</li></ul></li><li><p><strong>计算密集型的重复操作</strong>：</p><ul><li>每次请求都重新计算所有节点的坐标和映射关系，即使数据没有变化。</li></ul></li></ol><hr><h3 id="2-优化方案一：Docker-数据的独立缓存与后台更新"><a href="#2-优化方案一：Docker-数据的独立缓存与后台更新" class="headerlink" title="2. 优化方案一：Docker 数据的独立缓存与后台更新"></a>2. 优化方案一：Docker 数据的独立缓存与后台更新</h3><p>Docker 的元数据（IP、容器名）变化频率远低于 P2P 网络连接的变化频率。<strong>不要在每次请求拓扑时都去查询 Docker。</strong></p><p><strong>优化策略：</strong> 使用“读写分离”的策略，后台任务更新 Docker 映射，前台请求只读内存变量。</p><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">EthereumTopologyHandler</span>(<span class="hljs-title class_ inherited__">TopologyProvider</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># ... 原有初始化 ...</span><br>        <span class="hljs-variable language_">self</span>.ip_container_map_cache = {}<br>        <span class="hljs-variable language_">self</span>.map_last_update = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.map_update_lock = asyncio.Lock()<br>        <br>        <span class="hljs-comment"># 启动时预热</span><br>        <span class="hljs-comment"># 注意：实际代码中建议使用 apscheduler 或 asyncio.create_task 在后台循环运行</span><br>        <br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_ip_to_container_map_optimized</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]:<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        优化后的获取映射方法：</span><br><span class="hljs-string">        1. 优先返回内存缓存</span><br><span class="hljs-string">        2. 缓存过期（如5分钟）才异步更新</span><br><span class="hljs-string">        """</span><br>        current_time = time.time()<br>        <span class="hljs-comment"># 缓存有效期设为 300秒 (Docker容器IP不会频繁变动)</span><br>        <span class="hljs-keyword">if</span> current_time - <span class="hljs-variable language_">self</span>.map_last_update &lt; <span class="hljs-number">300</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.ip_container_map_cache:<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.ip_container_map_cache<br><br>        <span class="hljs-comment"># 如果需要更新，且未被锁定</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.map_update_lock.locked():<br>             <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.map_update_lock:<br>                 <span class="hljs-comment"># 二次检查</span><br>                 <span class="hljs-keyword">if</span> time.time() - <span class="hljs-variable language_">self</span>.map_last_update &lt; <span class="hljs-number">300</span>: <br>                     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.ip_container_map_cache<br>                 <br>                 <span class="hljs-comment"># 执行耗时的 Docker 查询</span><br>                 <span class="hljs-comment"># 建议：在一个线程池中运行同步的 docker client 操作，避免阻塞事件循环</span><br>                 loop = asyncio.get_running_loop()<br>                 <span class="hljs-variable language_">self</span>.ip_container_map_cache = <span class="hljs-keyword">await</span> loop.run_in_executor(<br>                     <span class="hljs-literal">None</span>, <span class="hljs-variable language_">self</span>._create_ip_to_container_mapping<br>                 )<br>                 <span class="hljs-variable language_">self</span>.map_last_update = time.time()<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.ip_container_map_cache<br></code></pre></td></tr></table></figure><h3 id="3-优化方案二：物理拓扑带宽检测的“非阻塞化”"><a href="#3-优化方案二：物理拓扑带宽检测的“非阻塞化”" class="headerlink" title="3. 优化方案二：物理拓扑带宽检测的“非阻塞化”"></a>3. 优化方案二：物理拓扑带宽检测的“非阻塞化”</h3><p>在 RealTopologyService 中，物理连接的带宽检测（tc 命令）是极其耗时的。绝对不能在用户请求 API 时实时去跑 tc 命令。</p><p><strong>优化策略：</strong> 将带宽数据设为“最终一致性”。主接口只返回拓扑结构，带宽字段先返回缓存值或 “Checking…”，后台任务专门负责轮询更新带宽。</p><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RealTopologyService</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># ...</span><br>        <span class="hljs-variable language_">self</span>.bandwidth_cache = {} <span class="hljs-comment"># Key: "container_ip", Value: "100Mbit"</span><br>        <br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_dynamic_physical_topology_from_containers</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># ... 前面生成 nodes 和 links 的逻辑保持不变 ...</span><br>        <br>        <span class="hljs-comment"># --- 优化点：移除实时 await _get_link_bandwidth ---</span><br>        <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> links:<br>            target_id = link[<span class="hljs-string">'target'</span>]<br>            target_node = nodes_by_id[target_id]<br>            container_name = target_node[<span class="hljs-string">'container_name'</span>]<br>            link_ip = target_node[<span class="hljs-string">'networks'</span>].get(link[<span class="hljs-string">'shared_network'</span>])<br>            <br>            <span class="hljs-comment"># 1. 尝试从缓存获取</span><br>            cache_key = <span class="hljs-string">f"<span class="hljs-subst">{container_name}</span>::<span class="hljs-subst">{link_ip}</span>"</span><br>            cached_bw = <span class="hljs-variable language_">self</span>.bandwidth_cache.get(cache_key)<br>            <br>            <span class="hljs-keyword">if</span> cached_bw:<br>                link[<span class="hljs-string">'bandwidth'</span>] = cached_bw<br>            <span class="hljs-keyword">else</span>:<br>                link[<span class="hljs-string">'bandwidth'</span>] = <span class="hljs-string">"Querying..."</span><br>                <span class="hljs-comment"># 2. 触发后台更新任务 (Fire and Forget)</span><br>                asyncio.create_task(<span class="hljs-variable language_">self</span>._update_bandwidth_cache(container_name, link_ip, cache_key))<br>                <br>        <span class="hljs-keyword">return</span> nodes, links<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_update_bandwidth_cache</span>(<span class="hljs-params">self, container_name, link_ip, cache_key</span>):<br>        <span class="hljs-string">"""后台单独更新带宽"""</span><br>        bw = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._get_link_bandwidth(container_name, link_ip)<br>        <span class="hljs-variable language_">self</span>.bandwidth_cache[cache_key] = bw<br></code></pre></td></tr></table></figure><h3 id="4-优化方案三：Neo4j-并发查询"><a href="#4-优化方案三：Neo4j-并发查询" class="headerlink" title="4. 优化方案三：Neo4j 并发查询"></a>4. 优化方案三：Neo4j 并发查询</h3><p>Neo4j 的 Python Driver (尤其是 Bolt 协议) 支持并发。执行层和共识层的查询是独立的，可以使用 asyncio.gather 同时发起查询。</p><p><strong>注意</strong>：这需要你的 database_manager 支持异步操作。如果底层是同步驱动，可以用 run_in_executor 包装。</p><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 在 EthereumTopologyHandler 中</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_real_topology_from_neo4j</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Dict</span>, <span class="hljs-type">Dict</span>]:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># ... 连接检查 ...</span><br><br>            <span class="hljs-comment"># 定义查询函数</span><br>            <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_exec</span>():<br>                <span class="hljs-comment"># 这里假设 database_manager 提供了某种异步执行方式，</span><br>                <span class="hljs-comment"># 或者我们将同步的 session.run 放入线程池</span><br>                <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_query</span>():<br>                    <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.database_manager.neo4j.session() <span class="hljs-keyword">as</span> session:<br>                        result = session.run(<span class="hljs-string">"MATCH (n:ExecNode)..."</span>) <span class="hljs-comment"># 填入完整的 Cypher</span><br>                        <span class="hljs-keyword">return</span> {r[<span class="hljs-string">'node_id'</span>]: ... <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> result} <span class="hljs-comment"># 处理结果</span><br>                <br>                loop = asyncio.get_running_loop()<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> loop.run_in_executor(<span class="hljs-literal">None</span>, run_query)<br><br>            <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_cons_and_validators</span>():<br>                <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_query</span>():<br>                    <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.database_manager.neo4j.session() <span class="hljs-keyword">as</span> session:<br>                        <span class="hljs-comment"># 合并共识节点和验证者的查询逻辑，减少一次 session 创建开销</span><br>                        cons_result = session.run(<span class="hljs-string">"MATCH (n:ConsNode)..."</span>) <br>                        <span class="hljs-comment"># ... 处理共识 ...</span><br>                        validator_result = session.run(<span class="hljs-string">"MATCH ... validators ..."</span>)<br>                        <span class="hljs-comment"># ... 处理验证者 ...</span><br>                        <span class="hljs-keyword">return</span> cons_data<br>                <br>                loop = asyncio.get_running_loop()<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> loop.run_in_executor(<span class="hljs-literal">None</span>, run_query)<br><br>            <span class="hljs-comment"># 并发执行</span><br>            exec_nodes_data, cons_nodes_data = <span class="hljs-keyword">await</span> asyncio.gather(<br>                fetch_exec(), <br>                fetch_cons_and_validators()<br>            )<br><br>            <span class="hljs-keyword">return</span> exec_nodes_data, cons_nodes_data<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-comment"># ... Error handling</span><br></code></pre></td></tr></table></figure><h3 id="5-优化方案四：Cypher-查询语句优化"><a href="#5-优化方案四：Cypher-查询语句优化" class="headerlink" title="5. 优化方案四：Cypher 查询语句优化"></a>5. 优化方案四：Cypher 查询语句优化</h3><p>目前的 Cypher 使用了 OPTIONAL MATCH 和 collect，这在数据量大时比较慢。</p><p><strong>原查询：</strong></p><p>codeCypher</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">MATCH (n:ExecNode)<br>OPTIONAL MATCH (n)-<span class="hljs-selector-attr">[r:EXEC_PEERS_WITH]</span>-&gt;(p:ExecNode)<br>RETURN ... <span class="hljs-built_in">collect</span>(...)<br></code></pre></td></tr></table></figure><p>如果在节点很多的情况下，这个查询会扫描整个图。</p><p><strong>优化建议：</strong></p><ol><li><p><strong>分批次</strong>：如果节点超过 1000 个，不要一次性 collect 所有 Peers。前端通常不需要展示所有几千条连线（会卡死浏览器）。可以限制返回的 Peer 数量，例如 LIMIT 10。</p></li><li><p><strong>索引</strong>：确保 node_id, ip 在 Neo4j 中建立了索引 (CREATE INDEX ON :ExecNode(node_id)).</p></li><li><p><strong>只查 ID</strong>：先查出所有 Node 的基础信息，再查 Relation 表（Links），在内存中组装，通常比 Graph DB 做复杂的聚合（Map/Collect）要快。</p></li></ol><h3 id="6-综合改进后的代码结构建议"><a href="#6-综合改进后的代码结构建议" class="headerlink" title="6. 综合改进后的代码结构建议"></a>6. 综合改进后的代码结构建议</h3><p>这里给出一个集成优化思路的 EthereumTopologyHandler 核心方法重构示例：</p><p>codePython</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EthereumTopologyHandler</span>(<span class="hljs-title class_ inherited__">TopologyProvider</span>):<br>    <span class="hljs-comment"># ... init ...</span><br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_topology</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">"""获取完整的以太坊拓扑 (优化版)"""</span><br>        <span class="hljs-comment"># 1. 检查拓扑缓存 (Short TTL: e.g., 5s)</span><br>        <span class="hljs-comment"># 拓扑结构变化很快，缓存时间短一点</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._is_cache_valid(<span class="hljs-string">"full_ethereum_topology"</span>, ttl=<span class="hljs-number">5</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.cache[<span class="hljs-string">"full_ethereum_topology"</span>]<br><br>        <span class="hljs-comment"># 2. 并行获取数据</span><br>        <span class="hljs-comment"># A. 获取 Docker 映射 (从长效缓存或后台任务获取，极快)</span><br>        <span class="hljs-comment"># B. 获取 Neo4j 数据 (并发查询)</span><br>        <br>        task_docker = <span class="hljs-variable language_">self</span>._get_ip_to_container_map_optimized() <span class="hljs-comment"># 优化点1</span><br>        task_neo4j = <span class="hljs-variable language_">self</span>._get_real_topology_from_neo4j()       <span class="hljs-comment"># 优化点3 (并发内部实现)</span><br>        <br>        ip_map, (exec_data, cons_data) = <span class="hljs-keyword">await</span> asyncio.gather(task_docker, task_neo4j)<br><br>        <span class="hljs-comment"># 3. 转换数据 (CPU 密集型)</span><br>        <span class="hljs-comment"># 如果节点数非常多 (&gt;5000)，可以考虑放入 ProcessPoolExecutor</span><br>        nodes, links = <span class="hljs-variable language_">self</span>._convert_topology_format_optimized(exec_data, cons_data, ip_map)<br><br>        topology_data = {<br>            <span class="hljs-string">'nodes'</span>: nodes, <span class="hljs-string">'links'</span>: links, <span class="hljs-string">'timestamp'</span>: time.time(),<br>            <span class="hljs-comment"># ...</span><br>        }<br><br>        <span class="hljs-comment"># 更新缓存</span><br>        <span class="hljs-variable language_">self</span>.cache[<span class="hljs-string">"full_ethereum_topology"</span>] = topology_data<br>        <span class="hljs-variable language_">self</span>.last_update = time.time()<br>        <br>        <span class="hljs-keyword">return</span> topology_data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_convert_topology_format_optimized</span>(<span class="hljs-params">self, exec_data, cons_data, ip_map</span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        优化点：</span><br><span class="hljs-string">        1. 使用 ip_map.get 避免重复循环</span><br><span class="hljs-string">        2. 预计算 positions 字典，避免列表遍历查找</span><br><span class="hljs-string">        """</span><br>        nodes = []<br>        links = []<br>        <span class="hljs-comment"># 使用字典加速查找: key=node_id, value={idx, type, ...}</span><br>        node_lookup = {} <br>        <br>        <span class="hljs-comment"># ... 处理 Exec 节点 ...</span><br>        <span class="hljs-keyword">for</span> i, (nid, data) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(exec_data.items()):<br>            <span class="hljs-comment"># 直接查预热好的 Map，O(1)</span><br>            container = ip_map.get(data[<span class="hljs-string">'ip'</span>], <span class="hljs-string">f"exec-<span class="hljs-subst">{data[<span class="hljs-string">'ip'</span>]}</span>"</span>)<br>            <span class="hljs-comment"># ... 创建 node ...</span><br>            node_lookup[nid] = {<span class="hljs-string">'type'</span>: <span class="hljs-string">'execution'</span>, <span class="hljs-string">'id'</span>: <span class="hljs-string">f'<span class="hljs-subst">{nid}</span>-exec'</span>}<br>            <br>        <span class="hljs-comment"># ... 处理 Cons 节点 ...</span><br>        <br>        <span class="hljs-comment"># ... 处理连接 ...</span><br>        <span class="hljs-comment"># 只需要遍历一次 exec_data 的 peers，利用 node_lookup 快速验证</span><br>        <span class="hljs-keyword">for</span> nid, data <span class="hljs-keyword">in</span> exec_data.items():<br>             source_full_id = <span class="hljs-string">f"<span class="hljs-subst">{nid}</span>-exec"</span><br>             <span class="hljs-keyword">for</span> peer <span class="hljs-keyword">in</span> data.get(<span class="hljs-string">'peers'</span>, []):<br>                 target_nid = peer[<span class="hljs-string">'peer_id'</span>]<br>                 <span class="hljs-comment"># O(1) 检查目标是否存在</span><br>                 <span class="hljs-keyword">if</span> target_nid <span class="hljs-keyword">in</span> node_lookup <span class="hljs-keyword">and</span> node_lookup[target_nid][<span class="hljs-string">'type'</span>] == <span class="hljs-string">'execution'</span>:<br>                     links.append({<br>                         <span class="hljs-string">'source'</span>: source_full_id,<br>                         <span class="hljs-string">'target'</span>: <span class="hljs-string">f"<span class="hljs-subst">{target_nid}</span>-exec"</span>,<br>                         <span class="hljs-comment"># ...</span><br>                     })<br>                     <br>        <span class="hljs-keyword">return</span> nodes, links<br></code></pre></td></tr></table></figure><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>要进行性能优化，最关键的修改是：</p><ol><li><p><strong>Docker 映射</strong>：改为后台定时更新或长缓存，不要每秒都去 inspect 容器。</p></li><li><p><strong>物理带宽 (tc)</strong>：改为异步/后台获取，不要阻塞 API 响应。</p></li><li><p><strong>Neo4j</strong>：使用并发查询，并限制 Cypher 复杂度。</p></li></ol><hr><h2 id="攻击方式（Attack-Strategies）"><a href="#攻击方式（Attack-Strategies）" class="headerlink" title="攻击方式（Attack Strategies）"></a>攻击方式（Attack Strategies）</h2><p>系统目前支持以下6种攻击方式：</p><h3 id="1-节点断网攻击（Node-Disconnection-Attack）"><a href="#1-节点断网攻击（Node-Disconnection-Attack）" class="headerlink" title="1. 节点断网攻击（Node Disconnection Attack）"></a>1. 节点断网攻击（Node Disconnection Attack）</h3><p>通过网络隔离手段切断目标节点与其他节点的连接。支持的方法包括：</p><ul><li><code>interface_down</code>: 禁用网络接口</li><li><code>route_flush</code>: 清除路由表</li><li><code>firewall_block</code>: 防火墙阻断</li><li><code>p2p_block</code>: P2P连接阻断</li></ul><h3 id="2-通信干扰攻击（Communication-Interference-Attack）"><a href="#2-通信干扰攻击（Communication-Interference-Attack）" class="headerlink" title="2. 通信干扰攻击（Communication Interference Attack）"></a>2. 通信干扰攻击（Communication Interference Attack）</h3><p>通过大量无效通信干扰目标节点正常通信。支持的方法包括：</p><ul><li><code>json_rpc_flood</code>: JSON-RPC请求泛洪</li><li><code>p2p_flood</code>: P2P消息泛洪</li><li><code>memory_exhaustion</code>: 内存耗尽攻击</li></ul><h3 id="3-时间攻击（Timestamp-Attack）"><a href="#3-时间攻击（Timestamp-Attack）" class="headerlink" title="3. 时间攻击（Timestamp Attack）"></a>3. 时间攻击（Timestamp Attack）</h3><p>针对共识机制的时间同步进行攻击。支持的方法包括：</p><ul><li>time_shift: 时间偏移</li><li><code>ntp_block</code>: 阻断NTP时间同步</li><li><code>time_drift</code>: 时间漂移</li></ul><h3 id="4-简化Sybil攻击（Simplified-Sybil-Attack）"><a href="#4-简化Sybil攻击（Simplified-Sybil-Attack）" class="headerlink" title="4. 简化Sybil攻击（Simplified Sybil Attack）"></a>4. 简化Sybil攻击（Simplified Sybil Attack）</h3><p>创建虚假节点来影响网络。可以配置：</p><ul><li>虚假节点数量（1-20）</li><li>节点类型（轻节点、全节点、验证者节点）</li><li>网络环境（主网、测试网、开发网）</li><li>连接真实节点选项</li></ul><h3 id="5-存储攻击（Storage-Attack）"><a href="#5-存储攻击（Storage-Attack）" class="headerlink" title="5. 存储攻击（Storage Attack）"></a>5. 存储攻击（Storage Attack）</h3><p>针对节点存储系统的攻击。支持的方法包括：</p><ul><li><code>disk_fill</code>: 磁盘空间填充</li><li><code>database_corruption</code>: 数据库损坏</li><li><code>state_pollution</code>: 状态污染</li><li><code>chain_data_spam</code>: 链上数据垃圾信息</li></ul><h3 id="6-Geth-Lighthouse客户端攻击（Geth-Lighthouse-Attack）"><a href="#6-Geth-Lighthouse客户端攻击（Geth-Lighthouse-Attack）" class="headerlink" title="6. Geth/Lighthouse客户端攻击（Geth/Lighthouse Attack）"></a>6. Geth/Lighthouse客户端攻击（Geth/Lighthouse Attack）</h3><p>针对特定以太坊客户端的攻击。支持的方法包括：</p><ul><li><code>process_kill</code>: 终止进程</li><li><code>db_corruption</code>: 数据库损坏</li><li><code>port_blocking</code>: 端口阻断</li><li><code>config_modification</code>: 配置文件修改</li></ul><h2 id="攻击模式（Execution-Modes）"><a href="#攻击模式（Execution-Modes）" class="headerlink" title="攻击模式（Execution Modes）"></a>攻击模式（Execution Modes）</h2><p>系统支持三种攻击执行模式：</p><h3 id="1-一次性攻击（One-shot）"><a href="#1-一次性攻击（One-shot）" class="headerlink" title="1. 一次性攻击（One-shot）"></a>1. 一次性攻击（One-shot）</h3><p>执行一次攻击，持续指定时间后自动清理恢复。 配置参数：</p><ul><li>duration_seconds: 攻击持续时间（秒）</li></ul><h3 id="2-重复攻击（Repeated）"><a href="#2-重复攻击（Repeated）" class="headerlink" title="2. 重复攻击（Repeated）"></a>2. 重复攻击（Repeated）</h3><p>按指定间隔重复执行多次攻击。 配置参数：</p><ul><li>interval_seconds: 攻击间隔时间（秒）</li><li>repeat_count: 重复次数</li><li>duration_seconds: 每次攻击持续时间（秒）</li></ul><h3 id="3-持续攻击（Continuous）"><a href="#3-持续攻击（Continuous）" class="headerlink" title="3. 持续攻击（Continuous）"></a>3. 持续攻击（Continuous）</h3><p>持续不断地执行攻击，直到手动停止。 配置参数：</p><ul><li>interval_seconds: 攻击间隔时间（秒）</li><li>duration_seconds: 每次攻击持续时间（秒）</li></ul><h2 id="动态目标攻击"><a href="#动态目标攻击" class="headerlink" title="动态目标攻击"></a>动态目标攻击</h2><p>系统还支持一种特殊的动态目标攻击功能，可以根据网络拓扑分析结果自动选择攻击目标。支持的中心性指标包括：</p><ul><li>度中心性（Degree Centrality）</li><li>介数中心性（Betweenness Centrality）</li><li>接近中心性（Closeness Centrality）</li><li>特征向量中心性（Eigenvector Centrality）</li></ul><p>通过这些攻击方式和模式的组合，系统可以模拟各种真实的以太坊网络攻击场景，帮助评估网络的安全性和鲁棒性。</p><hr><h3 id="1-发起普通攻击-Standard-Attack"><a href="#1-发起普通攻击-Standard-Attack" class="headerlink" title="1. 发起普通攻击 (Standard Attack)"></a>1. 发起普通攻击 (Standard Attack)</h3><p>此接口用于对<strong>明确指定的静态 IP 列表</strong>发起攻击。</p><p><strong>Prompt / 接口说明:</strong></p><ul><li><p><strong>接口地址</strong>: POST /api/simulate</p></li><li><p><strong>功能</strong>: 发起针对特定静态目标（IP/ID列表）的攻击模拟。</p></li><li><p><strong>逻辑约束</strong>:</p><ol><li><p>parameters.target_nodes 必须是字符串数组 [“ip1”, “ip2”]。</p></li><li><p>支持所有三种执行模式 (one_shot, repeated, continuous)。</p></li></ol></li><li><p><strong>请求体构建规则</strong>:</p><ul><li><p><strong>Level 1 (执行配置)</strong>: 决定攻击的时间维度。</p><ul><li><p>若是 one_shot: 仅需 duration_seconds。</p></li><li><p>若是 repeated: 需额外提供 interval_seconds 和 repeat_count。</p></li></ul></li><li><p><strong>Level 2 (策略参数)</strong>: 决定攻击的具体手段。</p><ul><li><p>必须包含 strategy 字段（枚举值）。</p></li><li><p>其余字段根据 strategy 变化（如 storage_attack 需要 size_mb，而 node_disconnection 不需要）。</p></li></ul></li></ul></li></ul><p><strong>请求示例 (JSON):</strong></p><p>codeJSON</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 场景：对两个节点进行重复的 P2P 洪水攻击</span><br>{<br>  <span class="hljs-string">"execution_config"</span>: {<br>    <span class="hljs-string">"mode"</span>: <span class="hljs-string">"repeated"</span>,<br>    <span class="hljs-string">"duration_seconds"</span>: <span class="hljs-number">30</span>,<br>    <span class="hljs-string">"interval_seconds"</span>: <span class="hljs-number">60</span>,<br>    <span class="hljs-string">"repeat_count"</span>: <span class="hljs-number">5</span><br>  },<br>  <span class="hljs-string">"parameters"</span>: {<br>    <span class="hljs-string">"strategy"</span>: <span class="hljs-string">"communication_interference"</span>,<br>    <span class="hljs-string">"method"</span>: <span class="hljs-string">"p2p_flood"</span>,<br>    <span class="hljs-string">"intensity"</span>: <span class="hljs-string">"high"</span>,<br>    <span class="hljs-string">"target_nodes"</span>: <span class="hljs-selector-attr">[<span class="hljs-string">"192.168.1.10"</span>, <span class="hljs-string">"192.168.1.11"</span>]</span><br>  }<br>}<br></code></pre></td></tr></table></figure><hr><h3 id="2-发起自适应攻击-Adaptive-Attack"><a href="#2-发起自适应攻击-Adaptive-Attack" class="headerlink" title="2. 发起自适应攻击 (Adaptive Attack)"></a>2. 发起自适应攻击 (Adaptive Attack)</h3><p>此接口用于<strong>动态目标</strong>攻击，系统会在每一轮攻击开始前重新计算受害者（例如：总是攻击网络中连接数最多的节点）。</p><p><strong>Prompt / 接口说明:</strong></p><ul><li><p><strong>接口地址</strong>: POST /api/simulate/adaptive</p></li><li><p><strong>功能</strong>: 发起自适应攻击，目标由后端实时计算。</p></li><li><p><strong>关键区别</strong>:</p><ol><li><p><strong>不支持</strong> one_shot 模式（因为一次性攻击不需要”自适应”变化）。必须是 repeated 或 continuous。</p></li><li><p>parameters.target_nodes <strong>必须</strong>是特定格式的字符串指令，以 dynamic: 开头。</p></li></ol></li><li><p><strong>目标指令语法</strong>: dynamic:{指标}:{选择策略}</p><ul><li><p>示例: dynamic:degree:top:5 (度中心性最高的前5个)</p></li><li><p>示例: dynamic:betweenness:highest (介数中心性最高的1个)</p></li></ul></li></ul><p><strong>请求示例 (JSON):</strong></p><p>codeJSON</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 场景：持续攻击网络中度中心性最高的前5个节点</span><br><span class="hljs-punctuation">{</span><br>  <span class="hljs-attr">"execution_config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"continuous"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"duration_seconds"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"interval_seconds"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><br>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_disconnection"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"firewall_block"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"target_nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic:degree:top:5"</span> <span class="hljs-comment">// 注意这里是字符串</span><br>  <span class="hljs-punctuation">}</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><hr><h3 id="3-前端分流逻辑-Frontend-Logic"><a href="#3-前端分流逻辑-Frontend-Logic" class="headerlink" title="3. 前端分流逻辑 (Frontend Logic)"></a>3. 前端分流逻辑 (Frontend Logic)</h3><p>这是前端 Vue 组件如何决定调用哪个接口的核心逻辑说明。</p><p><strong>Prompt / 逻辑说明:</strong></p><p>前端在点击”发起攻击”按钮时，必须执行以下判断逻辑：</p><ol><li><p><strong>检查目标类型</strong>:</p><ul><li><p>获取用户在表单中输入的目标配置。</p></li><li><p>如果目标是<strong>字符串指令</strong>且以 dynamic: 开头 -&gt; 标记为 isDynamic。</p></li><li><p>如果目标是<strong>手动输入的 IP 列表</strong> -&gt; 标记为 isStatic。</p></li></ul></li><li><p><strong>检查执行模式</strong>:</p><ul><li>获取用户选择的模式 (one_shot, repeated, continuous)。</li></ul></li><li><p><strong>路由决策树</strong>:</p><ul><li><p><strong>IF</strong> (isDynamic == True <strong>AND</strong> mode == one_shot):</p><ul><li>❌ <strong>报错</strong>: 自适应攻击不支持一次性模式。</li></ul></li><li><p><strong>IF</strong> (isDynamic == True <strong>AND</strong> mode != one_shot):</p><ul><li><p>✅ <strong>调用接口</strong>: POST /api/simulate/adaptive</p></li><li><p><strong>注意</strong>: 此时 target_nodes 字段发送字符串。</p></li></ul></li><li><p><strong>ELSE</strong> (即静态目标，无论什么模式):</p><ul><li><p>✅ <strong>调用接口</strong>: POST /api/simulate</p></li><li><p><strong>注意</strong>: 此时 target_nodes 字段必须转换为数组 [] 发送。</p></li></ul></li></ul></li></ol><hr><h3 id="4-停止攻击-Stop-Attack"><a href="#4-停止攻击-Stop-Attack" class="headerlink" title="4. 停止攻击 (Stop Attack)"></a>4. 停止攻击 (Stop Attack)</h3><p><strong>Prompt / 接口说明:</strong></p><ul><li><p><strong>接口地址</strong>: DELETE /api/simulations/{attack_id}</p></li><li><p><strong>功能</strong>: 立即终止一个正在运行 (running) 或挂起 (pending) 的攻击任务。</p></li><li><p><strong>适用场景</strong>:</p><ul><li><p>用户点击”紧急停止”按钮。</p></li><li><p>用于中断 continuous (无限持续) 类型的攻击。</p></li><li><p>用于中断剩余轮次尚未执行的 repeated 攻击。</p></li></ul></li><li><p><strong>后端行为</strong>:</p><ul><li><p>取消对应的 asyncio.Task。</p></li><li><p>执行清理逻辑（如恢复防火墙规则、删除垃圾文件）。</p></li><li><p>将数据库中的状态更新为 stopped。</p></li></ul></li></ul><hr><h3 id="5-状态轮询与监控-Monitoring"><a href="#5-状态轮询与监控-Monitoring" class="headerlink" title="5. 状态轮询与监控 (Monitoring)"></a>5. 状态轮询与监控 (Monitoring)</h3><p><strong>Prompt / 接口说明:</strong></p><p>为了在前端展示”实时状态”和”系统日志”，需要配合使用以下两个接口：</p><ol><li><p><strong>获取活跃列表</strong>: GET /api/simulations/active</p><ul><li><p><strong>用途</strong>: 判断当前是否有攻击在跑 (isRunning 状态)。</p></li><li><p><strong>频率</strong>: 建议每 3-5 秒轮询一次。</p></li><li><p><strong>返回</strong>: 包含 progress (进度百分比) 和 current_round (当前轮次)。</p></li></ul></li><li><p><strong>获取详情/日志</strong>: GET /api/simulations/{attack_id}</p><ul><li><p><strong>用途</strong>: 获取特定攻击的详细日志流。</p></li><li><p><strong>返回</strong>: 包含 logs 数组 ([“Attack started”, “Round 1 finished”])。</p></li><li><p><strong>前端展示</strong>: 将 logs 渲染到控制台面板中。</p></li></ul></li></ol><hr><h3 id="总结：数据结构对照表-Type-Mapping"><a href="#总结：数据结构对照表-Type-Mapping" class="headerlink" title="总结：数据结构对照表 (Type Mapping)"></a>总结：数据结构对照表 (Type Mapping)</h3><div class="table-container"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>参数字段</td><td>描述</td><td>类型限制</td></tr><tr><td><strong>execution_config</strong></td><td></td><td></td></tr><tr><td>mode</td><td>执行模式</td><td>“one_shot” \</td><td>“repeated” \</td><td>“continuous”</td></tr><tr><td>duration_seconds</td><td>单次持续时长</td><td>Integer (秒)</td></tr><tr><td>interval_seconds</td><td>轮次间隔</td><td>Integer (秒), 仅 repeated/continuous 有效</td></tr><tr><td>repeat_count</td><td>重复次数</td><td>Integer, 仅 repeated 有效</td></tr><tr><td><strong>parameters</strong></td><td></td><td></td></tr><tr><td>strategy</td><td>攻击策略</td><td>“node_disconnection” \</td><td>“storage_attack” …</td></tr><tr><td>target_nodes</td><td>攻击目标</td><td>Array [str] (普通) <strong>OR</strong> String dynamic:… (自适应)</td></tr><tr><td>method</td><td>具体手段</td><td>依赖于 strategy (如 firewall_block, disk_fill)</td></tr><tr><td>…</td><td>其他参数</td><td>依赖于 strategy (如 size_mb, intensity)</td></tr></tbody></table></div><hr><h3 id="1-全局枚举定义-Global-Enums"><a href="#1-全局枚举定义-Global-Enums" class="headerlink" title="1. 全局枚举定义 (Global Enums)"></a>1. 全局枚举定义 (Global Enums)</h3><p>这些枚举值用于填充请求体中的特定字段。</p><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>枚举类型</td><td>字段名</td><td>可选值 (Value)</td><td>说明</td></tr><tr><td><strong>执行模式</strong></td><td>mode</td><td>one_shot</td><td><strong>一次性</strong>：执行一次，持续指定时间后恢复。</td></tr><tr><td></td><td></td><td>repeated</td><td><strong>重复执行</strong>：按间隔重复执行多次。</td></tr><tr><td></td><td></td><td>continuous</td><td><strong>持续执行</strong>：按间隔无限执行，直到手动停止。</td></tr><tr><td><strong>攻击策略</strong></td><td>strategy</td><td>node_disconnection</td><td>节点断连攻击</td></tr><tr><td></td><td></td><td>communication_interference</td><td>通信干扰攻击</td></tr><tr><td></td><td></td><td>storage_attack</td><td>存储耗尽攻击</td></tr><tr><td></td><td></td><td>timestamp_attack</td><td>时间/NTP攻击</td></tr><tr><td></td><td></td><td>simplified_sybil_attack</td><td>简化版女巫攻击</td></tr><tr><td></td><td></td><td>geth_lighthouse_attack</td><td>客户端特定攻击 (Geth/Lighthouse)</td></tr></tbody></table></div><hr><h3 id="2-执行配置-execution-config"><a href="#2-执行配置-execution-config" class="headerlink" title="2. 执行配置 (execution_config)"></a>2. 执行配置 (execution_config)</h3><p>根据 mode 的不同，所需字段不同。<strong>注意：自适应攻击接口 (/simulate/adaptive) 不支持 one_shot。</strong></p><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>模式 (Mode)</td><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>约束/说明</td></tr><tr><td><strong>通用</strong></td><td>duration_seconds</td><td>Int</td><td>✅</td><td>30</td><td>攻击生效持续时间 (秒)，&gt;=1</td></tr><tr><td><strong>Repeated</strong></td><td>interval_seconds</td><td>Int</td><td>✅</td><td>60</td><td>轮次间隔时间 (秒)，&gt;=1</td></tr><tr><td>(重复)</td><td>repeat_count</td><td>Int</td><td>✅</td><td>-</td><td>重复执行的总轮数，&gt;=1</td></tr><tr><td><strong>Continuous</strong></td><td>interval_seconds</td><td>Int</td><td>✅</td><td>60</td><td>轮次间隔时间 (秒)，&gt;=1</td></tr></tbody></table></div><hr><h3 id="3-策略参数详情-parameters"><a href="#3-策略参数详情-parameters" class="headerlink" title="3. 策略参数详情 (parameters)"></a>3. 策略参数详情 (parameters)</h3><p>此部分为多态结构，根据 strategy 字段的值，JSON 结构发生变化。</p><h4 id="3-1-节点断连-node-disconnection"><a href="#3-1-节点断连-node-disconnection" class="headerlink" title="3.1 节点断连 (node_disconnection)"></a>3.1 节点断连 (node_disconnection)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>method</td><td>String</td><td>✅</td><td>-</td><td>interface_down (网卡下线), route_flush (清空路由), firewall_block (防火墙), p2p_block (P2P阻断)</td></tr><tr><td>target_nodes</td><td>Array/Str</td><td>✅</td><td>-</td><td>静态IP列表 或 动态指令 (见第4节)</td></tr></tbody></table></div><h4 id="3-2-通信干扰-communication-interference"><a href="#3-2-通信干扰-communication-interference" class="headerlink" title="3.2 通信干扰 (communication_interference)"></a>3.2 通信干扰 (communication_interference)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>method</td><td>String</td><td>✅</td><td>-</td><td>json_rpc_flood (RPC泛洪), p2p_flood (P2P泛洪), memory_exhaustion (内存耗尽)</td></tr><tr><td>intensity</td><td>String</td><td>❌</td><td>medium</td><td>low, medium, high, extreme</td></tr><tr><td>target_nodes</td><td>Array/Str</td><td>✅</td><td>-</td><td>静态IP列表 或 动态指令</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table></div><h4 id="3-3-存储攻击-storage-attack"><a href="#3-3-存储攻击-storage-attack" class="headerlink" title="3.3 存储攻击 (storage_attack)"></a>3.3 存储攻击 (storage_attack)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>method</td><td>String</td><td>✅</td><td>-</td><td>disk_fill (填充), database_corruption (脏数据), state_pollution (状态污染), chain_data_spam (链上垃圾)</td></tr><tr><td>size_mb</td><td>Int</td><td>❌</td><td>1000</td><td>填充大小 (MB)，100 - 10000</td></tr><tr><td>file_count</td><td>Int</td><td>❌</td><td>100</td><td>生成文件数量，10 - 1000</td></tr><tr><td>target_nodes</td><td>Array/Str</td><td>✅</td><td>-</td><td>静态IP列表 或 动态指令</td></tr></tbody></table></div><h4 id="3-4-时间攻击-timestamp-attack"><a href="#3-4-时间攻击-timestamp-attack" class="headerlink" title="3.4 时间攻击 (timestamp_attack)"></a>3.4 时间攻击 (timestamp_attack)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>method</td><td>String</td><td>✅</td><td>-</td><td>time_shift (平移), ntp_block (NTP阻断), time_drift (漂移)</td></tr><tr><td>time_shift</td><td>String</td><td>❌</td><td>+1 hour</td><td>偏移量 (如 +1 hour, -30 minutes)，仅 time_shift 方法有效</td></tr><tr><td>drift_seconds</td><td>Int</td><td>❌</td><td>3600</td><td>漂移秒数，-86400 到 86400，仅 time_drift 方法有效</td></tr><tr><td>target_nodes</td><td>Array/Str</td><td>✅</td><td>-</td><td>静态IP列表 或 动态指令</td></tr></tbody></table></div><h4 id="3-5-女巫攻击-simplified-sybil-attack"><a href="#3-5-女巫攻击-simplified-sybil-attack" class="headerlink" title="3.5 女巫攻击 (simplified_sybil_attack)"></a>3.5 女巫攻击 (simplified_sybil_attack)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>fake_node_count</td><td>Int</td><td>❌</td><td>5</td><td>虚假节点数量 (1-20)</td></tr><tr><td>node_type</td><td>String</td><td>❌</td><td>light</td><td>light (轻节点), full (全节点), validator (验证者)</td></tr><tr><td>network</td><td>String</td><td>❌</td><td>testnet</td><td>mainnet, testnet, devnet</td></tr><tr><td>connect_to_real</td><td>Bool</td><td>❌</td><td>True</td><td>是否连接真实节点</td></tr><tr><td>min_connections</td><td>Int</td><td>❌</td><td>3</td><td>最小连接数 (0-10)</td></tr><tr><td>target_nodes</td><td>-</td><td>-</td><td>-</td><td><strong>注意：此策略通常不需要指定具体目标节点</strong></td></tr></tbody></table></div><h4 id="3-6-客户端攻击-geth-lighthouse-attack"><a href="#3-6-客户端攻击-geth-lighthouse-attack" class="headerlink" title="3.6 客户端攻击 (geth_lighthouse_attack)"></a>3.6 客户端攻击 (geth_lighthouse_attack)</h4><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>默认值</td><td>描述/选项</td></tr><tr><td>method</td><td>String</td><td>✅</td><td>-</td><td>process_kill, db_corruption, port_blocking, config_modification</td></tr><tr><td>attack_type</td><td>String</td><td>✅</td><td>-</td><td>geth, lighthouse (指定攻击的客户端类型)</td></tr><tr><td>target_nodes</td><td>Array/Str</td><td>✅</td><td>-</td><td>静态IP列表 或 动态指令</td></tr></tbody></table></div><hr><h3 id="4-目标节点配置-target-nodes"><a href="#4-目标节点配置-target-nodes" class="headerlink" title="4. 目标节点配置 (target_nodes)"></a>4. 目标节点配置 (target_nodes)</h3><p>target_nodes 字段在不同接口下有严格的格式要求。</p><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>接口端点</td><td>格式类型</td><td>数据结构示例</td><td>说明</td></tr><tr><td>/api/simulate</td><td><strong>静态列表</strong></td><td>[“192.168.1.10”, “node_id_123”]</td><td>明确指定要攻击的节点列表。</td></tr><tr><td>/api/simulate/adaptive</td><td><strong>动态指令</strong></td><td>“dynamic:degree:top:5”</td><td>字符串格式，后端自动计算目标。</td></tr></tbody></table></div><p><strong>动态指令语法:</strong> dynamic:{指标}:{选择器}</p><ol><li><p><strong>指标 (Metric)</strong>:</p><ul><li><p>degree (度中心性)</p></li><li><p>betweenness (介数中心性)</p></li><li><p>closeness (接近中心性)</p></li><li><p>eigenvector (特征向量中心性)</p></li></ul></li><li><p><strong>选择器 (Selector)</strong>:</p><ul><li><p>highest (选最高的1个)</p></li><li><p>top:N (选前 N 个，N为数字)</p></li></ul></li></ol><hr><h3 id="5-防护配置-defense-enable"><a href="#5-防护配置-defense-enable" class="headerlink" title="5. 防护配置 (/defense/enable)"></a>5. 防护配置 (/defense/enable)</h3><div class="table-container"><table><thead><tr><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>字段名</td><td>类型</td><td>必填</td><td>示例</td><td>说明</td></tr><tr><td>enabled</td><td>Bool</td><td>❌</td><td>true</td><td>是否启用防护</td></tr><tr><td>rules</td><td>Object</td><td>✅</td><td>{“rate_limit”: 100}</td><td>防护规则字典，具体Key由后端逻辑决定</td></tr></tbody></table></div><hr><h3 id="6-响应结构概览"><a href="#6-响应结构概览" class="headerlink" title="6. 响应结构概览"></a>6. 响应结构概览</h3><p>所有接口通常遵循统一的响应格式：</p><p>codeJSON</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">{<br>  <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,  <span class="hljs-string">//</span> 或 <span class="hljs-string">"error"</span><br>  <span class="hljs-string">"message"</span>: <span class="hljs-string">"操作描述"</span>,<br>  <span class="hljs-string">"data"</span>: { <span class="hljs-string">...</span> }       <span class="hljs-string">//</span> 具体业务数据<br>}<br></code></pre></td></tr></table></figure><p><strong>关键数据字段 (data)</strong>:</p><ul><li><p>attack_id: (String) 攻击任务的唯一标识符。</p></li><li><p>status: (Enum) pending, running, completed, failed, stopped, cancelled。</p></li><li><p>logs: (Array[Str]) 攻击日志列表。</p></li></ul><p>{<br>  “nodes”: [<br>    {<br>      “id”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”,<br>      “name”: “Tether USD (USDT)”,<br>      “type”: “ERC20”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 5<br>    },<br>    {<br>      “id”: “0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48”,<br>      “name”: “USD Coin (USDC)”,<br>      “type”: “ERC20”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 3<br>    },<br>    {<br>      “id”: “0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984”,<br>      “name”: “Uniswap V3: Router”,<br>      “type”: “Router”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 8<br>    },<br>    {<br>      “id”: “0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45”,<br>      “name”: “Uniswap V3: SwapRouter02”,<br>      “type”: “SwapRouter”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 6<br>    },<br>    {<br>      “id”: “0xE592427A0AEce92De3Edee1F18E0157C05861564”,<br>      “name”: “Uniswap V3: Quoter”,<br>      “type”: “Quoter”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 4<br>    },<br>    {<br>      “id”: “0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D”,<br>      “name”: “Uniswap V2: Router”,<br>      “type”: “Router”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 7<br>    },<br>    {<br>      “id”: “0x881D40237659C251811CEC9c364ef91dC08D300C”,<br>      “name”: “Curve: 3pool Controller”,<br>      “type”: “CurvePool”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 4<br>    },<br>    {<br>      “id”: “0xbEbc44782C7dB0a1A60Cb6fe97d0b483032FF1C7”,<br>      “name”: “Curve: 3pool Gauge”,<br>      “type”: “Gauge”,<br>      “ip_address”: “”,<br>      “status”: “active”,<br>      “layer”: “contract”,<br>      “container_name”: null,<br>      “neighbor_count”: 2<br>    }<br>  ],<br>  “links”: [<br>    { “source”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”, “target”: “0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45”, “type”: “transfer_approve” },<br>    { “source”: “0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45”, “target”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”, “type”: “swap_out” },<br>    { “source”: “0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45”, “target”: “0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48”, “type”: “swap_in” },<br>    { “source”: “0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48”, “target”: “0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984”, “type”: “call” },<br>    { “source”: “0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984”, “target”: “0xE592427A0AEce92De3Edee1F18E0157C05861564”, “type”: “quote” },<br>    { “source”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”, “target”: “0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D”, “type”: “approve” },<br>    { “source”: “0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D”, “target”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”, “type”: “swap” },<br>    { “source”: “0xdAC17F958D2ee523a2206206994597C13D831ec7”, “target”: “0x881D40237659C251811CEC9c364ef91dC08D300C”, “type”: “deposit” },<br>    { “source”: “0x881D40237659C251811CEC9c364ef91dC08D300C”, “target”: “0xbEbc44782C7dB0a1A60Cb6fe97d0b483032FF1C7”, “type”: “stake” }<br>  ],<br>  “timestamp”: 1765095677.891234,<br>  “data_source”: “real_web3”,<br>  “topology_type”: “contract”<br>}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TB<br>    A[ETH前端] --&gt; B[src]<br>    A --&gt; C[package.json]<br>    A --&gt; D[index.html]<br>    A --&gt; E[vite.config.ts]<br>    A --&gt; F[README.md]<br>    A --&gt; G[public]<br>    <br>    B --&gt; H[__tests__]<br>    B --&gt; I[api]<br>    B --&gt; J[assets]<br>    B --&gt; K[components]<br>    B --&gt; L[composables]<br>    B --&gt; M[router]<br>    B --&gt; N[services]<br>    B --&gt; O[types]<br>    B --&gt; P[utils]<br>    B --&gt; Q[views]<br>    B --&gt; R[App.vue]<br>    B --&gt; S[main.ts]<br>    <br>    I --&gt; T[api_docs]<br>    I --&gt; U[attack]<br>    <br>    J --&gt; V[styles]<br>    V --&gt; W[global.css]<br>    V --&gt; X[tailwind.css]<br>    <br>    K --&gt; Y[blockchain]<br>    K --&gt; Z[common]<br>    K --&gt; AA[layout]<br>    K --&gt; AB[tabs]<br>    K --&gt; AC[topology]<br>    <br>    Y --&gt; AD[BlockchainCanvas.vue]<br>    Y --&gt; AE[BlockchainInfoPanel.vue]<br>    Y --&gt; AF[BlockchainModal.vue]<br>    Y --&gt; AG[BlockchainVisualization.vue]<br>    Y --&gt; AH[composables]<br>    Y --&gt; AI[types]<br>    <br>    AH --&gt; AJ[useBlockchainAPI.ts]<br>    AH --&gt; AK[useBlockchainAnimations.ts]<br>    AH --&gt; AL[useBlockchainData.ts]<br>    AH --&gt; AM[useBlockchainEvents.ts]<br>    AH --&gt; AN[useBlockchainRenderer.ts]<br>    AH --&gt; AO[useBlockchainScrolling.ts]<br>    <br>    Z --&gt; AP[ContainerTerminal.vue]<br>    Z --&gt; AQ[DEP-TERM.vue]<br>    Z --&gt; AR[StandaloneTerminal.vue]<br>    Z --&gt; AS[Terminal.vue]<br>    Z --&gt; AT[websocket_terminal8080.vue]<br>    <br>    AA --&gt; AU[DashboardHeader.vue]<br>    AA --&gt; AV[LeftPanel.vue]<br>    AA --&gt; AW[PanelSplitter.vue]<br>    AA --&gt; AX[RightPanel.vue]<br>    <br>    AB --&gt; AY[AttackMonitoringTab.vue]<br>    AB --&gt; AZ[Attack_sys]<br>    AB --&gt; BA[BlockchainBrowserTab.css]<br>    AB --&gt; BB[BlockchainBrowserTab.vue]<br>    AB --&gt; BC[ContainerListTab.vue]<br>    AB --&gt; BD[NetworkTopologyTab.vue]<br>    AB --&gt; BE[sections]<br>    AB --&gt; BF[tabstyle.css]<br>    <br>    AZ --&gt; BG[AttackSystemTab.vue]<br>    BE --&gt; BH[Network-analysis.vue]<br>    BE --&gt; BI[NodeInfoPanel.vue]<br>    BE --&gt; BJ[RealTimeMonitoring.vue]<br>    <br>    AC --&gt; BK[ContractTopology.vue]<br>    AC --&gt; BL[Ethereum_Topology]<br>    AC --&gt; BM[Physical_Topology]<br>    AC --&gt; BN[TopologyVisualization.vue]<br>    AC --&gt; BO[TransactionTopology.vue]<br>    AC --&gt; BP[composables]<br>    AC --&gt; BQ[types]<br>    <br>    BL --&gt; BR[types]<br>    BL --&gt; BS[workers]<br>    BL --&gt; BT[EthereumTopology_new.vue]<br>    BL --&gt; BU[useD3Renderer.ts]<br>    BL --&gt; BV[use_topology_core.ts]<br>    BL --&gt; BW[use_topology_visuals.ts]<br>    <br>    BM --&gt; BX[composables]<br>    BM --&gt; BY[PhysicalTopology.vue]<br>    <br>    BP --&gt; BZ[index.ts]<br>    BP --&gt; CA[topology.css]<br>    BP --&gt; CB[useTopologyAPI.ts]<br>    BP --&gt; CC[useTopologyData.ts]<br>    BP --&gt; CD[useTopologyRendererBase.ts]<br>    <br>    L --&gt; CE[useDashboardData.ts]<br>    L --&gt; CF[useDashboardLayout.ts]<br>    L --&gt; CG[useDashboardTabs.ts]<br>    <br>    M --&gt; CH[index.ts]<br>    <br>    N --&gt; CI[analysis.ts]<br>    N --&gt; CJ[api.ts]<br>    N --&gt; CK[apiService.ts]<br>    N --&gt; CL[attack.ts]<br>    N --&gt; CM[blockchain.ts]<br>    N --&gt; CN[daily-operations.ts]<br>    N --&gt; CO[device-monitoring.ts]<br>    N --&gt; CP[execution.ts]<br>    N --&gt; CQ[foundation.ts]<br>    N --&gt; CR[monitoring.ts]<br>    N --&gt; CS[readme.md]<br>    N --&gt; CT[root-api.ts]<br>    N --&gt; CU[security.ts]<br>    N --&gt; CV[temporal.ts]<br>    N --&gt; CW[topology.ts]<br>    <br>    O --&gt; CX[topology.ts]<br>    <br>    P --&gt; CY[http.ts]<br>    P --&gt; CZ[index.ts]<br>    P --&gt; DA[types.ts]<br>    <br>    Q --&gt; DB[BlockchainTest.vue]<br>    Q --&gt; DC[Dashboard.vue]<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;性能优化 (Web Workers)&lt;/strong&gt;: 目前的数据获取、解析和Diff算法都在&lt;strong&gt;主线程&lt;/strong&gt;运行。当拓扑变大时，计算Diff会导致页面卡顿。建议将这部分移至 &lt;strong&gt;Web Worker&lt;</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-12-05-字节工训营画布项目相关设计</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/17798.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/17798.html</id>
    <published>2025-12-04T18:00:16.000Z</published>
    <updated>2025-12-25T03:23:33.848Z</updated>
    
    <content type="html"><![CDATA[<h1 id="BDdraw-DEV"><a href="#BDdraw-DEV" class="headerlink" title="BDdraw_DEV"></a>BDdraw_DEV</h1><p>代码仓库：<br><a href="https://github.com/Zhongye1/BDdraw_DEV">https://github.com/Zhongye1/BDdraw_DEV</a></p><p>现代协同 2D 画布编辑器 · React 18 + TypeScript + Vite + TailwindCSS + Zustand + PixiJS v8</p><h4 id="技术栈-·-Tech-Stack"><a href="#技术栈-·-Tech-Stack" class="headerlink" title="技术栈 · Tech Stack"></a>技术栈 · Tech Stack</h4><p class='item-img' data-src='https://img.shields.io/badge/React-18.2.0-61DAFB?logo=react&logoColor=white'><img src="https://img.shields.io/badge/React-18.2.0-61DAFB?logo=react&logoColor=white" alt="React 18"> <img src="https://img.shields.io/badge/TypeScript-5.3.3-3178C6?logo=typescript&logoColor=white" alt="TypeScript 5" class='item-img' data-src='https://img.shields.io/badge/TypeScript-5.3.3-3178C6?logo=typescript&logoColor=white'><img src="https://img.shields.io/badge/TypeScript-5.3.3-3178C6?logo=typescript&logoColor=white" alt="TypeScript 5"> <img src="https://img.shields.io/badge/React_Router-6-CA4245?logo=reactrouter&logoColor=white" alt="React Router 6" class='item-img' data-src='https://img.shields.io/badge/React_Router-6-CA4245?logo=reactrouter&logoColor=white'><img src="https://img.shields.io/badge/React_Router-6-CA4245?logo=reactrouter&logoColor=white" alt="React Router 6"> <img src="https://img.shields.io/badge/tailwindcss--animate-1.0.7-06B6D4" alt="animate" class='item-img' data-src='https://img.shields.io/badge/tailwindcss--animate-1.0.7-06B6D4'><img src="https://img.shields.io/badge/tailwindcss--animate-1.0.7-06B6D4" alt="animate"> <img src="https://img.shields.io/badge/Arco_Design-2.66.8-006AFF?logo=arco-design&logoColor=white" alt="Arco Design" class='item-img' data-src='https://img.shields.io/badge/Arco_Design-2.66.8-006AFF?logo=arco-design&logoColor=white'><img src="https://img.shields.io/badge/Arco_Design-2.66.8-006AFF?logo=arco-design&logoColor=white" alt="Arco Design"> <img src="https://img.shields.io/badge/Lucide_React-0.554.0-000000?logo=lucide&logoColor=white" alt="Lucide" class='item-img' data-src='https://img.shields.io/badge/Lucide_React-0.554.0-000000?logo=lucide&logoColor=white'><img src="https://img.shields.io/badge/Lucide_React-0.554.0-000000?logo=lucide&logoColor=white" alt="Lucide"> <img src="https://img.shields.io/badge/Immer-10.2.0-00E0C8?logo=immer&logoColor=white" alt="Immer" class='item-img' data-src='https://img.shields.io/badge/Immer-10.2.0-00E0C8?logo=immer&logoColor=white'><img src="https://img.shields.io/badge/Immer-10.2.0-00E0C8?logo=immer&logoColor=white" alt="Immer"> <img src="https://img.shields.io/badge/PixiJS-8.14.3-CC0066?logo=pixijs&logoColor=white" alt="PixiJS v8" class='item-img' data-src='https://img.shields.io/badge/PixiJS-8.14.3-CC0066?logo=pixijs&logoColor=white'><img src="https://img.shields.io/badge/PixiJS-8.14.3-CC0066?logo=pixijs&logoColor=white" alt="PixiJS v8"> <img src="https://img.shields.io/badge/Tiptap-3.11.0-1F1F1F?logo=tiptap&logoColor=white" alt="Tiptap v3" class='item-img' data-src='https://img.shields.io/badge/Tiptap-3.11.0-1F1F1F?logo=tiptap&logoColor=white'><img src="https://img.shields.io/badge/Tiptap-3.11.0-1F1F1F?logo=tiptap&logoColor=white" alt="Tiptap v3"> <img src="https://img.shields.io/badge/Framer_Motion-12.23.24-9D5CFF?logo=framer&logoColor=white" alt="Framer Motion 12" class='item-img' data-src='https://img.shields.io/badge/Framer_Motion-12.23.24-9D5CFF?logo=framer&logoColor=white'><img src="https://img.shields.io/badge/Framer_Motion-12.23.24-9D5CFF?logo=framer&logoColor=white" alt="Framer Motion 12"> <img src="https://img.shields.io/badge/nanoid-5.1.6-000000" alt="nanoid" class='item-img' data-src='https://img.shields.io/badge/nanoid-5.1.6-000000'><img src="https://img.shields.io/badge/nanoid-5.1.6-000000" alt="nanoid"> <img src="https://img.shields.io/badge/ESLint-8.38.0-4B32C3?logo=eslint&logoColor=white" alt="ESLint" class='item-img' data-src='https://img.shields.io/badge/ESLint-8.38.0-4B32C3?logo=eslint&logoColor=white'><img src="https://img.shields.io/badge/ESLint-8.38.0-4B32C3?logo=eslint&logoColor=white" alt="ESLint"> <img src="https://img.shields.io/badge/Husky-8.0.3-7711A4" alt="Husky" class='item-img' data-src='https://img.shields.io/badge/Husky-8.0.3-7711A4'><img src="https://img.shields.io/badge/Husky-8.0.3-7711A4" alt="Husky"> <img src="https://img.shields.io/badge/Deploy-GitHub_Pages-222222?logo=githubpages&logoColor=white" alt="GitHub Pages"></p><h4 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h4><p><strong>frontend</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:Zhongye1/BDdraw_DEV.git<br><br><span class="hljs-built_in">cd</span> BDdraw_DEV (进入项目)<br>bun install (安装依赖包)<br>bun start (启动服务)<br></code></pre></td></tr></table></figure><p><strong>backend</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> BDdraw_DEV/ALD_Backend/<br>bun install <span class="hljs-comment">#安装依赖</span><br>bun index.ts  <span class="hljs-comment">#启动后端服务</span><br></code></pre></td></tr></table></figure><p>推荐使用 bun 包管理器，见个人博客</p><p><a href="https://zhongye1.github.io/Arknight-notes/posts/15722.html">关于包管理器 npm,pnpm,yarn 和 bun 以及我为何选择后者</a></p><h4 id="Docker-部署"><a href="#Docker-部署" class="headerlink" title="Docker 部署"></a>Docker 部署</h4><p>项目支持通过 Docker 进行容器化部署，使用 Node 22 和 Bun 包管理器。</p><p><strong>开发环境部署：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></table></figure><p><strong>生产环境部署：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose -f docker-compose.prod.yml up -d<br></code></pre></td></tr></table></figure><p>部署完成后，可以通过以下地址访问：</p><ul><li>前端应用: <a href="http://localhost:5000/BDdraw_DEV/">http://localhost:5000/BDdraw_DEV/</a></li><li>后端 API 文档: <a href="http://localhost:3000/swagger-ui">http://localhost:3000/swagger-ui</a></li></ul><h4 id="整体架构设计"><a href="#整体架构设计" class="headerlink" title="整体架构设计"></a>整体架构设计</h4><p>项目采用了模块化的架构设计，将不同的功能划分为独立的模块，以方便后续维护和扩展</p><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul><li>60 FPS 渲染（得益于 PixiJS WebGL）</li><li>完整撤销/重做（Command Pattern + 防抖快照）</li><li>多元素选择与群组操作</li><li>画布元素变换控制器</li><li>富文本所见即所得编辑（WanngEditor + PIXI.HTMLText）</li><li>图片插入 + 内置滤镜（模糊、亮度、灰度等）</li><li>插件式元素系统</li><li>插件式元素系统</li><li>完整的 TypeScript 类型支持</li><li>现代开发体验（Vite + ESLint + Prettier + Husky）</li><li>集成 GitHub-Actions 支持， 实现每次 push 到 main 分支后，GitHub 自动构建 → 自动发布页面的操作</li></ul><hr><h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><p>这时候需要简单做一个技术选型分析，根据任务拆解，选择了如下技术栈</p><p><strong>【框架】</strong>【技术方案：采用 React 18 + TypeScript 5 构建应用，React 提供完整的 UI 生态，TypeScript 提供更清晰可靠的类型安全，相比 JavaScript 更易于维护】</p><p><strong>【构建工具】</strong>【技术方案：使用 Vite 5 作为构建工具，其开发服务器启动和热模块替换（HMR）速度明显快于 Webpack】</p><p><strong>【路由】</strong>【技术方案：采用 React Router DOM 6 实现路由管理，API 稳定且文档完善】</p><p><strong>【样式】</strong>【技术方案：使用 Tailwind CSS 3 + PostCSS 处理样式，开发时编写样式更快，生产环境会自动进行 tree-shaking 优化，相比 CSS Modules 和 styled-components 更高效且原子化更直观，对 AI 工具友好】</p><p><strong>【样式扩展】</strong>【技术方案：少量使用 Less 覆盖 Tailwind 主题变量，保持兼容性】</p><p><strong>【SVG 处理】</strong>【技术方案：使用 SVGR 1.5 处理 SVG，Vite 原生支持，可以将 SVG 作为 React 组件使用，比直接使用 SVG 或 SVG sprite 更灵活】</p><p><strong>【UI 组件库】</strong>【技术方案：采用 shadcn/ui（latest）和 Arco Design 2 实现 UI 组件，易于使用，符合字节项目使用字节组件库的习惯】</p><p><strong>【全局状态】</strong>【技术方案：采用 Zustand 4 管理全局状态，API 简洁、性能良好且无样板代码，相比 Redux Toolkit、Pinia、Jotai 代码量更少且配有 Devtools】</p><p><strong>【图形/画布】</strong>【技术方案：使用 PixiJS 8 + pixi-viewport 实现图形和画布功能，基于 WebGL 渲染，适合处理大量精灵元素，相比其他可选方案性能更高】</p><p><strong>【富文本编辑器】</strong>【技术方案：采用 WangEditor 5 作为富文本编辑器，轻量且文档和社区均为中文，相比 Slate/TipTap 等编辑器，默认输出的 HTML 可直接给 PixiJS HTMLText 进行渲染】</p><p><strong>【图标】</strong>【技术方案：使用 Lucide React 图标库，图标数量多、风格统一且支持 Tree-shaking】</p><p><strong>【工具库】</strong>【技术方案：采用 nanoid 3 为画布元素生成唯一标识符等操作，轻量实用】</p><p><strong>【代码质量】</strong>【技术方案：使用 ESLint + Stylelint + Prettier + Husky + lint-staged + commitlint 保证团队代码风格一致，这是中大型项目的基本配置，有利于多人协作开发】</p><p>此外，还配置了 react 开发者工具 react-dev-inspector，配置了一下，开发环境下 ctrl+q 可以实现点击页面上的组件，在 VSCode 中自动跳转到对应文件，并定位到对应行号，方便调试（先前写 vue 也用过类似的）</p><p>项目 <a href="https://react-dev-inspector.zthxxx.me/docs">https://react-dev-inspector.zthxxx.me/docs</a></p><h3 id="功能要素和方案"><a href="#功能要素和方案" class="headerlink" title="功能要素和方案"></a>功能要素和方案</h3><p>分析以上需求，查阅相关资料后，进行各个核心模块的技术方案选型，确定初步实现方案</p><p><strong>【基础渲染引擎】</strong>【技术方案：PixiJS v8（WebGL）提供高性能 2D 渲染，根据不同元素类型创建对应的 Pixi 对象（图形、文本、图像），通过 pixi-viewport 实现无限画布的视口控制，支持缩放、拖拽等交互】</p><p><strong>【无限画布视口】</strong>【技术方案：pixi-viewport（内置 zoom、drag、decelerate、clampZoom）库创建无限画布，在 StageManagerCore.ts 中初始化 viewport，并添加拖拽、缩放等交互功能，支持鼠标中键拖拽画布、滚轮缩放等常见操作】</p><p><strong>【富文本编辑】</strong>【技术方案：WangEditor 5 作为富文本编辑器，提供完整的文本编辑功能，编辑结果以 HTML 格式存储在元素的 text/string 属性中，元素使用 PixiJS 内置的 HTMLText 进行渲染实现富文本效果】</p><p><strong>【状态管理与数据结构】</strong>【技术方案：Zustand 作为全局状态管理库，通过 structuredClone 函数手动创建状态快照，管理画布元素、选中状态、工具类型等，通过中间件监听状态变化并触发重渲染，在特定的 ts 中定义所有状态和操作方法】</p><p><strong>【图片上传显示与滤镜】</strong>【技术方案：PixiJS 内置 Filter 系统包括 BlurFilter、ColorMatrixFilter（黑白、对比度、饱和度）实现图像处理效果，支持模糊、亮度调整、灰度等多种滤镜效果，在 ElementRenderer.ts 中根据元素的 filter 属性应用相应滤镜，支持 blur（模糊）、brightness（亮度）、grayscale（灰度）等滤镜类型】</p><p><strong>【选中与变换系统】</strong>【技术方案：SelectionManager + TransformOverlay（8 个把手 + 旋转把手）实现变换控件渲染，支持单个元素选中和多个元素群组选中，提供 8 个控制点和 1 个旋转点进行变换操作，根据不同元素类型提供不同的控制方式】</p><p><strong>【旋转与组合嵌套】</strong>【技术方案：每个元素维护自己的 matrix（局部矩阵），组合后父容器统一应用矩阵变换，支持多层级嵌套和复杂变换】</p><p><strong>【Minimap】</strong>【技术方案：单独一个小的 Pixi.Application（共享 texture 缓存）实现缩略图功能，主画布所有容器使用 cacheAsBitmap 后生成低分辨率 texture，实时更新到小画布，视口框用一个半透明矩形表示在主画布中的位置】</p><p><strong>【元素永久缓存】</strong>【技术方案：使用 spriteMap 来存储 PIXI 对象，元素更新时只修改属性并设置 container.dirty = true，而不是销毁重建，来解决拖拽中断、光标丢失、闪烁等问题】</p><p><strong>【辅助对齐线】</strong>【技术方案：拖拽时实时遍历所有元素 bounds，计算对齐情况（水平/垂直/间距相等），差值&lt;6px 就吸附并画蓝线，支持水平、垂直对齐以及等间距对齐等多种对齐方式，当距离小于阈值时自动吸附并对齐】</p><p><strong>【Undo/Redo】</strong>【技术方案：Command Pattern + structuredClone 完整快照（每步 before/after）实现撤销/重做功能，通过管理命令栈（undo，redo 栈），使用 structuredClone 创建状态快照，记录操作前后的完整状态，来支持添加元素、删除元素、修改元素属性等操作的撤销/重做，针对拖拽和调整大小操作的命令生成逻辑可能还要具体再处理一套】</p><p><strong>【数据持久化与离线】</strong>【技术方案：Zustand-persist + localForage（IndexedDB）实现数据持久化和离线使用，使用 Zustand 的持久化中间件保存状态，通过 localForage 将数据存储到 IndexedDB 中，实现数据的自动保存和恢复功能】</p><p><strong>【实时协同】</strong>【技术方案：Y.js + y-websocket（或自己写 CRDT）+ Operation Transform 合并策略实现无冲突的实时协同编辑，通过 y-websocket 插件实现服务端同步（问的 AI），有个思路是把操作打给时间 tag，然后然后按时间合并】</p><hr><h4 id="项目架构树"><a href="#项目架构树" class="headerlink" title="项目架构树"></a>项目架构树</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs sh">BDdraw_DEV/<br>├── ALD_Backend/                    <span class="hljs-comment"># 后端服务目录</span><br>│   ├── src/                        <span class="hljs-comment"># 后端源代码</span><br>│   │   ├── api/                    <span class="hljs-comment"># API接口目录</span><br>│   │   │   ├── Room_management/    <span class="hljs-comment"># 房间管理相关API</span><br>│   │   │   │   ├── types/          <span class="hljs-comment"># 房间管理相关类型定义</span><br>│   │   │   │   │   ├── Room_CRUD_types.ts  <span class="hljs-comment"># 房间增删改查类型定义</span><br>│   │   │   │   │   ├── Room_List_types.ts  <span class="hljs-comment"># 房间列表类型定义</span><br>│   │   │   │   │   ├── Room_users_types.ts <span class="hljs-comment"># 房间用户类型定义</span><br>│   │   │   │   │   └── index.ts            <span class="hljs-comment"># 类型索引文件</span><br>│   │   │   │   ├── CORE.ts         <span class="hljs-comment"># 核心房间管理逻辑</span><br>│   │   │   │   ├── Room_CRUD.ts    <span class="hljs-comment"># 房间增删改查操作实现</span><br>│   │   │   │   ├── Room_List.ts    <span class="hljs-comment"># 房间列表管理实现</span><br>│   │   │   │   └── Room_users.ts   <span class="hljs-comment"># 房间用户管理实现</span><br>│   │   │   ├── USER_management/    <span class="hljs-comment"># 用户管理相关API</span><br>│   │   │   │   ├── auth_API.ts     <span class="hljs-comment"># 用户认证API实现</span><br>│   │   │   │   └── auth_API_types.ts  <span class="hljs-comment"># 用户认证类型定义</span><br>│   │   │   └── index.ts            <span class="hljs-comment"># API索引文件</span><br>│   │   ├── auth.ts                 <span class="hljs-comment"># 认证模块实现</span><br>│   │   ├── collab.ts               <span class="hljs-comment"># 协作功能模块实现</span><br>│   │   └── db.ts                   <span class="hljs-comment"># 数据库连接和操作实现</span><br>│   ├── ARCHITECTURE.md             <span class="hljs-comment"># 后端架构说明文档</span><br>│   ├── README.md                   <span class="hljs-comment"># 后端说明文档</span><br>│   ├── index.ts                    <span class="hljs-comment"># 后端服务入口文件</span><br>│   ├── package.json                <span class="hljs-comment"># 后端依赖配置文件</span><br>│   └── tsconfig.json               <span class="hljs-comment"># 后端TypeScript配置</span><br>├── src/                            <span class="hljs-comment"># 前端源代码目录</span><br>│   ├── api/                        <span class="hljs-comment"># 前端API客户端</span><br>│   │   ├── types/                  <span class="hljs-comment"># API类型定义</span><br>│   │   │   ├── Room_management/    <span class="hljs-comment"># 房间管理相关类型定义</span><br>│   │   │   │   ├── Room_CRUD_types.ts  <span class="hljs-comment"># 房间增删改查类型定义</span><br>│   │   │   │   ├── Room_List_types.ts  <span class="hljs-comment"># 房间列表类型定义</span><br>│   │   │   │   ├── Room_users_types.ts <span class="hljs-comment"># 房间用户类型定义</span><br>│   │   │   │   └── index.ts            <span class="hljs-comment"># 类型索引文件</span><br>│   │   │   ├── auth_API_types.ts   <span class="hljs-comment"># 认证相关类型定义</span><br>│   │   │   └── index.ts            <span class="hljs-comment"># API类型索引文件</span><br>│   │   ├── utils/                  <span class="hljs-comment"># API工具函数</span><br>│   │   │   └── apiClient.ts        <span class="hljs-comment"># API客户端工具</span><br>│   │   ├── apiService.ts           <span class="hljs-comment"># API服务封装实现</span><br>│   │   └── index.ts                <span class="hljs-comment"># API索引文件</span><br>│   ├── components/                 <span class="hljs-comment"># React组件目录</span><br>│   │   ├── Richtext_editor/        <span class="hljs-comment"># 富文本编辑器组件</span><br>│   │   │   ├── BottomTextEditor.tsx    <span class="hljs-comment"># 底部文本编辑器实现</span><br>│   │   │   └── Richtext_editor.tsx     <span class="hljs-comment"># 富文本编辑器主组件</span><br>│   │   ├── canvas_toolbar/         <span class="hljs-comment"># 画布工具栏组件</span><br>│   │   │   ├── ContextMenu.tsx     <span class="hljs-comment"># 上下文菜单实现</span><br>│   │   │   └── TopToolbar.tsx      <span class="hljs-comment"># 顶部工具栏实现</span><br>│   │   ├── collaboration/          <span class="hljs-comment"># 协作功能组件</span><br>│   │   │   ├── CollaboratorCursors.tsx <span class="hljs-comment"># 协作者光标显示组件</span><br>│   │   │   └── RemoteSelectionLayer.tsx <span class="hljs-comment"># 远程选择层组件</span><br>│   │   ├── error-page/             <span class="hljs-comment"># 错误页面组件</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 错误页面实现</span><br>│   │   ├── header/                 <span class="hljs-comment"># 页面头部组件</span><br>│   │   │   ├── contents/           <span class="hljs-comment"># 头部内容组件</span><br>│   │   │   │   ├── ExportCanvasModal.tsx   <span class="hljs-comment"># 导出画布模态框</span><br>│   │   │   │   └── StageManagerContext.tsx <span class="hljs-comment"># 舞台管理上下文</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 头部组件入口</span><br>│   │   ├── image-insert-modal/     <span class="hljs-comment"># 图片插入模态框组件</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 图片插入模态框实现</span><br>│   │   ├── layout/                 <span class="hljs-comment"># 布局组件</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 布局组件实现</span><br>│   │   ├── minimap/                <span class="hljs-comment"># 小地图组件</span><br>│   │   │   └── Minimap.tsx         <span class="hljs-comment"># 小地图实现</span><br>│   │   ├── property-panel/         <span class="hljs-comment"># 属性面板组件</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 属性面板实现</span><br>│   │   ├── settings/               <span class="hljs-comment"># 设置组件</span><br>│   │   │   └── setting.tsx         <span class="hljs-comment"># 设置组件实现</span><br>│   │   ├── ui/                     <span class="hljs-comment"># 基础UI组件</span><br>│   │   │   ├── blackwhitebutton.tsx    <span class="hljs-comment"># 黑白按钮组件</span><br>│   │   │   ├── button.tsx          <span class="hljs-comment"># 按钮组件</span><br>│   │   │   ├── icon-circle.tsx     <span class="hljs-comment"># 圆形图标组件</span><br>│   │   │   ├── icon-clear.tsx      <span class="hljs-comment"># 清除图标组件</span><br>│   │   │   ├── icon-rect.tsx       <span class="hljs-comment"># 矩形图标组件</span><br>│   │   │   ├── icon-select.tsx     <span class="hljs-comment"># 选择图标组件</span><br>│   │   │   └── icon-triangle.tsx   <span class="hljs-comment"># 三角形图标组件</span><br>│   │   ├── AnimatedRoutes.tsx      <span class="hljs-comment"># 动画路由组件</span><br>│   │   ├── ParallaxBackground.tsx  <span class="hljs-comment"># 视差背景组件</span><br>│   │   └── WipeTransition.tsx      <span class="hljs-comment"># 擦除过渡动画组件</span><br>│   ├── hooks/                      <span class="hljs-comment"># 自定义React Hooks</span><br>│   │   ├── use-localstorage-state.ts   <span class="hljs-comment"># localStorage状态管理Hook</span><br>│   │   └── use_React_hotkeys_management.ts <span class="hljs-comment"># 快捷键管理Hook</span><br>│   ├── lib/                        <span class="hljs-comment"># 工具库和核心功能模块</span><br>│   │   ├── AddElementCommand.ts    <span class="hljs-comment"># 添加元素命令实现</span><br>│   │   ├── RemoveElementCommand.ts <span class="hljs-comment"># 删除元素命令实现</span><br>│   │   ├── UndoRedoManager.ts      <span class="hljs-comment"># 撤销重做管理器实现</span><br>│   │   ├── UpdateElementCommand.ts <span class="hljs-comment"># 更新元素命令实现</span><br>│   │   ├── UpdateElementPropertyCommand.ts <span class="hljs-comment"># 更新元素属性命令实现</span><br>│   │   ├── constants.ts            <span class="hljs-comment"># 常量定义文件</span><br>│   │   ├── env.ts                  <span class="hljs-comment"># 环境变量配置</span><br>│   │   ├── minimapUtils.ts         <span class="hljs-comment"># 小地图工具函数</span><br>│   │   └── utils.ts                <span class="hljs-comment"># 通用工具函数</span><br>│   ├── pages/                      <span class="hljs-comment"># 页面组件目录</span><br>│   │   ├── auth/                   <span class="hljs-comment"># 认证相关页面</span><br>│   │   │   ├── Login.tsx           <span class="hljs-comment"># 登录页面实现</span><br>│   │   │   └── Register.tsx        <span class="hljs-comment"># 注册页面实现</span><br>│   │   ├── canvas/                 <span class="hljs-comment"># 画布主页面</span><br>│   │   │   ├── Pixi_STM_modules/   <span class="hljs-comment"># Pixi.js状态管理模块</span><br>│   │   │   │   ├── core/           <span class="hljs-comment"># 核心类和初始化逻辑</span><br>│   │   │   │   │   ├── Core_StageManager.ts    <span class="hljs-comment"># 核心舞台管理器</span><br>│   │   │   │   │   ├── ElementRender.ts        <span class="hljs-comment"># 元素渲染器</span><br>│   │   │   │   │   ├── TF_controler_Renderer.ts <span class="hljs-comment"># 变换控制器渲染器</span><br>│   │   │   │   │   └── types.ts                <span class="hljs-comment"># 核心类型定义</span><br>│   │   │   │   ├── interaction/    <span class="hljs-comment"># 交互处理模块</span><br>│   │   │   │   │   ├── Base_InteractionHandler.ts   <span class="hljs-comment"># 基础交互处理器</span><br>│   │   │   │   │   └── Stage_InteractionHandler.ts  <span class="hljs-comment"># 舞台交互处理器</span><br>│   │   │   │   ├── shared/         <span class="hljs-comment"># 共享类型定义</span><br>│   │   │   │   │   └── types.ts    <span class="hljs-comment"># 共享类型定义文件</span><br>│   │   │   │   ├── utils/          <span class="hljs-comment"># 工具函数目录</span><br>│   │   │   │   │   ├── commandUtils.ts      <span class="hljs-comment"># 命令工具函数</span><br>│   │   │   │   │   ├── cursorUtils.ts       <span class="hljs-comment"># 光标工具函数</span><br>│   │   │   │   │   ├── destroyUtils.ts      <span class="hljs-comment"># 销毁工具函数</span><br>│   │   │   │   │   ├── dragUtils.ts         <span class="hljs-comment"># 拖拽工具函数</span><br>│   │   │   │   │   ├── drawingUtils.ts      <span class="hljs-comment"># 绘图工具函数</span><br>│   │   │   │   │   ├── eraserUtils.ts       <span class="hljs-comment"># 橡皮擦工具函数</span><br>│   │   │   │   │   ├── geometryUtils.ts     <span class="hljs-comment"># 几何工具函数</span><br>│   │   │   │   │   ├── guidelineUtils.ts    <span class="hljs-comment"># 辅助线工具函数</span><br>│   │   │   │   │   ├── interactionUtils.ts  <span class="hljs-comment"># 交互工具函数</span><br>│   │   │   │   │   ├── renderUtils.ts       <span class="hljs-comment"># 渲染工具函数</span><br>│   │   │   │   │   ├── resizeUtils.ts       <span class="hljs-comment"># 调整大小工具函数</span><br>│   │   │   │   │   ├── rotationUtils.ts     <span class="hljs-comment"># 旋转工具函数</span><br>│   │   │   │   │   ├── scaleUtils.ts        <span class="hljs-comment"># 缩放工具函数</span><br>│   │   │   │   │   ├── selectionUtils.ts    <span class="hljs-comment"># 选择工具函数</span><br>│   │   │   │   │   └── stateUtils.ts        <span class="hljs-comment"># 状态工具函数</span><br>│   │   │   │   └── STM_modules.md  <span class="hljs-comment"># 状态管理模块说明文档</span><br>│   │   │   ├── Pixi_stageManager.ts    <span class="hljs-comment"># Pixi舞台管理器入口</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 画布页面入口文件</span><br>│   │   ├── home/                   <span class="hljs-comment"># 主页</span><br>│   │   │   ├── contents/           <span class="hljs-comment"># 主页内容组件</span><br>│   │   │   │   └── AKN.tsx         <span class="hljs-comment"># AKN内容组件</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 主页入口文件</span><br>│   │   ├── intro/                  <span class="hljs-comment"># 介绍页面</span><br>│   │   │   └── index.tsx           <span class="hljs-comment"># 介绍页面实现</span><br>│   │   └── room/                   <span class="hljs-comment"># 房间管理页面</span><br>│   │       └── RoomManagement.tsx  <span class="hljs-comment"># 房间管理页面实现</span><br>│   ├── router/                     <span class="hljs-comment"># 路由配置目录</span><br>│   │   └── router.tsx              <span class="hljs-comment"># 路由配置实现</span><br>│   ├── stores/                     <span class="hljs-comment"># 状态存储目录(Zustand)</span><br>│   │   ├── canvasStore.ts          <span class="hljs-comment"># 画布状态存储</span><br>│   │   ├── persistenceStore.ts     <span class="hljs-comment"># 持久化状态存储</span><br>│   │   └── themeStore.ts           <span class="hljs-comment"># 主题状态存储</span><br>│   ├── app.tsx                     <span class="hljs-comment"># 应用根组件</span><br>│   ├── main.tsx                    <span class="hljs-comment"># 应用入口文件</span><br>│   └── vite-env.d.ts               <span class="hljs-comment"># Vite环境声明文件</span><br>├── README.md                       <span class="hljs-comment"># 项目说明文档</span><br>├── components.json                 <span class="hljs-comment"># 组件配置文件</span><br>├── index.html                      <span class="hljs-comment"># HTML入口文件</span><br>├── lint-staged.config.js           <span class="hljs-comment"># Lint-staged配置</span><br>├── package.json                    <span class="hljs-comment"># 项目依赖和脚本配置</span><br>├── postcss.config.js               <span class="hljs-comment"># PostCSS配置</span><br>├── tailwind.config.js              <span class="hljs-comment"># Tailwind CSS配置</span><br>├── transmart.config.ts             <span class="hljs-comment"># Transmart配置</span><br>├── tsconfig.json                   <span class="hljs-comment"># TypeScript配置</span><br>├── tsconfig.node.json              <span class="hljs-comment"># Node.js TypeScript配置</span><br>└── vite.config.ts                  <span class="hljs-comment"># Vite构建配置</span><br></code></pre></td></tr></table></figure><h3 id="项目架构设计"><a href="#项目架构设计" class="headerlink" title="项目架构设计"></a>项目架构设计</h3><p>项目采用数据驱动视图（Data-Driven View）模式，使用<strong>React (UI) + Zustand (数据) + PixiJS (渲染)</strong>的三层架构</p><p>React 只负责 UI 和事件入口<br>Zustand 是唯一的真实数据源（纯 JSON，可持久化、可协同）<br>PixiJS 层只做”渲染 + 交互计算”，所有对象永久缓存（Map），绝不每帧重建<br>所有变换（拖拽、缩放、旋转、组合）都在 Pixi 层完成，最后再同步回 Zustand（单向数据流）</p><p>项目主要划分为三个层次：渲染层、状态管理层和逻辑层，来实现关注点分离，提高代码的可维护性和可扩展性。</p><h4 id="渲染层"><a href="#渲染层" class="headerlink" title="渲染层"></a><strong>渲染层</strong></h4><p>主要由 PixiJS (WebGL) 负责处理图形渲染，包括创建、更新和删除图形对象。这一层负责将状态管理层的数据转换为可视化的图形元素，并处理用户的交互操作，如拖拽、缩放和旋转等</p><h4 id="状态管理层"><a href="#状态管理层" class="headerlink" title="状态管理层"></a><strong>状态管理层</strong></h4><p>采用 Zustand 管理 JSON 画布数据。<br>先定义一个 CanvasState 接口（JSON 数据结构，包含 id, type, x, y, width, height 等属性）</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CanvasState</span> {<br>  <span class="hljs-attr">tool</span>: <span class="hljs-title class_">ToolType</span> <span class="hljs-comment">// 当前工具类型</span><br>  <span class="hljs-attr">elements</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CanvasElement</span>&gt; <span class="hljs-comment">// 画布元素集合</span><br>  <span class="hljs-attr">selectedIds</span>: <span class="hljs-built_in">string</span>[] <span class="hljs-comment">// 选中元素ID列表</span><br>  <span class="hljs-attr">editingId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> <span class="hljs-comment">// 正在编辑的元素ID</span><br>  <span class="hljs-attr">clipboard</span>: <span class="hljs-title class_">CanvasElement</span>[] | <span class="hljs-literal">null</span> <span class="hljs-comment">// 剪贴板数据</span><br>  <span class="hljs-attr">pasteOffset</span>: <span class="hljs-built_in">number</span> <span class="hljs-comment">// 粘贴偏移计数</span><br>  <span class="hljs-attr">currentStyle</span>: {<br>    <span class="hljs-attr">fill</span>: <span class="hljs-built_in">string</span><br>    <span class="hljs-attr">stroke</span>: <span class="hljs-built_in">string</span><br>    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-built_in">number</span><br>    <span class="hljs-comment">// ... 其他样式属性</span><br>  }<br>}<br></code></pre></td></tr></table></figure><p>使用 Zustand 状态管理库，其中 elements 被定义为 Record<string, CanvasElement="">类型，表示一个以 id 为键，CanvasElement 为值的对象，用于存储画布上的所有元素。更新元素时使用 structuredClone 函数来克隆状态数据。后续持久化存储和撤销重做机制也是基于这一套状态管理来实现。这一层作为数据核心，主要维护画布上所有元素的状态信息，通过集中管理状态，确保了数据的一致性，便于后续的协同编辑和撤销重做功能的开发。</string,></p><h4 id="逻辑层"><a href="#逻辑层" class="headerlink" title="逻辑层"></a><strong>逻辑层</strong></h4><p>核心是 StageManagerCore 类，通过 StageManagerState 接口管理交互状态，包括当前交互模式、起始位置、当前元素 ID、初始元素状态等，处理多种交互模式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">idle - 空闲状态<br>panning - 画布平移<br>selecting - 选择元素<br>dragging - 拖拽元素<br>resizing - 调整元素大小<br>drawing - 绘制元素<br>texting - 文本编辑<br>erasing - 擦除元素<br></code></pre></td></tr></table></figure><p>处理多种元素操作逻辑：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">创建元素 - 根据不同工具类型创建相应元素<br>选择元素 - 支持单选和多选<br>拖拽元素 - 记录初始状态，计算偏移量<br>调整大小 - 通过控制手柄调整元素尺寸<br>删除元素 - 通过橡皮擦工具删除元素<br></code></pre></td></tr></table></figure><p>通过这种方式来实现面向对象编程并封装业务逻辑，提高代码的可维护性，利用后续拓展</p><hr><h3 id="数据流程"><a href="#数据流程" class="headerlink" title="数据流程"></a>数据流程</h3><p class='item-img' data-src='./assets/image-20251123121234358.png'><img src="./assets/image-20251123121234358.png" alt="image-20251123121234358"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[用户交互] --&gt; B{交互类型}<br>    B --&gt;|创建元素| C[StageManagerCore.onPointerDown]<br>    B --&gt;|拖拽元素| D[StageManagerCore.onPointerMove]<br>    B --&gt;|调整大小| E[StageManagerCore.onHandleDown]<br>    B --&gt;|选择元素| F[StageManagerCore.onPointerUp]<br><br>    C --&gt; G[Zustand Store.addElement]<br>    D --&gt; H[Zustand Store.updateElement]<br>    E --&gt; I[Zustand Store.updateElement]<br>    F --&gt; J[Zustand Store.setSelected]<br><br>    G --&gt; K[Zustand 状态更新]<br>    H --&gt; K<br>    I --&gt; K<br>    J --&gt; K<br><br>    K --&gt; L{状态变化}<br>    L --&gt;|元素变化| M[ElementRenderer.renderElements]<br>    L --&gt;|选择变化| N[TransformerRenderer.renderTransformer]<br><br>    M --&gt; O[PixiJS 图形渲染]<br>    N --&gt; O<br><br>    O --&gt; P[用户看到更新结果]<br><br>    K --&gt; Q[Zustand 持久化]<br>    Q --&gt; R[本地存储/IndexedDB]<br><br>    K --&gt; S[撤销/重做管理]<br>    S --&gt; T[命令栈管理]<br><br>    style A fill:#e1f5fe<br>    style O fill:#e8f5e8<br>    style K fill:#fff3e0<br>    style Q fill:#fce4ec<br></code></pre></td></tr></table></figure><p>流程如下：</p><h4 id="用户交互输入"><a href="#用户交互输入" class="headerlink" title="用户交互输入"></a>用户交互输入</h4><p>所有用户交互事件由 StageManagerCore 处理<br>用户通过鼠标、键盘等方式与画布进行交互：</p><ul><li>创建新元素（点击工具栏选择图形类型后在画布上绘制）</li><li>拖拽元素（选中元素后拖动）</li><li>调整元素大小（拖拽元素控制点）</li><li>选择元素（点击或框选元素）</li></ul><h4 id="创建元素流程"><a href="#创建元素流程" class="headerlink" title="创建元素流程"></a>创建元素流程</h4><ol><li>用户在画布上按下鼠标开始绘制</li><li><a href="">onPointerDown</a>捕获事件，创建新元素</li><li>调用 Zustand store 的<a href="">addElement</a>方法添加元素</li></ol><blockquote><p>创建元素时的中间状态要锁定撤销/重做管理器防止记录中间的一堆状态</p></blockquote><h4 id="拖拽元素流程"><a href="#拖拽元素流程" class="headerlink" title="拖拽元素流程"></a>拖拽元素流程</h4><ol><li>用户按下并拖动已选中的元素</li><li><a href="">onPointerMove</a>持续捕获鼠标移动事件</li><li>实时调用 Zustand store 的<a href="">updateElement</a>更新元素位置</li></ol><blockquote><p>拖拽元素时也是中间状态要锁定撤销/重做管理器防止记录中间的一堆状态</p></blockquote><h4 id="调整大小流程"><a href="#调整大小流程" class="headerlink" title="调整大小流程"></a>调整大小流程</h4><ol><li>用户拖拽元素的控制点（resize handle）</li><li><a href="">onHandleDown</a>捕获控制点拖拽事件</li><li><a href="">onPointerMove</a>计算缩放比例并更新元素大小</li><li>调用 Zustand store 的<a href="">updateElement</a>更新元素属性</li></ol><blockquote><p>调整元素大小时也是中间状态要锁定撤销/重做管理器防止记录中间的一堆状态</p></blockquote><h4 id="交互结束处理"><a href="#交互结束处理" class="headerlink" title="交互结束处理"></a>交互结束处理</h4><ol><li>用户释放鼠标按键，<a href="">onPointerUp</a>处理交互结束,解锁撤销/重做管理器</li><li>创建相应的命令（<a href="">UpdateElementCommand</a>并添加到命令栈中</li><li>清理临时状态</li></ol><h4 id="状态更新"><a href="#状态更新" class="headerlink" title="状态更新"></a>状态更新</h4><p>Zustand 作为全局状态管理器，处理所有状态更新：</p><ol><li><strong>状态更新</strong>：自定义一套<a href="">originalSet</a>方法更新状态</li><li><strong>撤销/重做处理</strong>：创建状态快照并生成命令对象</li><li><strong>状态订阅</strong>：通知所有订阅者状态变化</li></ol><h4 id="渲染更新"><a href="#渲染更新" class="headerlink" title="渲染更新"></a>渲染更新</h4><p>Zustand 状态变化触发 StageManagerCore 的订阅回调：</p><ol><li><a href="">ElementRenderer.renderElements</a> 根据元素数据更新 PixiJS 图形对象</li><li><a href="">TransformerRenderer.renderTransformer</a> 更新选中元素的变换控制器</li><li>PixiJS 自动进行渲染</li></ol><h4 id="撤销-重做管理"><a href="#撤销-重做管理" class="headerlink" title="撤销/重做管理"></a>撤销/重做管理</h4><p>通过命令模式实现撤销/重做功能：</p><ol><li>每个操作生成对应的命令对象（<a href="">UpdateElementCommand</a>、<a href="">SnapshotCommand</a>等）</li><li>命令对象保存操作前后的状态快照</li><li>通过<a href="">UndoRedoManager</a>管理命令栈，实现撤销和重做功能</li></ol><h4 id="数据持久化阶段"><a href="#数据持久化阶段" class="headerlink" title="数据持久化阶段"></a>数据持久化阶段</h4><p>Zustand 状态变化同时触发数据持久化：</p><ol><li>状态通过<a href="">persist</a>中间件自动保存到本地存储</li><li>数据存储在 IndexedDB 中，来支持离线使用</li></ol><blockquote><p>这一块还在写</p></blockquote><hr><h3 id="设计的相关考虑"><a href="#设计的相关考虑" class="headerlink" title="设计的相关考虑"></a>设计的相关考虑</h3><p><strong>解耦</strong>：渲染层、状态管理层和逻辑层相互独立，便于维护和扩展</p><p><strong>便于后续的协同编辑</strong>：实现多人协同，要监听 WebSocket 消息，然后更新 Zustand Store。StageManager 可以去监听到 Store 的变化，并作出相应的渲染更新</p><p><strong>对撤销/重做的实现</strong>：因为所有状态都在 Store 里，只需要保存/恢复 Store 的快照</p><p><strong>序列化/反序列化</strong>：保存项目只需 JSON.stringify(store.elements)</p><h4 id="目前的问题"><a href="#目前的问题" class="headerlink" title="目前的问题"></a>目前的问题</h4><p>【待补充】</p><h2 id="项目预览"><a href="#项目预览" class="headerlink" title="项目预览"></a>项目预览</h2><p>部署地址：<a href="https://zhongye1.github.io/BDdraw_DEV/">https://zhongye1.github.io/BDdraw_DEV/</a></p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><h4 id="【P0】基础渲染"><a href="#【P0】基础渲染" class="headerlink" title="【P0】基础渲染"></a><del>【P0】基础渲染</del></h4><ul><li><del>支持图形渲染，需要支持至少 3 种不同图形，比如矩形、圆角矩形、圆形、三角形等。需要支持以下图形属性：</del><ul><li><del>背景色（background）</del></li><li><del>边框宽度（border-width）</del></li><li><del>边框颜色（border-color）</del></li></ul></li><li><del>支持图片渲染，需要支持 png、jpeg 格式，支持设置三种简单滤镜</del></li><li><del>支持富文本文字渲染，需要支持以下文本属性：</del><ul><li><del>字体（font-family）</del></li><li><del>字号（font-size）</del></li><li><del>颜色（color）</del></li><li><del>背景色（background）</del></li><li><del>BIUS（加粗、斜体、下划线、删除线）</del></li></ul></li></ul><h4 id="【P0】画布交互"><a href="#【P0】画布交互" class="headerlink" title="【P0】画布交互"></a><del>【P0】画布交互</del></h4><ul><li><del>支持无限画布的缩放、滚动、拖拽</del><ul><li><del>支持无限画布滚动条</del></li><li><del>支持无限画布的 minimap 功能</del></li></ul></li><li><del>支持选区功能：</del><ul><li><del>点击选中单个元素</del></li><li><del>框选选中多个元素</del></li></ul></li><li><del>支持数据持久化，每次操作后自动保存数据，刷新页面数据仍然存在</del></li><li><del>快捷键复制选中元素</del></li><li><del>支持辅助线功能</del></li></ul><h4 id="【P0】调参工具栏"><a href="#【P0】调参工具栏" class="headerlink" title="【P0】调参工具栏"></a><del>【P0】调参工具栏</del></h4><ul><li><del>浮动工具栏</del><ul><li><del>当选中文本元素时出现在上方，支持设置不同文本属性</del>（做了个编辑器）</li><li><del>当选中图形元素时出现在上方，支持设置不同图形属性</del></li><li><del>选中文本元素的部分文字时也能够出现，支持设置局部文本的文本属性</del>（编辑器内编辑可实现）</li></ul></li></ul><h4 id="【P0】元素编辑"><a href="#【P0】元素编辑" class="headerlink" title="【P0】元素编辑"></a><del>【P0】元素编辑</del></h4><ul><li><del>支持双击文本进入编辑，可以输入/删除文本内容</del></li><li><del>支持对选中元素（单个或多个）删除</del></li><li><del>支持对选中元素（单个或多个）拖拽</del></li><li><del>支持对选中元素（单个或多个）缩放</del></li><li><del>支持对选中元素（单个或多个）旋转</del></li><li><del>支持对多个元素进行组合操作，组合可以嵌套</del></li><li><del>支持对多个元素进行打组、解组</del><del>(组操作 bug 复现了，目前在修)</del>（已修复）</li></ul><h4 id="【P0】性能优化"><a href="#【P0】性能优化" class="headerlink" title="【P0】性能优化"></a><del>【P0】性能优化</del></h4><ul><li><del>画布存在 100 个元素，打开页面到渲染完成 &lt; 3s</del></li><li><del>同时操作 100 个元素，FPS 50+</del></li></ul><h4 id="【P1】协同"><a href="#【P1】协同" class="headerlink" title="【P1】协同"></a><del>【P1】协同</del></h4><ul><li><del>支持 undo &amp; redo 操作</del> <del>（大体实现了，可能要修一下 undo，redo 栈，有个不能稳定复现的 bug）</del>（已实现）</li><li><del>支持协同编辑，多人打开同一个画布可以协同编辑</del> (写了个 Node.js 后端)</li><li><del>支持离线编辑，断网后仍然可以对画布编辑，恢复网络后自动提交数据</del>（IndexedDB）</li></ul><blockquote><p>各模块的技术文档补充中<br>此文档最后编辑于 2025.11.27<br>项目开发中，欢迎提 issue 和 pr</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;BDdraw-DEV&quot;&gt;&lt;a href=&quot;#BDdraw-DEV&quot; class=&quot;headerlink&quot; title=&quot;BDdraw_DEV&quot;&gt;&lt;/a&gt;BDdraw_DEV&lt;/h1&gt;&lt;p&gt;代码仓库：&lt;br&gt;&lt;a href=&quot;https://github.com/Z</summary>
      
    
    
    
    <category term="Github项目" scheme="https://zhongye1.github.io/Arknight-notes/categories/Github%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="excalidraw" scheme="https://zhongye1.github.io/Arknight-notes/tags/excalidraw/"/>
    
    <category term="github" scheme="https://zhongye1.github.io/Arknight-notes/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-23-Undo/Redo机制具体实现</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/52695.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/52695.html</id>
    <published>2025-11-23T11:15:00.000Z</published>
    <updated>2025-11-23T16:03:47.889Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-模块摘要-Executive-Summary"><a href="#1-模块摘要-Executive-Summary" class="headerlink" title="1. 模块摘要 (Executive Summary)"></a>1. 模块摘要 (Executive Summary)</h3><p>Undo/Redo 机制是画布应用中实现操作撤销和重做的核心功能模块。它基于命令模式（Command Pattern）实现来，管理操作历史、执行撤销/重做操作和防止操作冲突，通过维护撤销栈和重做栈来管理用户的操作历史。</p><ul><li><p><strong>项目结构树</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">src/<br>├── lib/<br>│   ├── UndoRedoManager.ts        <span class="hljs-comment"># 撤销重做管理器核心实现</span><br>│   └── UpdateElementCommand.ts   <span class="hljs-comment"># 元素更新命令实现</span><br>└── stores/<br>    └── canvasStore.ts            <span class="hljs-comment"># 状态存储，命令操作的目标</span><br></code></pre></td></tr></table></figure><ul><li><code>Command Pattern</code>：设计模式，用于封装操作命令</li><li><code>Zustand</code>：状态管理库，作为命令操作的目标</li><li><code>TypeScript</code>：提供类型安全和代码可维护性</li></ul></li></ul><h3 id="2-Props-和相关类型定义"><a href="#2-Props-和相关类型定义" class="headerlink" title="2. Props 和相关类型定义"></a>2. Props 和相关类型定义</h3><h4 id="2-1-UndoRedoManager-核心方法"><a href="#2-1-UndoRedoManager-核心方法" class="headerlink" title="2.1 UndoRedoManager 核心方法"></a>2.1 UndoRedoManager 核心方法</h4><p>撤销重做管理器提供了一系列核心方法用于管理操作命令。</p><div class="table-container"><table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>描述</th></tr></thead><tbody><tr><td>executeCommand</td><td>command: Command</td><td>void</td><td>执行并记录命令</td></tr><tr><td>undo</td><td>无</td><td>void</td><td>执行撤销操作</td></tr><tr><td>redo</td><td>无</td><td>void</td><td>执行重做操作</td></tr><tr><td>lock</td><td>无</td><td>void</td><td>锁定管理器，防止记录新命令</td></tr><tr><td>unlock</td><td>无</td><td>void</td><td>解锁管理器</td></tr><tr><td>isLocked</td><td>无</td><td>boolean</td><td>检查管理器是否被锁定</td></tr><tr><td>canUndo</td><td>无</td><td>boolean</td><td>检查是否可以撤销</td></tr><tr><td>canRedo</td><td>无</td><td>boolean</td><td>检查是否可以重做</td></tr></tbody></table></div><h4 id="2-2-核心类型定义"><a href="#2-2-核心类型定义" class="headerlink" title="2.2 核心类型定义"></a>2.2 核心类型定义</h4><p><strong><a href="/src/lib/UndoRedoManager.ts#L3-L7">Command</a> 接口</strong>：<br>定义了命令对象必须实现的方法。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Command</span> {<br>  <span class="hljs-title function_">execute</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 执行命令</span><br>  <span class="hljs-title function_">undo</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 撤销命令</span><br>  <span class="hljs-title function_">redo</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 重做命令</span><br>}<br></code></pre></td></tr></table></figure><p><strong>UpdateOperation 接口</strong>：<br>定义了元素更新操作的数据结构。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateOperation</span> {<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 元素ID</span><br>  <span class="hljs-attr">initialAttrs</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;; <span class="hljs-comment">// 修改前的属性</span><br>  <span class="hljs-attr">finalAttrs</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;; <span class="hljs-comment">// 修改后的属性</span><br>}<br></code></pre></td></tr></table></figure><h3 id="3-核心状态管理-State-Architecture"><a href="#3-核心状态管理-State-Architecture" class="headerlink" title="3. 核心状态管理 (State Architecture)"></a>3. 核心状态管理 (State Architecture)</h3><blockquote><p>⚠️ 为防止在执行撤销/重做操作时记录新的命令，系统实现了锁定机制。在执行命令时会先锁定管理器，执行完成后再解锁，确保操作的原子性。</p></blockquote><h4 id="3-1-内部状态-Local-State"><a href="#3-1-内部状态-Local-State" class="headerlink" title="3.1 内部状态 (Local State)"></a>3.1 内部状态 (Local State)</h4><p>UndoRedoManager 维护以下内部状态用于管理操作历史：</p><div class="table-container"><table><thead><tr><th>状态名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>undoStack</td><td>Command[]</td><td>撤销命令栈，存储可以撤销的命令</td></tr><tr><td>redoStack</td><td>Command[]</td><td>重做命令栈，存储可以重做的命令</td></tr><tr><td>locked</td><td>boolean</td><td>锁定状态，防止在执行命令时记录新命令</td></tr></tbody></table></div><h4 id="3-2-外部状态-Global-Server-State"><a href="#3-2-外部状态-Global-Server-State" class="headerlink" title="3.2 外部状态 (Global/Server State)"></a>3.2 外部状态 (Global/Server State)</h4><p>Undo/Redo 机制通过 Zustand 状态管理库操作外部状态：</p><div class="table-container"><table><thead><tr><th>状态名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>elements</td><td>Record<string, CanvasElement=""></string,></td><td>所有画布元素数据，命令操作的目标</td></tr></tbody></table></div><h4 id="3-3-状态同步机制"><a href="#3-3-状态同步机制" class="headerlink" title="3.3 状态同步机制"></a>3.3 状态同步机制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[用户操作] --&gt; B{StageManager}<br>    B --&gt; C[创建命令对象]<br>    C --&gt; D[UndoRedoManager.executeCommand]<br>    D --&gt; E{管理器锁定?}<br>    E --&gt;|是| F[忽略命令]<br>    E --&gt;|否| G[执行命令]<br>    G --&gt; H[命令入撤销栈]<br>    H --&gt; I[清空重做栈]<br>    I --&gt; J[Zustand 状态更新]<br>    <br>    subgraph 撤销操作<br>      K[UndoRedoManager.undo]<br>      K --&gt; L{撤销栈空?}<br>      L --&gt;|是| M[无法撤销]<br>      L --&gt;|否| N[弹出命令]<br>      N --&gt; O[执行命令.undo]<br>      O --&gt; P[命令入重做栈]<br>      P --&gt; Q[Zustand 状态更新]<br>    end<br>    <br>    subgraph 重做操作<br>      R[UndoRedoManager.redo]<br>      R --&gt; S{重做栈空?}<br>      S --&gt;|是| T[无法重做]<br>      S --&gt;|否| U[弹出命令]<br>      U --&gt; V[执行命令.redo]<br>      V --&gt; W[命令入撤销栈]<br>      W --&gt; X[Zustand 状态更新]<br>    end<br>    <br>    style A fill:#e1f5fe<br>    style J fill:#e8f5e8<br>    style Q fill:#e8f5e8<br>    style X fill:#e8f5e8<br>    style F fill:#ffebee<br></code></pre></td></tr></table></figure><h3 id="4-命令管理机制"><a href="#4-命令管理机制" class="headerlink" title="4. 命令管理机制"></a>4. 命令管理机制</h3><p>Undo/Redo 机制采用命令模式（Command Pattern）来管理操作命令，通过定义统一的接口和不同的实现类来处理各种操作。</p><h4 id="4-1-命令类型"><a href="#4-1-命令类型" class="headerlink" title="4.1 命令类型"></a>4.1 命令类型</h4><p>系统中主要有两种命令类型：</p><ol><li><p><strong>快照命令（SnapshotCommand）</strong>：用于记录整个画布状态的变化，通常用于添加元素、删除元素等较大范围的操作，保存完整的状态快照</p></li><li><p><strong>更新元素命令（UpdateElementCommand）</strong>：用于记录特定元素的属性变化，主要用于拖拽移动和调整大小操作，只保存相关元素的特定属性变化</p></li></ol><h4 id="4-2-命令接口定义"><a href="#4-2-命令接口定义" class="headerlink" title="4.2 命令接口定义"></a>4.2 命令接口定义</h4><p>所有命令都实现统一的 <a href="/src/lib/UndoRedoManager.ts#L3-L7">Command</a> 接口：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Command</span> {<br>  <span class="hljs-title function_">execute</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 执行命令</span><br>  <span class="hljs-title function_">undo</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 撤销命令</span><br>  <span class="hljs-title function_">redo</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 重做命令</span><br>}<br></code></pre></td></tr></table></figure><h4 id="4-3-快照命令（SnapshotCommand）"><a href="#4-3-快照命令（SnapshotCommand）" class="headerlink" title="4.3 快照命令（SnapshotCommand）"></a>4.3 快照命令（SnapshotCommand）</h4><p>快照命令用于记录整个画布状态的变化，适用于影响范围较大的操作。</p><p><strong>核心实现</strong>：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnapshotCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">prevState</span>: <span class="hljs-built_in">any</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">nextState</span>: <span class="hljs-built_in">any</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">commandId</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;<br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">prevState</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">nextState</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">type</span>: <span class="hljs-built_in">any</span></span>) {<br>    <span class="hljs-comment">// 使用 structuredClone 进行深拷贝，确保状态隔离</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevState</span> = <span class="hljs-title function_">structuredClone</span>(prevState);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextState</span> = <span class="hljs-title function_">structuredClone</span>(nextState);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;<br>    <span class="hljs-comment">// 生成唯一的命令ID用于调试</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commandId</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() % <span class="hljs-number">1000000</span>;<br>  }<br><br>  <span class="hljs-title function_">execute</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// execute在添加到命令栈之前已经执行了</span><br>  }<br><br>  <span class="hljs-title function_">undo</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// 恢复到之前的状态</span><br>    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prevState</span>);<br>  }<br><br>  <span class="hljs-title function_">redo</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// 恢复到之后的状态</span><br>    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nextState</span>);<br>  }<br>}<br></code></pre></td></tr></table></figure><h4 id="4-4-更新元素命令（UpdateElementCommand）"><a href="#4-4-更新元素命令（UpdateElementCommand）" class="headerlink" title="4.4 更新元素命令（UpdateElementCommand）"></a>4.4 更新元素命令（UpdateElementCommand）</h4><p>更新元素命令用于记录特定元素的属性变化，适用于影响范围较小的精细操作。</p><p><strong>核心实现</strong>：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateOperation</span> {<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">initialAttrs</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;; <span class="hljs-comment">// 修改前的属性</span><br>  <span class="hljs-attr">finalAttrs</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;; <span class="hljs-comment">// 修改后的属性</span><br>}<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateElementCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">commandId</span>: <span class="hljs-built_in">string</span>;<br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">    <span class="hljs-keyword">private</span> <span class="hljs-attr">operations</span>: <span class="hljs-title class_">UpdateOperation</span>[],</span><br><span class="hljs-params">    <span class="hljs-keyword">private</span> <span class="hljs-attr">operationType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"更新元素"</span></span><br><span class="hljs-params">  </span>) {<br>    <span class="hljs-comment">// 生成唯一命令ID</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commandId</span> = <span class="hljs-string">`UpdateElementCommand-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()</span></span><br><span class="hljs-subst"><span class="hljs-string">      .toString(<span class="hljs-number">36</span>)</span></span><br><span class="hljs-subst"><span class="hljs-string">      .slice(<span class="hljs-number">2</span>, <span class="hljs-number">11</span>)}</span>`</span>;<br>  }<br><br>  <span class="hljs-title function_">execute</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// 应用最终状态</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">updates</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; = {};<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">op</span>) =&gt;</span> {<br>      updates[op.<span class="hljs-property">id</span>] = op.<span class="hljs-property">finalAttrs</span>;<br>    });<br><br>    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {<br>      <span class="hljs-keyword">const</span> newElements = { ...state.<span class="hljs-property">elements</span> };<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(updates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, attrs]</span>) =&gt;</span> {<br>        <span class="hljs-keyword">if</span> (newElements[id]) newElements[id] = { ...newElements[id], ...attrs };<br>      });<br>      <span class="hljs-keyword">return</span> { <span class="hljs-attr">elements</span>: newElements };<br>    });<br>  }<br><br>  <span class="hljs-title function_">undo</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// 撤销：恢复到 initialAttrs</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">updates</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; = {};<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">op</span>) =&gt;</span> {<br>      updates[op.<span class="hljs-property">id</span>] = op.<span class="hljs-property">initialAttrs</span>;<br>    });<br><br>    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {<br>      <span class="hljs-keyword">const</span> newElements = { ...state.<span class="hljs-property">elements</span> };<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(updates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, attrs]</span>) =&gt;</span> {<br>        <span class="hljs-keyword">if</span> (newElements[id]) newElements[id] = { ...newElements[id], ...attrs };<br>      });<br>      <span class="hljs-keyword">return</span> { <span class="hljs-attr">elements</span>: newElements };<br>    });<br>  }<br><br>  <span class="hljs-title function_">redo</span>(): <span class="hljs-built_in">void</span> {<br>    <span class="hljs-comment">// 重做：恢复到 finalAttrs</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">updates</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; = {};<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">op</span>) =&gt;</span> {<br>      updates[op.<span class="hljs-property">id</span>] = op.<span class="hljs-property">finalAttrs</span>;<br>    });<br><br>    useStore.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {<br>      <span class="hljs-keyword">const</span> newElements = { ...state.<span class="hljs-property">elements</span> };<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(updates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, attrs]</span>) =&gt;</span> {<br>        <span class="hljs-keyword">if</span> (newElements[id]) newElements[id] = { ...newElements[id], ...attrs };<br>      });<br>      <span class="hljs-keyword">return</span> { <span class="hljs-attr">elements</span>: newElements };<br>    });<br>  }<br>}<br></code></pre></td></tr></table></figure><h4 id="4-5-命令生命周期"><a href="#4-5-命令生命周期" class="headerlink" title="4.5 命令生命周期"></a>4.5 命令生命周期</h4><p>命令的生命周期包括创建、执行、撤销和重做四个阶段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[命令创建] --&gt; B[命令执行]<br>    B --&gt; C{用户操作}<br>    C --&gt;|撤销| D[执行undo方法]<br>    C --&gt;|重做| E[执行redo方法]<br>    D --&gt; F[命令状态切换]<br>    E --&gt; F<br>    F --&gt; G[状态更新完成]<br>    <br>    style A fill:#e1f5fe<br>    style B fill:#f3e5f5<br>    style D fill:#fff3e0<br>    style E fill:#fff3e0<br>    style G fill:#e8f5e8<br></code></pre></td></tr></table></figure><h3 id="5-命令栈管理机制"><a href="#5-命令栈管理机制" class="headerlink" title="5. 命令栈管理机制"></a>5. 命令栈管理机制</h3><p>撤销/重做机制使用两个栈来管理命令历史：</p><ol><li><strong>撤销栈（Undo Stack）</strong>：</li></ol><p>存储用户可以撤销的操作命令，栈顶是最近执行的命令，执行新命令时，命令被推入此栈，执行撤销操作时，命令从此栈弹出并推入重做栈</p><ol><li><strong>重做栈（Redo Stack）</strong>：</li></ol><p>存储用户可以重做的操作命令，在执行撤销操作时，被撤销的命令被推入此栈，执行重做操作时，命令从此栈弹出并推入撤销栈，执行新命令时，此栈被清空</p><h4 id="5-1-命令栈操作流程"><a href="#5-1-命令栈操作流程" class="headerlink" title="5.1 命令栈操作流程"></a>5.1 命令栈操作流程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[执行新命令] --&gt; B[命令入撤销栈]<br>    B --&gt; C[清空重做栈]<br>    <br>    D[执行撤销] --&gt; E{撤销栈空?}<br>    E --&gt;|是| F[无操作]<br>    E --&gt;|否| G[弹出命令]<br>    G --&gt; H[执行命令.undo]<br>    H --&gt; I[命令入重做栈]<br>    <br>    J[执行重做] --&gt; K{重做栈空?}<br>    K --&gt;|是| L[无操作]<br>    K --&gt;|否| M[弹出命令]<br>    M --&gt; N[执行命令.redo]<br>    N --&gt; O[命令入撤销栈]<br>    <br>    style A fill:#e1f5fe<br>    style B fill:#f3e5f5<br>    style C fill:#f3e5f5<br>    style D fill:#e1f5fe<br>    style H fill:#fff3e0<br>    style I fill:#fff3e0<br>    style J fill:#e1f5fe<br>    style N fill:#e8f5e8<br>    style O fill:#e8f5e8<br></code></pre></td></tr></table></figure><h4 id="5-2-不同类型的命令"><a href="#5-2-不同类型的命令" class="headerlink" title="5.2 不同类型的命令"></a>5.2 不同类型的命令</h4><p>撤销栈中并不全是快照命令。系统中至少有两种不同类型的命令：</p><ol><li><p><strong>快照命令（SnapshotCommand）</strong>：</p><ul><li>用于记录整个画布状态的变化</li><li>通常用于添加元素、删除元素等较大范围的操作</li><li>保存完整的状态快照</li></ul></li><li><p><strong>更新元素命令（UpdateElementCommand）</strong>：</p><ul><li>用于记录特定元素的属性变化</li><li>主要用于拖拽移动和调整大小操作</li><li>只保存相关元素的特定属性变化</li></ul></li></ol><h4 id="5-3-操作序列和撤销栈状态变化示例"><a href="#5-3-操作序列和撤销栈状态变化示例" class="headerlink" title="5.3 操作序列和撤销栈状态变化示例"></a>5.3 操作序列和撤销栈状态变化示例</h4><h5 id="初始状态"><a href="#初始状态" class="headerlink" title="初始状态"></a>初始状态</h5><p>撤销栈：空<br>重做栈：空</p><h5 id="1-创建元素-A"><a href="#1-创建元素-A" class="headerlink" title="1. 创建元素 A"></a>1. 创建元素 A</h5><p>当创建元素 A 时，系统会生成一个快照命令，记录整个画布状态的变化。<br>撤销栈：[SnapshotCommand_A] (大小: 1)<br>重做栈：空</p><h5 id="2-移动-A-到一个位置"><a href="#2-移动-A-到一个位置" class="headerlink" title="2. 移动 A 到一个位置"></a>2. 移动 A 到一个位置</h5><p>当移动元素 A 时，系统会生成一个更新元素命令（UpdateElementCommand），只记录 A 元素位置的变化。<br>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA] (大小: 2)<br>重做栈：空</p><h5 id="3-创建元素-B"><a href="#3-创建元素-B" class="headerlink" title="3. 创建元素 B"></a>3. 创建元素 B</h5><p>当创建元素 B 时，系统会生成另一个快照命令，记录添加 B 元素后的状态。<br>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA, SnapshotCommand_B] (大小: 3)<br>重做栈：空</p><h5 id="4-缩放-B-到一个位置"><a href="#4-缩放-B-到一个位置" class="headerlink" title="4. 缩放 B 到一个位置"></a>4. 缩放 B 到一个位置</h5><p>当缩放元素 B 时，系统会生成一个更新元素命令，记录 B 元素尺寸和位置的变化。<br>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA, SnapshotCommand_B, UpdateElementCommand_ResizeB] (大小: 4)<br>重做栈：空</p><h5 id="5-移动-B-到一个位置"><a href="#5-移动-B-到一个位置" class="headerlink" title="5. 移动 B 到一个位置"></a>5. 移动 B 到一个位置</h5><p>当再次移动元素 B 时，系统会生成另一个更新元素命令，记录 B 元素位置的新变化。<br>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA, SnapshotCommand_B, UpdateElementCommand_ResizeB, UpdateElementCommand_MoveB] (大小: 5)<br>重做栈：空</p><h4 id="5-4-执行撤销操作时的状态变化"><a href="#5-4-执行撤销操作时的状态变化" class="headerlink" title="5.4 执行撤销操作时的状态变化"></a>5.4 执行撤销操作时的状态变化</h4><h5 id="第一次撤销（移动-B-操作）"><a href="#第一次撤销（移动-B-操作）" class="headerlink" title="第一次撤销（移动 B 操作）"></a>第一次撤销（移动 B 操作）</h5><ol><li>从撤销栈弹出最后一个命令：UpdateElementCommand_MoveB</li><li>执行该命令的 undo()方法，将 B 元素恢复到缩放后的位置</li><li>将该命令推入重做栈</li></ol><p>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA, SnapshotCommand_B, UpdateElementCommand_ResizeB] (大小: 4)<br>重做栈：[UpdateElementCommand_MoveB] (大小: 1)</p><h5 id="第二次撤销（缩放-B-操作）"><a href="#第二次撤销（缩放-B-操作）" class="headerlink" title="第二次撤销（缩放 B 操作）"></a>第二次撤销（缩放 B 操作）</h5><ol><li>从撤销栈弹出最后一个命令：UpdateElementCommand_ResizeB</li><li>执行该命令的 undo()方法，将 B 元素恢复到刚创建时的尺寸和位置</li><li>将该命令推入重做栈</li></ol><p>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA, SnapshotCommand_B] (大小: 3)<br>重做栈：[UpdateElementCommand_MoveB, UpdateElementCommand_ResizeB] (大小: 2)</p><h5 id="第三次撤销（创建-B-操作）"><a href="#第三次撤销（创建-B-操作）" class="headerlink" title="第三次撤销（创建 B 操作）"></a>第三次撤销（创建 B 操作）</h5><ol><li>从撤销栈弹出最后一个命令：SnapshotCommand_B</li><li>执行该命令的 undo()方法，将整个画布状态恢复到创建 B 之前的状态（即只包含 A 元素的状态）</li><li>将该命令推入重做栈</li></ol><p>撤销栈：[SnapshotCommand_A, UpdateElementCommand_MoveA] (大小: 2)<br>重做栈：[UpdateElementCommand_MoveB, UpdateElementCommand_ResizeB, SnapshotCommand_B] (大小: 3)</p><h5 id="第四次撤销（移动-A-操作）"><a href="#第四次撤销（移动-A-操作）" class="headerlink" title="第四次撤销（移动 A 操作）"></a>第四次撤销（移动 A 操作）</h5><ol><li>从撤销栈弹出最后一个命令：UpdateElementCommand_MoveA</li><li>执行该命令的 undo()方法，将 A 元素恢复到初始位置</li><li>将该命令推入重做栈</li></ol><p>撤销栈：[SnapshotCommand_A] (大小: 1)<br>重做栈：[UpdateElementCommand_MoveB, UpdateElementCommand_ResizeB, SnapshotCommand_B, UpdateElementCommand_MoveA] (大小: 4)</p><h5 id="第五次撤销（创建-A-操作）"><a href="#第五次撤销（创建-A-操作）" class="headerlink" title="第五次撤销（创建 A 操作）"></a>第五次撤销（创建 A 操作）</h5><ol><li>从撤销栈弹出最后一个命令：SnapshotCommand_A</li><li>执行该命令的 undo()方法，将整个画布状态恢复到初始状态（空画布）</li><li>将该命令推入重做栈</li></ol><p>撤销栈：空<br>重做栈：[UpdateElementCommand_MoveB, UpdateElementCommand_ResizeB, SnapshotCommand_B, UpdateElementCommand_MoveA, SnapshotCommand_A] (大小: 5)</p><h3 id="6-逻辑流程-Logic-Flow"><a href="#6-逻辑流程-Logic-Flow" class="headerlink" title="6. 逻辑流程 (Logic Flow)"></a>6. 逻辑流程 (Logic Flow)</h3><h4 id="6-1-交互时序图-Mermaid"><a href="#6-1-交互时序图-Mermaid" class="headerlink" title="6.1 交互时序图 (Mermaid)"></a>6.1 交互时序图 (Mermaid)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">sequenceDiagram<br>    participant U as 用户<br>    participant SM as StageManager<br>    participant URM as UndoRedoManager<br>    participant C as Command<br>    participant ZS as Zustand Store<br>    <br>    U-&gt;&gt;SM: 执行操作（如拖拽元素）<br>    SM-&gt;&gt;SM: 记录操作初始状态<br>    SM-&gt;&gt;ZS: 更新元素状态<br>    SM-&gt;&gt;C: 创建 UpdateElementCommand<br>    SM-&gt;&gt;URM: executeCommand(command)<br>    URM-&gt;&gt;C: command.execute()<br>    C-&gt;&gt;URM: 命令入撤销栈<br>    URM-&gt;&gt;URM: 清空重做栈<br>    <br>    U-&gt;&gt;URM: 执行撤销 (Ctrl+Z)<br>    URM-&gt;&gt;URM: 锁定管理器<br>    URM-&gt;&gt;C: command.undo()<br>    C-&gt;&gt;ZS: 恢复初始状态<br>    C-&gt;&gt;URM: 命令入重做栈<br>    URM-&gt;&gt;URM: 解锁管理器<br>    <br>    U-&gt;&gt;URM: 执行重做 (Ctrl+Y)<br>    URM-&gt;&gt;URM: 锁定管理器<br>    URM-&gt;&gt;C: command.redo()<br>    C-&gt;&gt;ZS: 恢复最终状态<br>    C-&gt;&gt;URM: 命令入撤销栈<br>    URM-&gt;&gt;URM: 解锁管理器<br></code></pre></td></tr></table></figure><h4 id="6-2-核心函数解析"><a href="#6-2-核心函数解析" class="headerlink" title="6.2 核心函数解析"></a>6.2 核心函数解析</h4><p><strong>executeCommand 函数</strong>：当用户完成一个操作（如创建、更新、删除元素）时触发，执行命令并将命令添加到撤销栈，同时清空重做栈</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title function_">executeCommand</span>(<span class="hljs-params"><span class="hljs-attr">command</span>: <span class="hljs-title class_">Command</span></span>) {<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">locked</span>) {<br>    <span class="hljs-comment">// 如果管理器被锁定，忽略命令</span><br>    <span class="hljs-keyword">return</span><br>  }<br><br>  <span class="hljs-comment">// 执行命令</span><br>  command.<span class="hljs-title function_">execute</span>()<br><br>  <span class="hljs-comment">// 将命令添加到撤销栈</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">undoStack</span>.<span class="hljs-title function_">push</span>(command)<br><br>  <span class="hljs-comment">// 清空重做栈</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">redoStack</span> = []<br>}<br></code></pre></td></tr></table></figure><p><strong>undo 函数</strong>：当用户执行撤销操作（如按 Ctrl+Z）时触发，从撤销栈弹出命令，执行命令的 undo 方法，并将命令放入重做栈</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title function_">undo</span>(<span class="hljs-params"></span>) {<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">undoStack</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {<br>    <span class="hljs-comment">// 撤销栈为空，无法撤销</span><br>    <span class="hljs-keyword">return</span><br>  }<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lock</span>()  <span class="hljs-comment">// 锁定管理器</span><br>  <span class="hljs-keyword">const</span> command = <span class="hljs-variable language_">this</span>.<span class="hljs-property">undoStack</span>.<span class="hljs-title function_">pop</span>()!  <span class="hljs-comment">// 弹出命令</span><br>  command.<span class="hljs-title function_">undo</span>()  <span class="hljs-comment">// 执行撤销</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">redoStack</span>.<span class="hljs-title function_">push</span>(command)  <span class="hljs-comment">// 命令入重做栈</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unlock</span>()  <span class="hljs-comment">// 解锁管理器</span><br>}<br></code></pre></td></tr></table></figure><p><strong>redo 函数</strong>：当用户执行重做操作（如按 Ctrl+Y）时触发，从重做栈弹出命令，执行命令的 redo 方法，并将命令放入撤销栈</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title function_">redo</span>(<span class="hljs-params"></span>) {<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">redoStack</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {<br>    <span class="hljs-comment">// 重做栈为空，无法重做</span><br>    <span class="hljs-keyword">return</span><br>  }<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lock</span>()  <span class="hljs-comment">// 锁定管理器</span><br>  <span class="hljs-keyword">const</span> command = <span class="hljs-variable language_">this</span>.<span class="hljs-property">redoStack</span>.<span class="hljs-title function_">pop</span>()!  <span class="hljs-comment">// 弹出命令</span><br>  command.<span class="hljs-title function_">redo</span>()  <span class="hljs-comment">// 执行重做</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">undoStack</span>.<span class="hljs-title function_">push</span>(command)  <span class="hljs-comment">// 命令入撤销栈</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unlock</span>()  <span class="hljs-comment">// 解锁管理器</span><br>}<br></code></pre></td></tr></table></figure><h3 id="7-UI-与样式实现-UI-Implementation"><a href="#7-UI-与样式实现-UI-Implementation" class="headerlink" title="7. UI 与样式实现 (UI Implementation)"></a>7. UI 与样式实现 (UI Implementation)</h3><p>Undo/Redo 机制通过快捷键和控制台界面与用户交互：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[用户交互] --&gt; B{交互方式}<br>    B --&gt; C[键盘快捷键]<br>    B --&gt; D[控制台界面]<br>    C --&gt; E[Ctrl+Z 撤销]<br>    C --&gt; F[Ctrl+Y 重做]<br>    D --&gt; G[命令栈控制台]<br>    G --&gt; H[撤销按钮]<br>    G --&gt; I[重做按钮]<br>    G --&gt; J[清空按钮]<br>    <br>    style A fill:#e1f5fe<br>    style C fill:#f3e5f5<br>    style D fill:#f3e5f5<br>    style E fill:#e8f5e8<br>    style F fill:#e8f5e8<br>    style G fill:#fff3e0<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-模块摘要-Executive-Summary&quot;&gt;&lt;a href=&quot;#1-模块摘要-Executive-Summary&quot; class=&quot;headerlink&quot; title=&quot;1. 模块摘要 (Executive Summary)&quot;&gt;&lt;/a&gt;1. 模块摘要 (Ex</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
    <category term="状态管理" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-23-canvas项目相关-逻辑层</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/62457.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/62457.html</id>
    <published>2025-11-23T09:45:00.000Z</published>
    <updated>2025-11-23T16:04:12.040Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-模块摘要-Executive-Summary"><a href="#1-模块摘要-Executive-Summary" class="headerlink" title="1. 模块摘要 (Executive Summary)"></a>1. 模块摘要 (Executive Summary)</h3><p>逻辑层是整个画布应用的中枢神经系统，负责协调状态管理层和渲染层之间的交互。它通过 StageManagerCore 类实现，主要处理用户交互、协调状态更新、管理渲染流程、维护交互状态</p><ul><li><p><strong>项目结构树</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">src/<br>└── pages/<br>    └── canvas/<br>        ├── Pixi_stageManager.ts               <span class="hljs-comment"># StageManager 入口文件</span><br>        └── Pixi_STM_modules/                  <span class="hljs-comment"># StageManager 模块目录</span><br>            ├── core/<br>            │   ├── StageManagerCore.ts        <span class="hljs-comment"># 核心类</span><br>            │   └── types.ts                   <span class="hljs-comment"># 类型定义文件</span><br>            ├── rendering/<br>            │   ├── ElementRenderer.ts         <span class="hljs-comment"># 元素渲染器</span><br>            │   └── TransformerRenderer.ts     <span class="hljs-comment"># 变换控制器渲染器</span><br>            ├── interaction/<br>            │   └── InteractionHandler.ts      <span class="hljs-comment"># 交互处理器</span><br>            └── utils/<br>                └── cursorUtils.ts             <span class="hljs-comment"># 光标工具函数</span><br></code></pre></td></tr></table></figure><ul><li><code>PixiJS</code>：WebGL 渲染引擎，负责图形渲染</li><li><code>pixi-viewport</code>：视口管理插件，处理画布缩放和平移</li><li><code>Zustand</code>：状态管理库，与状态管理层对接</li><li><code>nanoid</code>：用于生成唯一 ID</li></ul></li></ul><h3 id="2-Props-和相关类型定义"><a href="#2-Props-和相关类型定义" class="headerlink" title="2. Props 和相关类型定义"></a>2. Props 和相关类型定义</h3><h4 id="2-1-StageManagerCore-构造函数参数"><a href="#2-1-StageManagerCore-构造函数参数" class="headerlink" title="2.1 StageManagerCore 构造函数参数"></a>2.1 StageManagerCore 构造函数参数</h4><p>StageManagerCore 类通过构造函数接收容器元素参数。</p><div class="table-container"><table><thead><tr><th>参数名</th><th>类型</th><th>必填</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>container</td><td>HTMLElement</td><td>是</td><td>无</td><td>用于挂载 PixiJS 应用的 DOM 容器</td></tr></tbody></table></div><p>代码示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 创建 StageManager 实例</span><br><span class="hljs-keyword">const</span> stageManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StageManagerCore</span>(containerElement);<br></code></pre></td></tr></table></figure><h4 id="2-2-核心类型定义"><a href="#2-2-核心类型定义" class="headerlink" title="2.2 核心类型定义"></a>2.2 核心类型定义</h4><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/core/types.ts#L11-L38">StageManagerState</a> 类型</strong>：<br>定义了 StageManager 的核心状态。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">StageManagerState</span> {<br>  <span class="hljs-attr">mode</span>: <span class="hljs-title class_">InteractionMode</span>; <span class="hljs-comment">// 当前交互模式</span><br>  <span class="hljs-attr">startPos</span>: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> }; <span class="hljs-comment">// 起始坐标</span><br>  <span class="hljs-attr">currentId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 当前操作元素 ID</span><br>  <span class="hljs-attr">initialElementsMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 初始元素映射</span><br>  <span class="hljs-attr">initialGroupBounds</span>: {<br>    <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;<br>    <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;<br>    <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;<br>    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;<br>  } | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 初始群组边界</span><br>  <span class="hljs-attr">initialElementState</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt; | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 初始元素状态</span><br>  <span class="hljs-attr">resizeInitialStates</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 调整大小初始状态</span><br>  <span class="hljs-attr">dragInitialStates</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;&gt; | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 拖拽初始状态</span><br>  <span class="hljs-attr">activeHandle</span>: <span class="hljs-title class_">HandleType</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 激活的手柄</span><br>  <span class="hljs-attr">isSpacePressed</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 空格键是否按下</span><br>  <span class="hljs-attr">destroyed</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否已销毁</span><br>}<br></code></pre></td></tr></table></figure><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/core/types.ts#L3-L8">InteractionMode</a> 类型</strong>：<br>定义了用户与画布交互的各种模式。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">InteractionMode</span> =<br>  | <span class="hljs-string">"idle"</span> <span class="hljs-comment">// 空闲状态</span><br>  | <span class="hljs-string">"panning"</span> <span class="hljs-comment">// 画布平移</span><br>  | <span class="hljs-string">"selecting"</span> <span class="hljs-comment">// 选择元素</span><br>  | <span class="hljs-string">"dragging"</span> <span class="hljs-comment">// 拖拽元素</span><br>  | <span class="hljs-string">"resizing"</span> <span class="hljs-comment">// 调整元素大小</span><br>  | <span class="hljs-string">"drawing"</span> <span class="hljs-comment">// 绘制元素</span><br>  | <span class="hljs-string">"texting"</span> <span class="hljs-comment">// 文本编辑</span><br>  | <span class="hljs-string">"erasing"</span>; <span class="hljs-comment">// 擦除元素</span><br></code></pre></td></tr></table></figure><h3 id="3-核心状态管理-State-Architecture"><a href="#3-核心状态管理-State-Architecture" class="headerlink" title="3. 核心状态管理 (State Architecture)"></a>3. 核心状态管理 (State Architecture)</h3><h4 id="3-1-内部状态-Local-State"><a href="#3-1-内部状态-Local-State" class="headerlink" title="3.1 内部状态 (Local State)"></a>3.1 内部状态 (Local State)</h4><p>StageManagerCore 维护以下内部状态：</p><div class="table-container"><table><thead><tr><th>状态名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>app</td><td>PIXI.Application</td><td>PixiJS 应用实例</td></tr><tr><td>viewport</td><td>Viewport</td><td>pixi-viewport 实例</td></tr><tr><td>elementLayer</td><td>PIXI.Container</td><td>元素图层容器</td></tr><tr><td>uiLayer</td><td>PIXI.Container</td><td>UI 图层容器</td></tr><tr><td>elementRenderer</td><td>ElementRenderer</td><td>元素渲染器实例</td></tr><tr><td>transformerRenderer</td><td>TransformerRenderer</td><td>变换控制器渲染器实例</td></tr><tr><td>interactionHandler</td><td>InteractionHandler</td><td>交互处理器实例</td></tr><tr><td>state</td><td>StageManagerState</td><td>交互状态对象</td></tr><tr><td>selectionRectGraphic</td><td>PIXI.Graphics</td><td>选区框图形对象</td></tr><tr><td>eraserGraphic</td><td>PIXI.Graphics</td><td>橡皮擦指示器图形对象</td></tr></tbody></table></div><h4 id="3-2-外部状态-Global-Server-State"><a href="#3-2-外部状态-Global-Server-State" class="headerlink" title="3.2 外部状态 (Global/Server State)"></a>3.2 外部状态 (Global/Server State)</h4><p>逻辑层通过 Zustand 状态管理库订阅外部状态：</p><div class="table-container"><table><thead><tr><th>状态名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>elements</td><td>Record<string, CanvasElement=""></string,></td><td>所有画布元素数据</td></tr><tr><td>selectedIds</td><td>string[]</td><td>当前选中的元素 ID 数组</td></tr><tr><td>tool</td><td>ToolType</td><td>当前工具类型</td></tr></tbody></table></div><h4 id="3-3-状态同步机制"><a href="#3-3-状态同步机制" class="headerlink" title="3.3 状态同步机制"></a>3.3 状态同步机制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[Zustand Store 状态变更] --&gt; B{StageManager 订阅}<br>    B --&gt; C{状态处理}<br>    C --&gt; D[ElementRenderer.renderElements]<br>    C --&gt; E[TransformerRenderer.renderTransformer]<br>    C --&gt; F[更新视口状态]<br>    C --&gt; G[更新光标样式]<br>    D --&gt; H[PixiJS 渲染元素]<br>    E --&gt; I[PixiJS 渲染变换控制器]<br>    <br>    style A fill:#e1f5fe<br>    style H fill:#e8f5e8<br>    style I fill:#e8f5e8<br>    style F fill:#fff3e0<br>    style G fill:#fff3e0<br></code></pre></td></tr></table></figure><h3 id="4-逻辑流程-Logic-Flow"><a href="#4-逻辑流程-Logic-Flow" class="headerlink" title="4. 逻辑流程 (Logic Flow)"></a>4. 逻辑流程 (Logic Flow)</h3><h4 id="4-1-交互时序图-Mermaid"><a href="#4-1-交互时序图-Mermaid" class="headerlink" title="4.1 交互时序图 (Mermaid)"></a>4.1 交互时序图 (Mermaid)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">sequenceDiagram<br>    participant U as 用户<br>    participant SM as StageManagerCore<br>    participant IH as InteractionHandler<br>    participant ZS as Zustand Store<br>    participant ER as ElementRenderer<br>    participant TR as TransformerRenderer<br>    <br>    U-&gt;&gt;IH: 触发交互事件 (点击/拖拽等)<br>    IH-&gt;&gt;SM: 调用处理函数 (onPointerDown等)<br>    SM-&gt;&gt;SM: 更新内部状态 (mode, startPos等)<br>    SM-&gt;&gt;ZS: 更新画布数据 (addElement等)<br>    ZS-&gt;&gt;SM: 通知状态变更<br>    SM-&gt;&gt;ER: 调用renderElements()<br>    SM-&gt;&gt;TR: 调用renderTransformer()<br>    ER-&gt;&gt;ER: 更新 PIXI 元素<br>    TR-&gt;&gt;TR: 更新变换控制器<br></code></pre></td></tr></table></figure><h4 id="4-2-核心函数解析"><a href="#4-2-核心函数解析" class="headerlink" title="4.2 核心函数解析"></a>4.2 核心函数解析</h4><p><strong>onPointerDown 函数</strong>：当用户在画布上按下鼠标时触发，根据当前工具和点击位置处理不同的交互逻辑（选择、绘制、拖拽等）</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> onPointerDown = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">e</span>: PIXI.<span class="hljs-title class_">FederatedPointerEvent</span></span>) =&gt;</span> {<br>  <span class="hljs-comment">// 处理防抖</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerDebounceSnapshot</span>()<br><br>  <span class="hljs-comment">// 获取当前状态</span><br>  <span class="hljs-keyword">const</span> state = useStore.<span class="hljs-title function_">getState</span>()<br>  <span class="hljs-keyword">const</span> tool = state.<span class="hljs-property">tool</span><br>  <span class="hljs-keyword">const</span> worldPos = e.<span class="hljs-title function_">getLocalPosition</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">viewport</span>)<br><br>  <span class="hljs-comment">// 根据工具类型处理不同逻辑</span><br>  <span class="hljs-keyword">if</span> (tool === <span class="hljs-string">'text'</span>) {<br>    <span class="hljs-comment">// 处理文本工具</span><br>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tool === <span class="hljs-string">'eraser'</span>) {<br>    <span class="hljs-comment">// 处理橡皮擦工具</span><br>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span> &amp;&amp; e.<span class="hljs-property">target</span>.<span class="hljs-property">label</span>) {<br>    <span class="hljs-comment">// 处理元素点击</span><br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-comment">// 处理绘制或选择</span><br>  }<br>}<br></code></pre></td></tr></table></figure><p><strong>onPointerMove 函数</strong>：当用户在画布上移动鼠标时触发，根据当前交互模式处理不同的移动逻辑（绘制、拖拽、调整大小等）</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> onPointerMove = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">e</span>: PIXI.<span class="hljs-title class_">FederatedPointerEvent</span></span>) =&gt;</span> {<br>  <span class="hljs-comment">// 处理防抖</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerDebounceSnapshot</span>()<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'idle'</span>) <span class="hljs-keyword">return</span><br><br>  <span class="hljs-keyword">const</span> state = useStore.<span class="hljs-title function_">getState</span>()<br>  <span class="hljs-keyword">const</span> currentPos = e.<span class="hljs-title function_">getLocalPosition</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">viewport</span>)<br><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">mode</span>) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'selecting'</span>:<br>      <span class="hljs-comment">// 处理选择框绘制</span><br>      <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'erasing'</span>:<br>      <span class="hljs-comment">// 处理橡皮擦操作</span><br>      <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'dragging'</span>:<br>      <span class="hljs-comment">// 处理元素拖拽</span><br>      <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'resizing'</span>:<br>      <span class="hljs-comment">// 处理元素调整大小</span><br>      <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'drawing'</span>:<br>      <span class="hljs-comment">// 处理元素绘制</span><br>      <span class="hljs-keyword">break</span><br>  }<br>}<br></code></pre></td></tr></table></figure><h3 id="5-UI-与样式实现-UI-Implementation"><a href="#5-UI-与样式实现-UI-Implementation" class="headerlink" title="5. UI 与样式实现 (UI Implementation)"></a>5. UI 与样式实现 (UI Implementation)</h3><p>逻辑层通过管理不同图层来实现 UI 布局：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[Viewport] --&gt; B[elementLayer]<br>    A --&gt; C[uiLayer]<br>    B --&gt; D[图形元素]<br>    C --&gt; E[选区框]<br>    C --&gt; F[橡皮擦指示器]<br>    C --&gt; G[变换控制器]<br>    <br>    style A fill:#e1f5fe<br>    style B fill:#f3e5f5<br>    style C fill:#e8f5e8<br>    style D fill:#fce4ec<br>    style E fill:#fff3e0<br>    style F fill:#fff3e0<br>    style G fill:#fff3e0<br></code></pre></td></tr></table></figure><p>使用 PixiJS 的容器系统管理图层，分为元素层和 UI 层，通过 PIXI.Graphics API 实现图形绘制，通过 CSS 控制光标样式</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-模块摘要-Executive-Summary&quot;&gt;&lt;a href=&quot;#1-模块摘要-Executive-Summary&quot; class=&quot;headerlink&quot; title=&quot;1. 模块摘要 (Executive Summary)&quot;&gt;&lt;/a&gt;1. 模块摘要 (Ex</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
    <category term="PixiJS" scheme="https://zhongye1.github.io/Arknight-notes/tags/PixiJS/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-23-canvas项目相关-状态管理层</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/61173.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/61173.html</id>
    <published>2025-11-23T09:17:00.000Z</published>
    <updated>2025-11-23T16:04:20.906Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-模块摘要-Executive-Summary"><a href="#1-模块摘要-Executive-Summary" class="headerlink" title="1. 模块摘要 (Executive Summary)"></a>1. 模块摘要 (Executive Summary)</h3><p>状态管理层管理画布元素数据、选中状态、工具状态、剪贴板数据等核心业务数据，是整个画布应用的数据核心，负责维护所有画布元素的状态信息和用户交互相关的全局状态。它采用了 Zustand 作为状态管理库，实现了数据的集中管理和状态变更的响应式更新</p><ul><li><p><strong>项目结构树</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">src/<br>└── stores/<br>    └── canvasStore.ts        <span class="hljs-comment"># Zustand 状态管理核心文件</span><br></code></pre></td></tr></table></figure><ul><li><code>Zustand</code>：轻量级状态管理库，用于管理全局状态</li><li><code>nanoid</code>：用于生成唯一 ID</li><li><code>structuredClone</code>：用于深拷贝状态数据</li></ul></li></ul><h3 id="2-Props-和相关类型定义"><a href="#2-Props-和相关类型定义" class="headerlink" title="2. Props 和相关类型定义"></a>2. Props 和相关类型定义</h3><h4 id="2-1-useStore-参数"><a href="#2-1-useStore-参数" class="headerlink" title="2.1 useStore 参数"></a>2.1 useStore 参数</h4><p>状态管理模块通过 <a href="/src/stores/canvasStore.ts#L35-L136">useStore</a> Hook 提供状态访问和更新功能。</p><div class="table-container"><table><thead><tr><th>参数名</th><th>类型</th><th>必填</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>setTool</td><td>Function</td><td>是</td><td>无</td><td>设置当前使用的工具类型</td></tr><tr><td>addElement</td><td>Function</td><td>是</td><td>无</td><td>添加新元素到画布</td></tr><tr><td>updateElement</td><td>Function</td><td>是</td><td>无</td><td>更新指定元素的属性</td></tr><tr><td>removeElements</td><td>Function</td><td>是</td><td>无</td><td>从画布中移除指定元素</td></tr><tr><td>setSelected</td><td>Function</td><td>是</td><td>无</td><td>设置当前选中的元素</td></tr><tr><td>setEditingId</td><td>Function</td><td>是</td><td>无</td><td>设置当前正在编辑的元素</td></tr><tr><td>copyElements</td><td>Function</td><td>是</td><td>无</td><td>复制指定元素到剪贴板</td></tr><tr><td>pasteElements</td><td>Function</td><td>是</td><td>无</td><td>从剪贴板粘贴元素到画布</td></tr></tbody></table></div><p>代码示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 设置工具类型</span><br>useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">setTool</span>(<span class="hljs-string">"rect"</span>);<br><br><span class="hljs-comment">// 添加元素</span><br>useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">addElement</span>({<br>  <span class="hljs-attr">id</span>: <span class="hljs-string">"element1"</span>,<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">"rect"</span>,<br>  <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,<br>  <span class="hljs-attr">y</span>: <span class="hljs-number">100</span>,<br>  <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,<br>  <span class="hljs-attr">height</span>: <span class="hljs-number">150</span>,<br>  <span class="hljs-attr">fill</span>: <span class="hljs-string">"#ff0000"</span>,<br>  <span class="hljs-attr">stroke</span>: <span class="hljs-string">"#000000"</span>,<br>  <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">2</span>,<br>});<br><br><span class="hljs-comment">// 更新元素</span><br>useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">updateElement</span>(<span class="hljs-string">"element1"</span>, { <span class="hljs-attr">fill</span>: <span class="hljs-string">"#00ff00"</span> });<br><br><span class="hljs-comment">// 移除元素</span><br>useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">removeElements</span>([<span class="hljs-string">"element1"</span>]);<br></code></pre></td></tr></table></figure><h4 id="2-2-核心类型定义"><a href="#2-2-核心类型定义" class="headerlink" title="2.2 核心类型定义"></a>2.2 核心类型定义</h4><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/core/types.ts#L15-L15">CanvasElement</a> 类型</strong>：<br>定义了画布上所有元素的基本属性和可选属性。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CanvasElement</span> {<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 元素唯一标识符</span><br>  <span class="hljs-attr">type</span>: <span class="hljs-title class_">ToolType</span>; <span class="hljs-comment">// 元素类型</span><br>  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 元素左上角 x 坐标</span><br>  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 元素左上角 y 坐标</span><br>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 元素宽度</span><br>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 元素高度</span><br>  <span class="hljs-attr">fill</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 填充颜色</span><br>  <span class="hljs-attr">stroke</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 描边颜色</span><br>  <span class="hljs-attr">strokeWidth</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 描边宽度</span><br>  <span class="hljs-attr">alpha</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 透明度</span><br>  <span class="hljs-attr">points</span>?: <span class="hljs-built_in">number</span>[][]; <span class="hljs-comment">// 点坐标数组（用于线条类元素）</span><br>  <span class="hljs-attr">rotation</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 旋转角度（弧度制）</span><br>  <span class="hljs-attr">text</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 文本内容（HTML 格式）</span><br>  <span class="hljs-attr">fontSize</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 字体大小</span><br>  <span class="hljs-attr">fontFamily</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 字体族</span><br>  <span class="hljs-attr">textAlign</span>?: <span class="hljs-string">"left"</span> | <span class="hljs-string">"center"</span> | <span class="hljs-string">"right"</span>; <span class="hljs-comment">// 文本对齐方式</span><br>  <span class="hljs-attr">imageUrl</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 图片 URL</span><br>  <span class="hljs-attr">filter</span>?: <span class="hljs-string">"none"</span> | <span class="hljs-string">"blur"</span> | <span class="hljs-string">"brightness"</span> | <span class="hljs-string">"grayscale"</span>; <span class="hljs-comment">// 图片滤镜</span><br>  <span class="hljs-attr">radius</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 圆角半径</span><br>}<br></code></pre></td></tr></table></figure><p><strong><a href="/src/stores/canvasStore.ts#L6-L21">ToolType</a> 类型</strong>：<br>定义了用户可选择的工具类型。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToolType</span> =<br>  | <span class="hljs-string">"select"</span> <span class="hljs-comment">// 选择工具</span><br>  | <span class="hljs-string">"hand"</span> <span class="hljs-comment">// 手型工具</span><br>  | <span class="hljs-string">"rect"</span> <span class="hljs-comment">// 矩形工具</span><br>  | <span class="hljs-string">"circle"</span> <span class="hljs-comment">// 圆形工具</span><br>  | <span class="hljs-string">"triangle"</span> <span class="hljs-comment">// 三角形工具</span><br>  | <span class="hljs-string">"diamond"</span> <span class="hljs-comment">// 菱形工具</span><br>  | <span class="hljs-string">"line"</span> <span class="hljs-comment">// 直线工具</span><br>  | <span class="hljs-string">"arrow"</span> <span class="hljs-comment">// 箭头工具</span><br>  | <span class="hljs-string">"pencil"</span> <span class="hljs-comment">// 铅笔工具</span><br>  | <span class="hljs-string">"text"</span> <span class="hljs-comment">// 文本工具</span><br>  | <span class="hljs-string">"image"</span> <span class="hljs-comment">// 图片工具</span><br>  | <span class="hljs-string">"eraser"</span>; <span class="hljs-comment">// 橡皮擦工具</span><br></code></pre></td></tr></table></figure><h3 id="3-核心状态管理-State-Architecture"><a href="#3-核心状态管理-State-Architecture" class="headerlink" title="3. 核心状态管理 (State Architecture)"></a>3. 核心状态管理 (State Architecture)</h3><p>状态管理层维护以下内部状态：</p><div class="table-container"><table><thead><tr><th>状态名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>tool</td><td><a href="/src/stores/canvasStore.ts#L6-L21">ToolType</a></td><td>当前选中的工具类型</td></tr><tr><td>elements</td><td>Record&lt;string, [CanvasElement](/src/pages/canvas/Pixi_STM_modules/core/types.ts#L15-L15)&gt;</td><td>所有画布元素的集合</td></tr><tr><td>selectedIds</td><td>string[]</td><td>当前选中的元素 ID 数组</td></tr><tr><td>editingId</td><td>string \</td><td>null</td><td>当前正在编辑的元素 ID</td></tr><tr><td>clipboard</td><td><a href="/src/pages/canvas/Pixi_STM_modules/core/types.ts#L15-L15">CanvasElement</a>[] \</td><td>null</td><td>剪贴板数据</td></tr><tr><td>pasteOffset</td><td>number</td><td>粘贴偏移计数</td></tr><tr><td>currentStyle</td><td>Object</td><td>当前样式设置</td></tr></tbody></table></div><h4 id="3-3-状态同步机制"><a href="#3-3-状态同步机制" class="headerlink" title="3.3 状态同步机制"></a>3.3 状态同步机制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>    A[Zustand Store 状态变更] --&gt; B{订阅者监听}<br>    B --&gt; C[StageManager 订阅]<br>    B --&gt; D[UI 组件订阅]<br>    C --&gt; E[触发渲染层更新]<br>    D --&gt; F[触发 UI 更新]<br>    <br>    style A fill:#e1f5fe<br>    style E fill:#e8f5e8<br>    style F fill:#fff3e0<br></code></pre></td></tr></table></figure><h3 id="4-逻辑流程-Logic-Flow"><a href="#4-逻辑流程-Logic-Flow" class="headerlink" title="4. 逻辑流程 (Logic Flow)"></a>4. 逻辑流程 (Logic Flow)</h3><h4 id="4-1-交互时序图-Mermaid"><a href="#4-1-交互时序图-Mermaid" class="headerlink" title="4.1 交互时序图 (Mermaid)"></a>4.1 交互时序图 (Mermaid)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">sequenceDiagram<br>    participant U as 用户<br>    participant C as CanvasStore<br>    participant SM as StageManager<br>    participant R as 渲染层<br>    <br>    U-&gt;&gt;C: 调用 Action (如 addElement)<br>    C-&gt;&gt;C: 更新内部状态<br>    C-&gt;&gt;SM: 通知状态变更<br>    SM-&gt;&gt;R: 触发重新渲染<br>    R-&gt;&gt;R: 更新 PIXI 对象<br>    R-&gt;&gt;U: 显示更新结果<br></code></pre></td></tr></table></figure><h4 id="4-2-核心函数"><a href="#4-2-核心函数" class="headerlink" title="4.2 核心函数"></a>4.2 核心函数</h4><p><strong>addElement 函数</strong>：当用户创建新元素时调用，创建新元素并添加到 elements 集合中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-attr">addElement</span>: <span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span><br>  <span class="hljs-title function_">originalSet</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({<br>    <span class="hljs-attr">elements</span>: { ...state.<span class="hljs-property">elements</span>, [el.<span class="hljs-property">id</span>]: el },<br>  }));<br></code></pre></td></tr></table></figure><p><strong>updateElement 函数</strong>：当用户修改元素属性时调用，更新指定元素的属性并保持其他元素不变</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-attr">updateElement</span>: <span class="hljs-function">(<span class="hljs-params">id, attrs</span>) =&gt;</span><br>  <span class="hljs-title function_">originalSet</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {<br>    <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">elements</span>[id]) <span class="hljs-keyword">return</span> state;<br>    <span class="hljs-keyword">return</span> {<br>      <span class="hljs-attr">elements</span>: {<br>        ...state.<span class="hljs-property">elements</span>,<br>        [id]: { ...state.<span class="hljs-property">elements</span>[id], ...attrs },<br>      },<br>    };<br>  });<br></code></pre></td></tr></table></figure><p>状态管理层作为纯数据层，不直接涉及 UI 和样式实现，但为上层 UI 提供了必要的状态支持，通过状态结构支持上层组件的布局逻辑和状态中的样式属性支持上层组件的样式实现</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-模块摘要-Executive-Summary&quot;&gt;&lt;a href=&quot;#1-模块摘要-Executive-Summary&quot; class=&quot;headerlink&quot; title=&quot;1. 模块摘要 (Executive Summary)&quot;&gt;&lt;/a&gt;1. 模块摘要 (Ex</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
    <category term="Zustand" scheme="https://zhongye1.github.io/Arknight-notes/tags/Zustand/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-23-canvas项目相关-渲染层</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/8350.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/8350.html</id>
    <published>2025-11-23T06:56:37.000Z</published>
    <updated>2025-11-23T16:06:10.487Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-模块摘要-Executive-Summary"><a href="#1-模块摘要-Executive-Summary" class="headerlink" title="1. 模块摘要 (Executive Summary)"></a>1. 模块摘要 (Executive Summary)</h3><p>渲染层是基于 PixiJS 构建的可视化层，负责将存储在 Zustand 状态管理器中的画布元素数据转化为可视化的图形界面，并处理用户的交互操作。它主要包括元素渲染（ElementRenderer）和变换控制器渲染（TransformerRenderer）两大部分，分别负责绘制元素本身和元素的选中状态、控制手柄等辅助 UI。</p><p>其项目结构树如下：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix">src<span class="hljs-symbol">/</span><br>└── pages<span class="hljs-symbol">/</span><br>    └── canvas<span class="hljs-symbol">/</span><br>        ├── Pixi_stageManager.ts               <span class="hljs-comment"># 整合StageManager各模块的入口文件</span><br>        ├── index.tsx                          <span class="hljs-comment"># 画布页面组件，整合渲染层到React组件中</span><br>        └── Pixi_STM_modules<span class="hljs-symbol">/</span>                  <span class="hljs-comment"># StageManager模块目录</span><br>            ├── STM_modules.md                 <span class="hljs-comment"># 模块设计文档</span><br>            ├── core<span class="hljs-symbol">/</span><br>            │   ├── StageManagerCore.ts        <span class="hljs-comment"># 核心类，整合渲染、交互和状态管理</span><br>            │   └── types.ts                   <span class="hljs-comment"># 类型定义文件</span><br>            ├── rendering<span class="hljs-symbol">/</span><br>            │   ├── ElementRenderer.ts         <span class="hljs-comment"># 元素渲染器，负责渲染各类画布元素</span><br>            │   └── TransformerRenderer.ts     <span class="hljs-comment"># 变换控制器渲染器，负责渲染选中元素的手柄等</span><br>            ├── interaction<span class="hljs-symbol">/</span><br>            │   └── InteractionHandler.ts      <span class="hljs-comment"># 交互处理器，绑定和处理各种交互事件</span><br>            └── utils<span class="hljs-symbol">/</span><br>                └── cursorUtils.ts             <span class="hljs-comment"># 光标工具函数</span><br></code></pre></td></tr></table></figure><p>该模块主要负责将状态管理层的数据渲染成可视化图形，并处理用户交互反馈</p><ul><li><code>pixi.js</code>：WebGL 渲染引擎</li><li><code>pixi-viewport</code>：视口管理插件</li><li><code>zustand</code>：状态管理库（虽然不是渲染层直接依赖，但与其紧密协作）</li></ul><h3 id="2-Props-和相关类型定义"><a href="#2-Props-和相关类型定义" class="headerlink" title="2. Props 和相关类型定义"></a>2. Props 和相关类型定义</h3><p>渲染层接收来自逻辑层的 props 参数，用于驱动元素渲染和交互控制。这些参数主要包括元素数据、状态信息和事件回调函数。</p><h4 id="2-1-ElementRenderer-renderElements-方法参数"><a href="#2-1-ElementRenderer-renderElements-方法参数" class="headerlink" title="2.1 ElementRenderer.renderElements 方法参数"></a>2.1 ElementRenderer.renderElements 方法参数</h4><p>ElementRenderer 负责将画布元素数据渲染为 PIXI 可视化对象，其 <a href="src/pages/canvas/Pixi_STM_modules/rendering/ElementRenderer.ts#L57-L157">renderElements</a> 方法接收以下参数：</p><div class="table-container"><table><thead><tr><th style="text-align:left">字段名</th><th style="text-align:left">类型</th><th style="text-align:left">必填</th><th style="text-align:left">默认值</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">elements</td><td style="text-align:left">Record<string, CanvasElement=""></string,></td><td style="text-align:left">是</td><td style="text-align:left">无</td><td style="text-align:left">包含所有画布元素的数据对象</td></tr><tr><td style="text-align:left">elementLayer</td><td style="text-align:left">PIXI.Container</td><td style="text-align:left">是</td><td style="text-align:left">无</td><td style="text-align:left">用于承载所有可视元素的容器</td></tr><tr><td style="text-align:left">destroyed</td><td style="text-align:left">boolean</td><td style="text-align:left">是</td><td style="text-align:left">false</td><td style="text-align:left">标识组件是否已被销毁</td></tr></tbody></table></div><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-comment">// elements对象结构示例</span><br><span class="hljs-punctuation">{</span><br>  <span class="hljs-string">"element1"</span>: <span class="hljs-punctuation">{</span><br><span class="hljs-symbol">    id:</span> <span class="hljs-string">"element1"</span>,<br><span class="hljs-symbol">    type:</span> <span class="hljs-string">"rect"</span>,<br><span class="hljs-symbol">    x:</span> <span class="hljs-number">100</span>,<br><span class="hljs-symbol">    y:</span> <span class="hljs-number">100</span>,<br><span class="hljs-symbol">    width:</span> <span class="hljs-number">200</span>,<br><span class="hljs-symbol">    height:</span> <span class="hljs-number">150</span>,<br><span class="hljs-symbol">    fill:</span> <span class="hljs-string">"#ff0000"</span><br>  <span class="hljs-punctuation">}</span>,<br>  <span class="hljs-string">"element2"</span>: <span class="hljs-punctuation">{</span><br><span class="hljs-symbol">    id:</span> <span class="hljs-string">"element2"</span>,<br><span class="hljs-symbol">    type:</span> <span class="hljs-string">"text"</span>,<br><span class="hljs-symbol">    x:</span> <span class="hljs-number">50</span>,<br><span class="hljs-symbol">    y:</span> <span class="hljs-number">50</span>,<br><span class="hljs-symbol">    width:</span> <span class="hljs-number">300</span>,<br><span class="hljs-symbol">    height:</span> <span class="hljs-number">100</span>,<br><span class="hljs-symbol">    text:</span> <span class="hljs-string">"&lt;p&gt;示例文本&lt;/p&gt;"</span><br>  <span class="hljs-punctuation">}</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><p><a href="src/pages/canvas/Pixi_STM_modules/core/StageManagerCore.ts#L36-L36">elementLayer</a>: PIXI.Container - PIXI.js 中的容器对象，用于承载所有画布元素的可视化对象。ElementRenderer 会将创建的 PIXI 对象添加到这个容器中，以便在画布上显示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 在StageManagerCore.ts中创建elementLayer</span><br><span class="hljs-keyword">private</span> elementLayer: PIXI.Container = new PIXI.Container()<br><span class="hljs-comment">// 然后传给ElementRenderer</span><br><span class="hljs-keyword">this</span>.elementRenderer.renderElements(elements, <span class="hljs-keyword">this</span>.elementLayer, <span class="hljs-keyword">this</span>.state.destroyed)<br></code></pre></td></tr></table></figure><p>destroyed: boolean - 标识渲染器是否已被销毁。当组件被销毁时，此参数防止在销毁后继续执行渲染操作，避免内存泄漏。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">public</span> <span class="hljs-title function_">renderElements</span>(<span class="hljs-params"><span class="hljs-attr">elements</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CanvasElement</span>&gt;, <span class="hljs-attr">elementLayer</span>: PIXI.<span class="hljs-title class_">Container</span>, <span class="hljs-attr">destroyed</span>: <span class="hljs-built_in">boolean</span></span>) {<br>  <span class="hljs-keyword">if</span> (destroyed) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 如果已销毁，直接返回不执行渲染</span><br>  <span class="hljs-comment">// ... 其他渲染逻辑</span><br>}<br></code></pre></td></tr></table></figure><h4 id="2-2-TransformerRenderer-renderTransformer-方法参数"><a href="#2-2-TransformerRenderer-renderTransformer-方法参数" class="headerlink" title="2.2 TransformerRenderer.renderTransformer 方法参数"></a>2.2 TransformerRenderer.renderTransformer 方法参数</h4><p>TransformerRenderer 负责渲染选中元素的变换控制器（手柄、边框等），其 <a href="src/pages/canvas/Pixi_STM_modules/rendering/TransformerRenderer.ts#L31-L182">renderTransformer</a> 方法接收以下参数：</p><div class="table-container"><table><thead><tr><th style="text-align:left">参数名</th><th style="text-align:left">类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">elements</td><td style="text-align:left">Record<string, CanvasElement=""></string,></td><td style="text-align:left">所有画布元素的数据</td></tr><tr><td style="text-align:left">selectedIds</td><td style="text-align:left">string[]</td><td style="text-align:left">当前选中元素的 ID 数组</td></tr><tr><td style="text-align:left">spriteMap</td><td style="text-align:left">Map<string, PIXI.DisplayObject=""></string,></td><td style="text-align:left">元素 ID 到 PIXI 可视化对象的映射</td></tr><tr><td style="text-align:left">onHandleDown</td><td style="text-align:left">Function</td><td style="text-align:left">手柄按下事件的回调函数</td></tr><tr><td style="text-align:left">viewportScale</td><td style="text-align:left">number</td><td style="text-align:left">当前视口的缩放比例</td></tr></tbody></table></div><p>elements: Record<string, CanvasElement=""> - 与 ElementRenderer 中的 elements 相同，提供所有画布元素的数据。TransformerRenderer 需要访问元素数据来计算选中元素的边界框和位置信息。</string,></p><p>selectedIds: string[] - 包含当前选中元素 ID 的数组。TransformerRenderer 根据这个数组决定是否以及如何绘制变换控制器（选中框和手柄）。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// selectedIds数组示例</span><br>;<span class="hljs-selector-attr">[<span class="hljs-string">'element1'</span>, <span class="hljs-string">'element3'</span>]</span> <span class="hljs-comment">// 表示element1和element3被选中</span><br></code></pre></td></tr></table></figure><p>spriteMap: Map&lt;string, PIXI.Graphics | PIXI.HTMLText | PIXI.Sprite&gt; - 提供元素 ID 到 PIXI 可视化对象的映射。TransformerRenderer 需要访问实际的 PIXI 对象来准确计算元素的边界（特别是文本元素）。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment">// spriteMap结构示例</span><br><span class="hljs-built_in">Map</span>(<span class="hljs-number">2</span>) {<br>  <span class="hljs-string">"element1"</span> =&gt; Graphics {},     <span class="hljs-comment">// 矩形元素的PIXI.Graphics对象</span><br>  <span class="hljs-string">"element2"</span> =&gt; HTMLText {}      <span class="hljs-comment">// 文本元素的PIXI.HTMLText对象</span><br>}<br></code></pre></td></tr></table></figure><p>onHandleDown: Function - 手柄按下事件的回调函数。当用户点击变换控制器上的手柄时，会调用这个函数开始变换操作（如缩放、旋转）。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 在StageManagerCore.ts中定义并传递给TransformerRenderer</span><br><span class="hljs-keyword">private</span> onHandleDown = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">e</span>: PIXI.<span class="hljs-title class_">FederatedPointerEvent</span>, <span class="hljs-attr">handle</span>: <span class="hljs-title class_">HandleType</span> | <span class="hljs-string">'p0'</span> | <span class="hljs-string">'p1'</span>, <span class="hljs-attr">elementId</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> {<br>  <span class="hljs-comment">// 处理手柄按下事件</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">mode</span> = <span class="hljs-string">'resizing'</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">activeHandle</span> = handle <span class="hljs-keyword">as</span> <span class="hljs-title class_">HandleType</span> | <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// ... 其他逻辑</span><br>}<br></code></pre></td></tr></table></figure><p>viewportScale: number - 当前视口的缩放比例。TransformerRenderer 使用这个值来调整手柄和控制器的大小，确保在不同缩放级别下都有合适的尺寸。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 在StageManagerCore.ts中获取并传递视口缩放比例</span><br><span class="hljs-keyword">this</span>.transformerRenderer.renderTransformer(<br>  elements,<br>  selectedIds,<br>  <span class="hljs-keyword">this</span>.elementRenderer.getSpriteMap(),<br>  <span class="hljs-keyword">this</span>.onHandleDown,<br>  <span class="hljs-keyword">this</span>.viewport.scale.x, <span class="hljs-comment">// 传递视口缩放比例</span><br>)<br></code></pre></td></tr></table></figure><h3 id="2-3-核心类型定义"><a href="#2-3-核心类型定义" class="headerlink" title="2.3 核心类型定义"></a>2.3 核心类型定义</h3><p>渲染层涉及到的关键类型定义如下：</p><h4 id="CanvasElement-类型"><a href="#CanvasElement-类型" class="headerlink" title="CanvasElement 类型"></a>CanvasElement 类型</h4><p>定义了画布元素的基本属性和可选属性：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CanvasElement</span> {<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">type</span>:<br>    | <span class="hljs-string">"rect"</span><br>    | <span class="hljs-string">"circle"</span><br>    | <span class="hljs-string">"triangle"</span><br>    | <span class="hljs-string">"text"</span><br>    | <span class="hljs-string">"image"</span><br>    | <span class="hljs-string">"line"</span><br>    | <span class="hljs-string">"arrow"</span><br>    | <span class="hljs-string">"pencil"</span>;<br>  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">fill</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">stroke</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">strokeWidth</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-comment">// 根据元素类型可能包含额外属性</span><br>  <span class="hljs-attr">text</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 文本元素</span><br>  <span class="hljs-attr">imageUrl</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 图片元素</span><br>  <span class="hljs-attr">points</span>?: <span class="hljs-built_in">number</span>[][]; <span class="hljs-comment">// 线条/铅笔元素</span><br>  <span class="hljs-attr">fontSize</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 文本元素</span><br>  <span class="hljs-attr">fontFamily</span>?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 文本元素</span><br>  <span class="hljs-attr">alpha</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 透明度</span><br>  <span class="hljs-attr">radius</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 圆角矩形</span><br>}<br></code></pre></td></tr></table></figure><h4 id="HandleType-类型"><a href="#HandleType-类型" class="headerlink" title="HandleType 类型"></a>HandleType 类型</h4><p>定义了变换控制器上各种手柄的类型：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">HandleType</span> =<br>  | <span class="hljs-string">"tl"</span> <span class="hljs-comment">// top-left 左上角</span><br>  | <span class="hljs-string">"t"</span> <span class="hljs-comment">// top 顶部中间</span><br>  | <span class="hljs-string">"tr"</span> <span class="hljs-comment">// top-right 右上角</span><br>  | <span class="hljs-string">"r"</span> <span class="hljs-comment">// right 右侧中间</span><br>  | <span class="hljs-string">"br"</span> <span class="hljs-comment">// bottom-right 右下角</span><br>  | <span class="hljs-string">"b"</span> <span class="hljs-comment">// bottom 底部中间</span><br>  | <span class="hljs-string">"bl"</span> <span class="hljs-comment">// bottom-left 左下角</span><br>  | <span class="hljs-string">"l"</span> <span class="hljs-comment">// left 左侧中间</span><br>  | <span class="hljs-string">"p0"</span> <span class="hljs-comment">// 线段起点</span><br>  | <span class="hljs-string">"p1"</span> <span class="hljs-comment">// 线段终点</span><br>  | <span class="hljs-string">"rotate"</span>; <span class="hljs-comment">// 旋转手柄</span><br></code></pre></td></tr></table></figure><h3 id="3-核心状态管理-State-Architecture"><a href="#3-核心状态管理-State-Architecture" class="headerlink" title="3. 核心状态管理 (State Architecture)"></a>3. 核心状态管理 (State Architecture)</h3><p>渲染层采用内外结合的状态管理模式，既维护自身的局部状态，又与外部的 Zustand 状态管理库协同工作。</p><h4 id="3-1-内部状态-Local-State"><a href="#3-1-内部状态-Local-State" class="headerlink" title="3.1 内部状态 (Local State)"></a>3.1 内部状态 (Local State)</h4><p>渲染层维护一组局部状态，用于管理 PIXI 对象和渲染优化：</p><div class="table-container"><table><thead><tr><th style="text-align:left">状态名</th><th style="text-align:left">类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>spriteMap</code></td><td style="text-align:left">`Map&lt;string, PIXI.Graphics \</td><td style="text-align:left">PIXI.HTMLText \</td><td>PIXI.Sprite&gt;`</td><td>存储元素 ID 到 PIXI 图形对象的映射关系，用于快速查找和更新元素</td></tr><tr><td style="text-align:left"><code>textureCache</code></td><td style="text-align:left"><code>Map&lt;string, PIXI.Texture&gt;</code></td><td style="text-align:left">图片纹理缓存，避免重复加载相同图片</td></tr><tr><td style="text-align:left"><code>loadingSet</code></td><td style="text-align:left"><code>Set&lt;string&gt;</code></td><td style="text-align:left">正在加载中的图片 URL 集合，防止重复加载</td></tr><tr><td style="text-align:left"><code>imageUpdateTimers</code></td><td style="text-align:left"><code>Map&lt;string, NodeJS.Timeout&gt;</code></td><td style="text-align:left">图像元素更新检查定时器映射</td></tr><tr><td style="text-align:left"><code>transformerGraphic</code></td><td style="text-align:left"><code>PIXI.Graphics</code></td><td style="text-align:left">用于绘制变换控制器（选中框、手柄等）的图形对象</td></tr></tbody></table></div><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ElementRenderer 内部状态示例</span><br><span class="hljs-keyword">private</span> <span class="hljs-attr">spriteMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">DisplayObject</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()<br><span class="hljs-keyword">private</span> <span class="hljs-attr">textureCache</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">Texture</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()<br><span class="hljs-keyword">private</span> <span class="hljs-attr">loadingSet</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()<br><span class="hljs-keyword">private</span> <span class="hljs-attr">imageUpdateTimers</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()<br><br><span class="hljs-comment">// TransformerRenderer 内部状态示例</span><br><span class="hljs-keyword">private</span> <span class="hljs-attr">transformerGraphic</span>: <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">Graphics</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-title class_">Graphics</span>()<br><br></code></pre></td></tr></table></figure><h4 id="3-2-外部状态-Global-Server-State"><a href="#3-2-外部状态-Global-Server-State" class="headerlink" title="3.2 外部状态 (Global/Server State)"></a>3.2 外部状态 (Global/Server State)</h4><p>渲染层通过订阅 Zustand 状态管理库中的 <a href="src/stores/canvasStore.ts#L35-L136">canvasStore</a> 来获取画布元素数据和选中状态：</p><div class="table-container"><table><thead><tr><th style="text-align:left">状态名</th><th style="text-align:left">类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>elements</code></td><td style="text-align:left"><code>Record&lt;string, CanvasElement&gt;</code></td><td style="text-align:left">所有画布元素的数据对象</td></tr><tr><td style="text-align:left"><code>selectedIds</code></td><td style="text-align:left"><code>string[]</code></td><td style="text-align:left">当前选中元素的 ID 数组</td></tr></tbody></table></div><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// StageManagerCore.ts 中订阅外部状态的方式</span><br>useStore.<span class="hljs-title function_">subscribe</span>(<br>  <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">elements</span>: state.<span class="hljs-property">elements</span>, <span class="hljs-attr">selectedIds</span>: state.<span class="hljs-property">selectedIds</span> }),<br>  <span class="hljs-function">(<span class="hljs-params">{ elements, selectedIds }</span>) =&gt;</span> {<br>    <span class="hljs-comment">// 当 elements 或 selectedIds 发生变化时触发重新渲染</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();<br>  },<br>  { <span class="hljs-attr">equalityFn</span>: shallow }<br>);<br></code></pre></td></tr></table></figure><h4 id="3-3-状态同步机制"><a href="#3-3-状态同步机制" class="headerlink" title="3.3 状态同步机制"></a>3.3 状态同步机制</h4><p>渲染层通过增量更新（Diffing）算法实现高效的状态同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>A[Zustand Store 状态变更] --&gt; B{StageManager 订阅}<br>B --&gt; C{Diff 算法对比}<br>C --&gt;|新增元素| D[创建 PIXI 对象]<br>C --&gt;|更新元素| E[更新 PIXI 对象属性]<br>C --&gt;|删除元素| F[销毁 PIXI 对象]<br>D --&gt; G[添加到 spriteMap]<br>E --&gt; G<br>F --&gt; H[从 spriteMap 移除]<br>G --&gt; I[PixiJS 渲染]<br>H --&gt; I<br>    style A fill:#e1f5fe<br>    style I fill:#e8f5e8<br>    style G fill:#fff3e0<br>    style H fill:#ffebee<br><br></code></pre></td></tr></table></figure><h3 id="4-逻辑流程-Logic-Flow"><a href="#4-逻辑流程-Logic-Flow" class="headerlink" title="4. 逻辑流程 (Logic Flow)"></a>4. 逻辑流程 (Logic Flow)</h3><h4 id="4-1-交互时序图-Mermaid"><a href="#4-1-交互时序图-Mermaid" class="headerlink" title="4.1 交互时序图 (Mermaid)"></a>4.1 交互时序图 (Mermaid)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">sequenceDiagram<br>participant U as 用户<br>participant SM as StageManagerCore<br>participant ER as ElementRenderer<br>participant TR as TransformerRenderer<br>participant S as Zustand Store<br><br>    U-&gt;&gt;SM: 触发状态变更 (添加/更新元素)<br>    SM-&gt;&gt;S: 更新elements数据<br>    S-&gt;&gt;SM: 通知状态变更<br>    SM-&gt;&gt;ER: 调用renderElements()<br>    ER-&gt;&gt;ER: 根据元素类型创建/更新PIXI对象<br>    ER-&gt;&gt;SM: 更新spriteMap<br>    <br>    U-&gt;&gt;SM: 选择元素<br>    SM-&gt;&gt;S: 更新selectedIds<br>    S-&gt;&gt;SM: 通知选中状态变更<br>    SM-&gt;&gt;TR: 调用renderTransformer()<br>    TR-&gt;&gt;TR: 根据选中元素绘制变换控制器<br></code></pre></td></tr></table></figure><hr><h4 id="4-2-核心函数解析"><a href="#4-2-核心函数解析" class="headerlink" title="4.2 核心函数解析"></a>4.2 核心函数解析</h4><ul><li><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/rendering/ElementRenderer.ts#L57-L157">ElementRenderer.renderElements()</a></strong>:</p><ul><li><p><strong>触发时机</strong>: 当画布元素数据发生变更时，通过状态订阅机制触发。每当 Zustand store 中的 <a href="/src/stores/canvasStore.ts#L44-L44">elements</a> 对象发生变化时，StageManagerCore 会调用此方法进行重新渲染。</p></li><li><p><strong>逻辑闭环</strong>: 遍历所有元素数据，根据元素类型创建或更新对应的 PIXI 对象，并将其添加到容器中。通过 diff 算法比较现有 spriteMap 和新元素数据（遍历 spriteMap 中的所有元素 ID，检查哪些元素在新的 elements 数据中不存在，这些元素需要被删除，遍历新的 elements 数据中的所有元素 ID，检查哪些是新增的元素需要创建，哪些是已存在的元素需要更新），确定需要创建、更新或删除的元素，最终保持 PIXI 对象与数据状态同步。</p></li><li><p><strong>核心实现</strong>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 核心渲染逻辑</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">renderElements</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-attr">elements</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CanvasElement</span>&gt;,</span><br><span class="hljs-params">  <span class="hljs-attr">elementLayer</span>: PIXI.<span class="hljs-title class_">Container</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">destroyed</span>: <span class="hljs-built_in">boolean</span></span><br><span class="hljs-params"></span>) {<br>  <span class="hljs-keyword">if</span> (destroyed) <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">// 获取当前所有元素ID</span><br>  <span class="hljs-keyword">const</span> elementIds = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(elements);<br><br>  <span class="hljs-comment">// 删除已移除的元素</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">keys</span>()) {<br>    <span class="hljs-keyword">if</span> (!elementIds.<span class="hljs-title function_">includes</span>(id)) {<br>      <span class="hljs-keyword">const</span> sprite = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">get</span>(id)!;<br>      sprite.<span class="hljs-title function_">destroy</span>({ <span class="hljs-attr">children</span>: <span class="hljs-literal">true</span> });<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">delete</span>(id);<br>    }<br>  }<br><br>  <span class="hljs-comment">// 更新或创建元素</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> elementIds) {<br>    <span class="hljs-keyword">const</span> data = elements[id];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">has</span>(id)) {<br>      <span class="hljs-comment">// 更新现有元素</span><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateElement</span>(data, <span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">get</span>(id)!);<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-comment">// 创建新元素</span><br>      <span class="hljs-keyword">const</span> sprite = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(data);<br>      elementLayer.<span class="hljs-title function_">addChild</span>(sprite);<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">spriteMap</span>.<span class="hljs-title function_">set</span>(id, sprite);<br>    }<br>  }<br>}<br></code></pre></td></tr></table></figure></li><li><p><strong>差异化渲染处理</strong>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 根据不同类型元素进行差异化渲染处理</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">CanvasElement</span>): <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">DisplayObject</span> {<br>  <span class="hljs-keyword">switch</span> (data.<span class="hljs-property">type</span>) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'rect'</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'circle'</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'triangle'</span>:<br>      <span class="hljs-comment">// 几何图形处理逻辑：使用Graphics API绘制形状</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createGraphicsElement</span>(data);<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'text'</span>:<br>      <span class="hljs-comment">// 文本元素处理逻辑：使用HTMLText组件渲染富文本</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createTextElement</span>(data);<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'image'</span>:<br>      <span class="hljs-comment">// 图片元素处理逻辑：加载纹理并创建Sprite</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createImageElement</span>(data);<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'line'</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'arrow'</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">'pencil'</span>:<br>      <span class="hljs-comment">// 线条/铅笔元素处理逻辑：使用Graphics API绘制线条</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createLineElement</span>(data);<br><br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unsupported element type: <span class="hljs-subst">${data.<span class="hljs-keyword">type</span>}</span>`</span>);<br>  }<br>}<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/rendering/TransformerRenderer.ts#L31-L182">TransformerRenderer.renderTransformer()</a></strong>:</p><ul><li><p><strong>触发时机</strong>: 当选中元素发生变更时触发。每当 Zustand store 中的 <a href="/src/stores/canvasStore.ts#L45-L45">selectedIds</a> 数组发生变化时，StageManagerCore 会调用此方法更新变换控制器的显示。</p></li><li><p><strong>逻辑闭环</strong>: 根据选中元素的数量和类型，绘制相应的变换控制器（如缩放手柄、旋转手柄等）。通过清除之前的控制器图形并根据当前选中状态重新绘制，保持变换控制器与选中状态同步。</p></li><li><p><strong>核心实现</strong>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 变换控制器渲染逻辑</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">renderTransformer</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-attr">elements</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CanvasElement</span>&gt;,</span><br><span class="hljs-params">  <span class="hljs-attr">selectedIds</span>: <span class="hljs-built_in">string</span>[],</span><br><span class="hljs-params">  <span class="hljs-attr">spriteMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, PIXI.<span class="hljs-title class_">DisplayObject</span>&gt;,</span><br><span class="hljs-params">  <span class="hljs-attr">onHandleDown</span>: (</span><br><span class="hljs-params">    e: PIXI.FederatedPointerEvent,</span><br><span class="hljs-params">    handle: HandleType | <span class="hljs-string">'p0'</span> | <span class="hljs-string">'p1'</span>,</span><br><span class="hljs-params">    elementId: <span class="hljs-built_in">string</span></span><br><span class="hljs-params">  ) =&gt; <span class="hljs-built_in">void</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">viewportScale</span>: <span class="hljs-built_in">number</span></span><br><span class="hljs-params"></span>) {<br>  <span class="hljs-comment">// 清除之前的变换控制器</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">transformerGraphic</span>.<span class="hljs-title function_">clear</span>();<br><br>  <span class="hljs-keyword">if</span> (selectedIds.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-keyword">if</span> (selectedIds.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {<br>    <span class="hljs-comment">// 单个元素选中逻辑</span><br>    <span class="hljs-keyword">const</span> element = elements[selectedIds[<span class="hljs-number">0</span>]];<br>    <span class="hljs-keyword">const</span> sprite = spriteMap.<span class="hljs-title function_">get</span>(selectedIds[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span> (sprite) {<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">drawSingleElementTransformer</span>(element, sprite, onHandleDown, viewportScale);<br>    }<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-comment">// 多个元素选中逻辑</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">drawMultiElementTransformer</span>(elements, selectedIds, spriteMap, onHandleDown, viewportScale);<br>  }<br>}<br></code></pre></td></tr></table></figure></li></ul></li></ul><h4 id="UI-与样式实现-UI-Implementation"><a href="#UI-与样式实现-UI-Implementation" class="headerlink" title="UI 与样式实现 (UI Implementation)"></a>UI 与样式实现 (UI Implementation)</h4><ul><li><p><strong>布局策略</strong>: 使用 PIXI 的容器系统进行布局管理，分为 <a href="/src/pages/canvas/Pixi_STM_modules/core/StageManagerCore.ts#L36-L36">elementLayer</a>（元素层）和 <a href="/src/pages/canvas/Pixi_STM_modules/core/StageManagerCore.ts#L37-L37">uiLayer</a>（UI 层）两个层级，通过坐标系统定位元素</p><ul><li><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/core/StageManagerCore.ts#L36-L36">elementLayer</a></strong>: 用于承载所有画布元素的容器层，包括矩形、圆形、文本、图像等各种元素的 PIXI 对象都添加到这一层。这是渲染层的主要内容，负责显示用户创建的所有图形元素。</p></li><li><p><strong><a href="/src/pages/canvas/Pixi_STM_modules/core/StageManagerCore.ts#L37-L37">uiLayer</a></strong>: 用于承载所有 UI 元素的容器层，包括选区框、橡皮擦指示器、变换控制器等辅助 UI 元素。这一层位于元素层之上，确保 UI 元素始终显示在图形元素的前面。</p></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 在 StageManagerCore.ts 中创建两个容器层</span><br><span class="hljs-keyword">private</span> <span class="hljs-attr">elementLayer</span>: <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">Container</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-title class_">Container</span>()<br><span class="hljs-keyword">private</span> <span class="hljs-attr">uiLayer</span>: <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-property">Container</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">PIXI</span>.<span class="hljs-title class_">Container</span>()<br><br><span class="hljs-comment">// 将两个容器层添加到视口中</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">viewport</span>.<span class="hljs-title function_">addChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elementLayer</span>)<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">viewport</span>.<span class="hljs-title function_">addChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiLayer</span>)<br></code></pre></td></tr></table></figure></li><li><p><strong>样式方案</strong>:</p><ul><li>几何图形使用 PIXI 的绘图 API 进行绘制，支持描边、填充、透明度等样式</li><li>文本元素使用 HTMLText 组件支持富文本渲染</li><li>图片元素使用 PIXI.Sprite 并支持滤镜效果（模糊、亮度、灰度等）</li><li>变换控制器统一使用紫色 (#8b5cf6) 作为主题色</li></ul></li><li><p><strong>条件渲染</strong>:</p><ul><li>根据元素类型选择不同的渲染方式</li><li>根据选中状态决定是否显示变换控制器</li><li>根据选中元素数量显示不同的控制器形态（单选手柄 vs 群组控制器）</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TD<br>A[Viewport] --&gt; B[elementLayer]<br>A --&gt; C[uiLayer]<br>B --&gt; D[图形元素 1]<br>B --&gt; E[图形元素 2]<br>B --&gt; F[文本元素]<br>B --&gt; G[图像元素]<br>C --&gt; H[选区框]<br>C --&gt; I[橡皮擦指示器]<br>C --&gt; J[变换控制器]<br><br>    style A fill:#e1f5fe<br>    style B fill:#f3e5f5<br>    style C fill:#e8f5e8<br>    style D fill:#fce4ec<br>    style E fill:#fce4ec<br>    style F fill:#fce4ec<br>    style G fill:#fce4ec<br>    style H fill:#fff3e0<br>    style I fill:#fff3e0<br>    style J fill:#fff3e0<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-模块摘要-Executive-Summary&quot;&gt;&lt;a href=&quot;#1-模块摘要-Executive-Summary&quot; class=&quot;headerlink&quot; title=&quot;1. 模块摘要 (Executive Summary)&quot;&gt;&lt;/a&gt;1. 模块摘要 (Ex</summary>
      
    
    
    
    <category term="笔记" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>前端项目安装和配置指南 Vite + React + TypeScript + Tailwind CSS</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/39845.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/39845.html</id>
    <published>2025-11-23T04:38:32.000Z</published>
    <updated>2025-11-23T06:46:44.951Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Vite-React-TypeScript-Tailwind-CSS-脚手架搭建指南"><a href="#Vite-React-TypeScript-Tailwind-CSS-脚手架搭建指南" class="headerlink" title="Vite + React + TypeScript + Tailwind CSS 脚手架搭建指南"></a>Vite + React + TypeScript + Tailwind CSS 脚手架搭建指南</h2><p>本文记录从零搭建 <code>Vite + React + Tailwind CSS</code> 项目，省去一个个官网去查阅文档，旨在方便快速丝滑的创建项目</p><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><ul><li><strong>Vite 4.2.0</strong> - 新一代构建工具，提供极快的冷启动和热更新。基于原生 ES 模块实现，开发时按需编译，相比传统打包工具具有显著的速度优势。</li><li><strong>React 18.2.0</strong> - 流行的前端 UI 库，采用组件化架构和虚拟 DOM 技术，提供高效的渲染性能和良好的开发体验。</li><li><strong>TypeScript 5.3.3</strong> - JavaScript 的超集，提供静态类型检查，在编译阶段发现潜在错误，增强代码可维护性和开发效率。</li><li><strong>Tailwind CSS 3.3.1</strong> - 实用优先的 CSS 框架，通过组合预定义的原子类来构建界面，无需编写自定义 CSS 即可实现复杂设计。</li><li><strong>ESLint &amp; Prettier</strong> - 代码规范和格式化工具。ESLint 用于检测代码质量问题和潜在错误，Prettier 专注于代码格式统一，共同保障代码质量。</li><li><strong>Husky &amp; lint-staged</strong> - Git 钩子工具，用于提交前代码检查。Husky 简化 Git 钩子配置，lint-staged 仅对暂存文件执行操作，提升提交前检查效率。</li><li><strong>React Router DOM 6</strong> - React 应用的路由管理工具，提供声明式路由配置，支持动态路由、嵌套路由等特性，是构建单页应用的核心组件。</li></ul><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">BDdraw_DEV/<br>├── .husky/                     <span class="hljs-comment"># Git hooks 配置</span><br>├── .vscode/                    <span class="hljs-comment"># VSCode 配置</span><br>├── docs/                       <span class="hljs-comment"># 文档目录</span><br>├── public/                     <span class="hljs-comment"># 静态资源目录</span><br>├── src/                        <span class="hljs-comment"># 源代码主目录</span><br>│   ├── api/                    <span class="hljs-comment"># API 接口定义</span><br>│   ├── assets/                 <span class="hljs-comment"># 静态资源文件</span><br>│   ├── components/             <span class="hljs-comment"># 公共组件</span><br>│   ├── hooks/                  <span class="hljs-comment"># 自定义 React Hooks</span><br>│   ├── lib/                    <span class="hljs-comment"># 工具库和核心功能模块</span><br>│   ├── pages/                  <span class="hljs-comment"># 页面组件</span><br>│   ├── router/                 <span class="hljs-comment"># 路由配置</span><br>│   │   └── router.tsx          <span class="hljs-comment"># 路由定义</span><br>│   ├── stores/                 <span class="hljs-comment"># 状态管理</span><br>│   ├── styles/                 <span class="hljs-comment"># 样式文件</span><br>│   ├── app.tsx                 <span class="hljs-comment"># 应用入口组件</span><br>│   ├── main.tsx                <span class="hljs-comment"># 主入口文件</span><br>│   └── vite-env.d.ts           <span class="hljs-comment"># Vite 环境声明文件</span><br>├── .editorconfig               <span class="hljs-comment"># 编辑器配置</span><br>├── .eslintrc                  <span class="hljs-comment"># ESLint 配置</span><br>├── .gitignore                 <span class="hljs-comment"># Git 忽略文件配置</span><br>├── .prettierrc.js             <span class="hljs-comment"># Prettier 配置</span><br>├── .stylelintrc.json          <span class="hljs-comment"># Stylelint 配置</span><br>├── commitlint.config.cjs      <span class="hljs-comment"># Commitlint 配置</span><br>├── components.json            <span class="hljs-comment"># 组件配置</span><br>├── index.html                 <span class="hljs-comment"># HTML 入口</span><br>├── lint-staged.config.js      <span class="hljs-comment"># Lint-staged 配置</span><br>├── package.json               <span class="hljs-comment"># 项目依赖和脚本配置</span><br>├── postcss.config.js          <span class="hljs-comment"># PostCSS 配置</span><br>├── tailwind.config.js         <span class="hljs-comment"># Tailwind CSS 配置</span><br>├── transmart.config.ts        <span class="hljs-comment"># Transmart 配置</span><br>├── tsconfig.json              <span class="hljs-comment"># TypeScript 配置</span><br>├── tsconfig.node.json         <span class="hljs-comment"># Node.js TypeScript 配置</span><br>├── vite.config.ts             <span class="hljs-comment"># Vite 配置</span><br>└── README.md                  <span class="hljs-comment"># 项目说明文档</span><br><br></code></pre></td></tr></table></figure><h3 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h3><p>使用 Vite 创建项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm create vite@latest [项目名] -- --template react-ts<br><span class="hljs-built_in">cd</span> [项目名]<br></code></pre></td></tr></table></figure><p>安装依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install<br></code></pre></td></tr></table></figure><h3 id="集成-Tailwind-CSS-v3"><a href="#集成-Tailwind-CSS-v3" class="headerlink" title="集成 Tailwind CSS v3"></a>集成 Tailwind CSS v3</h3><p>Tailwind CSS 是一个功能类优先的 CSS 框架，它提供了大量的实用类，可以直接在 HTML 中组合使用来构建任何设计。通过配置文件可以自定义主题、颜色、间距等设计系统，并且只生成实际使用的样式，使得最终的 CSS 文件非常精简。其 JIT（Just-In-Time）模式可以按需生成样式，大大提高了编译速度并支持更多功能。</p><p>安装 Tailwind CSS v3 及其依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -D tailwindcss postcss autoprefixer<br>npx tailwindcss init -p<br></code></pre></td></tr></table></figure><p>如果出问题可以去翻一下官方文档，v4 改变了一些部署方式</p><p>配置 Tailwind CSS</p><p>编辑 <code>tailwind.config.js</code> 文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('tailwindcss').Config</span>} */</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {<br>  <span class="hljs-attr">content</span>: [<span class="hljs-string">"./index.html"</span>, <span class="hljs-string">"./src/**/*.{js,ts,jsx,tsx}"</span>],<br>  <span class="hljs-attr">theme</span>: {<br>    <span class="hljs-attr">extend</span>: {},<br>  },<br>  <span class="hljs-attr">plugins</span>: [],<br>};<br></code></pre></td></tr></table></figure><h3 id="引入-Tailwind-CSS-v3"><a href="#引入-Tailwind-CSS-v3" class="headerlink" title="引入 Tailwind CSS v3"></a>引入 Tailwind CSS v3</h3><p>在 <code>src/index.css</code> 文件中添加：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-keyword">@tailwind</span> base;<br><span class="hljs-keyword">@tailwind</span> components;<br><span class="hljs-keyword">@tailwind</span> utilities;<br></code></pre></td></tr></table></figure><p>并在入口文件中导入该 CSS 文件：</p><p>Tailwind CSS 的三个核心层：</p><ul><li><code>@tailwind base</code> - 包含 Normalize.css 和一些基础样式重置</li><li><code>@tailwind components</code> - 包含框架的组件类，可用于添加结构样式</li><li><code>@tailwind utilities</code> - 包含所有实用类，这是 Tailwind 的核心部分</li></ul><p>通过这种分层方式，Tailwind 提供了一种灵活的方式来组织和扩展样式。</p><h3 id="配置-TypeScript"><a href="#配置-TypeScript" class="headerlink" title="配置 TypeScript"></a>配置 TypeScript</h3><p>TypeScript 是 JavaScript 的超集，添加了可选的静态类型。它可以帮助开发者在编码阶段捕获错误，提供更好的代码补全和重构支持。通过配置 <code>tsconfig.json</code>，我们可以控制 TypeScript 编译器的行为，如目标 JavaScript 版本、模块解析策略、严格性级别等。在本项目中，我们启用了严格的类型检查，同时配置了 React JSX 支持。</p><p>项目中的 <code>tsconfig.json</code> 文件已经包含了基本的 TypeScript 配置。根据项目需求，我们可以对其进行定制：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br>  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"allowJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Node"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-jsx"</span><br>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"references"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./tsconfig.node.json"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><h3 id="配置-ESLint-和-Prettier"><a href="#配置-ESLint-和-Prettier" class="headerlink" title="配置 ESLint 和 Prettier"></a>配置 ESLint 和 Prettier</h3><p>ESLint 是一个可插拔的 JavaScript 和 TypeScript 代码质量检查工具，它可以识别语法错误和代码风格问题。Prettier 是一个代码格式化工具，专注于代码风格统一。两者结合使用可以确保团队代码质量和风格的一致性。通过配置规则，我们可以自定义检查标准，例如是否使用分号、引号类型、缩进大小等。</p><p>安装相关依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -D eslint prettier eslint-config-prettier eslint-plugin-prettier eslint-plugin-react eslint-plugin-react-hooks @typescript-eslint/eslint-plugin @typescript-eslint/parser<br></code></pre></td></tr></table></figure><p>配置 ESLint</p><p>创建 <code>.eslintrc</code> 文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br>  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"browser"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"es2021"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">"eslint:recommended"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">"plugin:@typescript-eslint/recommended"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">"plugin:react/recommended"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">"plugin:react-hooks/recommended"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">"prettier"</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@typescript-eslint/parser"</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"parserOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"ecmaVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"latest"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"sourceType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><br>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@typescript-eslint"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"prettier/prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"react/react-in-jsx-scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"off"</span><br>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"detect"</span><br>    <span class="hljs-punctuation">}</span><br>  <span class="hljs-punctuation">}</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><p>配置 Prettier</p><p>创建 <code>.prettierrc</code> 文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br>  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><h3 id="配置-Git-Hooks"><a href="#配置-Git-Hooks" class="headerlink" title="配置 Git Hooks"></a>配置 Git Hooks</h3><p>Git Hooks 允许我们在 Git 操作的不同阶段执行自定义脚本。通过 Husky 和 lint-staged，我们可以在代码提交前自动运行 ESLint 和 Prettier，确保只有符合规范的代码才能进入代码库。lint-staged 只会针对暂存区的文件运行检查，提高效率。这有助于保持整个项目的代码质量和一致性。</p><p>使用 Husky 和 lint-staged 在代码提交前自动运行代码检查和格式化。</p><p>安装依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -D husky lint-staged<br></code></pre></td></tr></table></figure><p>初始化 Husky</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx husky install<br></code></pre></td></tr></table></figure><p>配置 lint-staged</p><p>创建 <code>lint-staged.config.js</code> 文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {<br>  <span class="hljs-string">"*.{ts,tsx}"</span>: [<span class="hljs-string">"eslint --fix"</span>, <span class="hljs-string">"prettier --write"</span>],<br>  <span class="hljs-string">"*.{css,md}"</span>: <span class="hljs-string">"prettier --write"</span>,<br>};<br></code></pre></td></tr></table></figure><p>添加 pre-commit 钩子</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx husky add .husky/pre-commit <span class="hljs-string">"npx lint-staged"</span><br></code></pre></td></tr></table></figure><h3 id="集成-React-Router"><a href="#集成-React-Router" class="headerlink" title="集成 React Router"></a>集成 React Router</h3><p>React Router 是 React 应用中最流行的路由解决方案，它允许我们构建单页应用程序(SPA)，通过 URL 的变化来展示不同的视图组件。它提供了声明式的路由配置，支持嵌套路由、动态路由参数、编程式导航等功能。通过使用 React Router，我们可以轻松地管理应用的不同页面和视图之间的导航关系。</p><p>安装 React Router</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install react-router-dom<br>npm install -D @types/react-router-dom<br></code></pre></td></tr></table></figure><p>创建路由配置</p><p>创建 <code>src/router/router.tsx</code> 文件：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> { createBrowserRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../pages/Home"</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../pages/About"</span>;<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  {<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span>,<br>  },<br>  {<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">"/about"</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">About</span> /&gt;</span></span>,<br>  },<br>]);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure><p>在应用中使用路由</p><p>更新 <code>src/App.tsx</code> 文件：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RouterProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;<br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/router"</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{router}</span> /&gt;</span></span>;<br>}<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;<br></code></pre></td></tr></table></figure><p>创建页面组件</p><p>创建 <code>src/pages/Home.tsx</code> 和 <code>src/pages/About.tsx</code> 文件：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// src/pages/Home.tsx</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>};<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>;<br></code></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// src/pages/About.tsx</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">About</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>};<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">About</span>;<br></code></pre></td></tr></table></figure><p>React Router 是 React 应用中最流行的路由解决方案，它允许我们构建单页应用程序(SPA)，通过 URL 的变化来展示不同的视图组件。它提供了声明式的路由配置，支持嵌套路由、动态路由参数、编程式导航等功能。通过使用 React Router，我们可以轻松地管理应用的不同页面和视图之间的导航关系。</p><h3 id="配置-Vite"><a href="#配置-Vite" class="headerlink" title="配置 Vite"></a>配置 Vite</h3><p>项目的 <code>vite.config.ts</code> 文件配置如下：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;<br><span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-react"</span>;<br><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;<br><br><span class="hljs-comment">// https://vitejs.dev/config/</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],<br>  <span class="hljs-attr">resolve</span>: {<br>    <span class="hljs-attr">alias</span>: {<br>      <span class="hljs-string">"@"</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"./src"</span>),<br>    },<br>  },<br>  <span class="hljs-attr">css</span>: {<br>    <span class="hljs-attr">postcss</span>: <span class="hljs-string">"./postcss.config.js"</span>,<br>  },<br>  <span class="hljs-attr">server</span>: {<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,<br>  },<br>});<br></code></pre></td></tr></table></figure><h3 id="配置-PostCSS"><a href="#配置-PostCSS" class="headerlink" title="配置 PostCSS"></a>配置 PostCSS</h3><p>PostCSS 是一个使用 JavaScript 插件转换 CSS 的工具。在这个项目中，我们使用了两个关键插件：</p><ul><li>Tailwind CSS 插件：处理 Tailwind CSS 相关的样式生成</li><li>Autoprefixer 插件：自动添加厂商前缀以确保样式在不同浏览器中的兼容性</li></ul><p>通过 PostCSS，我们可以自动化处理 CSS，减少手动工作并提高样式兼容性。</p><p><code>postcss.config.js</code> 文件配置如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {<br>  <span class="hljs-attr">plugins</span>: {<br>    <span class="hljs-attr">tailwindcss</span>: {},<br>    <span class="hljs-attr">autoprefixer</span>: {},<br>  },<br>};<br></code></pre></td></tr></table></figure><h3 id="添加常用组件和工具"><a href="#添加常用组件和工具" class="headerlink" title="添加常用组件和工具"></a>添加常用组件和工具</h3><p>通过创建可复用的 UI 组件和自定义 Hooks，可以大大提高开发效率并保证界面一致性。路径别名的配置使得导入模块更加简洁，避免了复杂的相对路径引用。</p><p>创建基础 UI 组件：在 <code>src/components/ui</code> 目录下创建一些基础 UI 组件，例如按钮、输入框等</p><p>创建自定义 Hooks：在 <code>src/hooks</code> 目录下创建常用的自定义 Hooks，例如 <code>useLocalStorage</code>、<code>useToggle</code> 等</p><p>配置路径别名：在 <code>tsconfig.json</code> 中配置路径别名，方便导入模块：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br>  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>    <span class="hljs-comment">// ... 其他配置</span><br>    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><br>      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">}</span><br>  <span class="hljs-punctuation">}</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></table></figure><p>通过创建可复用的 UI 组件和自定义 Hooks，可以大大提高开发效率并保证界面一致性。路径别名的配置使得导入模块更加简洁，避免了复杂的相对路径引用。</p><h3 id="其他重要配置文件说明"><a href="#其他重要配置文件说明" class="headerlink" title="其他重要配置文件说明"></a>其他重要配置文件说明</h3><h4 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h4><p><code>.gitignore</code> 文件用于指定 Git 应当忽略的文件和目录，防止不必要的文件被提交到代码仓库。在本项目中，该文件包含了以下几类被忽略的内容：</p><ol><li><strong>系统文件</strong>：如 macOS 系统生成的 <code>.DS_Store</code> 文件</li><li><strong>日志文件</strong>：如 npm、yarn 等生成的日志文件</li><li><strong>依赖目录</strong>：如 <code>node_modules/</code> 目录</li><li><strong>构建输出</strong>：如构建工具生成的 <code>dist/</code>、<code>.next/</code> 等目录</li><li><strong>缓存文件</strong>：如各种工具生成的缓存文件</li><li><strong>环境变量文件</strong>：如 <code>.env</code> 及其变体文件，防止敏感信息泄露</li><li><strong>编辑器配置</strong>：如编辑器生成的临时文件</li></ol><p>通过合理配置 <code>.gitignore</code>，可以减小代码仓库体积，保护敏感信息，并避免无关文件干扰开发。</p><h4 id="editorconfig"><a href="#editorconfig" class="headerlink" title=".editorconfig"></a>.editorconfig</h4><p><code>.editorconfig</code> 文件用于统一不同编辑器和 IDE 的代码格式设置。在团队协作中，不同开发者可能使用不同的编辑器，该文件可以确保所有人使用相同的编码规范：</p><ul><li>使用空格缩进，缩进大小为 2 个空格</li><li>行尾符使用 LF (Unix 风格)</li><li>字符编码使用 UTF-8</li><li>自动删除行尾空白字符</li><li>文件末尾自动添加新行</li></ul><p>这有助于保持代码风格的一致性，避免因编辑器差异导致的格式混乱。</p><h4 id="prettierrc-js"><a href="#prettierrc-js" class="headerlink" title=".prettierrc.js"></a>.prettierrc.js</h4><p>Prettier 配置文件，用于统一代码格式化风格：</p><ul><li>不使用分号结尾</li><li>对象和数组末尾保留逗号</li><li>使用单引号而非双引号</li><li>单行最大宽度为 120 字符</li><li>缩进使用 2 个空格</li><li>行尾符自动适应操作系统</li></ul><p>Prettier 会在保存文件或执行格式化命令时自动应用这些规则，确保整个项目的代码风格统一。</p><h4 id="commitlint-config-cjs"><a href="#commitlint-config-cjs" class="headerlink" title="commitlint.config.cjs"></a>commitlint.config.cjs</h4><p>Commitlint 配置文件，用于校验 Git 提交信息的格式。它继承了 <code>@commitlint/config-conventional</code> 规则，要求提交信息遵循约定式提交规范：</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">&lt;<span class="hljs-keyword">type</span>&gt;[<span class="hljs-keyword">optional</span> scope]: &lt;description&gt;<br><br>[<span class="hljs-keyword">optional</span> body]<br><br>[<span class="hljs-keyword">optional</span> footer(s)]<br></code></pre></td></tr></table></figure><p>其中 type 必须是以下几种之一：</p><ul><li>feat: 新功能</li><li>fix: 修复 bug</li><li>chore: 构建过程或辅助工具的变动</li><li>docs: 文档更新</li><li>style: 代码格式调整</li><li>refactor: 重构</li><li>perf: 性能优化</li><li>test: 测试用例</li></ul><p>这有助于生成标准化的变更日志，便于团队理解和维护项目历史。</p><h4 id="stylelintrc-json"><a href="#stylelintrc-json" class="headerlink" title=".stylelintrc.json"></a>.stylelintrc.json</h4><p>Stylelint 配置文件，用于检查 CSS/LESS 样式代码的质量和风格。该项目配置了：</p><ul><li>继承标准规则集和 Prettier 推荐规则</li><li>支持 LESS 语法</li><li>启用 Prettier 规则</li><li>自定义类名命名规范（小写字母和连字符）</li><li>允许未知的 at-rule（为了支持 LESS 特性）</li></ul><p>通过 Stylelint 可以确保样式代码的一致性和质量，避免常见的样式错误。</p><h4 id="lint-staged-config-js"><a href="#lint-staged-config-js" class="headerlink" title="lint-staged.config.js"></a>lint-staged.config.js</h4><p>Lint-staged 配置文件，用于对 Git 暂存区的文件执行检查和格式化：</p><ul><li>对 TypeScript 文件执行 ESLint 和 Prettier</li><li>对 JavaScript 文件执行 ESLint 和 Prettier</li><li>对 LESS 和 CSS 文件执行 Stylelint</li><li>对其他文件执行相应检查</li></ul><p>这确保只有符合规范的代码才能被提交到仓库，提升整体代码质量。</p><h3 id="开发环境和生产环境配置"><a href="#开发环境和生产环境配置" class="headerlink" title="开发环境和生产环境配置"></a>开发环境和生产环境配置</h3><p>开发环境启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run dev<br></code></pre></td></tr></table></figure><p>构建生产版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run build<br></code></pre></td></tr></table></figure><p>预览生产构建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run preview<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Vite-React-TypeScript-Tailwind-CSS-脚手架搭建指南&quot;&gt;&lt;a href=&quot;#Vite-React-TypeScript-Tailwind-CSS-脚手架搭建指南&quot; class=&quot;headerlink&quot; title=&quot;Vite + R</summary>
      
    
    
    
    <category term="Github" scheme="https://zhongye1.github.io/Arknight-notes/categories/Github/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-22- 使用 GitHub Actions 自动部署基于vite的项目到 GitHub Pages</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/33040.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/33040.html</id>
    <published>2025-11-22T17:59:24.000Z</published>
    <updated>2025-11-23T09:48:37.352Z</updated>
    
    <content type="html"><![CDATA[<p>这篇笔记主要讲在新创建前端项目后，如何通过 GitHub-Actions 实现每次 push 到 main 分支后，GitHub 自动构建 → 自动发布页面的操作</p><p>参考 <a href="https://zhongye1.github.io/BDdraw_DEV/#/">https://zhongye1.github.io/BDdraw_DEV/#/</a><br>其从仓库 <a href="https://github.com/Zhongye1/BDdraw_DEV">https://github.com/Zhongye1/BDdraw_DEV</a> 实现自动构建和部署</p><h3 id="0-前置条件"><a href="#0-前置条件" class="headerlink" title="0.前置条件"></a>0.前置条件</h3><ul><li>GitHub 账户 + 一个 public 仓库（私有仓库需要 GitHub Pro 才能开 Pages）</li></ul><h3 id="1-创建-GitHub-Actions-工作流"><a href="#1-创建-GitHub-Actions-工作流" class="headerlink" title="1. 创建 GitHub Actions 工作流"></a>1. 创建 GitHub Actions 工作流</h3><p>在仓库根目录创建文件： .github/workflows/deploy.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span><br><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]<br>  <span class="hljs-attr">workflow_dispatch:</span><br><br><span class="hljs-attr">permissions:</span><br>  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span><br>  <span class="hljs-attr">pages:</span> <span class="hljs-string">write</span><br>  <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span><br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">deploy:</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">github-pages</span><br>      <span class="hljs-attr">url:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.deployment.outputs.page_url</span> <span class="hljs-string">}}</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Bun</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">oven-sh/setup-bun@v1</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">bun-version:</span> <span class="hljs-string">latest</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">bun</span> <span class="hljs-string">install</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">bun</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Pages</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/configure-pages@v5</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">artifact</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-pages-artifact@v3</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">"./dist"</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-string">deployment</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/deploy-pages@v4</span><br></code></pre></td></tr></table></figure><h3 id="2-配置-vite-config-ts-的-base"><a href="#2-配置-vite-config-ts-的-base" class="headerlink" title="2. 配置 vite.config.ts 的 base"></a>2. 配置 vite.config.ts 的 base</h3><p>打开 vite.config.ts</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs TypeScript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span><br><span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],<br>  <span class="hljs-attr">base</span>: <span class="hljs-string">'/BDdraw_DEV/'</span>,   <span class="hljs-comment">// 必须和仓库名完全一致！大小写也要一样</span><br>})<br></code></pre></td></tr></table></figure><p>如果想让它在本地开发和 GitHub Pages 都正常，可以写成动态 base：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs TypeScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],<br>  <span class="hljs-attr">base</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'/BDdraw_DEV/'</span> : <span class="hljs-string">'/'</span>,<br>})<br></code></pre></td></tr></table></figure><h3 id="3-GitHub-仓库设置-Pages-为-Actions-模式"><a href="#3-GitHub-仓库设置-Pages-为-Actions-模式" class="headerlink" title="3. GitHub 仓库设置 Pages 为 Actions 模式"></a>3. GitHub 仓库设置 Pages 为 Actions 模式</h3><ol><li>进入仓库 → Settings → Pages（左侧菜单）</li><li>Build and deployment → Source 选 <strong>GitHub Actions</strong></li><li>保存</li></ol><h3 id="4-提交代码触发第一次部署"><a href="#4-提交代码触发第一次部署" class="headerlink" title="4. 提交代码触发第一次部署"></a>4. 提交代码触发第一次部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Bash">git add .<br>git commit -m <span class="hljs-string">"chore: 新建 GitHub Actions 部署工作流"</span><br>git push origin main<br></code></pre></td></tr></table></figure><p>然后去仓库 → Actions 标签页，就能看到正在跑的 “Deploy to GitHub Pages” 工作流。</p><p>成功后可以前往对应的 GitHub Pages 地址查看效果</p><p class='item-img' data-src='https://pica.zhimg.com/v2-25ed9b20ac34367edf61581afc6742ea_r.jpg'><img src="https://pica.zhimg.com/v2-25ed9b20ac34367edf61581afc6742ea_r.jpg" alt="alt text"></p><p>只要 push 到 main 分支，GitHub Actions 就会自动触发工作流，实现自动部署。</p><blockquote><p>如果是私有仓库，需要 GitHub Pro 才能开 Pages</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;这篇笔记主要讲在新创建前端项目后，如何通过 GitHub-Actions 实现每次 push 到 main 分支后，GitHub 自动构建 → 自动发布页面的操作&lt;/p&gt;
&lt;p&gt;参考 &lt;a href=&quot;https://zhongye1.github.io/BDdraw_DE</summary>
      
    
    
    
    <category term="Github" scheme="https://zhongye1.github.io/Arknight-notes/categories/Github/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-22- 关于前端包管理器npm,pnpm,yarn和bun以及我为何选择后者</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/15722.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/15722.html</id>
    <published>2025-11-22T13:21:15.000Z</published>
    <updated>2025-11-22T13:39:37.145Z</updated>
    
    <content type="html"><![CDATA[<p><strong>因为快。</strong></p><p>2025 年，Bun 作为一个「全能型」运行时 + 包管理器，在实际项目中对传统包管理器（npm/yarn/pnpm）确实有相当大的优势，很多人已经开始抛弃 npm/yarn/pnpm，转用 Bun 作为前端项目的包管理器</p><h3 id="初识-Bun-管理器"><a href="#初识-Bun-管理器" class="headerlink" title="初识 Bun 管理器"></a>初识 Bun 管理器</h3><p>Bun 是 JavaScript 和 TypeScript 应用程序的一站式工具包。它作为一个名为<code>bun</code>的单个可执行文件提供。</p><p>其核心是 Bun 运行时，这是一个快速的 JavaScript 运行时，设计为 Node.js 的即插即用替代品。它是用 Zig 编写的，在底层由 JavaScriptCore 驱动，大大减少了启动时间和内存使用。</p><h3 id="对比其他包管理器"><a href="#对比其他包管理器" class="headerlink" title="对比其他包管理器"></a>对比其他包管理器</h3><h4 id="1-npm（Node-Package-Manager）"><a href="#1-npm（Node-Package-Manager）" class="headerlink" title="1. npm（Node Package Manager）"></a>1. npm（Node Package Manager）</h4><p><strong>核心实现</strong>：</p><ul><li><strong>依赖存储与解析</strong>：使用扁平化依赖树（flattened dependency tree，自 v3+ 引入），但仍依赖传统的 node_modules 目录结构。每个包及其子依赖都会下载 tarball（压缩包），然后解压到本地 node_modules 中。如果有版本冲突，会创建嵌套的 node_modules 子目录（hoisting 机制试图扁平化，但不总是完美）。</li><li><strong>锁文件</strong>：package-lock.json，记录精确的依赖树和哈希值，确保可重现安装。</li><li><strong>缓存机制</strong>：全局缓存在 ~/.npm（或 Windows 的 %AppData%\npm-cache），存储 tarball 和元数据。安装时先检查缓存，命中则直接解压。</li><li><strong>下载与并行</strong>：自 v7+ 支持并行下载（自 v5+），使用 HTTP/1.1 或 HTTP/2，但解析依赖树时仍依赖 JavaScript 引擎（Node.js），导致启动开销大。</li><li><strong>monorepo 支持</strong>：基本支持（通过 workspaces），但需手动配置，效率一般。</li></ul><p><strong>技术栈</strong>：纯 Node.js 实现，CLI 基于 npm-cli。</p><h4 id="2-pnpm（Performant-NPM）"><a href="#2-pnpm（Performant-NPM）" class="headerlink" title="2. pnpm（Performant NPM）"></a>2. pnpm（Performant NPM）</h4><p><strong>核心实现</strong>：</p><ul><li><strong>依赖存储与解析</strong>：引入<strong>内容寻址存储（content-addressable store）</strong>，所有包统一存储在全局 .pnpm/store（硬链接 + 符号链接）。项目中只生成一个扁平的 node_modules/.pnpm 目录，通过符号链接（symlinks）指向全局包，避免重复下载。严格的 peer dependency 隔离，防止“幽灵依赖”（phantom dependencies）。</li><li><strong>锁文件</strong>：pnpm-lock.yaml，YAML 格式，记录依赖图和完整哈希链。</li><li><strong>缓存机制</strong>：全局 store + 硬链接，安装时直接链接现有包（无解压开销）。支持范围补丁（patching），允许动态修改依赖。</li><li><strong>下载与并行</strong>：并行下载 + 增量更新，自 v8+ 优化为“聪明缓存”，只下载变化部分。monorepo 原生支持（workspace 协议），通过过滤命令（如 pnpm -r）高效处理多包。</li><li><strong>monorepo 支持</strong>：最佳，原生高效，节省 70-80% 磁盘。</li></ul><p><strong>技术栈</strong>：Node.js 实现，但使用 Rust-like 的高效链接系统（实际是 JS + 文件系统优化）。</p><h4 id="3-Yarn-Berry（Yarn-v2-）"><a href="#3-Yarn-Berry（Yarn-v2-）" class="headerlink" title="3. Yarn Berry（Yarn v2+）"></a>3. Yarn Berry（Yarn v2+）</h4><p><strong>核心实现</strong>：</p><ul><li><strong>依赖存储与解析</strong>：革命性 <strong>Plug’n’Play (PnP)</strong> 模式，默认<strong>完全消除 node_modules</strong>。依赖通过 .pnp.cjs（或 .pnp.js）文件映射（类似虚拟文件系统），运行时动态解析路径，而非物理目录。备选 nodeLinker: node-modules 模式回退到传统结构。</li><li><strong>锁文件</strong>：yarn.lock（v2+ 格式），包含完整依赖树、校验和和 ZIP 存档引用。</li><li><strong>缓存机制</strong>：项目级 .yarn/cache，存储 ZIP 压缩的包（可提交到 Git，实现“零安装”——clone 后直接运行）。支持“零安装”（zero-installs），CI/CD 无需重新下载。</li><li><strong>下载与并行</strong>：并行下载 + 增量缓存，自 v3+ 引入 Constraints（依赖规则检查）。monorepo 通过 Workspaces + Plug’n’Play 实现高效共享。</li><li><strong>monorepo 支持</strong>：优秀，支持 Constraints 和 Patch 协议，适合大型团队。</li></ul><p><strong>技术栈</strong>：Node.js 实现，但 PnP 使用自定义加载器（loader）拦截模块解析。</p><h4 id="4-Bun"><a href="#4-Bun" class="headerlink" title="4. Bun"></a>4. Bun</h4><p><strong>核心实现</strong>：</p><ul><li><strong>依赖存储与解析</strong>：<strong>无 node_modules</strong>，所有包存储在全局单例缓存（~/.bun/install/cache），项目只生成极小的 .bun 文件夹（二进制锁文件）。使用<strong>极致压缩 + 硬链接</strong>，运行时直接从缓存加载（跳过解压）。兼容 npm 注册表，但内置 JSR（JavaScript Registry）支持。</li><li><strong>锁文件</strong>：bun.lockb，二进制格式（超小、超快解析）。</li><li><strong>缓存机制</strong>：全局缓存 + 内容哈希，安装时并行下载并验证哈希。支持“热缓存”（hot cache），CI 复用率近 100%。</li><li><strong>下载与并行</strong>：使用 Zig 语言编写的超快解析器（非 JS），HTTP/3 支持 + 原生并行。monorepo 自动识别，无需额外配置。</li><li><strong>monorepo 支持</strong>：优秀，极速安装，但生态仍在完善（2025 年已稳定）。</li></ul><p><strong>技术栈</strong>：Zig + JavaScriptCore（WebKit 引擎），非 Node.js 依赖，实现全栈（包管理 + bundler + 测试运行器）。</p><p>基于 pnpm 官方基准（2025-11-16 更新）、Bun 团队报告和社区测试，四个包管理器中<strong>Bun 整体最快，pnpm/Yarn Berry 在磁盘效率上领先，npm 最稳但最慢</strong>。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Bun 支持 Linux（x64 和 arm64）和 macOS（x64 和 Apple Silicon）。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 使用npm</span><br>npm install -g bun<br></code></pre></td></tr></table></figure><h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">bun upgrade<br></code></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><code>bun</code>命令行工具实现了测试运行器、脚本运行器和与 Node.js 兼容的包管理器。Bun 的内置工具明显比现有选项快，并且在现有 Node.js 项目中几乎不需要进行任何更改。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">bun <span class="hljs-built_in">test</span>                      <span class="hljs-comment"># 运行测试</span><br>bun run start                 <span class="hljs-comment"># 运行`package.json`中的`start`脚本</span><br>bun install &lt;pkg&gt;             <span class="hljs-comment"># 安装包</span><br>bunx cowsay <span class="hljs-string">'Hello, world!'</span>   <span class="hljs-comment"># 执行包</span><br>bun run index.tsx             <span class="hljs-comment"># 默认支持TS和JSX</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;因为快。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;2025 年，Bun 作为一个「全能型」运行时 + 包管理器，在实际项目中对传统包管理器（npm/yarn/pnpm）确实有相当大的优势，很多人已经开始抛弃 npm/yarn/pnpm，转用 Bun 作为前端项目的包</summary>
      
    
    
    
    <category term="Github项目" scheme="https://zhongye1.github.io/Arknight-notes/categories/Github%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-21-canvas项目杂记</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/14933.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/14933.html</id>
    <published>2025-11-21T06:50:48.000Z</published>
    <updated>2025-11-23T09:36:28.701Z</updated>
    
    <content type="html"><![CDATA[<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a><del>分析</del></h2><p><del>要做的就是一个<strong>类 Canva / Figma 的在线图形绘板</strong>，完整需求优先级和覆盖范围如下：</del></p><div class="table-container"><table><thead><tr><th>优先级</th><th>功能模块</th><th>具体需求</th><th>是否必须</th><th>难度</th></tr></thead><tbody><tr><td>P0</td><td>基础渲染</td><td>矩形、圆形、三角形任意填充色、边框色、边框宽度、圆角、透明度</td><td>Yes</td><td>★☆</td></tr><tr><td>P0</td><td>图片支持</td><td>上传 png/jpg/webp，任意缩放、圆角、模糊、灰度、亮度调节、裁剪掩模</td><td>Yes</td><td>★★</td></tr><tr><td>P0</td><td>富文本</td><td>字体、字号、颜色、加粗、斜体、下划线、删除线、文本背景色、文字对齐、行距、局部样式支持</td><td>Yes</td><td>★★★★</td></tr><tr><td>P0</td><td>基本交互</td><td>单选、多选（框选 + Shift）、拖拽、删除、复制粘贴、缩放把手（8 个方向）、旋转把手</td><td>Yes</td><td>★★</td></tr><tr><td>P0</td><td>无限画布 + 缩放平移</td><td>Ctrl+滚轮缩放、空格拖拽平移、无限滚动</td><td>Yes</td><td>★☆</td></tr><tr><td>P0</td><td>数据持久化</td><td>自动 localStorage 保存、打开页面自动恢复</td><td>Yes</td><td>★☆</td></tr><tr><td>P1</td><td>高级交互</td><td>组合（Group）、解散组合、图层排序、辅助对齐线、吸附、旋转任意角度</td><td>Yes</td><td>★★★</td></tr><tr><td>P1</td><td>工具栏 &amp; 属性面板</td><td>顶部工具栏（切换文本/形状/图片模式）、右侧属性面板实时编辑属性</td><td>Yes</td><td>★★</td></tr><tr><td>P1</td><td>历史记录</td><td>Undo / Redo（支持跨会话）</td><td>Yes</td><td>★★</td></tr><tr><td>P1</td><td>性能要求</td><td>100 个复杂元素（图片+富文本）打开 &lt; 3s，拖拽 60fps 不闪烁</td><td>Yes</td><td>★★★★</td></tr><tr><td>P2</td><td>未来可扩展</td><td>实时协同编辑、离线编辑、模板库、导出 PNG/SVG/PDF、激光笔、箭头、自由画笔等</td><td>No</td><td>★★★★</td></tr></tbody></table></div><h1 id="架构方案"><a href="#架构方案" class="headerlink" title="架构方案"></a><del>架构方案</del></h1><ul><li><del><strong>渲染层</strong>：PixiJS (WebGL) 处理高性能图形渲染 + HTML DOM 处理文本编辑/输入框。</del></li><li><del><strong>状态管理</strong>：Zustand / Pinia (管理庞大的 JSON 画布数据)。</del></li><li><del><strong>逻辑层</strong>：自定义 Class 结构（如  Shape, Tool, History）实现面向对象编程。</del></li></ul><h3 id="二、项目设计要素"><a href="#二、项目设计要素" class="headerlink" title="二、项目设计要素"></a><del>二、项目设计要素</del></h3><div class="table-container"><table><thead><tr><th>设计维度</th><th>推荐技术方案</th><th></th></tr></thead><tbody><tr><td>1. 渲染引擎</td><td>PixiJS v8（WebGL） + HTMLText</td><td>WebGL 抗锯齿完美 + 高分屏不模糊；HTMLText 是目前唯一能轻松实现富文本局部样式的方案</td></tr><tr><td>2. 状态管理</td><td>Zustand（或 Jotai + signals）</td><td>轻量、响应式、支持中间件（持久化、历史栈）</td></tr><tr><td>3. 元素对象缓存</td><td>Map<string, Container=""> 永久缓存（一个元素一个 Container，永不 destroy）</string,></td><td>彻底解决闪烁、拖拽中断、光标丢失的根本方案</td></tr><tr><td>4. 历史栈</td><td>Command Pattern + structuredClone 快照（每操作记录 before/after）</td><td>简单可靠，支持跨页面 Undo</td></tr><tr><td>5. 选中/变换系统</td><td>单独的 SelectionManager + TransformHandles（旋转、缩放把手层也缓存）</td><td>tldraw/Figma 标配</td></tr><tr><td>6. 辅助对齐线</td><td>拖拽时实时遍历所有元素 bounds，差值 &lt; 5px 就吸附并画蓝线</td><td>提升专业感</td></tr><tr><td>7. 组合（Group）</td><td>元素加 groupId 字段；选中时绘制大虚线框；拖拽/缩放/旋转时整体应用矩阵变换</td><td>必须有，属于 P1 核心</td></tr><tr><td>8. 数据持久化</td><td>Zustand middleware persist + localForage（IndexedDB）</td><td>防止 localStorage 炸掉</td></tr><tr><td>9. 图片处理</td><td>Sprite + Graphics mask（圆角）+ BlurFilter + ColorMatrixFilter</td><td>PixiJS 原生支持</td></tr><tr><td>10. 架构分层</td><td>- store（纯数据） - rendering（Pixi 元素缓存 &amp; 更新） - interaction（拖拽、选中逻辑） - ui（React 面板）</td></tr></tbody></table></div><p><del>installed pixi.js@8.14.3</del><br><del>installed zustand@5.0.8</del><br><del>installed nanoid@5.1.6</del></p><p><del><strong>数据驱动视图”（Data-Driven View）</strong>  模式，采用了  <strong>React (UI) + Zustand (数据) + PixiJS (渲染)</strong>  的三层分离架构</del></p><p><del>这种架构的核心理念是：<strong>PixiJS 实例不保存“业务状态”，它只是 Zustand 数据的“投影”</strong></del></p><p><del class='item-img' data-src='Pasted%20image%2020251121155817.png'><img src="Pasted%20image%2020251121155817.png" alt=""></del></p><p><del>其中，</del></p><ul><li><del>React 只负责 UI 和事件入口</del></li><li><del>Zustand 是唯一的真实数据源（纯 JSON，可持久化、可协同）</del></li><li><del>PixiJS 层只做“渲染 + 交互计算”，所有对象永久缓存（Map），绝不每帧重建</del></li><li><del>所有变换（拖拽、缩放、旋转、组合）都在 Pixi 层完成，最后再同步回 Zustand（单向数据流）</del></li></ul><h3 id="三层架构详解"><a href="#三层架构详解" class="headerlink" title="三层架构详解"></a><del>三层架构详解</del></h3><h4 id="第一层：数据层-The-Source-of-Truth-canvasStore-ts"><a href="#第一层：数据层-The-Source-of-Truth-canvasStore-ts" class="headerlink" title="第一层：数据层 (The Source of Truth) - canvasStore.ts"></a><del>第一层：数据层 (The Source of Truth) - canvasStore.ts</del></h4><p><del>这是整个应用的大脑。</del></p><ul><li><del><strong>职责</strong>：只存储纯 JSON 数据（Serializable），不包含任何 UI 实例或 Pixi 对象。</del></li><li><del><strong>存储内容</strong>：</del><ul><li><del>elements: 一个 Map 对象（Record<id, Element="">），存储所有矩形、圆形的坐标、颜色等。</id,></del></li><li><del>selectedIds: 当前选中的 ID 列表。</del></li><li><del>tool: 当前使用的工具。</del></li></ul></li><li><del><strong>特点</strong>：</del><ul><li><del><strong>单一数据源</strong>：画布上显示什么，完全由这里的数据决定。</del></li><li><del><strong>无副作用</strong>：这里的 Action 只修改数据，不直接操作 DOM 或 Canvas。</del></li></ul></li></ul><h4 id="第二层：适配层-The-Bridge-StageManager-ts"><a href="#第二层：适配层-The-Bridge-StageManager-ts" class="headerlink" title="第二层：适配层 (The Bridge) - StageManager.ts"></a><del>第二层：适配层 (The Bridge) - StageManager.ts</del></h4><p><del>这是连接 React/Zustand 和 PixiJS 的胶水层，也是架构中最复杂的部分。</del></p><ul><li><del><strong>职责</strong>：将“声明式”的数据（Zustand）转换为“命令式”的 Pixi 调用。</del></li><li><del><strong>核心机制 - 增量更新 (Diffing)</strong>：</del><ul><li><del>它维护了一个  spriteMap (Map<id, PIXI.Graphics="">)。</id,></del></li><li><del><strong>订阅 (Subscribe)</strong>：它监听 Store 的变化。</del></li><li><del><strong>同步 (Sync/Render Loop)</strong>：</del><ul><li><del><strong>Create</strong>: Store 有 ID，Map 里没有 -&gt; new PIXI.Graphics()。</del></li><li><del><strong>Update</strong>: Store 有，Map 里也有 -&gt; 更新  x, y, width, color。</del></li><li><del><strong>Delete</strong>: Store 没有，Map 里有 -&gt; destroy()。</del></li></ul></li></ul></li><li><del><strong>事件转换</strong>：</del><ul><li><del>它监听 Pixi 的  pointerdown/move/up  事件，将屏幕坐标转换为逻辑坐标，然后调用 Store 的 Action。</del></li></ul></li></ul><h4 id="第三层：视图层-The-Container-Canvas-tsx"><a href="#第三层：视图层-The-Container-Canvas-tsx" class="headerlink" title="第三层：视图层 (The Container) - Canvas.tsx"></a><del>第三层：视图层 (The Container) - Canvas.tsx</del></h4><p><del>这是 React 组件层。</del></p><ul><li><del><strong>职责</strong>：</del><ul><li><del>提供  div  容器供 Pixi 挂载。</del></li><li><del>渲染 HTML UI（工具栏、属性面板）。</del></li><li><del>生命周期管理：组件 Mount 时初始化  StageManager，Unmount 时销毁。</del></li></ul></li></ul><p><del>—-</del></p><h3 id="3-关键数据流转-Data-Flow"><a href="#3-关键数据流转-Data-Flow" class="headerlink" title="3. 关键数据流转 (Data Flow)"></a><del>3. 关键数据流转 (Data Flow)</del></h3><p><del>让我们以  <strong>“拖拽矩形移动”</strong>  为例，看数据如何在架构中流转：</del></p><p><del><strong>Input (输入)</strong>:</del></p><ul><li><del>用户在画布上按住矩形并移动鼠标。</del></li><li><del>StageManager  的  onPointerMove  被触发。</del></li></ul><p><del><strong>Logic (逻辑处理)</strong>:</del></p><ul><li><del>StageManager  计算鼠标的偏移量  (dx, dy)。</del></li><li><del>它<strong>不直接修改</strong> Pixi 图形的  graphics.x (这是关键！)。</del></li><li><del>它调用  store.updateElement(id, { x: newX, y: newY })。</del></li></ul><p><del><strong>State Update (状态更新)</strong>:</del></p><ul><li><del>Zustand Store 更新内部的 JSON 数据。</del></li><li><del>Zustand 触发订阅回调 (subscribe)。</del></li></ul><p><del><strong>Render Sync (渲染同步)</strong>:</del></p><ul><li><del>StageManager  的  render  方法被调用。</del></li><li><del>它从  spriteMap  找到对应的 Pixi 实例。</del></li><li><del>执行  graphic.position.set(newX, newY)。</del></li><li><del>PixiJS 在下一个  requestAnimationFrame  自动重绘 Canvas。</del></li></ul><p><del>—-</del></p><h3 id="4-为什么选择这种架构？"><a href="#4-为什么选择这种架构？" class="headerlink" title="4. 为什么选择这种架构？"></a><del>4. 为什么选择这种架构？</del></h3><h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a><del>优点：</del></h4><p><del><strong>解耦 (Decoupling)</strong>：渲染引擎可以随时替换（比如换成 Konva 或原生 Canvas），只需要重写  StageManager，数据层和 UI 层不需要动。</del></p><p><del><strong>协同编辑 (Collaboration) 友好</strong>：</del></p><ul><li><del>如果要实现多入协同，只需要监听 WebSocket 消息，然后更新 Zustand Store。StageManager  会自动把队友的操作画出来，无需写额外的同步绘图逻辑。</del><br><del><strong>撤销/重做 (Undo/Redo) 容易</strong>：</del></li><li><del>因为所有状态都在 Store 里，只需要保存/恢复 Store 的快照（或 Patch）即可。</del><br><del><strong>序列化/反序列化</strong>：</del></li><li><del>保存项目只需  JSON.stringify(store.elements)。</del></li></ul><h4 id="潜在挑战（及优化方案）："><a href="#潜在挑战（及优化方案）：" class="headerlink" title="潜在挑战（及优化方案）："></a><del>潜在挑战（及优化方案）：</del></h4><p><del><strong>性能瓶颈</strong>：</del></p><ul><li><del>问题：高频触发  Store Update -&gt; Diff  循环可能在元素极多时（&gt;2000 个）产生开销。</del></li><li><del>优化：对于拖拽这种 60FPS 的操作，可以引入“临时层” (Transient State)。即拖拽时直接修改 Pixi 对象，鼠标松开时再同步到 Store。</del><br><del><strong>复杂性</strong>：</del></li><li><del>相比直接用 Canvas API 画图，这种架构代码量更大，需要维护 ID 映射和 Diff 逻辑。</del></li></ul><p><del>feat(canvas): 重构画布实现，应项目要求，删除了基于tldraw的实现转而选择PixiJS 库重构以进行渲染操作，基于Zustand 进行状态管理。新增的文件中canvasStore.ts主要负责维护整个画布项目的全局可序列化状态，是渲染画布系统中唯一数据来源。Pixi_stageManager.ts 负责将声明式数据（Zustand）实时、高性能地映射为命令式渲染实例（PixiJS），并处理所有用户交互的计算与反馈。canvas下的index.ts最轻量的一层，仅负责生命周期管理与组件组装。三层数据驱动架构详情可见文档</del></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;分析&quot;&gt;&lt;a href=&quot;#分析&quot; class=&quot;headerlink&quot; title=&quot;分析&quot;&gt;&lt;/a&gt;&lt;del&gt;分析&lt;/del&gt;&lt;/h2&gt;&lt;p&gt;&lt;del&gt;要做的就是一个&lt;strong&gt;类 Canva / Figma 的在线图形绘板&lt;/strong&gt;，完整需求优先</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-11-19-重拾编程语言设计与计科相关概念</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/29484.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/29484.html</id>
    <published>2025-11-19T03:06:20.000Z</published>
    <updated>2025-11-19T03:22:30.204Z</updated>
    
    <content type="html"><![CDATA[<p>计算机类专业结果这些都得自己学，整理一套编程语言设计与计算机科学核心概念集，日后开坑学习，博客狠狠写，知识学爆</p><h2 id="一、内存管理"><a href="#一、内存管理" class="headerlink" title="一、内存管理"></a>一、内存管理</h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><ul><li>指针（Pointer）</li><li>引用（Reference）</li><li>堆（Heap）</li><li>栈（Stack）</li><li>内存布局（Memory Layout）</li><li>垃圾回收（Garbage Collection）</li><li>内存泄漏（Memory Leak）</li><li>悬挂指针/引用（Dangling Pointer/Reference）</li><li>内存序（Memory Ordering）</li><li>写时复制（Copy-on-Write）</li><li>内存映射文件（Memory-mapped Files）</li><li>缓存一致性协议（Cache Coherence Protocol）</li><li>虚拟内存机制（Virtual Memory）</li><li>内存屏障（Memory Barrier）</li><li>内存对齐（Memory Alignment）</li><li>内存分配器（Memory Allocator）</li><li>内存池（Memory Pool）</li><li>引用计数（Reference Counting）</li><li>弱引用（Weak Reference）</li><li>循环引用（Circular Reference）</li><li>内存碎片（Memory Fragmentation）：包括内部碎片和外部碎片</li><li>分页与分段（Paging and Segmentation）：虚拟内存管理技术</li><li>垃圾回收算法：如标记-清除、复制、标记-整理等具体算法</li><li>内存管理单元（Memory Management Unit）</li><li>内存保护（Memory Protection）</li><li>内存访问（Memory Access）</li></ul><h3 id="存储类别"><a href="#存储类别" class="headerlink" title="存储类别"></a>存储类别</h3><ul><li>自动存储期（Automatic Storage Duration）</li><li>静态存储期（Static Storage Duration）</li><li>动态存储期（Dynamic Storage Duration）</li><li>线程存储期（Thread Storage Duration）</li><li>寄存器变量（Register Variable）</li></ul><h2 id="二、程序执行模型"><a href="#二、程序执行模型" class="headerlink" title="二、程序执行模型"></a>二、程序执行模型</h2><h3 id="函数调用机制"><a href="#函数调用机制" class="headerlink" title="函数调用机制"></a>函数调用机制</h3><ul><li>调用栈（Call Stack）</li><li>栈帧（Stack Frame）</li><li>调用约定（Calling Convention）</li><li>参数传递（Parameter Passing）</li><li>尾调用优化（Tail Call Optimization）</li><li>尾递归（Tail Recursion）</li><li>Trampoline 机制</li><li>Thunk：延迟计算的代码块</li><li>Thunk 函数：用于实现惰性求值的技术</li></ul><h3 id="执行上下文"><a href="#执行上下文" class="headerlink" title="执行上下文"></a>执行上下文</h3><ul><li>作用域（Scope）</li><li>词法作用域（Lexical Scope）</li><li>动态作用域（Dynamic Scope）</li><li>作用域链（Scope Chain）</li><li>闭包（Closure）</li><li>执行上下文（Execution Context）</li><li>变量环境（Variable Environment）</li><li>词法环境（Lexical Environment）</li><li>延续（Continuation）</li><li>协程（Coroutine）</li><li>生成器（Generator）</li></ul><h3 id="控制流"><a href="#控制流" class="headerlink" title="控制流"></a>控制流</h3><ul><li>事件循环（Event Loop）</li><li>计算器模型（Evaluator Model）</li><li>消息传递接口（Message Passing）</li><li>Actor 模型</li><li>CSP（Communicating Sequential Processes）</li><li>控制流图（Control Flow Graph）</li><li>数据流分析（Data Flow Analysis）</li></ul><h2 id="三、并发与并行"><a href="#三、并发与并行" class="headerlink" title="三、并发与并行"></a>三、并发与并行</h2><h3 id="并发模型"><a href="#并发模型" class="headerlink" title="并发模型"></a>并发模型</h3><ul><li>并发（Concurrency）</li><li>并行（Parallelism）</li><li>绿色线程（Green Threads）</li><li>内核线程（Kernel Threads）</li><li>用户态线程（User-level Threads）</li><li>线程池（Thread Pool）</li><li>工作窃取（Work Stealing）</li><li>屏障（Barrier）：同步原语</li><li>fork-join 模型：并行任务执行模型</li><li>数据竞争（Data Race）：并发访问共享数据的问题</li></ul><h3 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h3><ul><li>原子操作（Atomic Operations）</li><li>比较并交换（Compare-and-Swap）</li><li>锁（Lock）</li><li>自旋锁（Spinlock）</li><li>互斥锁（Mutex）</li><li>读写锁（Read-Write Lock）</li><li>信号量（Semaphore）</li><li>条件变量（Condition Variable）</li><li>无锁编程（Lock-free Programming）</li><li>内存模型（Memory Model）</li><li>顺序一致性（Sequential Consistency）</li><li>释放获取语义（Release-Acquire Semantics）</li></ul><h3 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h3><ul><li>Promise/Future</li><li>async/await</li><li>响应式编程（Reactive Programming）</li><li>数据并行（Data Parallelism）</li><li>任务并行（Task Parallelism）</li><li>事务内存（Transactional Memory）</li></ul><h2 id="四、类型系统"><a href="#四、类型系统" class="headerlink" title="四、类型系统"></a>四、类型系统</h2><h3 id="类型分类"><a href="#类型分类" class="headerlink" title="类型分类"></a>类型分类</h3><ul><li>静态类型（Static Typing）</li><li>动态类型（Dynamic Typing）</li><li>强类型（Strong Typing）</li><li>弱类型（Weak Typing）</li><li>基本数据类型（Primitive Data Types）</li><li>复合数据类型（Composite Data Types）</li><li>引用类型（Reference Types）</li><li>值类型（Value Types）</li><li>类型推导（Type Inference）</li><li>类型检查（Type Checking）</li><li>类型擦除（Type Erasure）</li><li>类型转换（Type Casting）</li><li>类型别名（Type Alias）</li><li>类型注解（Type Annotation）</li><li>泛型（Generics）</li><li>类型参数（Type Parameter）</li><li>类型变量（Type Variable）</li><li>类型约束（Type Constraint）</li><li>类型构造器（Type Constructor）</li><li>类型等价（Type Equality）</li><li>类型子类型（Type Subtyping）</li><li>类型上界（Type Upper Bound）</li><li>类型下界（Type Lower Bound）</li><li>类型推断（Type Inference）</li><li>类型检查（Type Checking）</li><li>子类型（Subtyping）：类型之间的关系</li><li>型变（Covariance/Contravariance）：更详细的变型规则说明</li><li>不透明类型（Opaque Types）：隐藏实现细节的类型</li></ul><h3 id="高级类型概念"><a href="#高级类型概念" class="headerlink" title="高级类型概念"></a>高级类型概念</h3><ul><li>行多态（Row Polymorphism）</li><li>存在类型（Existential Types）</li><li>高阶类型（Higher-Kinded Types）</li><li>依赖类型（Dependent Types）</li><li>渐进类型（Gradual Typing）</li><li>类型类（Type Classes）</li><li>泛型（Generics）</li><li>变型（Variance）：协变、逆变、不变</li><li>类型安全（Type Safety）</li><li>类型擦除（Type Erasure）</li><li>单态化（Monomorphization）</li></ul><h2 id="五、函数与抽象"><a href="#五、函数与抽象" class="headerlink" title="五、函数与抽象"></a>五、函数与抽象</h2><h3 id="函数概念"><a href="#函数概念" class="headerlink" title="函数概念"></a>函数概念</h3><ul><li>高阶函数（Higher-Order Function）</li><li>回调函数（Callback）</li><li>递归（Recursion）</li><li>匿名函数（Anonymous Function）</li><li>Lambda 表达式</li><li>柯里化（Currying）</li><li>部分应用（Partial Application）</li><li>函数组合（Function Composition）</li></ul><h3 id="抽象机制"><a href="#抽象机制" class="headerlink" title="抽象机制"></a>抽象机制</h3><ul><li>控制抽象（Control Abstraction）</li><li>数据抽象（Data Abstraction）</li><li>迭代器（Iterator）</li><li>流处理（Stream Processing）</li><li>声明式编程（Declarative Programming）</li><li>函子（Functor）：映射结构的抽象概念</li><li>单子（Monad）：具有绑定操作的计算容器</li></ul><h2 id="六、面向对象编程"><a href="#六、面向对象编程" class="headerlink" title="六、面向对象编程"></a>六、面向对象编程</h2><h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><ul><li>类（Class）</li><li>对象（Object）</li><li>封装（Encapsulation）</li><li>继承（Inheritance）</li><li>多态（Polymorphism）</li><li>接口（Interface）</li><li>抽象类（Abstract Class）</li><li>混入（Mixin）</li><li>特质（Trait）</li></ul><h3 id="对象模型"><a href="#对象模型" class="headerlink" title="对象模型"></a>对象模型</h3><ul><li>虚函数表（Virtual Method Table）</li><li>方法解析顺序（Method Resolution Order）</li><li>对象布局（Object Layout）</li><li>多重继承（Multiple Inheritance）</li><li>虚继承（Virtual Inheritance）</li><li>原型继承（Prototypal Inheritance）</li><li>消息传递（Message Passing）：对象间的通信机制</li><li>委托（Delegation）：替代继承的复用机制</li></ul><h2 id="七、元编程与反射"><a href="#七、元编程与反射" class="headerlink" title="七、元编程与反射"></a>七、元编程与反射</h2><h3 id="元编程技术"><a href="#元编程技术" class="headerlink" title="元编程技术"></a>元编程技术</h3><ul><li>反射（Reflection）</li><li>内省（Introspection）</li><li>宏系统（Macro System）</li><li>卫生宏（Hygienic Macro）</li><li>语法宏（Syntax Macro）</li><li>过程宏（Procedural Macro）</li><li>模板元编程（Template Metaprogramming）</li><li>注解处理（Annotation Processing）</li><li>属性导向编程（Attribute-Oriented Programming）</li></ul><h3 id="运行时元编程"><a href="#运行时元编程" class="headerlink" title="运行时元编程"></a>运行时元编程</h3><ul><li>动态代理（Dynamic Proxy）</li><li>方法缺失处理（Method Missing）</li><li>代码生成（Code Generation）</li><li>AST 操作（Abstract Syntax Tree Manipulation）</li></ul><h2 id="八、编译与解释"><a href="#八、编译与解释" class="headerlink" title="八、编译与解释"></a>八、编译与解释</h2><h3 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h3><ul><li>词法分析（Lexical Analysis）</li><li>语法分析（Syntax Analysis）</li><li>语义分析（Semantic Analysis）</li><li>中间代码生成（Intermediate Code Generation）</li><li>代码优化（Code Optimization）</li><li>目标代码生成（Target Code Generation）</li><li>编译器架构（Compiler Architecture）</li><li>编译器设计（Compiler Design）</li><li>编译器实现（Compiler Implementation）</li><li>链接时优化（Link Time Optimization, LTO）：跨模块优化技术</li><li>Profile-Guided Optimization (PGO)：基于运行时信息的优化</li></ul><h3 id="执行引擎"><a href="#执行引擎" class="headerlink" title="执行引擎"></a>执行引擎</h3><ul><li>解释器（Interpreter）</li><li>字节码（Bytecode）</li><li>即时编译（Just-In-Time Compilation）</li><li>抽象语法树（Abstract Syntax Tree, AST）</li><li>单态化（Monomorphization）</li><li>类型擦除（Type Erasure）</li><li>中间表示（Intermediate Representation）</li><li>SSA 形式（Static Single Assignment）</li></ul><h2 id="九、系统接口"><a href="#九、系统接口" class="headerlink" title="九、系统接口"></a>九、系统接口</h2><h3 id="操作系统交互"><a href="#操作系统交互" class="headerlink" title="操作系统交互"></a>操作系统交互</h3><ul><li>系统调用（System Call）</li><li>文件描述符（File Descriptor）</li><li>ABI（Application Binary Interface）</li><li>系统 V ABI</li><li>TLS（Thread Local Storage）</li><li>信号处理（Signal Handling）</li></ul><h2 id="十、异常与错误处理"><a href="#十、异常与错误处理" class="headerlink" title="十、异常与错误处理"></a>十、异常与错误处理</h2><h3 id="错误处理机制"><a href="#错误处理机制" class="headerlink" title="错误处理机制"></a>错误处理机制</h3><ul><li>异常处理（Exception Handling）</li><li>返回值错误（Error Return Values）</li><li>Result 类型</li><li>可选值（Option/Maybe）</li><li>断言（Assertion）</li><li>契约编程（Design by Contract）</li></ul><h3 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h3><ul><li>RAII（Resource Acquisition Is Initialization）</li><li>所有权系统（Ownership System）</li><li>借用检查（Borrow Checking）</li><li>生命周期（Lifetime）</li><li>析构函数（Destructor）</li><li>finally 块</li></ul><h2 id="十一、模块化与代码组织"><a href="#十一、模块化与代码组织" class="headerlink" title="十一、模块化与代码组织"></a>十一、模块化与代码组织</h2><h3 id="代码组织"><a href="#代码组织" class="headerlink" title="代码组织"></a>代码组织</h3><ul><li>模块化（Modularity）</li><li>命名空间（Namespace）</li><li>包管理（Package Management）</li><li>依赖注入（Dependency Injection）</li><li>接口隔离（Interface Segregation）</li></ul><h3 id="链接与加载"><a href="#链接与加载" class="headerlink" title="链接与加载"></a>链接与加载</h3><ul><li>静态链接（Static Linking）</li><li>动态链接（Dynamic Linking）</li><li>符号解析（Symbol Resolution）</li><li>重定位（Relocation）</li><li>名称修饰（Name Mangling）</li></ul><h2 id="十二、性能优化"><a href="#十二、性能优化" class="headerlink" title="十二、性能优化"></a>十二、性能优化</h2><h3 id="编译器优化"><a href="#编译器优化" class="headerlink" title="编译器优化"></a>编译器优化</h3><ul><li>内联优化（Inlining）</li><li>常量传播（Constant Propagation）</li><li>死代码消除（Dead Code Elimination）</li><li>循环优化（Loop Optimization）</li><li>向量化（Vectorization）</li><li>分支目标缓冲（Branch Target Buffer）：提高分支预测准确性的硬件机制</li><li>指令级并行（Instruction Level Parallelism）：CPU 级别的并行执行</li></ul><h3 id="运行时优化"><a href="#运行时优化" class="headerlink" title="运行时优化"></a>运行时优化</h3><ul><li>内联缓存（Inline Cache）</li><li>方法缓存（Method Cache）</li><li>逃逸分析（Escape Analysis）</li><li>栈上替换（On-Stack Replacement）</li><li>热点代码检测（Hotspot Detection）</li></ul><h3 id="硬件优化"><a href="#硬件优化" class="headerlink" title="硬件优化"></a>硬件优化</h3><ul><li>缓存局部性（Cache Locality）</li><li>分支预测（Branch Prediction）</li><li>流水线冒险（Pipeline Hazard）</li><li>预取（Prefetching）</li><li>SIMD（Single Instruction Multiple Data）</li></ul><h2 id="十三、形式化方法与理论"><a href="#十三、形式化方法与理论" class="headerlink" title="十三、形式化方法与理论"></a>十三、形式化方法与理论</h2><h3 id="形式化验证"><a href="#形式化验证" class="headerlink" title="形式化验证"></a>形式化验证</h3><ul><li>霍尔逻辑（Hoare Logic）</li><li>指称语义（Denotational Semantics）</li><li>操作语义（Operational Semantics）</li><li>公理语义（Axiomatic Semantics）</li><li>进展定理（Progress Theorem）</li><li>保持定理（Preservation Theorem）</li></ul><h3 id="计算理论"><a href="#计算理论" class="headerlink" title="计算理论"></a>计算理论</h3><ul><li>λ 演算（Lambda Calculus）</li><li>组合子逻辑（Combinatory Logic）</li><li>图灵完备性（Turing Completeness）</li><li>邱奇-图灵论题（Church-Turing Thesis）</li><li>停机问题（Halting Problem）</li></ul><h2 id="十四、现代语言特性"><a href="#十四、现代语言特性" class="headerlink" title="十四、现代语言特性"></a>十四、现代语言特性</h2><h3 id="语言设计趋势"><a href="#语言设计趋势" class="headerlink" title="语言设计趋势"></a>语言设计趋势</h3><ul><li>空安全（Null Safety）</li><li>模式匹配（Pattern Matching）</li><li>异步/等待（Async/Await）</li><li>记录类型（Record Types）</li><li>代数数据类型（Algebraic Data Types）</li><li>效应系统（Effect System）</li><li>资源安全（Resource Safety）</li><li>所有权与借用（Ownership and Borrowing）：Rust 中的内存安全机制</li><li>异构编程（Heterogeneous Programming）：利用多种计算设备的编程模型</li></ul><h3 id="表达式问题"><a href="#表达式问题" class="headerlink" title="表达式问题"></a>表达式问题</h3><ul><li>表达式问题（Expression Problem）</li><li>访问者模式（Visitor Pattern）</li><li>模式匹配解构</li></ul><h2 id="十五、编程范式"><a href="#十五、编程范式" class="headerlink" title="十五、编程范式"></a>十五、编程范式</h2><h3 id="主要范式"><a href="#主要范式" class="headerlink" title="主要范式"></a>主要范式</h3><ul><li>命令式编程（Imperative Programming）</li><li>声明式编程（Declarative Programming）</li><li>函数式编程（Functional Programming）</li><li>逻辑编程（Logic Programming）</li><li>面向对象编程（Object-Oriented Programming）</li><li>面向方面编程（Aspect-Oriented Programming）</li></ul><h3 id="混合范式"><a href="#混合范式" class="headerlink" title="混合范式"></a>混合范式</h3><ul><li>多范式编程（Multi-paradigm Programming）</li><li>函数响应式编程（Functional Reactive Programming）</li><li>元对象协议（Metaobject Protocol）</li></ul><h2 id="十六、软件开发基础"><a href="#十六、软件开发基础" class="headerlink" title="十六、软件开发基础"></a>十六、软件开发基础</h2><h3 id="基础概念-1"><a href="#基础概念-1" class="headerlink" title="基础概念"></a>基础概念</h3><ul><li>表达式与语句（Expressions vs Statements）</li><li>控制流（Control Flow）</li><li>数据结构（Data Structures）</li><li>算法（Algorithms）</li><li>复杂度分析（Complexity Analysis）</li><li>设计模式（Design Patterns）：常见问题的标准解决方案</li><li>SOLID 原则：面向对象设计的五个基本原则</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;计算机类专业结果这些都得自己学，整理一套编程语言设计与计算机科学核心概念集，日后开坑学习，博客狠狠写，知识学爆&lt;/p&gt;
&lt;h2 id=&quot;一、内存管理&quot;&gt;&lt;a href=&quot;#一、内存管理&quot; class=&quot;headerlink&quot; title=&quot;一、内存管理&quot;&gt;&lt;/a&gt;一、内存管</summary>
      
    
    
    
    <category term="笔记" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="日志" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-17-Arch-Linux运行AppImage相关</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/11830.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/11830.html</id>
    <published>2025-11-17T01:59:59.000Z</published>
    <updated>2025-11-17T02:22:32.104Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://link.zhihu.com/?target=https%3A//appimage.org/">AppImage</a>是一种可执行文件格式，类似于 Windows 的 exe 文件，macOS 的 app 文件，不过 AppImage 是运行在 Linux 上的可执行文件，而且是可以运行在不同发行版本的 Linux，如 Ubuntu, Debian, openSUSE, RHEL, CentOS, Fedora, Arch Linux …</p></blockquote><p>运行时</p><ol><li>切换到文件路径 <code>cd [文件路径]</code></li><li>设置文件可以执行权限，<code>chmod +x my.AppImage</code></li><li>运行 AppImage <code>./my.AppImage</code></li></ol><p>第一次执行的时候可能会碰到<code>FUSE</code>相关的问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs log">dlopen(): error loading libfuse.so.2<br><br>AppImages require FUSE to run.<br>You might still be able to extract the contents of this AppImage<br>if you run it with the --appimage-extract option.<br>See https://github.com/AppImage/AppImageKit/wiki/FUSE<br>for more information<br></code></pre></td></tr></table></figure><p>此时在 Arch Linux 上需要安装<code>fuse2</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> pacman -S fuse2<br></code></pre></td></tr></table></figure><p>更多关于 FUSE 的问题可以查看：<a href="https://link.zhihu.com/?target=https%3A//docs.appimage.org/user-guide/troubleshooting/fuse.html">I get some errors related to something called “FUSE”</a></p><p>在 Arch Linux 中创建 Desktop Entry（桌面条目）可以让你在应用启动器（如 GNOME、KDE 等）中显示应用图标。以下是创建步骤：</p><h4 id="创建-desktop文件"><a href="#创建-desktop文件" class="headerlink" title="创建 .desktop文件"></a><strong>创建 <code>.desktop</code>文件</strong></h4><p>在以下目录之一创建 <code>.desktop</code>文件：</p><p><strong>系统级</strong>（所有用户可用）：<code>/usr/share/applications/</code><br><strong>用户级</strong>（仅当前用户可用）：<code>~/.local/share/applications/</code></p><p>例如，为用户创建条目：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">mkdir -p ~/.<span class="hljs-keyword">local</span>/<span class="hljs-keyword">share</span>/applications<br>nano ~/.<span class="hljs-keyword">local</span>/<span class="hljs-keyword">share</span>/applications/myapp.desktop<br></code></pre></td></tr></table></figure><hr><p>模板参考（以 VSCode 为例）：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Desktop Entry]</span><br><span class="hljs-attr">Version</span>=<span class="hljs-number">1.0</span><br><span class="hljs-attr">Type</span>=Application<br><span class="hljs-attr">Name</span>=My Application<br><span class="hljs-attr">Comment</span>=应用描述<br><span class="hljs-attr">Exec</span>=/path/to/application/executable<br><span class="hljs-attr">Icon</span>=/path/to/icon/image.png<br><span class="hljs-attr">Terminal</span>=<span class="hljs-literal">false</span><br><span class="hljs-attr">Categories</span>=Utility<span class="hljs-comment">;Development;</span><br></code></pre></td></tr></table></figure><p><strong><code>Type</code></strong>: 固定为 <code>Application</code>（也可以是 <code>Link</code>或 <code>Directory</code>）<br><strong><code>Name</code></strong>: 显示在菜单中的名称<br><strong><code>Exec</code></strong>: 可执行文件的<strong>绝对路径</strong>（支持参数，如 <code>%F</code>表示文件）<br><strong><code>Icon</code></strong>: 图标路径（支持绝对路径或主题图标名，如 <code>firefox</code>）<br><strong><code>Terminal</code></strong>: 是否在终端中运行（<code>true/false</code>）<br><strong><code>Categories</code></strong>: 应用分类（参考 <a href="https://standards.freedesktop.org/menu-spec/latest/apa.html">freedesktop 规范</a>）</p><h4 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod +x ~<span class="hljs-regexp">/.local/</span>share<span class="hljs-regexp">/applications/my</span>app.desktop<br></code></pre></td></tr></table></figure><h4 id="验证语法"><a href="#验证语法" class="headerlink" title="验证语法"></a><strong>验证语法</strong></h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">desktop-<span class="hljs-keyword">file</span>-validate ~<span class="hljs-regexp">/.local/</span>share<span class="hljs-regexp">/applications/my</span>app.desktop<br></code></pre></td></tr></table></figure><h4 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a><strong>更新数据库</strong></h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">update</span>-desktop-<span class="hljs-keyword">database</span> ~/.<span class="hljs-keyword">local</span>/<span class="hljs-keyword">share</span>/applications/<br></code></pre></td></tr></table></figure><p>这时候就可以看到桌面上有相关的应用了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//appimage.org/&quot;&gt;AppImage&lt;/a&gt;是一种可执行文件格式，类似于 Windows 的 exe 文件，macOS 的 app 文件，</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
  </entry>
  
  <entry>
    <title>2025-11-16-ES6相关</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/9503.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/9503.html</id>
    <published>2025-11-16T09:21:25.000Z</published>
    <updated>2025-11-17T01:59:40.012Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ES6"><a href="#ES6" class="headerlink" title="ES6"></a>ES6</h3><h3 id="1、let-和-const"><a href="#1、let-和-const" class="headerlink" title="1、let 和 const"></a>1、let 和 const</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>let</td><td>声明变量的关键字，let 声明的变量只在 let 命令所在的代码块内有效</td></tr><tr><td>const</td><td>声明常量的关键字，const 声明一个只读的常量，一旦声明，常量的值就不能改变。</td></tr></tbody></table></div><h3 id="2、模板字符串-和-箭头函数"><a href="#2、模板字符串-和-箭头函数" class="headerlink" title="2、模板字符串 和 箭头函数"></a>2、模板字符串 和 箭头函数</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>``</td><td>使用反引号``包裹的字符串</td></tr><tr><td>() =&gt;{}</td><td>使用箭头（=&gt;）声明函数，不用再书写 function 关键字 <br>示例： const add = () =&gt;{ console.log(‘add’)}</td></tr><tr><td>this</td><td>1、非箭头函数中的 this 指向函数的调用者 <br>2、箭头函数中的 this 指向定义时所在的对象 <br>3、全局作用域中 this 指向 window</td></tr></tbody></table></div><h3 id="3、解构赋值"><a href="#3、解构赋值" class="headerlink" title="3、解构赋值"></a>3、解构赋值</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>[] = []</td><td>数组的解构赋值 <br>示例：let [a, b, c] = [1, 2, 3]; 可以从数组中提取值，按照对应位置，给左侧变量赋值</td></tr><tr><td>{} = {}</td><td>对象的解构赋值 <br>示例：let { bar，foo } = { foo: ‘aaa’, bar: ‘bbb’ }; 按照对应的属性，给左侧的变量赋值，等号左边的两个变量的书写顺序，与等号右边两个同名属性的顺序可以不一致</td></tr><tr><td>[] = “” ，{} = “”</td><td>字符串的解构赋值，在解构前，字符串被转换成了一个类似数组的对象 （不常用，了解即可） <br>1、以数组的形式解构，const [a, b, c, d, e] = ‘hello’ <br>2、以对象的形式解构，let { 0: a } = ‘hello’</td></tr></tbody></table></div><h3 id="4、剩余参数，展开运算符"><a href="#4、剩余参数，展开运算符" class="headerlink" title="4、剩余参数，展开运算符"></a>4、剩余参数，展开运算符</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>…arg</td><td>将一个不定数量的参数表示为一个数组</td></tr><tr><td>…</td><td>将内容展开</td></tr></tbody></table></div><h3 id="5、数据结构"><a href="#5、数据结构" class="headerlink" title="5、数据结构"></a>5、数据结构</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>Set</td><td>是一系列无序、没有重复值的集合</td></tr><tr><td>Map</td><td>是键值对的集合，但是“键”的范围不限于字符串，各种类型的值（包括对象）都可以当作键</td></tr></tbody></table></div><h3 id="6、Set-和-Map-共有的方法和属性"><a href="#6、Set-和-Map-共有的方法和属性" class="headerlink" title="6、Set 和 Map 共有的方法和属性"></a>6、Set 和 Map 共有的方法和属性</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>has()</td><td>判断该值是否为 Set/Map 的成员。</td></tr><tr><td>delete()</td><td>删除某个成员</td></tr><tr><td>clear()</td><td>删除所有成员</td></tr><tr><td>forEach()</td><td>遍历每个成员</td></tr><tr><td>size</td><td>返回 Set/Map 实例的成员总数</td></tr></tbody></table></div><h3 id="7、Set-和-Map-实例的方法"><a href="#7、Set-和-Map-实例的方法" class="headerlink" title="7、Set 和 Map 实例的方法"></a>7、Set 和 Map 实例的方法</h3><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>add()</td><td>Set 实例的方法，添加成员</td></tr><tr><td>set()</td><td>Map 实例的方法，添加成员</td></tr><tr><td>get()</td><td>Map 实例的方法，获取成员</td></tr></tbody></table></div><h3 id="8、遍历器"><a href="#8、遍历器" class="headerlink" title="8、遍历器"></a>8、遍历器</h3><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>Iterator</td><td>为各种不同的数据结构提供统一的访问机制</td></tr><tr><td>for…of</td><td>遍历成员，for…of 循环可以使用的范围包括数组、 <br>Set 和 Map 结构、某些类似数组的对象（比如 arguments 对象、DOM NodeList 对象）</td></tr></tbody></table></div><h3 id="9、数组的新增方法"><a href="#9、数组的新增方法" class="headerlink" title="9、数组的新增方法"></a>9、数组的新增方法</h3><div class="table-container"><table><thead><tr><th>方法名称</th><th>描述</th></tr></thead><tbody><tr><td>keys()</td><td>遍历索引</td></tr><tr><td>values()</td><td>遍历值</td></tr><tr><td>entries()</td><td>遍历索引和值</td></tr><tr><td>includes()</td><td>判断数组中是否含某个成员（不常用，了解即可）</td></tr><tr><td>Array.from()</td><td>将其他数据类型转换为数组</td></tr><tr><td>find()</td><td>返回第一个符合条件的数组成员</td></tr><tr><td>findIndex()</td><td>返回第一个符合条件的数组成员的位置</td></tr></tbody></table></div><h3 id="10、字符串的新增方法"><a href="#10、字符串的新增方法" class="headerlink" title="10、字符串的新增方法"></a>10、字符串的新增方法</h3><div class="table-container"><table><thead><tr><th>方法名称</th><th>描述</th></tr></thead><tbody><tr><td>includes()</td><td>判断字符串中是否包含某些字符</td></tr><tr><td>padStart()</td><td>补全字符串的长度，用于头部补全（不常用，了解即可）</td></tr><tr><td>padEnd()</td><td>补全字符串的长度，用于尾部补全（不常用，了解即可）</td></tr><tr><td>trimLeft() ，trimStart()</td><td>清除字符串头部的空格（不常用，了解即可）</td></tr><tr><td>trimEnd() ，trimRight()</td><td>清除字符串尾部的空格（不常用，了解即可）</td></tr></tbody></table></div><h3 id="11、对象的新增方法"><a href="#11、对象的新增方法" class="headerlink" title="11、对象的新增方法"></a>11、对象的新增方法</h3><div class="table-container"><table><thead><tr><th>方法名称</th><th>描述</th></tr></thead><tbody><tr><td>assign()</td><td>合并对象</td></tr><tr><td>Object.keys()</td><td>返回一个数组，成员是键名</td></tr><tr><td>Object.values()</td><td>返回一个数组，成员是键值</td></tr><tr><td>Object.entries()</td><td>返回一个数组，成员是键名和键值</td></tr></tbody></table></div>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ES6&quot;&gt;&lt;a href=&quot;#ES6&quot; class=&quot;headerlink&quot; title=&quot;ES6&quot;&gt;&lt;/a&gt;ES6&lt;/h3&gt;&lt;h3 id=&quot;1、let-和-const&quot;&gt;&lt;a href=&quot;#1、let-和-const&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-09-关于软考高项网规</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/53411.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/53411.html</id>
    <published>2025-11-09T11:54:52.000Z</published>
    <updated>2025-11-17T04:17:47.505Z</updated>
    
    <content type="html"><![CDATA[<p class='item-img' data-src='https://pic1.zhimg.com/80/v2-64f704998685ee637755df7f76ed905c_720w.webp'><img src="https://pic1.zhimg.com/80/v2-64f704998685ee637755df7f76ed905c_720w.webp" alt=""></p><p class='item-img' data-src='https://pica.zhimg.com/80/v2-94e7dccfb5b4f6ef38ffa16111e52822_720w.webp'><img src="https://pica.zhimg.com/80/v2-94e7dccfb5b4f6ef38ffa16111e52822_720w.webp" alt=""></p><p>早八去东风路考试，上午选择大概考了网络基础概念 OSI 模型、编码传输之类，另外就是问企业内部网络规划（VLAN、路由交换）、路由协议（OSPF、BGP）、传输应用层（TCP/IP、DNS）及网络管理（SNMP），差不多还有广域网接入、无线与 IPv6，问了下网络安全解决方案（防火墙、VPN、加密认证）、服务器存储与容灾技术，网络规划设计与实施能力，加上一些操作系统、项目管理，专业英语之类的八股</p><p>然后案例分析问了网络安全、无线网络规划和存储容灾之类的内容，第一题问一家公司网络中存在大量用户敏感信息，还不进行网络安全等级保护测评，业务烂的要死被勒索病毒攻击事件还不立马断网还查资料把整个单位崩了之类的情况让你分析 <strong>（安全问题加钱就完了，开月薪 3000 谁给你写 waf）</strong></p><p>第二题问在图书馆、教学楼、宿舍、操场、体育馆等不同场景下进行无线网络部署的工作，​ 比较 2.4G、5G、6G 等不同无线频段的特性（答了穿透性、速率、干扰、信道数量），再问设备选型之类（密集放装型、面板型、室外定向天线），还问怎么写一万人使用的网络设计方案</p><p>第三题问某公司的数据备份和存储架构规划，问备份策略（全量/增量通过 IPSec VPN 传输）的不足（一眼带宽占用大、恢复时间长），提出改进措施（如改用专线、增量永久合成等技术，一时半会没想到都），然后就是问提升集中式存储可靠性的技术（如 RAID、双控制器、快照、镜像等）。再问技术选型，对比集中式存储和分布式存储在架构、冗余机制、扩展性和性能等方面的差异，比较堆叠和 MLAG 这两种提高网络可靠性的技术差异之类。</p><p>论文是讲国家教育数字化战略，推进智慧校园建设相关的内容，“论智慧校园网络规划与设计”，比如智慧校园要如何满足同城双校区网络互联，无线网络覆盖，智慧教室专网，校园安防专网等基本需求。<br>说是要结合自身参与规划、设计和实施的智慧校园网络建设项目，详细论述规划和设计方案，包括项目整体规划，网络架构，设备选型等，再结合自身参与实施的项目，分析智慧校园网络规划与设计中的难点和创新点。（哪个大三的会有这经验）</p><p>吃 408 计网老本还有平时一些积累考的，区别在于感觉题目更侧重问通信工程相关，做起来没啥太大压力，论文的话感觉没两年工作经验写不动，只能靠先前准备的内容糊上去，感觉会被卡 10%通过率，大概率寄了痛失两百块，下次考也许工作后罢。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p class=&#39;item-img&#39; data-src=&#39;https://pic1.zhimg.com/80/v2-64f704998685ee637755df7f76ed905c_720w.webp&#39;&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="日志" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-05-基于随机加权推断模型（IM）的参数估计算法</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/10893.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/10893.html</id>
    <published>2025-11-05T12:51:41.000Z</published>
    <updated>2025-11-17T04:31:38.490Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基于随机加权推断模型（IM）的参数估计方法"><a href="#基于随机加权推断模型（IM）的参数估计方法" class="headerlink" title="基于随机加权推断模型（IM）的参数估计方法"></a>基于随机加权推断模型（IM）的参数估计方法</h2><p>不可观测的泊松过程 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="14.938ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 6602.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(1036.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(2092.6,0)"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(681,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1181,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1459,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1853,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2247,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2747,0)"></path></g><g data-mml-node="mo" transform="translate(5395.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(5784.6,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(6213.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> 和 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="14.75ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 6519.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(922.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(1978.6,0)"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(681,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1181,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1459,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1853,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2247,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2747,0)"></path></g><g data-mml-node="mo" transform="translate(5281.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(5670.6,0)"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(6130.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，观测值 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="27.713ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 12249 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path></g><g data-mml-node="mo" transform="translate(1040.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2096.6,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mo" transform="translate(3077.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(4078,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(5000.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(6056.6,0)"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(681,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1181,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1459,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1853,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2247,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2747,0)"></path></g><g data-mml-node="mo" transform="translate(9359.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(9748.6,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(10399.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(11400,0)"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(11860,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> 和辅助变量 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.213ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 8492 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g><g data-mml-node="mo" transform="translate(1325.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(2381.6,0)"><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(681,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1181,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1459,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1853,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2247,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2747,0)"></path></g><g data-mml-node="mo" transform="translate(5684.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6073.6,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(7173.8,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(7674,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(8103,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，目标是估计参数 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.971ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 429 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container>、<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.041ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 460 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container><br>m?</p><p>现提出基于随机加权推断模型（Inferential Model, IM）的算法通过引入随机权重处理离散分布，来构造置信区间</p><h3 id="方法概述"><a href="#方法概述" class="headerlink" title="方法概述"></a>方法概述</h3><p>随机加权 IM 方法的核心是通过引入均匀随机变量和权重，将离散泊松分布连续化，从而逆解参数<br>该方法假设 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.986ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 878 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container> 已知算法分为四个步骤：建立关联模型、引入随机权重连续化、逆解参数、模拟验证覆盖率</p><h3 id="算法步骤"><a href="#算法步骤" class="headerlink" title="算法步骤"></a>算法步骤</h3><h4 id="1-建立关联模型"><a href="#1-建立关联模型" class="headerlink" title="1: 建立关联模型"></a>1: 建立关联模型</h4><p>对观测值 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.726ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 763 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path></g></g></g></svg></mjx-container>，其分布函数为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.262ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2325.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></g><g data-mml-node="TeXAtom" transform="translate(676,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1057.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1446.6,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1936.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="8.855ex" height="2.034ex" role="img" focusable="false" viewBox="0 -705 3914 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"></path></g><g data-mml-node="mo" transform="translate(746.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(1802.6,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(2453.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(3454,0)"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container><br>引入辅助变量 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="17.519ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 7743.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(849.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(1905.6,0)"><path data-c="55" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 418V291Q232 189 240 145T280 67Q325 24 389 24Q454 24 506 64T571 183Q575 206 575 410V598Q569 608 565 613T541 627T489 637H472V683H481Q496 680 598 680T715 683H724V637H707Q634 633 622 598L621 399Q620 194 617 180Q617 179 615 171Q595 83 531 31T389 -22Q304 -22 226 33T130 192Q129 201 128 412V622Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(750,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1306,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1584,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1890,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2390,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2782,0)"></path></g><g data-mml-node="mo" transform="translate(5520.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(5909.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(6409.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(6854.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(7354.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，建立关联：</p><script type="math/tex; mode=display">F_{θ}(Y-1) \leq u < F_{θ}(Y)</script><p>对观测值 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="2.371ex" height="1.595ex" role="img" focusable="false" viewBox="0 -683 1048 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g></g></g></svg></mjx-container>，其分布函数为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="7.114ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3144.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></g><g data-mml-node="TeXAtom" transform="translate(676,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1650.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2039.2,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mo" transform="translate(2755.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，引入辅助变量 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="17.322ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 7656.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mo" transform="translate(762.8,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(1818.6,0)"><path data-c="55" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 418V291Q232 189 240 145T280 67Q325 24 389 24Q454 24 506 64T571 183Q575 206 575 410V598Q569 608 565 613T541 627T489 637H472V683H481Q496 680 598 680T715 683H724V637H707Q634 633 622 598L621 399Q620 194 617 180Q617 179 615 171Q595 83 531 31T389 -22Q304 -22 226 33T130 192Q129 201 128 412V622Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(750,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1306,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1584,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1890,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2390,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2782,0)"></path></g><g data-mml-node="mo" transform="translate(5433.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(5822.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(6322.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(6767.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(7267.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，建立关联：</p><script type="math/tex; mode=display">F_{mb}(W-1) \leq v \leq F_{mb}(W)</script><h4 id="2-引入随机权重进行连续化"><a href="#2-引入随机权重进行连续化" class="headerlink" title="2: 引入随机权重进行连续化"></a>2: 引入随机权重进行连续化</h4><p>引入随机权重 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="22.446ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 9921 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mn" transform="translate(749,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1152.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1597.2,0)"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mn" transform="translate(749,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(3027.6,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(4083.3,0)"><path data-c="55" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 418V291Q232 189 240 145T280 67Q325 24 389 24Q454 24 506 64T571 183Q575 206 575 410V598Q569 608 565 613T541 627T489 637H472V683H481Q496 680 598 680T715 683H724V637H707Q634 633 622 598L621 399Q620 194 617 180Q617 179 615 171Q595 83 531 31T389 -22Q304 -22 226 33T130 192Q129 201 128 412V622Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(750,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1306,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1584,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1890,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2390,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2782,0)"></path></g><g data-mml-node="mo" transform="translate(7698.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(8087.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(8587.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(9032,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(9532,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.622ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 8672.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(572,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1016.7,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mo" transform="translate(1779.4,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(2835.2,0)"><path data-c="55" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 418V291Q232 189 240 145T280 67Q325 24 389 24Q454 24 506 64T571 183Q575 206 575 410V598Q569 608 565 613T541 627T489 637H472V683H481Q496 680 598 680T715 683H724V637H707Q634 633 622 598L621 399Q620 194 617 180Q617 179 615 171Q595 83 531 31T389 -22Q304 -22 226 33T130 192Q129 201 128 412V622Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(750,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1306,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1584,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1890,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2390,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2782,0)"></path></g><g data-mml-node="mo" transform="translate(6450.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(6839.2,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(7339.2,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(7783.9,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(8283.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>构造方程：</p><script type="math/tex; mode=display">G(θ): w_1 F_{θ}(Y-1) + (1-w_1) F_{θ}(Y) = u</script><script type="math/tex; mode=display">H(mb): w_2 F_{mb}(W-1) + (1-w_2) F_{mb}(W) = v</script><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.778ex" height="1.645ex" role="img" focusable="false" viewBox="0 -705 786 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g></g></g></svg></mjx-container> 和 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></svg></mjx-container> 是关于参数的函数，且由于泊松分布函的单调性，逆函数 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="4.011ex" height="1.937ex" role="img" focusable="false" viewBox="0 -833.9 1772.7 855.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="TeXAtom" transform="translate(819,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container> 和 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="4.361ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1927.5 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="TeXAtom" transform="translate(973.9,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container> 存在</p><h4 id="3-逆解参数，使用-brentq-函数进行二分法求根"><a href="#3-逆解参数，使用-brentq-函数进行二分法求根" class="headerlink" title="3: 逆解参数，使用 brentq 函数进行二分法求根"></a>3: 逆解参数，使用 brentq 函数进行二分法求根</h4><p>从上述方程解出 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.061ex" height="1.618ex" role="img" focusable="false" viewBox="0 -705 469 715"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"></path></g></g></g></svg></mjx-container> 和 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="2.957ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 1307 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container>：</p><script type="math/tex; mode=display">θ = G^{-1}(u), \quad mb = H^{-1}(v)</script><p>推导参数：</p><script type="math/tex; mode=display">b = \frac{H^{-1}(v)}{m}, \quad q = θ - b = G^{-1}(u) - \frac{H^{-1}(v)}{m}</script><p>得到 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.971ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 429 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container> 和 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.041ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 460 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container> 的表达式</p><h4 id="4-验证覆盖率"><a href="#4-验证覆盖率" class="headerlink" title="4: 验证覆盖率"></a>4: 验证覆盖率</h4><ul><li><p>模拟目标：检查构造的置信区间覆盖真实 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.041ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 460 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container> 的概率是否接近 95%</p></li><li><p>步骤：</p></li></ul><p>生成观测数据：从分布生成一对观测值 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.863ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3033.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path></g><g data-mml-node="mo" transform="translate(1152,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1596.7,0)"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g><g data-mml-node="mo" transform="translate(2644.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></p><p>对于固定 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.863ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3033.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path></g><g data-mml-node="mo" transform="translate(1152,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1596.7,0)"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g><g data-mml-node="mo" transform="translate(2644.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，生成大量样本（如 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="10.682ex" height="1.731ex" role="img" focusable="false" viewBox="0 -683 4721.6 765"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(1165.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(2221.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"></path></g></g></g></svg></mjx-container> 个）的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="26.849ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 11867.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(572,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1016.7,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mo" transform="translate(1501.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1946.3,0)"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mn" transform="translate(749,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(3098.9,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(3543.6,0)"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mn" transform="translate(749,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4973.9,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mtext" transform="translate(6029.7,0)"><path data-c="55" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 418V291Q232 189 240 145T280 67Q325 24 389 24Q454 24 506 64T571 183Q575 206 575 410V598Q569 608 565 613T541 627T489 637H472V683H481Q496 680 598 680T715 683H724V637H707Q634 633 622 598L621 399Q620 194 617 180Q617 179 615 171Q595 83 531 31T389 -22Q304 -22 226 33T130 192Q129 201 128 412V622Z"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(750,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1306,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1584,0)"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1890,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2390,0)"></path><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2782,0)"></path></g><g data-mml-node="mo" transform="translate(9644.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(10033.7,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(10533.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(10978.3,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(11478.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></p><p>计算 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.041ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 460 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container> 的候选值：对于每个样本，计算 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.798ex;" xmlns="http://www.w3.org/2000/svg" width="26.9ex" height="3.301ex" role="img" focusable="false" viewBox="0 -1106.5 11889.8 1459.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="TeXAtom" transform="translate(479,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(444,0)"></path><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(944,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1500,0)"></path><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(2056,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(2334,0)"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(2890,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(3390,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(3779,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(3792.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msup" transform="translate(4848.7,0)"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="TeXAtom" transform="translate(819,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mo" transform="translate(6621.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(7010.3,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(7582.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(8193.6,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(9193.8,0)"><g data-mml-node="mrow" transform="translate(220,516.8) scale(0.707)"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="TeXAtom" transform="translate(973.9,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1927.5,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2316.5,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mo" transform="translate(2801.5,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><g data-mml-node="mi" transform="translate(1037.6,-345) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><rect width="2456" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></p><p>构造置信区间：从 10000 个 q 值中取分位数，得到置信区间 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.946ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 5280.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(278,0)"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="TeXAtom" transform="translate(479,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(778,0)"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(1278,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1778,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(2417.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(2862.5,0)"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="TeXAtom" transform="translate(479,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(778,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(1278,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1778,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(5002.2,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></p><p>检查覆盖率：重复步骤 2-5 多次（ <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="11.051ex" height="1.731ex" role="img" focusable="false" viewBox="0 -683 4884.6 765"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(1328.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(2384.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"></path></g></g></g></svg></mjx-container> 次），每次生成新的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.863ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3033.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D44C" d="M66 637Q54 637 49 637T39 638T32 641T30 647T33 664T42 682Q44 683 56 683Q104 680 165 680Q288 680 306 683H316Q322 677 322 674T320 656Q316 643 310 637H298Q242 637 242 624Q242 619 292 477T343 333L346 336Q350 340 358 349T379 373T411 410T454 461Q546 568 561 587T577 618Q577 634 545 637Q528 637 528 647Q528 649 530 661Q533 676 535 679T549 683Q551 683 578 682T657 680Q684 680 713 681T746 682Q763 682 763 673Q763 669 760 657T755 643Q753 637 734 637Q662 632 617 587Q608 578 477 424L348 273L322 169Q295 62 295 57Q295 46 363 46Q379 46 384 45T390 35Q390 33 388 23Q384 6 382 4T366 1Q361 1 324 1T232 2Q170 2 138 2T102 1Q84 1 84 9Q84 14 87 24Q88 27 89 30T90 35T91 39T93 42T96 44T101 45T107 45T116 46T129 46Q168 47 180 50T198 63Q201 68 227 171L252 274L129 623Q128 624 127 625T125 627T122 629T118 631T113 633T105 634T96 635T83 636T66 637Z"></path></g><g data-mml-node="mo" transform="translate(1152,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1596.7,0)"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g><g data-mml-node="mo" transform="translate(2644.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，计算区间覆盖真实 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.041ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 460 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container> 的比例覆盖率 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex;" xmlns="http://www.w3.org/2000/svg" width="9.783ex" height="3.07ex" role="img" focusable="false" viewBox="0 -1011.8 4324.2 1356.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(1055.8,0)"><g data-mml-node="mtext" transform="translate(220,481.4) scale(0.707)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">覆</text><text data-variant="normal" transform="translate(1000,0) scale(1,-1)" font-size="884px" font-family="serif">盖</text><text data-variant="normal" transform="translate(2000,0) scale(1,-1)" font-size="884px" font-family="serif">次</text><text data-variant="normal" transform="translate(3000,0) scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(1262.6,-345) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><rect width="3028.4" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container><br class='item-img' data-src='Pasted%20image%2020251107093229.png'><img src="Pasted%20image%2020251107093229.png" alt=""></p><h4 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> poisson, gamma<br><span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> brentq<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">'ignore'</span>)<br><br><br><span class="hljs-comment"># 设置全局字体为 SimHei (黑体) 或其他中文字体</span><br>plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]<br>plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PoissonSignalInference</span>:<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    基于随机加权IM方法的泊松信号推断类</span><br><span class="hljs-string">    用于估计背景率b、信号率q和尺度参数m</span><br><span class="hljs-string">    """</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, b_true=<span class="hljs-literal">None</span>, q_true=<span class="hljs-literal">None</span>, m_true=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        初始化真实参数值</span><br><span class="hljs-string">        """</span><br>        <span class="hljs-variable language_">self</span>.b_true = b_true<br>        <span class="hljs-variable language_">self</span>.q_true = q_true<br>        <span class="hljs-variable language_">self</span>.m_true = m_true<br>        <span class="hljs-variable language_">self</span>.STA_true = b_true + q_true <span class="hljs-keyword">if</span> b_true <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> q_true <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_data</span>(<span class="hljs-params">self, n_samples=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string"></span><br><span class="hljs-string">        生成观测数据Y和W</span><br><span class="hljs-string"></span><br><span class="hljs-string">        当前有不可观测的泊松过程 B ∼ Poisson(b) 和 S ∼ Poisson(q)</span><br><span class="hljs-string">        可观测对象有 Y = B + S ∼ Poisson(b + q) 和辅助变量 W ∼ Poisson(m · b)</span><br><span class="hljs-string">        目标是估计参数 b、q 和可能的 m</span><br><span class="hljs-string"></span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.b_true <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-variable language_">self</span>.q_true <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-variable language_">self</span>.m_true <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"必须先设置真实参数值"</span>)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.STA_true <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-variable language_">self</span>.STA_true = <span class="hljs-variable language_">self</span>.b_true + <span class="hljs-variable language_">self</span>.q_true<br><br>        Y = np.random.poisson(<span class="hljs-variable language_">self</span>.STA_true, n_samples)<br>        W = np.random.poisson(<span class="hljs-variable language_">self</span>.m_true * <span class="hljs-variable language_">self</span>.b_true, n_samples)<br><br>        <span class="hljs-keyword">return</span> Y, W<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">poisson_cdf</span>(<span class="hljs-params">self, k, theta</span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        计算泊松分布的累积分布函数</span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">return</span> poisson.cdf(k, theta) <span class="hljs-comment">#泊松分布的CDF公式，参数为 k 和 theta</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">solve_G_inverse</span>(<span class="hljs-params">self, u, Y, w1, bracket_low=<span class="hljs-number">0</span>, bracket_high=<span class="hljs-number">100</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        求解方程 G(STA) = u 的逆函数，得到STA</span><br><span class="hljs-string">        使用二分法求解 G(STA): w_1 F_{STA}(Y-1) + (1-w_1) F_{STA}(Y) = u</span><br><span class="hljs-string"></span><br><span class="hljs-string">        计算泊松混合分布的累积分布函数值与目标值的差值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        该函数计算一个泊松混合分布的CDF值，该混合分布由两个泊松分布组成，权重分别为w1和(1-w1)，</span><br><span class="hljs-string">        然后减去目标值u，通常用于求解分位数或进行概率计算</span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">            Y (int or array-like): 观测值，泊松分布的计数变量</span><br><span class="hljs-string">            STA (float or array-like): 泊松分布的参数λ（均值）</span><br><span class="hljs-string">            w1 (float): 第一个泊松分布的权重，取值范围[0,1]</span><br><span class="hljs-string">            u (float): 目标概率值，用于比较或求解</span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">equation</span>(<span class="hljs-params">STA</span>): <span class="hljs-comment">#返回值:(float or array-like): 泊松混合分布的CDF值与目标值u的差值</span><br>            <span class="hljs-keyword">if</span> Y == <span class="hljs-number">0</span>:<br>                <span class="hljs-comment"># 当Y=0时，F_STA(-1)=0，方程简化为F_STA(0)=u</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.poisson_cdf(<span class="hljs-number">0</span>, STA) - u<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> w1 * <span class="hljs-variable language_">self</span>.poisson_cdf(Y-<span class="hljs-number">1</span>, STA) + (<span class="hljs-number">1</span>-w1) * <span class="hljs-variable language_">self</span>.poisson_cdf(Y, STA) - u<br>                <span class="hljs-comment"># 求加权泊松混合分布</span><br>                <span class="hljs-comment"># 第一项：权重w1乘以P(X &lt;= Y-1)的概率</span><br>                <span class="hljs-comment"># 第二项：权重(1-w1)乘以P(X &lt;= Y)的概率</span><br>                <span class="hljs-comment"># 最后减去目标值u</span><br><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-string">"""</span><br><span class="hljs-string">            使用二分法求解 G(STA) = u 方程中的 STA 值</span><br><span class="hljs-string">            """</span><br>            <span class="hljs-comment"># 设置上下界来初始化搜索区间</span><br>            low = <span class="hljs-built_in">max</span>(<span class="hljs-number">0.00001</span>, bracket_low) <span class="hljs-comment">#bracket_low下界（）</span><br>            high = <span class="hljs-built_in">max</span>(<span class="hljs-number">10</span> * Y, bracket_high) <span class="hljs-keyword">if</span> Y &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> bracket_high <span class="hljs-comment">#bracket_high上界，根据观测值 Y 调整上界</span><br><br>            <span class="hljs-comment"># 检查边界值</span><br>            f_low = equation(low)<br>            f_high = equation(high)<br><br><br>            <span class="hljs-keyword">if</span> f_low * f_high &gt; <span class="hljs-number">0</span>:<br>                <span class="hljs-comment"># 如果 f_low * f_high &gt; 0（同号），则自动扩大搜索区间</span><br>                attempts = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">while</span> f_low * f_high &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> attempts &lt; <span class="hljs-number">10</span>:<br>                    high *= <span class="hljs-number">2</span> <span class="hljs-comment">#最多尝试10次，每次将上界翻倍：high *= 2</span><br>                    f_high = equation(high)<br>                    attempts += <span class="hljs-number">1</span><br><br>            STA_solution = brentq(equation, low, high, xtol=<span class="hljs-number">1e-6</span>)<br>            <span class="hljs-string">"""</span><br><span class="hljs-string">            参数为要求解的方程（加权泊松混合分布），上下区间，精度</span><br><span class="hljs-string">            使用 brentq 函数进行二分法求根</span><br><span class="hljs-string">            求解 w1 * self.poisson_cdf(Y-1, STA) + (1-w1) * self.poisson_cdf(Y, STA) - u = 0</span><br><span class="hljs-string"></span><br><span class="hljs-string">            即求解方程 G(STA) = u</span><br><span class="hljs-string">            得到STA</span><br><span class="hljs-string"></span><br><span class="hljs-string">            """</span><br><br>            <span class="hljs-keyword">return</span> STA_solution <span class="hljs-comment">#返回求解得到的 STA 值</span><br>        <span class="hljs-keyword">except</span> (ValueError, RuntimeError):<br>            <span class="hljs-comment"># 如果求解失败，返回保守估计</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">"ERR solve_G_inverse 求解失败，返回保守估计"</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-number">0.001</span>, Y)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">solve_H_inverse</span>(<span class="hljs-params">self, v, W, w2, m, bracket_low=<span class="hljs-number">0</span>, bracket_high=<span class="hljs-number">100</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        求解方程 H(mb) = v 的逆函数，得到mb</span><br><span class="hljs-string"></span><br><span class="hljs-string">        H(mb): w_2 F_{mb}(W-1) + (1-w_2) F_{mb}(W) = v</span><br><span class="hljs-string"></span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">equation</span>(<span class="hljs-params">mb</span>):<br>            <span class="hljs-keyword">if</span> W == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.poisson_cdf(<span class="hljs-number">0</span>, mb) - v<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> w2 * <span class="hljs-variable language_">self</span>.poisson_cdf(W-<span class="hljs-number">1</span>, mb) + (<span class="hljs-number">1</span>-w2) * <span class="hljs-variable language_">self</span>.poisson_cdf(W, mb) - v<br><br>        <span class="hljs-keyword">try</span>:<br>            low = <span class="hljs-built_in">max</span>(<span class="hljs-number">0.001</span>, bracket_low)<br>            high = <span class="hljs-built_in">max</span>(<span class="hljs-number">10</span> * W, bracket_high) <span class="hljs-keyword">if</span> W &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> bracket_high<br><br>            f_low = equation(low)<br>            f_high = equation(high)<br><br>            <span class="hljs-keyword">if</span> f_low * f_high &gt; <span class="hljs-number">0</span>:<br>                attempts = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">while</span> f_low * f_high &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> attempts &lt; <span class="hljs-number">10</span>:<br>                    high *= <span class="hljs-number">2</span><br>                    f_high = equation(high)<br>                    attempts += <span class="hljs-number">1</span><br><br>            mb_solution = brentq(equation, low, high, xtol=<span class="hljs-number">1e-6</span>)<br>            <span class="hljs-keyword">return</span> mb_solution<br>        <span class="hljs-keyword">except</span> (ValueError, RuntimeError):<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-number">0.001</span>, W)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">estimate_parameters_IM</span>(<span class="hljs-params">self, Y_obs, W_obs, m_known=<span class="hljs-literal">True</span>, n_inner_samples=<span class="hljs-number">10000</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        使用随机加权IM方法估计三个参数q、b和STA</span><br><span class="hljs-string">        Y_obs：观测值Y</span><br><span class="hljs-string">        W_obs：观测值W</span><br><span class="hljs-string">        m_known：一个布尔值，表示参数m是否已知</span><br><span class="hljs-string">        n_inner_samples：内部采样次数，默认为10000</span><br><span class="hljs-string"></span><br><span class="hljs-string">        """</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> m_known:<br>            <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"m未知"</span>)<br><br>        <span class="hljs-comment"># 创建三个列表存储候选参数值</span><br>        q_candidates = []<br>        b_candidates = []<br>        STA_candidates = []<br><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_inner_samples):<br>            <span class="hljs-comment"># 生成4个均匀分布的随机权重（u, v, w1, w2）</span><br>            u = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>            v = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>            w1 = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>            w2 = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br><br>            <span class="hljs-comment"># 使用solve_G_inverse和solve_H_inverse方法计算STA和mb的估计值</span><br>            STA_est = <span class="hljs-variable language_">self</span>.solve_G_inverse(u, Y_obs, w1)<br>            mb_est = <span class="hljs-variable language_">self</span>.solve_H_inverse(v, W_obs, w2, <span class="hljs-variable language_">self</span>.m_true)<br>            <span class="hljs-comment"># G(STA): w_1 F_{STA}(Y-1) + (1-w_1) F_{STA}(Y) = u ==&gt; 求解STA</span><br>            <span class="hljs-comment"># H(mb): w_2 F_{mb}(W-1) + (1-w_2) F_{mb}(W) = v ==&gt; 求解mb</span><br>            <span class="hljs-comment"># 可以得到</span><br>            <span class="hljs-comment"># STA = G⁻¹(u), mb = H⁻¹(v)</span><br>            <span class="hljs-comment"># 计算b和q</span><br>            <span class="hljs-comment"># b = H⁻¹(v)/m</span><br>            <span class="hljs-comment"># q = STA - b = G⁻¹(u) - H⁻¹(v)/m</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.m_true <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"参数 m_true 未设置，无法计算 b_est"</span>)<br>            b_est = mb_est / <span class="hljs-variable language_">self</span>.m_true<br>            q_est = STA_est - b_est<br><br>            <span class="hljs-comment"># 确保非负</span><br>            q_est = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, q_est)<br>            b_est = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, b_est)<br><br>            <span class="hljs-comment">#每次计算出新的 q_est 值后，会将其添加到 q_candidates 列表中</span><br>            q_candidates.append(q_est)<br>            b_candidates.append(b_est)<br>            STA_candidates.append(STA_est)<br><br>        <span class="hljs-keyword">return</span> {<br>            <span class="hljs-string">'q_candidates'</span>: np.array(q_candidates),<br>            <span class="hljs-string">'b_candidates'</span>: np.array(b_candidates),<br>            <span class="hljs-string">'STA_candidates'</span>: np.array(STA_candidates)<br>        }<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_confidence_intervals</span>(<span class="hljs-params">self, candidates_dict, alpha=<span class="hljs-number">0.05</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        计算参数的置信区间</span><br><span class="hljs-string">        """</span><br>        intervals = {}<br><br>        <span class="hljs-keyword">for</span> param, values <span class="hljs-keyword">in</span> candidates_dict.items():<br>            <span class="hljs-comment"># 移除'_candidates'后缀，使键名简化</span><br>            simple_param = param.replace(<span class="hljs-string">'_candidates'</span>, <span class="hljs-string">''</span>)<br>            lower = np.quantile(values, alpha/<span class="hljs-number">2</span>)<br>            upper = np.quantile(values, <span class="hljs-number">1</span> - alpha/<span class="hljs-number">2</span>)<br>            intervals[simple_param] = (lower, upper)<br><br>        <span class="hljs-keyword">return</span> intervals<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">coverage_simulation</span>(<span class="hljs-params">self, n_outer_trials=<span class="hljs-number">1000</span>, n_inner_samples=<span class="hljs-number">1000</span>, alpha=<span class="hljs-number">0.05</span></span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        进行覆盖率模拟验证</span><br><span class="hljs-string">        """</span><br>        coverage_results = {<br>            <span class="hljs-string">'q'</span>: <span class="hljs-number">0.0</span>,<br>            <span class="hljs-string">'b'</span>: <span class="hljs-number">0.0</span>,<br>            <span class="hljs-string">'STA'</span>: <span class="hljs-number">0.0</span><br>        }<br><br>        interval_lengths = {<br>            <span class="hljs-string">'q'</span>: [],<br>            <span class="hljs-string">'b'</span>: [],<br>            <span class="hljs-string">'STA'</span>: []<br>        }<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在进行覆盖率模拟..."</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(n_outer_trials)):<br>            <span class="hljs-comment"># 生成新的观测数据</span><br>            Y_obs, W_obs = <span class="hljs-variable language_">self</span>.generate_data(<span class="hljs-number">1</span>)<br>            Y_obs, W_obs = Y_obs[<span class="hljs-number">0</span>], W_obs[<span class="hljs-number">0</span>]<br><br>            <span class="hljs-comment"># 估计参数</span><br>            candidates_dict = <span class="hljs-variable language_">self</span>.estimate_parameters_IM(Y_obs, W_obs,<br>                                                         n_inner_samples=n_inner_samples)<br><br>            <span class="hljs-comment"># 计算置信区间</span><br>            intervals = <span class="hljs-variable language_">self</span>.calculate_confidence_intervals(candidates_dict, alpha)<br><br>            <span class="hljs-comment"># 检查覆盖率</span><br>            <span class="hljs-keyword">if</span> intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">0</span>] &lt;= <span class="hljs-variable language_">self</span>.q_true &lt;= intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">1</span>]:<br>                coverage_results[<span class="hljs-string">'q'</span>] += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">0</span>] &lt;= <span class="hljs-variable language_">self</span>.b_true &lt;= intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">1</span>]:<br>                coverage_results[<span class="hljs-string">'b'</span>] += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">0</span>] &lt;= <span class="hljs-variable language_">self</span>.STA_true &lt;= intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">1</span>]:<br>                coverage_results[<span class="hljs-string">'STA'</span>] += <span class="hljs-number">1</span><br><br>            <span class="hljs-comment"># 记录区间长度</span><br>            interval_lengths[<span class="hljs-string">'q'</span>].append(intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">1</span>] - intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">0</span>])<br>            interval_lengths[<span class="hljs-string">'b'</span>].append(intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">1</span>] - intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">0</span>])<br>            interval_lengths[<span class="hljs-string">'STA'</span>].append(intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">1</span>] - intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">0</span>])<br><br>        <span class="hljs-comment"># 计算覆盖率</span><br>        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> coverage_results:<br>            coverage_results[param] = coverage_results[param] / n_outer_trials<br><br>        <span class="hljs-keyword">return</span> coverage_results, interval_lengths<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_results</span>(<span class="hljs-params">self, candidates_dict, intervals, Y_obs, W_obs</span>):<br>        <span class="hljs-string">"""</span><br><span class="hljs-string">        可视化结果</span><br><span class="hljs-string">        """</span><br>        fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))<br><br>        <span class="hljs-comment"># q的分布</span><br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].hist(candidates_dict[<span class="hljs-string">'q_candidates'</span>], bins=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">0.7</span>, density=<span class="hljs-literal">True</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].axvline(<span class="hljs-variable language_">self</span>.q_true, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">f'真实 q = <span class="hljs-subst">{self.q_true}</span>'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].axvline(intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">0</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>, label=<span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-number">100</span>*(<span class="hljs-number">1</span>-<span class="hljs-number">0.05</span>)}</span>% CI'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].axvline(intervals[<span class="hljs-string">'q'</span>][<span class="hljs-number">1</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'q'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'密度'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].set_title(<span class="hljs-string">'q的后验分布'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].legend()<br><br>        <span class="hljs-comment"># b的分布</span><br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].hist(candidates_dict[<span class="hljs-string">'b_candidates'</span>], bins=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">0.7</span>, density=<span class="hljs-literal">True</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].axvline(<span class="hljs-variable language_">self</span>.b_true, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">f'真实 b = <span class="hljs-subst">{self.b_true}</span>'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].axvline(intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">0</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>, label=<span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-number">100</span>*(<span class="hljs-number">1</span>-<span class="hljs-number">0.05</span>)}</span>% CI'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].axvline(intervals[<span class="hljs-string">'b'</span>][<span class="hljs-number">1</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">'b'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].set_ylabel(<span class="hljs-string">'密度'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].set_title(<span class="hljs-string">'b的后验分布'</span>)<br>        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].legend()<br><br>        <span class="hljs-comment"># STA的分布</span><br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].hist(candidates_dict[<span class="hljs-string">'STA_candidates'</span>], bins=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">0.7</span>, density=<span class="hljs-literal">True</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].axvline(<span class="hljs-variable language_">self</span>.STA_true, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">f'真实 STA = <span class="hljs-subst">{self.STA_true}</span>'</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].axvline(intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">0</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>, label=<span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-number">100</span>*(<span class="hljs-number">1</span>-<span class="hljs-number">0.05</span>)}</span>% CI'</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].axvline(intervals[<span class="hljs-string">'STA'</span>][<span class="hljs-number">1</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">1</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'STA'</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'密度'</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].set_title(<span class="hljs-string">'STA的后验分布'</span>)<br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].legend()<br><br>        <span class="hljs-comment"># 观测数据信息</span><br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].axis(<span class="hljs-string">'off'</span>)<br>        text_str = <span class="hljs-string">f'观测数据:\nY = <span class="hljs-subst">{Y_obs}</span>\nW = <span class="hljs-subst">{W_obs}</span>\n\n真实参数:\nb = <span class="hljs-subst">{self.b_true}</span>\nq = <span class="hljs-subst">{self.q_true}</span>\nm = <span class="hljs-subst">{self.m_true}</span>\nSTA = <span class="hljs-subst">{self.STA_true}</span>'</span><br>        axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.9</span>, text_str, transform=axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].transAxes, fontsize=<span class="hljs-number">12</span>,<br>                    verticalalignment=<span class="hljs-string">'top'</span>, bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">'round'</span>, facecolor=<span class="hljs-string">'wheat'</span>, alpha=<span class="hljs-number">0.5</span>))<br><br>        plt.tight_layout()<br>        plt.show()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    主函数：演示完整的推断流程</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># 设置真实参数</span><br>    b_true = <span class="hljs-number">3.0</span>  <span class="hljs-comment"># b</span><br>    q_true = <span class="hljs-number">2.0</span>  <span class="hljs-comment"># q</span><br>    m_true = <span class="hljs-number">0.8</span>  <span class="hljs-comment"># 尺度参数（已知）</span><br>    STA_true = b_true + q_true<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 泊松推断演示 ==="</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"真实参数: b=<span class="hljs-subst">{b_true}</span>, q=<span class="hljs-subst">{q_true}</span>, m=<span class="hljs-subst">{m_true}</span>, STA=<span class="hljs-subst">{STA_true}</span>"</span>)<br><br>    <span class="hljs-comment"># 初始化推断器</span><br>    inference = PoissonSignalInference(b_true, q_true, m_true)<br><br>    <span class="hljs-comment"># 生成单次观测数据</span><br>    Y_obs, W_obs = inference.generate_data(<span class="hljs-number">1</span>)<br>    Y_obs, W_obs = Y_obs[<span class="hljs-number">0</span>], W_obs[<span class="hljs-number">0</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n生成的观测数据: Y=<span class="hljs-subst">{Y_obs}</span>, W=<span class="hljs-subst">{W_obs}</span>"</span>)<br><br>    <span class="hljs-comment"># 使用IM方法进行参数估计</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n正在进行参数估计..."</span>)<br>    candidates_dict = inference.estimate_parameters_IM(Y_obs, W_obs, n_inner_samples=<span class="hljs-number">10000</span>)<br><br>    <span class="hljs-comment"># 计算置信区间</span><br>    alpha = <span class="hljs-number">0.05</span>  <span class="hljs-comment"># 0.95置信区间</span><br>    intervals = inference.calculate_confidence_intervals(candidates_dict, alpha)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 估计结果 ==="</span>)<br>    <span class="hljs-keyword">for</span> param, (lower, upper) <span class="hljs-keyword">in</span> intervals.items():<br>        true_value = <span class="hljs-built_in">getattr</span>(inference, <span class="hljs-string">f"<span class="hljs-subst">{param.replace(<span class="hljs-string">'_candidates'</span>, <span class="hljs-string">''</span>)}</span>_true"</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">if</span> true_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{param}</span>: [<span class="hljs-subst">{lower:<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{upper:<span class="hljs-number">.3</span>f}</span>] (真实值: <span class="hljs-subst">{true_value:<span class="hljs-number">.3</span>f}</span>)"</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{param}</span>: [<span class="hljs-subst">{lower:<span class="hljs-number">.3</span>f}</span>, <span class="hljs-subst">{upper:<span class="hljs-number">.3</span>f}</span>]"</span>)<br><br>    <span class="hljs-comment"># 可视化结果</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n生成可视化图表..."</span>)<br>    inference.plot_results(candidates_dict, intervals, Y_obs, W_obs)<br><br>    <span class="hljs-comment"># 进行覆盖率模拟（样本量较小以加快演示速度）</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n正在进行覆盖率模拟..."</span>)<br>    coverage_results, interval_lengths = inference.coverage_simulation(<br>        n_outer_trials=<span class="hljs-number">500</span>,  <span class="hljs-comment"># 减少试验次数以加快演示</span><br>        n_inner_samples=<span class="hljs-number">1000</span>,  <span class="hljs-comment"># 减少内部样本数</span><br>        alpha=<span class="hljs-number">0.05</span><br>    )<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 覆盖率结果 ==="</span>)<br>    <span class="hljs-keyword">for</span> param, coverage <span class="hljs-keyword">in</span> coverage_results.items():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{param}</span>的覆盖率: <span class="hljs-subst">{coverage:<span class="hljs-number">.3</span>f}</span> (目标: <span class="hljs-subst">{<span class="hljs-number">1</span>-alpha:<span class="hljs-number">.3</span>f}</span>)"</span>)<br><br>    <span class="hljs-comment"># 绘制区间长度分布</span><br>    plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))<br>    <span class="hljs-keyword">for</span> i, (param, lengths) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(interval_lengths.items()):<br>        plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, i+<span class="hljs-number">1</span>)<br>        plt.hist(lengths, bins=<span class="hljs-number">30</span>, alpha=<span class="hljs-number">0.7</span>)<br>        plt.xlabel(<span class="hljs-string">f'<span class="hljs-subst">{param}</span>区间长度'</span>)<br>        plt.ylabel(<span class="hljs-string">'频数'</span>)<br>        plt.title(<span class="hljs-string">f'<span class="hljs-subst">{param}</span>置信区间长度分布'</span>)<br>    plt.tight_layout()<br>    plt.show()<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<br>    main()<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基于随机加权推断模型（IM）的参数估计方法&quot;&gt;&lt;a href=&quot;#基于随机加权推断模型（IM）的参数估计方法&quot; class=&quot;headerlink&quot; title=&quot;基于随机加权推断模型（IM）的参数估计方法&quot;&gt;&lt;/a&gt;基于随机加权推断模型（IM）的参数估计方法&lt;/</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="日志" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>2025-11-04-JavaScript 常用方法速查</title>
    <link href="https://zhongye1.github.io/Arknight-notes/posts/36778.html"/>
    <id>https://zhongye1.github.io/Arknight-notes/posts/36778.html</id>
    <published>2025-11-04T07:29:35.000Z</published>
    <updated>2025-11-17T02:26:53.983Z</updated>
    
    <content type="html"><![CDATA[<p>JavaScript 常用方法速查</p><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><div class="table-container"><table><thead><tr><th><strong>方法</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th><th><strong>返回值/副作用</strong></th></tr></thead><tbody><tr><td><code>push(...items)</code></td><td>末尾添加元素</td><td><code>arr.push(4)</code> → 修改原数组</td><td>返回新数组长度</td></tr><tr><td><code>pop()</code></td><td>删除末尾元素</td><td><code>arr.pop()</code> → 修改原数组</td><td>返回被删除元素</td></tr><tr><td><code>unshift(...items)</code></td><td>开头添加元素</td><td><code>arr.unshift(0)</code> → 修改原数组</td><td>返回新数组长度</td></tr><tr><td><code>shift()</code></td><td>删除开头元素</td><td><code>arr.shift()</code> → 修改原数组</td><td>返回被删除元素</td></tr><tr><td><code>slice(start, end)</code></td><td>截取数组片段（不修改原数组）</td><td><code>arr.slice(1, 3)</code></td><td>返回新数组</td></tr><tr><td><code>splice(start, deleteCount, ...items)</code></td><td>删除/替换元素</td><td><code>arr.splice(1, 2, 'a')</code> → 修改原数组</td><td>返回被删除元素组成的数组</td></tr><tr><td><code>map(callback)</code></td><td>遍历并返回新数组</td><td><code>[1,2,3].map(x =&gt; x*2)</code> → <code>[2,4,6]</code></td><td>新数组</td></tr><tr><td><code>filter(callback)</code></td><td>过滤符合条件的元素</td><td><code>[1,2,3].filter(x =&gt; x&gt;1)</code> → <code>[2,3]</code></td><td>新数组</td></tr><tr><td><code>reduce(callback, initialValue)</code></td><td>累计计算（如求和、统计）</td><td><code>[1,2,3].reduce((sum, x) =&gt; sum + x, 0)</code> → <code>6</code></td><td>最终累计值</td></tr><tr><td><code>find(callback)</code></td><td>查找第一个符合条件的元素</td><td><code>[1,2,3].find(x =&gt; x&gt;1)</code> → <code>2</code></td><td>元素或  <code>undefined</code></td></tr><tr><td><code>findIndex(callback)</code></td><td>查找第一个符合条件的索引</td><td><code>[1,2,3].findIndex(x =&gt; x&gt;1)</code> → <code>1</code></td><td>索引或  <code>-1</code></td></tr><tr><td><code>includes(value)</code></td><td>判断是否包含某元素（ES6）</td><td><code>[1,2,3].includes(2)</code> → <code>true</code></td><td>布尔值</td></tr><tr><td><code>flat(depth)</code></td><td>扁平化嵌套数组（ES2019）</td><td><code>[1, [2]].flat()</code> → <code>[1, 2]</code></td><td>新数组</td></tr></tbody></table></div><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><div class="table-container"><table><thead><tr><th><strong>方法</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th><th><strong>返回值</strong></th></tr></thead><tbody><tr><td><code>split(separator)</code></td><td>按分隔符拆分为数组</td><td><code>"a,b,c".split(",")</code> → <code>["a", "b", "c"]</code></td><td>数组</td></tr><tr><td><code>substring(start, end)</code></td><td>截取子字符串（不包含  <code>end</code>  索引）</td><td><code>"Hello".substring(1, 3)</code> → <code>"el"</code></td><td>新字符串</td></tr><tr><td><code>slice(start, end)</code></td><td>截取子字符串（支持负数索引）</td><td><code>"Hello".slice(-3)</code> → <code>"llo"</code></td><td>新字符串</td></tr><tr><td><code>replace(searchValue, newValue)</code></td><td>替换匹配内容（支持正则表达式）</td><td><code>"abc".replace("a", "A")</code> → <code>"Abc"</code></td><td>新字符串</td></tr><tr><td><code>toUpperCase()</code></td><td>转为大写</td><td><code>"hello".toUpperCase()</code> → <code>"HELLO"</code></td><td>新字符串</td></tr><tr><td><code>toLowerCase()</code></td><td>转为小写</td><td><code>"HELLO".toLowerCase()</code> → <code>"hello"</code></td><td>新字符串</td></tr><tr><td><code>trim()</code></td><td>去除首尾空格（ES5）</td><td><code>" hello ".trim()</code> → <code>"hello"</code></td><td>新字符串</td></tr><tr><td><code>startsWith(str)</code></td><td>判断是否以某字符串开头（ES6）</td><td><code>"hello".startsWith("he")</code> → <code>true</code></td><td>布尔值</td></tr><tr><td><code>endsWith(str)</code></td><td>判断是否以某字符串结尾（ES6）</td><td><code>"hello".endsWith("lo")</code> → <code>true</code></td><td>布尔值</td></tr><tr><td><code>padStart(length, padStr)</code></td><td>头部填充字符串（ES2017）</td><td><code>"5".padStart(3, "0")</code> → <code>"005"</code></td><td>新字符串</td></tr></tbody></table></div><h3 id="对象方法"><a href="#对象方法" class="headerlink" title="对象方法"></a>对象方法</h3><div class="table-container"><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>Object.assign()</td><td>方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象。</td></tr><tr><td>Object.create()</td><td>方法创建一个新对象，使用现有的对象来提供新创建的对象的<strong>proto</strong>。</td></tr><tr><td>Object.defineProperties()</td><td>方法直接在一个对象上定义新的属性或修改现有属性，并返回该对象。</td></tr><tr><td>Object.defineProperty()</td><td>方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。</td></tr><tr><td>Object.entries()</td><td>方法返回一个给定对象自身可枚举属性的键值对数组，其排列与使用 for…in 循环遍历该对象时返回的顺序一致。</td></tr><tr><td>Object.freeze()</td><td>方法可以冻结一个对象。</td></tr><tr><td>Object.fromEntries()</td><td>方法把键值对列表转换为一个对象。</td></tr><tr><td>Object.getOwnPropertyDescriptor()</td><td>方法返回指定对象上一个自有属性对应的属性描述符。</td></tr><tr><td>Object.getOwnPropertyDescriptors()</td><td>方法用来获取一个对象的所有自身属性的描述符。</td></tr><tr><td>Object.getOwnPropertyNames()</td><td>方法返回一个由指定对象的所有自身属性的属性名（包括不可枚举属性但不包括 Symbol 值作为名称的属性）组成的数组。</td></tr><tr><td>Object.getOwnPropertySymbols()</td><td>方法返回一个给定对象自身的所有 Symbol 属性的数组。</td></tr><tr><td>Object.getPrototypeOf()</td><td>方法返回指定对象的原型（内部[[Prototype]]属性的值）。</td></tr><tr><td>Object.is()</td><td>方法判断两个值是否为同一个值。</td></tr><tr><td>Object.isExtensible()</td><td>方法判断一个对象是否是可扩展的（是否可以在它上面添加新的属性）。</td></tr><tr><td>Object.isFrozen()</td><td>方法判断一个对象是否被冻结。</td></tr><tr><td>Object.preventExtensions()</td><td>方法让一个对象变的不可扩展，也就是永远不能再添加新的属性。</td></tr><tr><td>Object.isSealed()</td><td>方法判断一个对象是否被密封。</td></tr><tr><td>Object.keys()</td><td>方法会返回一个由一个给定对象的自身可枚举属性组成的数组，数组中属性名的排列顺序和正常循环遍历该对象时返回的顺序一致 。</td></tr><tr><td>Object.setPrototypeOf()</td><td>方法设置一个指定的对象的原型到另一个对象。</td></tr><tr><td>Object.values()</td><td>方法返回一个给定对象自身的所有可枚举属性值的数组。</td></tr><tr><td>Object.seal()</td><td>方法封闭一个对象，阻止添加新属性并将所有现有属性标记为不可配置。</td></tr></tbody></table></div><h3 id="Number-方法"><a href="#Number-方法" class="headerlink" title="Number 方法"></a>Number 方法</h3><p>Number 对象本身有一些静态属性和方法，而 Number 实例的方法是通过 Number.prototype 定义的，但通常我们使用数字字面量时可以直接调用这些方法（因为 JavaScript 会自动装箱）</p><div class="table-container"><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>constructor</td><td>返回对创建此对象的 Number 函数的引用。</td></tr><tr><td>isFinite()</td><td>检查值是否是有限数。</td></tr><tr><td>isInteger()</td><td>检查值是否为整数。</td></tr><tr><td>isNaN()</td><td>检查值是否为 Number.NaN。</td></tr><tr><td>parseFloat()</td><td>检查值是否为整数。</td></tr><tr><td>parseInt()</td><td>检查值是否为整数。</td></tr><tr><td>prototype</td><td>允许您向对象添加属性和方法。</td></tr><tr><td>toFixed(x)</td><td>把数字转换为字符串，结果的小数点后有指定位数的数字。</td></tr><tr><td>toPrecision(x)</td><td>把数字格式化为指定的长度。</td></tr><tr><td>toString()</td><td>把数字转换为字符串。</td></tr><tr><td>valueOf()​</td><td>返回数字的原始值（基本数字值）。</td></tr></tbody></table></div><h3 id="Math-方法"><a href="#Math-方法" class="headerlink" title="Math 方法"></a>Math 方法</h3><p>Math 对象是一个静态对象，它包含了许多数学常数和函数。</p><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>Math.abs(x)</td><td>返回一个数的绝对值。</td></tr><tr><td>Math.ceil(x)</td><td>返回大于或等于一个数的最小整数（向上取整）。</td></tr><tr><td>Math.floor(x)</td><td>返回小于或等于一个数的最大整数（向下取整）。</td></tr><tr><td>Math.round(x)</td><td>返回一个数四舍五入后的整数。</td></tr><tr><td>Math.max([value1[, value2[, …]]])</td><td>返回一组数中的最大值。</td></tr><tr><td>Math.min([value1[, value2[, …]]])</td><td>返回一组数中的最小值。</td></tr><tr><td>Math.pow(x, y)</td><td>返回 x 的 y 次幂。</td></tr><tr><td>Math.sqrt(x)</td><td>返回一个数的平方根。</td></tr><tr><td>Math.random()</td><td>返回一个 0 到 1 之间的伪随机数。</td></tr><tr><td>Math.sin(x)</td><td>返回一个数的正弦值。</td></tr><tr><td>Math.cos(x)</td><td>返回一个数的余弦值。</td></tr><tr><td>Math.tan(x)</td><td>返回一个数的正切值。</td></tr><tr><td>Math.log(x)</td><td>返回一个数的自然对数。</td></tr><tr><td>Math.exp(x)</td><td>返回 e 的 x 次幂。</td></tr></tbody></table></div><h3 id="Date-对象方法"><a href="#Date-对象方法" class="headerlink" title="Date 对象方法"></a>Date 对象方法</h3><p>Date 对象用于处理日期和时间</p><h5 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h5><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>Date.now()</td><td>返回自 1970 年 1 月 1 日 00:00:00 UTC 到当前时间的毫秒数。</td></tr><tr><td>Date.parse(dateString)</td><td>解析一个表示日期的字符串，并返回从 1970-1-1 00:00:00 UTC 所经过的毫秒数。</td></tr><tr><td>Date.UTC(year, month[, day[, hour[, minute[, second[, millisecond]]]]])</td><td>接受和构造函数最长形式的参数相同的参数，并返回从 1970-1-1 00:00:00 UTC 所经过的毫秒数。</td></tr></tbody></table></div><h5 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h5><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>getFullYear()</td><td>根据本地时间返回指定日期对象的年份。</td></tr><tr><td>getMonth()</td><td>根据本地时间返回指定日期对象的月份（0-11）。</td></tr><tr><td>getDate()</td><td>根据本地时间返回指定日期对象的日期（1-31）。</td></tr><tr><td>getDay()</td><td>根据本地时间返回指定日期对象的星期（0-6）。</td></tr><tr><td>getHours()</td><td>根据本地时间返回指定日期对象的小时（0-23）。</td></tr><tr><td>getMinutes()</td><td>根据本地时间返回指定日期对象的分钟（0-59）。</td></tr><tr><td>getSeconds()</td><td>根据本地时间返回指定日期对象的秒数（0-59）。</td></tr><tr><td>getMilliseconds()</td><td>根据本地时间返回指定日期对象的毫秒数。</td></tr><tr><td>getTime()</td><td>返回从 1970-1-1 00:00:00 UTC 到该日期经过的毫秒数。</td></tr><tr><td>setFullYear(year, [month], [day])</td><td>根据本地时间设置指定日期对象的年份。</td></tr><tr><td>setMonth(month, [day])</td><td>根据本地时间设置指定日期对象的月份。</td></tr><tr><td>setDate(day)</td><td>根据本地时间设置指定日期对象的日期。</td></tr><tr><td>setHours(hour, [min], [sec], [ms])</td><td>根据本地时间设置指定日期对象的小时。</td></tr><tr><td>setMinutes(min, [sec], [ms])</td><td>根据本地时间设置指定日期对象的分钟。</td></tr><tr><td>setSeconds(sec, [ms])</td><td>根据本地时间设置指定日期对象的秒数。</td></tr><tr><td>setMilliseconds(ms)</td><td>根据本地时间设置指定日期对象的毫秒数。</td></tr><tr><td>setTime(time)</td><td>通过指定从 1970-1-1 00:00:00 UTC 开始经过的毫秒数来设置日期对象。</td></tr><tr><td>toISOString()</td><td>返回一个 ISO 格式的字符串：YYYY-MM-DDTHH:mm:ss.sssZ。</td></tr><tr><td>toLocaleString()</td><td>返回一个表示日期对象的字符串，该字符串与当地环境的语言相对应。</td></tr></tbody></table></div><h4 id="JSON-对象的方法"><a href="#JSON-对象的方法" class="headerlink" title="JSON 对象的方法"></a>JSON 对象的方法</h4><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>JSON.parse(text[, reviver])</td><td>将一个 JSON 字符串转换为对象。</td></tr><tr><td>JSON.stringify(value[, replacer[, space]])</td><td>将一个值转换为 JSON 字符串。</td></tr></tbody></table></div><h4 id="Map-对象的方法"><a href="#Map-对象的方法" class="headerlink" title="Map 对象的方法"></a>Map 对象的方法</h4><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>set(key, value)</td><td>设置 Map 对象中键的值，返回该 Map 对象。</td></tr><tr><td>get(key)</td><td>返回键对应的值，如果不存在，则返回 undefined。</td></tr><tr><td>has(key)</td><td>返回一个布尔值，表示 Map 实例是否包含键对应的值。</td></tr><tr><td>delete(key)</td><td>删除 Map 中的元素，删除成功返回 true，否则返回 false。</td></tr><tr><td>clear()</td><td>移除 Map 对象中的所有元素。</td></tr><tr><td>keys()</td><td>返回一个新的 Iterator 对象，它按插入顺序包含了 Map 对象中每个元素的键。</td></tr><tr><td>values()</td><td>返回一个新的 Iterator 对象，它按插入顺序包含了 Map 对象中每个元素的值。</td></tr><tr><td>entries()</td><td>返回一个新的 Iterator 对象，它按插入顺序包含了 Map 对象中每个元素的[key, value]数组。</td></tr><tr><td>forEach(callbackFn[, thisArg])</td><td>按插入顺序，为 Map 对象里的每一键值对调用一次 callbackFn 函数。</td></tr></tbody></table></div><h4 id="Set-对象的方法"><a href="#Set-对象的方法" class="headerlink" title="Set 对象的方法"></a>Set 对象的方法</h4><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>add(value)</td><td>在 Set 对象尾部添加一个元素，返回该 Set 对象。</td></tr><tr><td>has(value)</td><td>返回一个布尔值，表示该值在 Set 中存在与否。</td></tr><tr><td>delete(value)</td><td>移除 Set 中与这个值相等的元素，返回 Set.prototype.has(value)在这个操作前返回的值。</td></tr><tr><td>clear()</td><td>移除 Set 对象内的所有元素。</td></tr><tr><td>keys()</td><td>返回一个新的 Iterator 对象，该对象包含 Set 对象中的按插入顺序排列的所有元素的值。</td></tr><tr><td>values()</td><td>与 keys()方法相同，返回一个新的 Iterator 对象。</td></tr><tr><td>entries()</td><td>返回一个新的 Iterator 对象，该对象包含 Set 对象中的按插入顺序排列的所有元素的值的[value, value]数组。</td></tr><tr><td>forEach(callbackFn[, thisArg])</td><td>按照插入顺序，为 Set 对象中的每一个值调用一次 callBackFn。</td></tr></tbody></table></div><h4 id="Promise-对象的方法"><a href="#Promise-对象的方法" class="headerlink" title="Promise 对象的方法"></a>Promise 对象的方法</h4><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>Promise.all(iterable)</td><td>返回一个新的 Promise，它在 iterable 中所有的 Promise 都成功时才成功，只要有一个失败就失败。</td></tr><tr><td>Promise.race(iterable)</td><td>返回一个新的 Promise，它在 iterable 中任意一个 Promise 解决或拒绝时立即解决或拒绝。</td></tr><tr><td>Promise.resolve(value)</td><td>返回一个以给定值解析后的 Promise 对象。</td></tr><tr><td>Promise.reject(reason)</td><td>返回一个带有拒绝原因的 Promise 对象。</td></tr></tbody></table></div><h3 id="函数与高阶方法"><a href="#函数与高阶方法" class="headerlink" title="函数与高阶方法"></a><strong>函数与高阶方法</strong></h3><div class="table-container"><table><thead><tr><th><strong>方法/语法</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>bind(thisArg, ...args)</code></td><td>绑定  <code>this</code>  并返回新函数</td><td><code>func.bind(obj)</code> → 新函数</td></tr><tr><td><code>call(thisArg, ...args)</code></td><td>立即调用函数并指定  <code>this</code></td><td><code>func.call(obj, 1, 2)</code></td></tr><tr><td><code>apply(thisArg, [args])</code></td><td>立即调用函数并指定  <code>this</code>（参数为数组）</td><td><code>func.apply(obj, [1, 2])</code></td></tr><tr><td><code>setTimeout(callback, delay)</code></td><td>延迟执行函数（返回定时器 ID）</td><td><code>setTimeout(() =&gt; {}, 1000)</code> → <code>ID</code></td></tr><tr><td><code>setInterval(callback, delay)</code></td><td>循环执行函数（返回定时器 ID）</td><td><code>setInterval(() =&gt; {}, 1000)</code> → <code>ID</code></td></tr></tbody></table></div><h3 id="RegExp-方法"><a href="#RegExp-方法" class="headerlink" title="RegExp 方法"></a>RegExp 方法</h3><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>exec(string)</td><td>在一个指定字符串中执行一个搜索匹配。返回一个结果数组或 null。</td></tr><tr><td>test(string)</td><td>执行一个检索，用来查看正则表达式与指定的字符串是否匹配。返回 true 或 false。</td></tr></tbody></table></div><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><div class="table-container"><table><thead><tr><th>方法名</th><th>描述</th></tr></thead><tbody><tr><td>eval(string)</td><td>执行字符串形式的 JavaScript 代码。</td></tr><tr><td>isNaN(value)</td><td>判断一个值是否是 NaN。注意：全局的 isNaN 会先将参数转换为数值再判断。</td></tr><tr><td>isFinite(value)</td><td>判断一个值是否是有限数字。</td></tr><tr><td>parseFloat(string)</td><td>将字符串解析成浮点数。</td></tr><tr><td>parseInt(string, radix)</td><td>将字符串解析成整数。</td></tr></tbody></table></div><p>【待补充】</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;JavaScript 常用方法速查&lt;/p&gt;
&lt;h3 id=&quot;数组&quot;&gt;&lt;a href=&quot;#数组&quot; class=&quot;headerlink&quot; title=&quot;数组&quot;&gt;&lt;/a&gt;数组&lt;/h3&gt;&lt;div class=&quot;table-container&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;t</summary>
      
    
    
    
    <category term="归档" scheme="https://zhongye1.github.io/Arknight-notes/categories/%E5%BD%92%E6%A1%A3/"/>
    
    
    <category term="前端开发" scheme="https://zhongye1.github.io/Arknight-notes/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
</feed>
