<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>2025-12-27-前端画布设计Vol.3 实时协作（Yjs + Hocuspocus + 持久化） | Zhongye's Blogs</title><link rel="icon" type="image/x-icon" href="/Arknight-notes/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/Arknight-notes/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/Arknight-notes/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/Arknight-notes/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/Arknight-notes/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/Arknight-notes/font/Bender.ttf"), url("/Arknight-notes/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/Arknight-notes/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/Arknight-notes/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/Arknight-notes/","code_fold":500,"search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/Arknight-notes/lib/encrypt/hbe.style.css"><script src="/Arknight-notes/js/gitalk.js"></script><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/Arknight-notes/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/Arknight-notes/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/Arknight-notes/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('https://picx.zhimg.com/v2-6c94831ec3400e77452e9bd9dde85cb5_r.jpg');
 --light-background: url('https://pica.zhimg.com/v2-0323b00e97b41d914a545c7ccea6ab0a_r.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/Arknight-notes/js/arknights.js"></script><script defer src="/Arknight-notes/js/search.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async src="/Arknight-notes/js/gitalk.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
  menuSettings: {
    zoom: "None"
  },
  showMathMenu: false,
  jax: ["input/TeX","output/CommonHTML"],
  extensions: ["tex2jax.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js"],
    equationNumbers: {
      autoNumber: "AMS"
    }
  },
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]]
  }
});
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/Arknight-notes/lib/encrypt/hbe.js"></script><script async src="/Arknight-notes/js/pjax.js"></script><script class="pjax-js">reset= () => {gitalk = new Gitalk({
 clientID: 'Ov23ct13Fb0b67x23wnT',
 clientSecret: 'f18ce69dd545e3c0f5e2456afde9c756fe8a254a',
 repo: 'Arknight-notes',
 owner: 'Zhongye1',
 admin: ['Zhongye1'],
 distractionFreeMode: false,
 id: location.pathname
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);document.addEventListener('pjax:success', _ => bszCaller.fetch(
 "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback", a => {
  bszTag.texts(a),
  bszTag.shows()
}));reset()})</script><script class="pjax-js">reset= () => {gitalk = new Gitalk({
 clientID: 'Ov23ct13Fb0b67x23wnT',
 clientSecret: 'f18ce69dd545e3c0f5e2456afde9c756fe8a254a',
 repo: 'Arknight-notes',
 owner: 'Zhongye1',
 admin: ['Zhongye1'],
 distractionFreeMode: false,
 id: location.pathname
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/Arknight-notes/rss.xml" title="Zhongye's Blogs" type="application/atom+xml">
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/Arknight-notes/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/Arknight-notes/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/Arknight-notes/about/"><span class="navItemTitle">About</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>2025-12-27-前端画布设计Vol.3 实时协作（Yjs + Hocuspocus + 持久化）</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2025-12-27T21:46:01.000Z" id="date"> 2025-12-28</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2025-12-29T07:44:06.909Z" id="updated"> 2025-12-29</time></div></span><br><span id="busuanzi_container_page_pv">页面浏览: <span class="control" id="busuanzi_value_page_pv">加载中...</span></span></div></div><hr><div id="post-content"><h1 id="实时协作画布系统：Yjs-Hocuspocus-持久化"><a href="#实时协作画布系统：Yjs-Hocuspocus-持久化" class="headerlink" title="实时协作画布系统：Yjs + Hocuspocus + 持久化"></a>实时协作画布系统：Yjs + Hocuspocus + 持久化</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在设计工具、白板应用和文档编辑器中，多用户同时编辑同一文档的需求日益增长。传统的客户端-服务器模型在这种场景下存在诸多挑战，例如冲突解决、网络延迟和离线支持等。</p>
<p>为了支持多用户同时编辑画布内容，并具备离线编辑能力，我们采用了 Yjs（一种 CRDT 实现）配合 IndexedDB 和 Hocuspocus 的架构方案。</p>
<h2 id="核心技术组件"><a href="#核心技术组件" class="headerlink" title="核心技术组件"></a>核心技术组件</h2><h3 id="Yjs-Y-Map"><a href="#Yjs-Y-Map" class="headerlink" title="Yjs (Y.Map)"></a>Yjs (Y.Map)</h3><p>Yjs 是一个用于创建实时协作应用程序的库，它实现了 Conflict-free Replicated Data Types (CRDTs) 算法。CRDTs 是一种特殊的数据结构，可以在多个副本之间同步，而不需要中央协调，从而保证最终一致性。</p>
<p>Y.Map 是 Yjs 提供的一种共享数据类型，类似于 JavaScript 中的 Map。它的关键特性包括：</p>
<ul>
<li><strong>自动冲突解决</strong>：当多个用户同时修改数据时，Yjs 自动解决冲突</li>
<li><strong>分布式一致性</strong>：保证所有客户端看到相同的数据状态</li>
<li><strong>高效同步</strong>：只传输变更部分，减少网络流量</li>
</ul>
<h3 id="持久化选项"><a href="#持久化选项" class="headerlink" title="持久化选项"></a>持久化选项</h3><p>持久化是协作系统的关键组件，不仅需要在客户端存储数据以支持离线使用，还需要在服务端存储数据以实现长期保存和共享。本项目实际实现的持久化策略包括：</p>
<h4 id="1-IndexedDB（客户端）"><a href="#1-IndexedDB（客户端）" class="headerlink" title="1. IndexedDB（客户端）"></a>1. IndexedDB（客户端）</h4><p>IndexedDB 是浏览器内置的数据库，用于存储大量结构化数据。在协作系统中，它用于：</p>
<ul>
<li>使用 <code>y-indexeddb</code> 库创建 IndexeddbPersistence 实例</li>
<li>为每个房间创建独立的 IndexedDB 存储 (<code>canvas-local-db-${roomId}</code>)</li>
<li>提供 getYDocForRoom、getYElementsForRoom 和 getIndexedDBProviderForRoom 等函数来管理不同房间的数据</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> Y <span class="hljs-keyword">from</span> <span class="hljs-string">'yjs'</span>;<br><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IndexeddbPersistence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'y-indexeddb'</span>;<br><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HocuspocusProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hocuspocus/provider'</span>; <span class="hljs-comment">// 如需实时同步时导入</span><br><br><span class="hljs-comment">// 使用 Map 存储不同房间的 Yjs 文档及相关提供者，确保单例管理和数据隔离</span><br><span class="hljs-keyword">const</span> roomDocuments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<br>  <span class="hljs-built_in">string</span>,<br>  {<br>    <span class="hljs-attr">yDoc</span>: Y.<span class="hljs-property">Doc</span>;<br>    <span class="hljs-attr">yElements</span>: Y.<span class="hljs-property">Map</span>&lt;<span class="hljs-built_in">any</span>&gt;;<br>    <span class="hljs-attr">indexeddbProvider</span>: <span class="hljs-title class_">IndexeddbPersistence</span>;<br>    <span class="hljs-attr">wsProvider</span>: <span class="hljs-title class_">HocuspocusProvider</span> | <span class="hljs-literal">null</span>;<br>  }<br>&gt;();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取或创建指定房间的 Yjs 文档实例</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> roomId 协作房间的唯一标识符</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> 该房间对应的 Y.Doc 实例</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getYDocForRoom = (<span class="hljs-attr">roomId</span>: <span class="hljs-built_in">string</span>): Y.<span class="hljs-property">Doc</span> =&gt; {<br>  <span class="hljs-comment">// 若该房间的文档已存在，直接复用以避免重复创建</span><br>  <span class="hljs-keyword">if</span> (roomDocuments.<span class="hljs-title function_">has</span>(roomId)) {<br>    <span class="hljs-keyword">return</span> roomDocuments.<span class="hljs-title function_">get</span>(roomId)!.<span class="hljs-property">yDoc</span>;<br>  }<br><br>  <span class="hljs-comment">// 创建新的 Yjs 文档实例</span><br>  <span class="hljs-keyword">const</span> yDoc = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Doc</span>();<br><br>  <span class="hljs-comment">// 获取画布元素的核心数据结构（Y.Map，用于存储所有 CanvasElement）</span><br>  <span class="hljs-keyword">const</span> yElements = yDoc.<span class="hljs-property">getMap</span>&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-string">'elements'</span>);<br><br>  <span class="hljs-comment">// 初始化 IndexedDB 持久化提供者</span><br>  <span class="hljs-comment">// 数据库名称动态包含 roomId，确保不同房间的数据互不干扰</span><br>  <span class="hljs-keyword">const</span> indexeddbProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexeddbPersistence</span>(<span class="hljs-string">`canvas-local-db-<span class="hljs-subst">${roomId}</span>`</span>, yDoc);<br><br>  <span class="hljs-comment">// 将文档相关信息存入 Map，便于后续访问和管理</span><br>  roomDocuments.<span class="hljs-title function_">set</span>(roomId, {<br>    yDoc,<br>    yElements,<br>    indexeddbProvider,<br>    <span class="hljs-attr">wsProvider</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 初始为空，后续可动态绑定 HocuspocusProvider 以实现实时协作</span><br>  });<br><br>  <span class="hljs-keyword">return</span> yDoc;<br>};<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>离线数据存储</strong>：即使用户断网，数据也不会丢失</li>
<li><strong>快速本地访问</strong>：减少对服务器的依赖</li>
<li><strong>大容量存储</strong>：相比 localStorage，支持更大的数据量</li>
</ul>
<h4 id="2-SQLite（服务端）"><a href="#2-SQLite（服务端）" class="headerlink" title="2. SQLite（服务端）"></a>2. SQLite（服务端）</h4><p>SQLite 作为服务端数据库，用于持久化存储画布内容：</p>
<ul>
<li><strong>关系型结构</strong>：提供 SQL 查询能力</li>
<li><strong>轻量级</strong>：无需单独的服务器进程</li>
<li><strong>跨平台</strong>：可在多种环境中运行</li>
<li><strong>服务端存储</strong>：确保数据在服务端持久化</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 服务端数据库实现 (ALD_Backend/src/db.ts)</span><br><br><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Database</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"bun:sqlite"</span>;<br><span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Database</span>(<span class="hljs-string">"collab.sqlite"</span>);<br><br><span class="hljs-comment">// 启用 WAL 模式以提高并发性能</span><br>db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"PRAGMA journal_mode = WAL;"</span>);<br><span class="hljs-comment">// 房间表，包含 content BLOB 字段存储 Yjs 二进制数据</span><br>db.<span class="hljs-title function_">run</span>(<span class="hljs-string">`</span><br><span class="hljs-string">  CREATE TABLE IF NOT EXISTS rooms (</span><br><span class="hljs-string">    id TEXT PRIMARY KEY,</span><br><span class="hljs-string">    name TEXT NOT NULL,</span><br><span class="hljs-string">    creator_id TEXT NOT NULL,</span><br><span class="hljs-string">    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,</span><br><span class="hljs-string">    content BLOB, -- Yjs 二进制数据</span><br><span class="hljs-string">    FOREIGN KEY (creator_id) REFERENCES users(id)</span><br><span class="hljs-string">  )</span><br><span class="hljs-string">`</span>);<br><br><span class="hljs-comment">// Hocuspocus 数据库扩展实现 (ALD_Backend/src/collab.ts)</span><br><br><span class="hljs-keyword">const</span> dbExtension = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HocuspocusDB</span>({<br>  <span class="hljs-attr">fetch</span>: <span class="hljs-title function_">async</span> ({ documentName }) =&gt; {<br>    <span class="hljs-keyword">const</span> roomId = <span class="hljs-title function_">getRoomId</span>(documentName);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>      <span class="hljs-string">`[Yjs] Fetching data for RoomID: <span class="hljs-subst">${roomId}</span>, Original documentName: <span class="hljs-subst">${documentName}</span>`</span><br>    );<br><br>    <span class="hljs-keyword">const</span> query = db.<span class="hljs-title function_">query</span>(<span class="hljs-string">"SELECT content FROM rooms WHERE id = $id"</span>);<br>    <span class="hljs-keyword">const</span> row = query.<span class="hljs-title function_">get</span>({ <span class="hljs-attr">$id</span>: roomId }) <span class="hljs-keyword">as</span> {<br>      <span class="hljs-attr">content</span>: <span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">null</span>;<br>    } | <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (row &amp;&amp; row.<span class="hljs-property">content</span> !== <span class="hljs-literal">null</span> &amp;&amp; row.<span class="hljs-property">content</span> !== <span class="hljs-literal">undefined</span>) {<br>      <span class="hljs-keyword">if</span> (row.<span class="hljs-property">content</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>          <span class="hljs-string">`[Yjs] Returning data with size: <span class="hljs-subst">${row.content.length}</span> bytes`</span><br>        );<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(row.<span class="hljs-property">content</span>);<br>      } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Yjs] content is empty, creating new Yjs document`</span>);<br>        <span class="hljs-keyword">const</span> ydoc = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Doc</span>();<br>        ydoc.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">"elements"</span>); <span class="hljs-comment">// 存储图形元素</span><br>        <span class="hljs-keyword">return</span> Y.<span class="hljs-title function_">encodeStateAsUpdate</span>(ydoc);<br>      }<br>    }<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Yjs] No valid data found, creating new Yjs document`</span>);<br>    <span class="hljs-keyword">const</span> ydoc = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Doc</span>();<br>    ydoc.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">"elements"</span>); <span class="hljs-comment">// 存储图形元素</span><br>    <span class="hljs-keyword">return</span> Y.<span class="hljs-title function_">encodeStateAsUpdate</span>(ydoc);<br>  },<br><br>  <span class="hljs-attr">store</span>: <span class="hljs-title function_">async</span> ({ documentName, state }) =&gt; {<br>    <span class="hljs-keyword">const</span> roomId = <span class="hljs-title function_">getRoomId</span>(documentName);<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>        <span class="hljs-string">`[Yjs] Saving data for RoomID: <span class="hljs-subst">${roomId}</span>, State size: <span class="hljs-subst">${state.length}</span> bytes, Original documentName: <span class="hljs-subst">${documentName}</span>`</span><br>      );<br><br>      <span class="hljs-keyword">if</span> (state.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {<br>        <span class="hljs-keyword">const</span> roomCheck = db.<span class="hljs-title function_">query</span>(<span class="hljs-string">"SELECT id FROM rooms WHERE id = $id"</span>);<br><br>        <span class="hljs-keyword">const</span> roomExists = roomCheck.<span class="hljs-title function_">get</span>({ <span class="hljs-attr">$id</span>: roomId });<br><br>        <span class="hljs-keyword">if</span> (!roomExists) {<br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<br>            <span class="hljs-string">`[Yjs] Room <span class="hljs-subst">${roomId}</span> does not exist, cannot save data`</span><br>          );<br><br>          <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-keyword">const</span> update = db.<span class="hljs-title function_">query</span>(<br>          <span class="hljs-string">"UPDATE rooms SET content = $blob WHERE id = $id"</span><br>        );<br><br>        update.<span class="hljs-title function_">run</span>({ <span class="hljs-attr">$blob</span>: state, <span class="hljs-attr">$id</span>: roomId });<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Yjs] Data saved successfully for RoomID: <span class="hljs-subst">${roomId}</span>`</span>);<br>      } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>          <span class="hljs-string">`[Yjs] Skipping save for RoomID: <span class="hljs-subst">${roomId}</span> as state is empty`</span><br>        );<br>      }<br>    } <span class="hljs-keyword">catch</span> (error) {<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[Yjs] Save failed for <span class="hljs-subst">${roomId}</span>:`</span>, error);<br>    }<br>  },<br>});<br></code></pre></td></tr></table></figure>
<h3 id="Hocuspocus-Provider"><a href="#Hocuspocus-Provider" class="headerlink" title="Hocuspocus Provider"></a>Hocuspocus Provider</h3><p>Hocuspocus 是一个协作编辑框架，提供了 Yjs 的服务器端实现。它负责：</p>
<ul>
<li><strong>多客户端同步</strong>：协调多个客户端之间的数据同步</li>
<li><strong>WebSocket 连接管理</strong>：建立持久连接</li>
<li><strong>房间管理</strong>：隔离不同协作空间的数据</li>
<li><strong>与多种持久化后端集成</strong>：可连接到数据库、文件系统等</li>
</ul>
<h2 id="系统架构设计"><a href="#系统架构设计" class="headerlink" title="系统架构设计"></a>系统架构设计</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph TB<br>    subgraph "Frontend Application (React/Vue)"<br>        A[Canvas UI Components]<br>        B[State Management&lt;br/&gt;Zustand/Pinia]<br>        C[Yjs Document&lt;br/&gt;Shared Data]<br>        D[IndexedDB&lt;br/&gt;Local Persistence]<br>    end<br>    subgraph "Backend Services"<br>        E[Hono Server&lt;br/&gt;Port 3000]<br>        F[RESTful API&lt;br/&gt;Auth/RM]<br>        G[SQLite DB&lt;br/&gt;Persistence]<br>    end<br>    subgraph "WebSocket Services"<br>        H[Hocuspocus Server&lt;br/&gt;Port 1234]<br>        I[Yjs Extensions&lt;br/&gt;DB/Storage]<br>    end<br>    A &lt;--&gt; C<br>    B &lt;--&gt; C<br>    C &lt;--&gt; D<br>    C &lt;--&gt; H<br>    E &lt;--&gt; F<br>    E &lt;--&gt; G<br>    F &lt;--&gt; H<br>    H &lt;--&gt; I<br>    I &lt;--&gt; G<br>    style A fill:#87CEEB<br>    style B fill:#98FB98<br>    style C fill:#FFD700<br>    style D fill:#DDA0DD<br>    style E fill:#F0E68C<br>    style F fill:#FFA07A<br>    style G fill:#BA55D3<br>    style H fill:#20B2AA<br>    style I fill:#FF69B4<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mermaid">graph LR<br>    subgraph "Client A"<br>        A[Y.Map&lt;br/&gt;Shared Data]<br>        B[IndexedDB&lt;br/&gt;Local Persistence]<br>    end<br>    subgraph "Server"<br>        C[Hocuspocus&lt;br/&gt;Server]<br>        D[SQLite DB&lt;br/&gt;Persistence]<br>    end<br>    subgraph "Client B"<br>        E[Y.Map&lt;br/&gt;Shared Data]<br>        F[IndexedDB&lt;br/&gt;Local Persistence]<br>    end<br>    A &lt;--&gt; C<br>    E &lt;--&gt; C<br>    B &lt;--&gt; D<br>    F &lt;--&gt; D<br>    C &lt;--&gt; D<br>    style A fill:#FFD700<br>    style B fill:#DDA0DD<br>    style C fill:#20B2AA<br>    style D fill:#BA55D3<br>    style E fill:#FFD700<br>    style F fill:#DDA0DD<br></code></pre></td></tr></table></figure>
<h3 id="数据流向"><a href="#数据流向" class="headerlink" title="数据流向"></a>数据流向</h3><ol>
<li>用户操作更新本地 Y.Map</li>
<li>变更自动同步到 IndexedDB（本地持久化）</li>
<li>变更通过 Hocuspocus 同步到服务器和其他客户端</li>
<li>服务器将变更存储到 SQLite 数据库</li>
<li>其他客户端接收变更并更新本地 Y.Map</li>
</ol>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="1-初始化协作环境"><a href="#1-初始化协作环境" class="headerlink" title="1. 初始化协作环境"></a>1. 初始化协作环境</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> Y <span class="hljs-keyword">from</span> <span class="hljs-string">"yjs"</span>;<br><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IndexeddbPersistence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"y-indexeddb"</span>;<br><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HocuspocusProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@hocuspocus/provider"</span>;<br><br><span class="hljs-comment">// 创建 Yjs 文档</span><br><span class="hljs-keyword">const</span> ydoc = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Doc</span>();<br><span class="hljs-comment">// 获取共享的 Y.Map 用于存储画布元素</span><br><span class="hljs-keyword">const</span> yElements = ydoc.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">"elements"</span>);<br><span class="hljs-comment">// 设置 IndexedDB 持久化</span><br><span class="hljs-keyword">const</span> indexeddbProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexeddbPersistence</span>(<span class="hljs-string">"canvas-room"</span>, ydoc);<br><span class="hljs-comment">// 设置 Hocuspocus 提供者</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initWsProvider</span> = (<span class="hljs-params"><span class="hljs-attr">roomId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span></span>) =&gt; {<br>  <span class="hljs-comment">// 如果房间不存在，先创建</span><br>  <span class="hljs-keyword">if</span> (!roomDocuments.<span class="hljs-title function_">has</span>(roomId)) {<br>    <span class="hljs-title function_">getYDocForRoom</span>(roomId);<br>  }<br><br>  <span class="hljs-keyword">const</span> roomData = roomDocuments.<span class="hljs-title function_">get</span>(roomId)!;<br><br>  <span class="hljs-comment">// 如果已存在 WebSocket 提供者，先销毁</span><br>  <span class="hljs-keyword">if</span> (roomData.<span class="hljs-property">wsProvider</span>) {<br>    roomData.<span class="hljs-property">wsProvider</span>.<span class="hljs-title function_">destroy</span>();<br>  }<br><br>  <span class="hljs-comment">// 创建新的 WebSocket 提供者，并关联 Yjs 文档</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>    <span class="hljs-string">`[Room <span class="hljs-subst">${roomId}</span>] Initializing WebSocket Provider with token: <span class="hljs-subst">${token}</span>`</span><br>  );<br><br>  <span class="hljs-keyword">const</span> wsProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HocuspocusProvider</span>({<br>    <span class="hljs-comment">// 确保 URL 结尾规范，方便拼接</span><br>    <span class="hljs-attr">url</span>: <span class="hljs-string">`ws://localhost:3000/collaboration/<span class="hljs-subst">${roomId}</span>`</span>,<br>    <span class="hljs-attr">name</span>: roomId, <span class="hljs-comment">// Hocuspocus 会将其拼接为 /collaboration/{roomId}</span><br>    <span class="hljs-attr">token</span>: token,<br>    <span class="hljs-comment">// 明确指定要同步的文档</span><br>    <span class="hljs-attr">document</span>: roomData.<span class="hljs-property">yDoc</span>,<br>  });<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(wsProvider);<br><br>  <span class="hljs-comment">// 监听 WebSocket 连接状态</span><br>  wsProvider.<span class="hljs-title function_">on</span>(<span class="hljs-string">"status"</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">event</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> {<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Room <span class="hljs-subst">${roomId}</span>] WebSocket status:`</span>, event.<span class="hljs-property">status</span>); <span class="hljs-comment">// 'connected' or 'disconnected'</span><br>  });<br><br>  <span class="hljs-comment">// 更新房间数据中的 WebSocket 提供者</span><br>  roomData.<span class="hljs-property">wsProvider</span> = wsProvider;<br>  <span class="hljs-keyword">return</span> wsProvider;<br>};<br></code></pre></td></tr></table></figure>
<h3 id="2-画布元素管理"><a href="#2-画布元素管理" class="headerlink" title="2. 画布元素管理"></a>2. 画布元素管理</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CanvasElement</span> {<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">color</span>: <span class="hljs-built_in">string</span>;<br>}<br><br><span class="hljs-comment">// 添加元素</span><br><br>yElements.<span class="hljs-title function_">set</span>(elementId, {<br>  <span class="hljs-attr">id</span>: elementId,<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">"rectangle"</span>,<br>  <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,<br>  <span class="hljs-attr">y</span>: <span class="hljs-number">100</span>,<br>  <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,<br>  <span class="hljs-attr">height</span>: <span class="hljs-number">150</span>,<br>  <span class="hljs-attr">color</span>: <span class="hljs-string">"#ff0000"</span>,<br>});<br><br><span class="hljs-comment">// 监听元素变化</span><br><br>yElements.<span class="hljs-title function_">observeDeep</span>(<span class="hljs-function">(<span class="hljs-params">events</span>) =&gt;</span> {<br>  events.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {<br>    <span class="hljs-comment">// 处理添加、更新、删除事件</span><br>  });<br>});<br></code></pre></td></tr></table></figure>
<h3 id="3-React-状态集成"><a href="#3-React-状态集成" class="headerlink" title="3. React 状态集成"></a>3. React 状态集成</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;<br><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;<br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CanvasStore</span> {<br>  <span class="hljs-attr">ydoc</span>: Y.<span class="hljs-property">Doc</span>;<br>  <span class="hljs-attr">yElements</span>: Y.<span class="hljs-property">Map</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;;<br>  <span class="hljs-attr">elements</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CanvasElement</span>&gt;;<br>  <span class="hljs-attr">addElement</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">element</span>: <span class="hljs-title class_">CanvasElement</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>  <span class="hljs-attr">updateElement</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">updates</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CanvasElement</span>&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>  <span class="hljs-attr">deleteElement</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>}<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCanvasStore = create&lt;<span class="hljs-title class_">CanvasStore</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> ({<br>  <span class="hljs-comment">// ... store implementation</span><br>}));<br></code></pre></td></tr></table></figure>
<h3 id="4-离线支持实现"><a href="#4-离线支持实现" class="headerlink" title="4. 离线支持实现"></a>4. 离线支持实现</h3><p>离线支持是通过 IndexedDB 实现的：</p>
<ul>
<li>当用户在线时，所有操作同步到服务器和其他客户端</li>
<li>当用户离线时，操作仅保存在本地 IndexedDB 中</li>
<li>当用户重新连接时，本地更改自动同步到服务器</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 等待 IndexedDB 数据加载</span><br><span class="hljs-keyword">await</span> indexeddbProvider.<span class="hljs-property">whenSynced</span>;<br><br><span class="hljs-comment">// 监听连接状态</span><br>provider.<span class="hljs-title function_">on</span>(<span class="hljs-string">"synced"</span>, <span class="hljs-function">() =&gt;</span> {<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Document synced with server"</span>);<br>});<br></code></pre></td></tr></table></figure>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>后续还可以实现批量更新，防抖，服务端数据验证等优化。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/Arknight-notes/posts/16956.html">← 下一篇 2025-12-28-前端学习-接口类型定义、Axios 封装与请求规范</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/Arknight-notes/posts/10362.html">2025-12-18-前端画布设计Vol.2 实现富文本编辑 上一篇 →</a></div></div></div><div id="comments"><div id="gitalk"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/Arknight-notes/" id="logo"><img src="https://pic4.zhimg.com/80/v2-d9884f32711e19e80979eac58e943897_720w.webp" alt="Logo" style="margin:20;border-radius:0;"></a><h1 id="Dr"><a href="zhongye">Zhongye</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E5%8D%8F%E4%BD%9C%E7%94%BB%E5%B8%83%E7%B3%BB%E7%BB%9F%EF%BC%9AYjs-Hocuspocus-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">实时协作画布系统：Yjs + Hocuspocus + 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">核心技术组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Yjs-Y-Map"><span class="toc-number">1.2.1.</span> <span class="toc-text">Yjs (Y.Map)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">持久化选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-IndexedDB%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">1. IndexedDB（客户端）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-SQLite%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2. SQLite（服务端）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hocuspocus-Provider"><span class="toc-number">1.2.3.</span> <span class="toc-text">Hocuspocus Provider</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">系统架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">数据流向</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">1.4.</span> <span class="toc-text">实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8D%8F%E4%BD%9C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 初始化协作环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%BB%E5%B8%83%E5%85%83%E7%B4%A0%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 画布元素管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-React-%E7%8A%B6%E6%80%81%E9%9B%86%E6%88%90"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. React 状态集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%A6%BB%E7%BA%BF%E6%94%AF%E6%8C%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. 离线支持实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">优化</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">GZHU</span><span class="icp-content">193001-0001</span></nobr><br><nobr><span class="icp-title">OUTPOST</span><span class="icp-content">169-2025-0331</span></nobr><br><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><!-- ── 访客信息获取脚本（建议放在页面底部 layout/_partial/after-footer.pug 或单独引入） ──--><script>(function() {
  const MAX_RETRY = 1;
  let retryCount = 0;

  async function fetchVisitorInfo() {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort(new Error('Request timeout after 1000ms'));
    }, 1000);

    try {
      const response = await fetch('https://ipapi.co/json/', {
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const data = await response.json();

      document.getElementById('visitor-ip').textContent = data.ip || '无法获取';
      
      const parts = [];
      if (data.city) parts.push(data.city);
      if (data.region) parts.push(data.region);
      if (data.country_name) parts.push(data.country_name);
      
      document.getElementById('visitor-location').textContent = 
        parts.length > 0 ? parts.join(' - ') : '未知地区';

    } catch (err) {
      clearTimeout(timeoutId);

      // 如果是超时错误，且还有重试次数，则重试一次
      if (err.name === 'AbortError' && retryCount < MAX_RETRY) {
        retryCount++;
        // 可选：显示「正在重试...」提示
        document.getElementById('visitor-ip').textContent = '超时，正在重试...';
        document.getElementById('visitor-location').textContent = '——';
        
        // 立即重试（也可加个很短的延迟，如 300ms）
        setTimeout(fetchVisitorInfo, 300);
        return;
      }

      // 最终失败
      document.getElementById('visitor-ip').textContent = '████';
      document.getElementById('visitor-location').textContent = '████';
    }
  }

  // 页面加载完成后获取访客信息
  fetchVisitorInfo();

  // 添加对PJAX事件的监听，以便在页面切换后重新获取访客信息
  document.addEventListener('pjax:complete', function() {
    // 延迟执行，确保DOM已经更新完成
    setTimeout(fetchVisitorInfo, 100);
  });
})();</script></main><canvas id="canvas-dust"></canvas></body></html>